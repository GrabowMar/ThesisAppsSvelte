{% extends "base.html" %}

{% block content %}
<div class="flex min-h-screen bg-gray-100">
  <!-- Main Content Area -->
  <div class="flex-1 flex flex-col overflow-hidden">
    <!-- Top Navigation and Filter Bar -->
    <div class="bg-gray-200 border-b border-gray-400 p-1">
      <div class="flex justify-between items-center">
        <div class="flex items-center space-x-2">
          <a href="{{ url_for('main.index') }}" class="action-btn h-6 px-2 text-xs rounded-sm">Back</a>
          <button id="startScan" class="action-btn h-6 px-2 text-xs rounded-sm">Start Scan</button>
          <button id="stopScan" class="action-btn h-6 px-2 text-xs hidden rounded-sm">Stop Scan</button>
        </div>
        <div class="flex items-center space-x-2">
          <input type="text" id="searchIssues" placeholder="Search issues..." 
                 aria-label="Search issues" class="h-6 px-2 text-xs border border-gray-300 rounded-sm">
          <select id="riskFilter" aria-label="Filter by risk level" class="h-6 px-2 text-xs border border-gray-300 rounded-sm">
            <option value="all">All Risks</option>
            <option value="High">High</option>
            <option value="Medium">Medium</option>
            <option value="Low">Low</option>
            <option value="Informational">Info</option>
          </select>
          <select id="confidenceFilter" aria-label="Filter by confidence level" class="h-6 px-2 text-xs border border-gray-300 rounded-sm">
            <option value="all">All Confidence</option>
            <option value="High">High</option>
            <option value="Medium">Medium</option>
            <option value="Low">Low</option>
          </select>
          <select id="codeFilter" aria-label="Filter by code availability" class="h-6 px-2 text-xs border border-gray-300 rounded-sm">
            <option value="all">All Alerts</option>
            <option value="hasCode">With Code</option>
            <option value="noCode">Without Code</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Status Cards Section -->
    <div class="p-2 grid grid-cols-5 gap-2">
      <div class="border border-gray-400 bg-white p-2 rounded-sm shadow-sm">
        <div class="text-xs text-gray-600">Scan Status</div>
        <div class="text-xs font-bold" id="scanStatus">Not Started</div>
      </div>
      <div class="border border-gray-400 bg-white p-2 rounded-sm shadow-sm">
        <div class="text-xs text-red-800">High Risk</div>
        <div class="text-xs font-bold text-red-700" id="highCount">0</div>
      </div>
      <div class="border border-gray-400 bg-white p-2 rounded-sm shadow-sm">
        <div class="text-xs text-yellow-800">Medium Risk</div>
        <div class="text-xs font-bold text-yellow-700" id="mediumCount">0</div>
      </div>
      <div class="border border-gray-400 bg-white p-2 rounded-sm shadow-sm">
        <div class="text-xs text-blue-800">Low Risk</div>
        <div class="text-xs font-bold text-blue-700" id="lowCount">0</div>
      </div>
      <div class="border border-gray-400 bg-white p-2 rounded-sm shadow-sm">
        <div class="text-xs text-gray-600">Info</div>
        <div class="text-xs font-bold" id="infoCount">0</div>
      </div>
    </div>

    <!-- Main Content Section -->
    <div class="p-2 flex-1 overflow-auto space-y-2">
      <!-- Progress Bar Section -->
      <div id="scanProgress" class="hidden border border-gray-400 bg-white p-2 rounded-sm shadow-sm">
        <div class="text-xs font-bold mb-1">Scan Progress</div>
        <div class="space-y-1">
          <div class="flex justify-between text-xs">
            <span>Overall Progress:</span>
            <span id="progressPercentage">0%</span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-2">
            <div id="progressBar" class="bg-blue-600 rounded-full h-2 transition-all duration-500" style="width: 0%"></div>
          </div>
          
          <!-- Detailed Phase Progress -->
          <div class="mt-2 grid grid-cols-3 gap-1 text-xs">
            <div>
              <div class="flex justify-between">
                <span>Spider:</span>
                <span id="spiderProgress">0%</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-1">
                <div id="spiderProgressBar" class="bg-green-600 rounded-full h-1" style="width: 0%"></div>
              </div>
            </div>
            <div>
              <div class="flex justify-between">
                <span>Passive Scan:</span>
                <span id="passiveProgress">0%</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-1">
                <div id="passiveProgressBar" class="bg-yellow-600 rounded-full h-1" style="width: 0%"></div>
              </div>
            </div>
            <div>
              <div class="flex justify-between">
                <span>Active Scan:</span>
                <span id="activeProgress">0%</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-1">
                <div id="activeProgressBar" class="bg-red-600 rounded-full h-1" style="width: 0%"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Log Output Section -->
      <div class="border border-gray-400 bg-white rounded-sm shadow-sm">
        <div class="bg-gray-100 border-b border-gray-400 px-2 py-1 flex justify-between items-center">
          <h2 class="font-bold text-xs">Scan Log</h2>
          <button id="clearLog" class="text-xs text-gray-600 hover:text-gray-900 rounded-sm">Clear</button>
        </div>
        <div class="p-2">
          <pre id="progressLog" class="text-xs font-mono bg-gray-50 p-2 border border-gray-300 h-64 overflow-auto rounded-sm"></pre>
        </div>
      </div>

      <!-- Alerts List Section -->
      <div id="alertsList" class="space-y-2">
        {% if alerts %}
          {% for alert in alerts %}
            <div class="border border-gray-400 bg-white alert-item rounded-sm shadow-sm" 
                 data-risk="{{ alert.risk }}" 
                 data-confidence="{{ alert.confidence }}"
                 data-has-code="{{ alert.affected_code is defined and alert.affected_code and alert.affected_code.snippet }}"
                 data-searchable="{{ alert.name }} {{ alert.description }} {{ alert.url }}">
              <div class="p-2">
                <!-- Alert Header -->
                <div class="flex items-center space-x-2 mb-1">
                  <!-- Risk Badge -->
                  <span class="text-xs px-2 py-0.5 border rounded-sm
                    {% if alert.risk == 'High' %}
                      bg-red-100 text-red-800 border-red-700
                    {% elif alert.risk == 'Medium' %}
                      bg-yellow-100 text-yellow-800 border-yellow-700
                    {% elif alert.risk == 'Low' %}
                      bg-blue-100 text-blue-800 border-blue-700
                    {% else %}
                      bg-gray-100 text-gray-800 border-gray-700
                    {% endif %}">
                    {{ alert.risk }}
                  </span>
                  
                  <!-- Confidence Badge -->
                  <span class="text-xs px-2 py-0.5 bg-gray-100 border border-gray-400 rounded-sm">{{ alert.confidence }}</span>
                  
                  <!-- CWE Badge (if available) -->
                  {% if alert.cwe_id %}
                    <span class="text-xs px-2 py-0.5 bg-gray-100 border border-gray-400 rounded-sm">CWE-{{ alert.cwe_id }}</span>
                  {% endif %}
                  
                  <!-- Code Badge (if available) -->
                  {% if alert.affected_code is defined and alert.affected_code and alert.affected_code.snippet %}
                    <span class="text-xs px-2 py-0.5 bg-purple-100 text-purple-800 border border-purple-400 rounded-sm">Code Available</span>
                  {% endif %}
                  
                  <!-- Expand Button -->
                  <button class="ml-auto action-btn h-6 px-2 text-xs expand-btn rounded-sm">Expand</button>
                </div>
                
                <!-- Alert Content -->
                <div class="space-y-2">
                  <div>
                    <div class="text-xs font-bold">{{ alert.name }}</div>
                    <div class="text-xs text-gray-600">{{ alert.url }}</div>
                    {% if alert.parameter %}
                      <div class="text-xs text-gray-600">Parameter: {{ alert.parameter }}</div>
                    {% endif %}
                  </div>
                  
                  <!-- Collapsible Details -->
                  <div class="alert-details hidden space-y-2">
                    {% if alert.description %}
                      <div class="text-xs bg-gray-50 p-2 border border-gray-300 rounded-sm">
                        <div class="font-bold">Description:</div>
                        <div class="whitespace-pre-wrap">{{ alert.description }}</div>
                      </div>
                    {% endif %}
                    
                    {% if alert.affected_code is defined and alert.affected_code and alert.affected_code.snippet %}
                      <div class="text-xs bg-gray-50 p-2 border border-gray-300 rounded-sm space-y-1">
                        <div class="font-bold">Affected Code:</div>
                        {% if alert.affected_code.file_path %}
                          <div class="text-xs text-gray-600 mb-1">
                            <span class="font-semibold">File:</span> {{ alert.affected_code.file_path }}
                          </div>
                        {% endif %}
                        {% if alert.affected_code.line_number %}
                          <div class="text-xs text-gray-600 mb-1">
                            <span class="font-semibold">Line:</span> {{ alert.affected_code.line_number }}
                          </div>
                        {% endif %}
                        <div class="font-mono text-xs bg-gray-900 text-white p-2 overflow-x-auto rounded-sm code-block whitespace-pre">
                          {% if alert.affected_code.start_line > 0 %}
                            {% set lines = alert.affected_code.snippet.split('\n') %}
                            {% for i in range(alert.affected_code.start_line, alert.affected_code.start_line + lines|length) %}
                              <div class="code-line {% if i in alert.affected_code.vulnerable_lines %}bg-red-900 vulnerable-line{% endif %}">
                                <span class="line-number text-gray-500 inline-block w-10 text-right pr-2 select-none border-r border-gray-600 mr-2">{{ i }}</span>
                                <span class="line-content">{{ lines[loop.index0] }}</span>
                                {% if i in alert.affected_code.vulnerable_lines %}
                                  <span class="text-red-400 ml-2 inline-block">← VULNERABILITY</span>
                                {% endif %}
                              </div>
                            {% endfor %}
                          {% else %}
                            <code>{{ alert.affected_code.snippet }}</code>
                          {% endif %}
                        </div>
                      </div>
                    {% endif %}
                    
                    {% if alert.solution %}
                      <div class="text-xs bg-gray-50 p-2 border border-gray-300 rounded-sm">
                        <div class="font-bold">Solution:</div>
                        <div class="whitespace-pre-wrap">{{ alert.solution }}</div>
                      </div>
                    {% endif %}
                    
                    {% if alert.evidence %}
                      <div class="text-xs font-mono bg-gray-800 text-white p-2 overflow-x-auto rounded-sm">
                        <div class="font-bold text-gray-400 mb-1">Evidence:</div>
                        <code>{{ alert.evidence }}</code>
                      </div>
                    {% endif %}
                    
                    {% if alert.attack %}
                      <div class="text-xs bg-gray-50 p-2 border border-gray-300 rounded-sm">
                        <div class="font-bold">Attack:</div>
                        <div class="font-mono">{{ alert.attack }}</div>
                      </div>
                    {% endif %}
                    
                    {% if alert.reference %}
                      <div class="text-xs bg-gray-50 p-2 border border-gray-300 rounded-sm">
                        <div class="font-bold">Reference:</div>
                        <div class="whitespace-pre-wrap">{{ alert.reference }}</div>
                      </div>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <!-- No Alerts Message -->
          <div class="border border-gray-400 bg-white p-4 text-center rounded-sm shadow-sm">
            {% if error %}
              <div class="inline-block border border-red-700 bg-red-50 p-2 rounded-sm">
                <p class="text-xs font-bold text-red-700">{{ error }}</p>
              </div>
            {% else %}
              <div class="inline-block border border-gray-700 bg-gray-50 p-2 rounded-sm">
                <p class="text-xs font-bold text-gray-700">No alerts found. Start a scan to begin.</p>
              </div>
            {% endif %}
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Right Sidebar -->
  <aside class="w-64 bg-gray-200 border-l border-gray-400 flex flex-col">
    <div class="p-2 space-y-2 flex-1 overflow-auto">
      <!-- Scan Information Card -->
      <div class="border border-gray-400 bg-white rounded-sm shadow-sm">
        <div class="bg-gray-100 border-b border-gray-400 px-2 py-1">
          <h2 class="font-bold text-xs">Scan Information</h2>
        </div>
        <div class="p-2 text-xs space-y-1">
          <div class="flex justify-between">
            <span class="text-gray-600">Model:</span>
            <span class="font-bold">{{ model }}</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600">App:</span>
            <span class="font-bold">{{ app_num }}</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600">Target:</span>
            <span class="font-bold" id="targetUrl"></span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600">Last Scan:</span>
            <span class="font-bold" id="lastScanTime">Never</span>
          </div>
        </div>
      </div>

      <!-- Scan Configuration Card -->
      <div class="border border-gray-400 bg-white rounded-sm shadow-sm">
        <div class="bg-gray-100 border-b border-gray-400 px-2 py-1">
          <h2 class="font-bold text-xs">Scan Configuration</h2>
        </div>
        <div class="p-2 text-xs space-y-1">
          <div class="flex justify-between">
            <span class="text-gray-600">Scan Mode:</span>
            <span class="font-bold">Comprehensive</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600">Spider:</span>
            <span class="font-bold">Enabled</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600">Passive Scan:</span>
            <span class="font-bold">Enabled</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600">Active Scan:</span>
            <span class="font-bold">Enabled</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600">Scan Depth:</span>
            <span class="font-bold">Comprehensive</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600">Policy:</span>
            <span class="font-bold">Default Policy</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600">Code Analysis:</span>
            <span class="font-bold text-purple-700">Enabled</span>
          </div>
          <div class="mt-2 p-2 bg-gray-50 border border-gray-300 rounded-sm">
            <p class="text-xs text-gray-700">This scanner runs a comprehensive security assessment including spider crawling, passive analysis, active vulnerability testing, and source code analysis.</p>
          </div>
        </div>
      </div>
      
      <!-- Scan Statistics Card -->
      <div class="border border-gray-400 bg-white rounded-sm shadow-sm">
        <div class="bg-gray-100 border-b border-gray-400 px-2 py-1">
          <h2 class="font-bold text-xs">Scan Statistics</h2>
        </div>
        <div class="p-2 text-xs space-y-1">
          <div class="flex justify-between">
            <span class="text-gray-600">Start Time:</span>
            <span class="font-bold" id="scanStartTime">-</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600">Duration:</span>
            <span class="font-bold" id="scanDuration">-</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600">Total Alerts:</span>
            <span class="font-bold" id="totalAlerts">0</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600">With Code:</span>
            <span class="font-bold text-purple-700" id="alertsWithCode">0</span>
          </div>
        </div>
      </div>
      
      <!-- Code Report Card -->
      <div class="border border-gray-400 bg-white rounded-sm shadow-sm">
        <div class="bg-gray-100 border-b border-gray-400 px-2 py-1">
          <h2 class="font-bold text-xs">Code Analysis Report</h2>
        </div>
        <div class="p-2 text-xs space-y-2">
          <p class="text-gray-700">A detailed source code analysis report is available for this scan, highlighting affected code for identified vulnerabilities.</p>
          <a href="{{ url_for('zap.download_code_report', model=model, app_num=app_num) }}" 
             class="block w-full py-1 px-2 bg-purple-100 text-purple-800 border border-purple-400 rounded-sm text-center hover:bg-purple-200 transition-colors">
            Download Code Report
          </a>
        </div>
      </div>
    </div>
  </aside>
</div>

<script>
// Initialize when DOM is ready
$(document).ready(function() {
  // Initialize core App functionality
  if (typeof App !== 'undefined' && App.Features.zapScan) {
    App.Features.zapScan.init();
  } else {
    // Fallback implementation if App object isn't available
    setupZapScan();
  }

  function setupZapScan() {
    let pollingActive = false;
    let filterTimeout = null;
    let scanStartTimestamp = null;
    let durationInterval = null;
    
    // DOM Elements
    const elements = {
      startScanBtn: $('#startScan'),
      stopScanBtn: $('#stopScan'),
      searchInput: $('#searchIssues'),
      riskFilter: $('#riskFilter'),
      confidenceFilter: $('#confidenceFilter'),
      codeFilter: $('#codeFilter'),
      progressBar: $('#progressBar'),
      scanProgress: $('#scanProgress'),
      targetUrlElem: $('#targetUrl'),
      lastScanTimeElem: $('#lastScanTime'),
      scanStatusElem: $('#scanStatus'),
      progressLogElem: $('#progressLog'),
      clearLogBtn: $('#clearLog'),
      countElements: {
        high: $('#highCount'),
        medium: $('#mediumCount'),
        low: $('#lowCount'),
        info: $('#infoCount')
      },
      progressElements: {
        percentage: $('#progressPercentage'),
        spider: $('#spiderProgress'),
        spiderBar: $('#spiderProgressBar'),
        passive: $('#passiveProgress'),
        passiveBar: $('#passiveProgressBar'),
        active: $('#activeProgress'),
        activeBar: $('#activeProgressBar')
      },
      statsElements: {
        startTime: $('#scanStartTime'),
        duration: $('#scanDuration'),
        totalAlerts: $('#totalAlerts'),
        withCode: $('#alertsWithCode')
      }
    };
    
    // Calculate frontend port based on model and app number
    function calculatePort(model, appNum) {
      // Constants matching those in app.py PortManager
      const BASE_FRONTEND_PORT = 5501;
      const PORTS_PER_APP = 2;
      const BUFFER_PORTS = 20;
      const APPS_PER_MODEL = 30;
      const TOTAL_PORTS_PER_MODEL = APPS_PER_MODEL * PORTS_PER_APP + BUFFER_PORTS;
      
      // AI_MODELS array from app.py for model indexing
      const AI_MODELS = [
        "Llama", "Mistral", "DeepSeek", "GPT4o", "Claude", 
        "Gemini", "Grok", "R1", "O3"
      ];
      
      // Get model index (0-based)
      let modelIdx = AI_MODELS.indexOf(model);
      if (modelIdx === -1) {
        console.warn(`Model "${model}" not found in AI_MODELS list. Using default index 0.`);
        modelIdx = 0;
      }
      
      // Calculate frontend port using the same logic as PortManager.get_app_ports
      const frontendPortRangeStart = BASE_FRONTEND_PORT + (modelIdx * TOTAL_PORTS_PER_MODEL);
      const port = frontendPortRangeStart + ((appNum - 1) * PORTS_PER_APP);
      
      return port;
    }
    
    // Update target URL display based on model and app number
    function updateTargetUrl() {
      // Get model and app number from URL
      const urlParts = window.location.pathname.split('/');
      const model = urlParts[urlParts.length - 2] || '';
      const appNum = parseInt(urlParts[urlParts.length - 1]) || 1;
      
      // Calculate the port using the port logic
      const port = calculatePort(model, appNum);
      
      if (elements.targetUrlElem.length) {
        elements.targetUrlElem.text(`http://localhost:${port}`);
      }
    }
    
    // Filter alerts based on search term, risk, confidence, and code availability
    function applyFilters() {
      if (!elements.searchInput.length || !elements.riskFilter.length || 
          !elements.confidenceFilter.length || !elements.codeFilter.length) return;
      
      const searchTerm = elements.searchInput.val().toLowerCase();
      const selectedRisk = elements.riskFilter.val();
      const selectedConfidence = elements.confidenceFilter.val();
      const codeFilter = elements.codeFilter.val();
      
      let visibleCount = 0;
      let withCodeCount = 0;
      
      $('.alert-item').each(function() {
        const $alert = $(this);
        const risk = $alert.data('risk');
        const confidence = $alert.data('confidence');
        const hasCode = $alert.data('has-code');
        const searchText = $alert.data('searchable').toLowerCase();
        
        const riskMatch = selectedRisk === 'all' || risk === selectedRisk;
        const confidenceMatch = selectedConfidence === 'all' || confidence === selectedConfidence;
        const searchMatch = !searchTerm || searchText.includes(searchTerm);
        const codeMatch = codeFilter === 'all' || 
                         (codeFilter === 'hasCode' && hasCode) || 
                         (codeFilter === 'noCode' && !hasCode);
        
        const isVisible = riskMatch && confidenceMatch && searchMatch && codeMatch;
        $alert.toggle(isVisible);
        
        if (isVisible) {
          visibleCount++;
          if (hasCode) withCodeCount++;
        }
      });
      
      // Update the alerts with code counter
      if (elements.statsElements.withCode.length) {
        elements.statsElements.withCode.text(withCodeCount);
      }
    }
    
    // Add a log message to the progress log
    function appendToLog(message) {
      if (!elements.progressLogElem.length) return;
      
      const timestamp = new Date().toLocaleTimeString();
      elements.progressLogElem.append(`[${timestamp}] ${message}\n`);
      elements.progressLogElem.scrollTop(elements.progressLogElem[0].scrollHeight);
    }
    
    // Format duration from seconds
    function formatDuration(totalSeconds) {
      if (!totalSeconds) return "-";
      
      const hours = Math.floor(totalSeconds / 3600);
      const minutes = Math.floor((totalSeconds % 3600) / 60);
      const seconds = totalSeconds % 60;
      
      if (hours > 0) {
        return `${hours}h ${minutes}m ${seconds}s`;
      } else if (minutes > 0) {
        return `${minutes}m ${seconds}s`;
      } else {
        return `${seconds}s`;
      }
    }
    
    // Update duration display
    function updateDuration() {
      if (!scanStartTimestamp) return;
      
      const now = new Date();
      const durationSeconds = Math.floor((now - scanStartTimestamp) / 1000);
      
      if (elements.statsElements.duration.length) {
        elements.statsElements.duration.text(formatDuration(durationSeconds));
      }
    }
    
    // Start a new ZAP scan
    function startScan() {
      if (!elements.startScanBtn.length || !elements.stopScanBtn.length || !elements.scanProgress.length) return;
      
      // Get model and app from URL
      const urlParts = window.location.pathname.split('/');
      const model = urlParts[urlParts.length - 2] || '';
      const appNum = urlParts[urlParts.length - 1] || '';
      
      // Update UI to scanning state
      elements.startScanBtn.prop('disabled', true);
      elements.stopScanBtn.removeClass('hidden');
      elements.scanProgress.removeClass('hidden');
      
      if (elements.scanStatusElem.length) {
        elements.scanStatusElem.text('Starting...');
      }
      
      // Reset progress elements
      if (elements.progressElements) {
        elements.progressElements.percentage.text('0%');
        elements.progressElements.spider.text('0%');
        elements.progressElements.passive.text('0%');
        elements.progressElements.active.text('0%');
        elements.progressBar.css('width', '0%');
        elements.progressElements.spiderBar.css('width', '0%');
        elements.progressElements.passiveBar.css('width', '0%');
        elements.progressElements.activeBar.css('width', '0%');
      }
      
      // Reset counters
      if (elements.countElements) {
        elements.countElements.high.text('0');
        elements.countElements.medium.text('0');
        elements.countElements.low.text('0');
        elements.countElements.info.text('0');
      }
      
      if (elements.statsElements) {
        const startTimeStr = new Date().toLocaleString();
        elements.statsElements.startTime.text(startTimeStr);
        elements.statsElements.duration.text('0s');
        elements.statsElements.totalAlerts.text('0');
        elements.statsElements.withCode.text('0');
      }
      
      // Set scan start time and start duration timer
      scanStartTimestamp = new Date();
      if (durationInterval) clearInterval(durationInterval);
      durationInterval = setInterval(updateDuration, 1000);
      
      appendToLog(`Starting comprehensive scan of target: http://localhost:${calculatePort(model, appNum)}`);
      
      // Send scan request to server - no options needed with railroaded approach
      $.ajax({
        url: `/zap/scan/${model}/${appNum}`,
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({})
      })
      .done(function() {
        // Start progress polling
        appendToLog('Scan initiated successfully. Starting spider phase...');
        pollProgress(model, appNum);
      })
      .fail(function(jqXHR) {
        const errorMsg = jqXHR.responseJSON?.error || `HTTP ${jqXHR.status}: ${jqXHR.statusText}`;
        console.error('Scan error:', errorMsg);
        appendToLog(`Error: ${errorMsg}`);
        alert('Failed to start scan: ' + errorMsg);
        
        // Reset UI
        elements.startScanBtn.prop('disabled', false);
        elements.stopScanBtn.addClass('hidden');
        if (elements.scanStatusElem.length) {
          elements.scanStatusElem.text('Error');
        }
        
        // Stop duration timer
        if (durationInterval) {
          clearInterval(durationInterval);
          durationInterval = null;
        }
      });
    }
    
    // Stop the currently running scan
    function stopScan() {
      if (!elements.startScanBtn.length || !elements.stopScanBtn.length) return;
      
      // Get model and app from URL
      const urlParts = window.location.pathname.split('/');
      const model = urlParts[urlParts.length - 2] || '';
      const appNum = urlParts[urlParts.length - 1] || '';
      
      appendToLog('Stopping scan...');
      
      $.ajax({
        url: `/zap/scan/${model}/${appNum}/stop`,
        method: 'POST'
      })
      .done(function() {
        // Reset UI
        pollingActive = false;
        elements.stopScanBtn.addClass('hidden');
        elements.startScanBtn.prop('disabled', false);
        
        if (elements.scanStatusElem.length) {
          elements.scanStatusElem.text('Stopped');
        }
        
        // Stop duration timer
        if (durationInterval) {
          clearInterval(durationInterval);
          durationInterval = null;
        }
        
        appendToLog('Scan stopped successfully');
      })
      .fail(function(jqXHR) {
        const errorMsg = jqXHR.responseJSON?.error || `HTTP ${jqXHR.status}: ${jqXHR.statusText}`;
        console.error('Stop error:', errorMsg);
        appendToLog(`Error stopping scan: ${errorMsg}`);
        alert('Failed to stop scan: ' + errorMsg);
      });
    }
    
    // Poll scan progress and update UI
    function pollProgress(model, appNum) {
      if (pollingActive) return;
      pollingActive = true;
      
      function updateUI() {
        $.ajax({
          url: `/zap/scan/${model}/${appNum}/status`,
          method: 'GET'
        })
        .done(function(data) {
          // Update progress bar and text
          const progress = Math.min(Math.max(data.progress || 0, 0), 100);
          
          if (elements.progressBar.length) {
            elements.progressBar.css('width', `${progress}%`);
          }
          
          if (elements.progressElements.percentage.length) {
            elements.progressElements.percentage.text(`${progress}%`);
          }
          
          // Update detailed progress bars if available
          if (elements.progressElements) {
            const spiderProgress = Math.min(Math.max(data.spider_progress || 0, 0), 100);
            const passiveProgress = Math.min(Math.max(data.passive_progress || 0, 0), 100);
            const activeProgress = Math.min(Math.max(data.active_progress || 0, 0), 100);
            
            elements.progressElements.spider.text(`${spiderProgress}%`);
            elements.progressElements.passive.text(`${passiveProgress}%`);
            elements.progressElements.active.text(`${activeProgress}%`);
            
            elements.progressElements.spiderBar.css('width', `${spiderProgress}%`);
            elements.progressElements.passiveBar.css('width', `${passiveProgress}%`);
            elements.progressElements.activeBar.css('width', `${activeProgress}%`);
          }
          
          // Update status text
          if (elements.scanStatusElem.length) {
            elements.scanStatusElem.text(data.status || 'Unknown');
          }
          
          // Update count elements
          if (elements.countElements) {
            elements.countElements.high.text(data.high_count || 0);
            elements.countElements.medium.text(data.medium_count || 0);
            elements.countElements.low.text(data.low_count || 0);
            elements.countElements.info.text(data.info_count || 0);
            
            // Update total alerts
            if (elements.statsElements.totalAlerts.length) {
              const total = 
                (parseInt(data.high_count) || 0) + 
                (parseInt(data.medium_count) || 0) + 
                (parseInt(data.low_count) || 0) + 
                (parseInt(data.info_count) || 0);
              elements.statsElements.totalAlerts.text(total);
            }
            
            // Update vulnerabilities with code count if available
            if (elements.statsElements.withCode.length && data.vulnerabilities_with_code !== undefined) {
              elements.statsElements.withCode.text(data.vulnerabilities_with_code || 0);
            }
          }
          
          // Log phase changes
          const prevStatus = elements.scanStatusElem.data('prev-status');
          if (data.status !== prevStatus) {
            appendToLog(`Status changed to: ${data.status}`);
            elements.scanStatusElem.data('prev-status', data.status);
            
            // Log specific phase messages
            if (data.status === 'Running - Spider') {
              appendToLog('Spider phase started - discovering web content...');
            } else if (data.status === 'Running - AJAX Spider') {
              appendToLog('AJAX Spider started - discovering JavaScript-rendered content...');
            } else if (data.status === 'Running - Passive Scan') {
              appendToLog('Passive scanning in progress - analyzing responses...');
            } else if (data.status === 'Running - Active Scan') {
              appendToLog('Active scanning in progress - testing for vulnerabilities...');
            } else if (data.status === 'Running - Code Analysis') {
              appendToLog('Code analysis in progress - identifying affected source code...');
            }
          }
          
          // Check if scan is complete
          if (data.status === 'Complete') {
            pollingActive = false;
            
            if (elements.stopScanBtn.length) elements.stopScanBtn.addClass('hidden');
            if (elements.startScanBtn.length) elements.startScanBtn.prop('disabled', false);
            if (elements.lastScanTimeElem.length) elements.lastScanTimeElem.text(new Date().toLocaleString());
            
            // Stop duration timer
            if (durationInterval) {
              clearInterval(durationInterval);
              durationInterval = null;
            }
            
            appendToLog('Scan completed successfully. Reloading page to show results...');
            setTimeout(() => window.location.reload(), 2000);
            return;
          }
          
          // Continue polling if still active
          if (pollingActive) {
            setTimeout(updateUI, 2000);
          }
        })
        .fail(function(jqXHR) {
          console.error('Polling error:', jqXHR.statusText);
          appendToLog(`Error updating status: ${jqXHR.responseJSON?.error || jqXHR.statusText}`);
          
          // Retry on failure a few times
          if (pollingActive) {
            setTimeout(updateUI, 5000); // Longer delay on error
          }
        });
      }
      
      // Start the polling loop
      updateUI();
    }
    
    // Set up event listeners
    if (elements.startScanBtn.length) {
      elements.startScanBtn.on('click', startScan);
    }
    
    if (elements.stopScanBtn.length) {
      elements.stopScanBtn.on('click', stopScan);
    }
    
    if (elements.clearLogBtn.length) {
      elements.clearLogBtn.on('click', function() {
        if (elements.progressLogElem.length) {
          elements.progressLogElem.text('');
        }
      });
    }
    
    // Set up search input with debounce
    if (elements.searchInput.length) {
      elements.searchInput.on('input', function() {
        clearTimeout(filterTimeout);
        filterTimeout = setTimeout(applyFilters, 300);
      });
    }
    
    // Set up filters
    if (elements.riskFilter.length) {
      elements.riskFilter.on('change', applyFilters);
    }
    
    if (elements.confidenceFilter.length) {
      elements.confidenceFilter.on('change', applyFilters);
    }
    
    if (elements.codeFilter.length) {
      elements.codeFilter.on('change', applyFilters);
    }
    
    // Set up expand/collapse buttons for alert details
    $('.expand-btn').on('click', function() {
      const $details = $(this).closest('div').next().find('.alert-details');
      if ($details.length) {
        $details.toggleClass('hidden');
        $(this).text($details.hasClass('hidden') ? 'Expand' : 'Collapse');
      }
    });
    
    // Initialize target URL
    updateTargetUrl();
    
    // Count alerts with code and update counter
    function updateCodeCounter() {
      let withCodeCount = 0;
      $('.alert-item').each(function() {
        if ($(this).data('has-code')) {
          withCodeCount++;
        }
      });
      
      if (elements.statsElements.withCode.length) {
        elements.statsElements.withCode.text(withCodeCount);
      }
    }
    
    // Initialize code counter
    updateCodeCounter();
    
    // Apply syntax highlighting to code blocks if highlight.js is available
    if (typeof hljs !== 'undefined') {
      $('.code-block code').each(function(i, block) {
        hljs.highlightElement(block);
      });
    }
    
    // Log ready message
    appendToLog('ZAP Scanner interface ready with code analysis capabilities. Click "Start Scan" to begin comprehensive security assessment.');
  }
});
</script>

<style>
/* Additional styles for code display */
.code-block {
  font-family: 'Consolas', 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
  tab-size: 4;
}

.vulnerable-line {
  position: relative;
}

.line-number {
  user-select: none;
  -webkit-user-select: none;
  -moz-user-select: none;
}

/* Add a subtle hover effect to code lines */
.code-line:hover {
  background-color: rgba(255, 255, 255, 0.05);
}

/* Make vulnerable lines more visible */
.vulnerable-line .line-content {
  font-weight: bold;
  color: #ff7b72;
}
</style>
{% endblock %}