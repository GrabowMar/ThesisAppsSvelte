{% extends "base.html" %}

{% block content %}
<div class="flex min-h-screen bg-gray-100">
  <!-- Main Content Area -->
  <div class="flex-1 flex flex-col overflow-hidden">
    <!-- Top Navigation and Filter Bar - ZapScan.setupEventListeners target elements -->
    <div class="bg-gray-200 border-b border-gray-400 p-1">
      <div class="flex justify-between items-center">
        <div class="flex items-center space-x-2">
          <a href="{{ url_for('main.index') }}" class="action-btn h-6 px-2 text-xs rounded-sm">Back</a>
          <button id="startScan" class="action-btn h-6 px-2 text-xs rounded-sm">Start Scan</button>
          <button id="stopScan" class="action-btn h-6 px-2 text-xs hidden rounded-sm">Stop Scan</button>
        </div>
        <div class="flex items-center space-x-2">
          <input type="text" id="searchIssues" placeholder="Search issues..." aria-label="Search issues" class="h-6 px-2 text-xs border border-gray-300 rounded-sm">
          <select id="riskFilter" aria-label="Filter by risk level" class="h-6 px-2 text-xs border border-gray-300 rounded-sm">
            <option value="all">All Risks</option>
            <option value="High">High</option><option value="Medium">Medium</option><option value="Low">Low</option><option value="Informational">Info</option>
          </select>
          <select id="confidenceFilter" aria-label="Filter by confidence level" class="h-6 px-2 text-xs border border-gray-300 rounded-sm">
            <option value="all">All Confidence</option>
            <option value="High">High</option><option value="Medium">Medium</option><option value="Low">Low</option>
          </select>
          <select id="codeFilter" aria-label="Filter by code availability" class="h-6 px-2 text-xs border border-gray-300 rounded-sm">
            <option value="all">All Alerts</option>
            <option value="hasCode">With Code</option><option value="noCode">Without Code</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Status Cards Section - matches ZapScan state properties -->
    <div class="p-2 grid grid-cols-5 gap-2">
      <div class="border border-gray-400 bg-white p-2 rounded-sm shadow-sm">
        <div class="text-xs text-gray-600">Scan Status</div>
        <div class="text-xs font-bold" id="scanStatus">Not Started</div>
      </div>
      <div class="border border-gray-400 bg-white p-2 rounded-sm shadow-sm">
        <div class="text-xs text-red-800">High Risk</div>
        <div class="text-xs font-bold text-red-700" id="highCount">0</div>
      </div>
      <div class="border border-gray-400 bg-white p-2 rounded-sm shadow-sm">
        <div class="text-xs text-yellow-800">Medium Risk</div>
        <div class="text-xs font-bold text-yellow-700" id="mediumCount">0</div>
      </div>
      <div class="border border-gray-400 bg-white p-2 rounded-sm shadow-sm">
        <div class="text-xs text-blue-800">Low Risk</div>
        <div class="text-xs font-bold text-blue-700" id="lowCount">0</div>
      </div>
      <div class="border border-gray-400 bg-white p-2 rounded-sm shadow-sm">
        <div class="text-xs text-gray-600">Info</div>
        <div class="text-xs font-bold" id="infoCount">0</div>
      </div>
    </div>

    <!-- Statistics Dashboard Section -->
    <div class="p-2 border border-gray-400 bg-white rounded-sm shadow-sm mb-2" id="statisticsDashboard">
      <div class="flex justify-between items-center mb-2">
        <h2 class="font-bold text-sm">Scan Statistics Dashboard</h2>
        <button id="toggleStats" class="text-xs text-gray-600 hover:text-gray-900 rounded-sm">
          <span id="toggleStatsText">Collapse</span>
          <svg id="toggleStatsIcon" xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 inline-block ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
          </svg>
        </button>
      </div>
      
      <div id="statsContent" class="space-y-3">
        <!-- Vulnerability Overview -->
        <div class="grid grid-cols-3 gap-2">
          <!-- Vulnerability Distribution -->
          <div class="border border-gray-300 bg-gray-50 p-2 rounded-sm">
            <h3 class="text-xs font-bold mb-1">Vulnerability Distribution</h3>
            <div class="h-20 w-full"><canvas id="vulnerabilityChart" height="80"></canvas></div>
          </div>
          
          <!-- Vulnerability Categories -->
          <div class="border border-gray-300 bg-gray-50 p-2 rounded-sm">
            <h3 class="text-xs font-bold mb-1">Vulnerability Categories</h3>
            <div class="text-xs space-y-1 max-h-20 overflow-y-auto" id="vulnCategories">
              {% set categories = {"Injection": 0, "XSS": 0, "Information Disclosure": 0, "Security Headers": 0, "Authentication": 0, "Authorization": 0, "Other": 0} %}
              {% for alert in alerts %}
                {% if "SQL Injection" in alert.name or "Command Injection" in alert.name or "LDAP Injection" in alert.name %}
                  {% set _ = categories.update({"Injection": categories["Injection"] + 1}) %}
                {% elif "Cross Site Scripting" in alert.name or "XSS" in alert.name %}
                  {% set _ = categories.update({"XSS": categories["XSS"] + 1}) %}
                {% elif "Information" in alert.name or "Disclosure" in alert.name %}
                  {% set _ = categories.update({"Information Disclosure": categories["Information Disclosure"] + 1}) %}
                {% elif "Header" in alert.name or "CSP" in alert.name %}
                  {% set _ = categories.update({"Security Headers": categories["Security Headers"] + 1}) %}
                {% elif "Authentication" in alert.name or "Session" in alert.name %}
                  {% set _ = categories.update({"Authentication": categories["Authentication"] + 1}) %}
                {% elif "Authorization" in alert.name or "Access" in alert.name or "Permission" in alert.name %}
                  {% set _ = categories.update({"Authorization": categories["Authorization"] + 1}) %}
                {% else %}
                  {% set _ = categories.update({"Other": categories["Other"] + 1}) %}
                {% endif %}
              {% endfor %}
              
              {% for category, count in categories.items() %}
                {% if count > 0 %}
                  <div class="flex justify-between"><span>{{ category }}:</span><span class="font-medium">{{ count }}</span></div>
                {% endif %}
              {% endfor %}
              
              {% if alerts|length == 0 %}
                <div class="text-gray-500">No vulnerabilities detected yet</div>
              {% endif %}
            </div>
          </div>
          
          <!-- Code Analysis Metrics -->
          <div class="border border-gray-300 bg-gray-50 p-2 rounded-sm">
            <h3 class="text-xs font-bold mb-1">Code Analysis Metrics</h3>
            <div class="text-xs space-y-1">
              {% set code_count = namespace(value=0) %}
              {% for alert in alerts %}
                {% if alert.affected_code is defined and alert.affected_code and alert.affected_code.snippet %}
                  {% set code_count.value = code_count.value + 1 %}
                {% endif %}
              {% endfor %}
              
              <div class="flex justify-between">
                <span>Vulnerabilities with code:</span><span class="font-medium">{{ code_count.value }}</span>
              </div>
              <div class="flex justify-between">
                <span>Code coverage:</span>
                <span class="font-medium">{% if alerts|length > 0 %}{{ (code_count.value / alerts|length * 100)|round|int }}%{% else %}0%{% endif %}</span>
              </div>
              <div class="flex justify-between">
                <span>Source files analyzed:</span><span class="font-medium" id="sourceFilesAnalyzed">{{ code_count.value }}</span>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Scan Details -->
        <div class="grid grid-cols-2 gap-2">
          <!-- Scan Configuration -->
          <div class="border border-gray-300 bg-gray-50 p-2 rounded-sm">
            <h3 class="text-xs font-bold mb-1">Scan Configuration</h3>
            <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-xs">
              <div class="flex justify-between"><span>Active Scan Rules:</span><span class="font-medium">100+</span></div>
              <div class="flex justify-between"><span>Passive Scan Rules:</span><span class="font-medium">50+</span></div>
              <div class="flex justify-between"><span>Attack Strength:</span><span class="font-medium">High</span></div>
              <div class="flex justify-between"><span>Alert Threshold:</span><span class="font-medium">Low</span></div>
              <div class="flex justify-between"><span>Spider Depth:</span><span class="font-medium">Unlimited</span></div>
              <div class="flex justify-between"><span>AJAX Spider:</span><span class="font-medium">Enabled</span></div>
            </div>
          </div>
          
          <!-- Scan Performance -->
          <div class="border border-gray-300 bg-gray-50 p-2 rounded-sm">
            <h3 class="text-xs font-bold mb-1">Scan Performance</h3>
            <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-xs">
              <div class="flex justify-between"><span>Total Duration:</span><span class="font-medium" id="totalDuration">{% if alerts|length > 0 %}{% else %}Not completed{% endif %}</span></div>
              <div class="flex justify-between"><span>Spider Time:</span><span class="font-medium" id="spiderTime">-</span></div>
              <div class="flex justify-between"><span>Passive Scan Time:</span><span class="font-medium" id="passiveScanTime">-</span></div>
              <div class="flex justify-between"><span>Active Scan Time:</span><span class="font-medium" id="activeScanTime">-</span></div>
              <div class="flex justify-between"><span>URLs Discovered:</span><span class="font-medium" id="urlsDiscovered">-</span></div>
              <div class="flex justify-between"><span>Requests Sent:</span><span class="font-medium" id="requestsSent">-</span></div>
            </div>
          </div>
        </div>
        
        <!-- CWE Coverage -->
        <div class="border border-gray-300 bg-gray-50 p-2 rounded-sm">
          <h3 class="text-xs font-bold mb-1">Common Weakness Enumeration (CWE) Coverage</h3>
          <div class="grid grid-cols-5 gap-2 text-xs">
            {% set cwe_coverage = {"CWE-79": ["XSS", 0], "CWE-89": ["SQL Injection", 0], "CWE-352": ["CSRF", 0], 
                                  "CWE-434": ["File Upload", 0], "CWE-306": ["Auth Issues", 0], "CWE-601": ["Open Redirect", 0], 
                                  "CWE-798": ["Hard-coded Creds", 0], "CWE-287": ["Auth Problems", 0], 
                                  "CWE-22": ["Path Traversal", 0], "CWE-611": ["XXE", 0]} %}
            
            {% for alert in alerts %}
              {% if alert.cwe_id %}
                {% set cwe_id = "CWE-" + alert.cwe_id %}
                {% if cwe_id in cwe_coverage %}
                  {% set entry = cwe_coverage[cwe_id] %}
                  {% set _ = cwe_coverage.update({cwe_id: [entry[0], entry[1] + 1]}) %}
                {% endif %}
              {% endif %}
            {% endfor %}
            
            {% for cwe_id, details in cwe_coverage.items() %}
              <div class="flex flex-col items-center border rounded-sm p-1 {% if details[1] > 0 %}bg-purple-50 border-purple-300{% else %}bg-gray-100 border-gray-300{% endif %}">
                <div class="font-bold">{{ cwe_id }}</div>
                <div class="text-center">{{ details[0] }}</div>
                <div class="{% if details[1] > 0 %}text-purple-700 font-bold{% else %}text-gray-500{% endif %}">{{ details[1] }}</div>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content Section -->
    <div class="p-2 flex-1 overflow-auto space-y-2">
      <!-- Progress Bar Section - ZapScan.pollProgress targets -->
      <div id="scanProgress" class="hidden border border-gray-400 bg-white p-2 rounded-sm shadow-sm">
        <div class="text-xs font-bold mb-1">Scan Progress</div>
        <div class="space-y-1">
          <div class="flex justify-between text-xs">
            <span>Overall Progress:</span><span id="progressPercentage">0%</span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-2">
            <div id="progressBar" class="bg-blue-600 rounded-full h-2 transition-all duration-500" style="width: 0%"></div>
          </div>
          
          <!-- Detailed Phase Progress -->
          <div class="mt-2 grid grid-cols-3 gap-1 text-xs">
            <div>
              <div class="flex justify-between"><span>Spider:</span><span id="spiderProgress">0%</span></div>
              <div class="w-full bg-gray-200 rounded-full h-1">
                <div id="spiderProgressBar" class="bg-green-600 rounded-full h-1" style="width: 0%"></div>
              </div>
            </div>
            <div>
              <div class="flex justify-between"><span>Passive Scan:</span><span id="passiveProgress">0%</span></div>
              <div class="w-full bg-gray-200 rounded-full h-1">
                <div id="passiveProgressBar" class="bg-yellow-600 rounded-full h-1" style="width: 0%"></div>
              </div>
            </div>
            <div>
              <div class="flex justify-between"><span>Active Scan:</span><span id="activeProgress">0%</span></div>
              <div class="w-full bg-gray-200 rounded-full h-1">
                <div id="activeProgressBar" class="bg-red-600 rounded-full h-1" style="width: 0%"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Log Output Section - ZapScan.appendToLog target -->
      <div class="border border-gray-400 bg-white rounded-sm shadow-sm">
        <div class="bg-gray-100 border-b border-gray-400 px-2 py-1 flex justify-between items-center">
          <h2 class="font-bold text-xs">Scan Log</h2>
          <button id="clearLog" class="text-xs text-gray-600 hover:text-gray-900 rounded-sm">Clear</button>
        </div>
        <div class="p-2">
          <pre id="progressLog" class="text-xs font-mono bg-gray-50 p-2 border border-gray-300 h-64 overflow-auto rounded-sm"></pre>
        </div>
      </div>

      <!-- Alerts List Section -->
      <div id="alertsList" class="space-y-2">
        {% if alerts %}
          {% for alert in alerts %}
            <div class="border border-gray-400 bg-white alert-item rounded-sm shadow-sm" 
                 data-risk="{{ alert.risk }}" data-confidence="{{ alert.confidence }}"
                 data-has-code="{{ alert.affected_code is defined and alert.affected_code and alert.affected_code.snippet }}"
                 data-searchable="{{ alert.name }} {{ alert.description }} {{ alert.url }}"
                 data-cwe="{{ alert.cwe_id }}">
              <div class="p-2">
                <!-- Alert Header -->
                <div class="flex items-center space-x-2 mb-1">
                  <!-- Risk Badge -->
                  <span class="text-xs px-2 py-0.5 border rounded-sm
                    {% if alert.risk == 'High' %}bg-red-100 text-red-800 border-red-700
                    {% elif alert.risk == 'Medium' %}bg-yellow-100 text-yellow-800 border-yellow-700
                    {% elif alert.risk == 'Low' %}bg-blue-100 text-blue-800 border-blue-700
                    {% else %}bg-gray-100 text-gray-800 border-gray-700{% endif %}">{{ alert.risk }}</span>
                  
                  <!-- Confidence Badge -->
                  <span class="text-xs px-2 py-0.5 bg-gray-100 border border-gray-400 rounded-sm">{{ alert.confidence }}</span>
                  
                  <!-- CWE Badge -->
                  {% if alert.cwe_id %}<span class="text-xs px-2 py-0.5 bg-gray-100 border border-gray-400 rounded-sm">CWE-{{ alert.cwe_id }}</span>{% endif %}
                  
                  <!-- Code Badge -->
                  {% if alert.affected_code is defined and alert.affected_code and alert.affected_code.snippet %}
                    <span class="text-xs px-2 py-0.5 bg-purple-100 text-purple-800 border border-purple-400 rounded-sm">Code Available</span>
                  {% endif %}
                  
                  <!-- Expand Button -->
                  <button class="ml-auto action-btn h-6 px-2 text-xs expand-btn rounded-sm">Expand</button>
                </div>
                
                <!-- Alert Content -->
                <div class="space-y-2">
                  <div>
                    <div class="text-xs font-bold">{{ alert.name }}</div>
                    <div class="text-xs text-gray-600">{{ alert.url }}</div>
                    {% if alert.parameter %}<div class="text-xs text-gray-600">Parameter: {{ alert.parameter }}</div>{% endif %}
                  </div>
                  
                  <!-- Collapsible Details -->
                  <div class="alert-details hidden space-y-2">
                    {% if alert.description %}
                      <div class="text-xs bg-gray-50 p-2 border border-gray-300 rounded-sm">
                        <div class="font-bold">Description:</div>
                        <div class="whitespace-pre-wrap">{{ alert.description }}</div>
                      </div>
                    {% endif %}
                    
                    {% if alert.affected_code is defined and alert.affected_code and alert.affected_code.snippet %}
                      <div class="text-xs bg-gray-50 p-2 border border-gray-300 rounded-sm space-y-1">
                        <div class="font-bold">Affected Code:</div>
                        {% if alert.affected_code.file_path %}<div class="text-xs text-gray-600 mb-1"><span class="font-semibold">File:</span> {{ alert.affected_code.file_path }}</div>{% endif %}
                        {% if alert.affected_code.line_number %}<div class="text-xs text-gray-600 mb-1"><span class="font-semibold">Line:</span> {{ alert.affected_code.line_number }}</div>{% endif %}
                        <div class="font-mono text-xs bg-gray-900 text-white p-2 overflow-x-auto rounded-sm code-block whitespace-pre">
                          {% if alert.affected_code.start_line > 0 %}
                            {% set lines = alert.affected_code.snippet.split('\n') %}
                            {% for i in range(alert.affected_code.start_line, alert.affected_code.start_line + lines|length) %}
                              <div class="code-line {% if i in alert.affected_code.vulnerable_lines %}bg-red-900 vulnerable-line{% endif %}">
                                <span class="line-number text-gray-500 inline-block w-10 text-right pr-2 select-none border-r border-gray-600 mr-2">{{ i }}</span>
                                <span class="line-content">{{ lines[loop.index0] }}</span>
                                {% if i in alert.affected_code.vulnerable_lines %}<span class="text-red-400 ml-2 inline-block">← VULNERABILITY</span>{% endif %}
                              </div>
                            {% endfor %}
                          {% else %}
                            <code>{{ alert.affected_code.snippet }}</code>
                          {% endif %}
                        </div>
                      </div>
                    {% endif %}
                    
                    {% if alert.solution %}
                      <div class="text-xs bg-gray-50 p-2 border border-gray-300 rounded-sm">
                        <div class="font-bold">Solution:</div>
                        <div class="whitespace-pre-wrap">{{ alert.solution }}</div>
                      </div>
                    {% endif %}
                    
                    {% if alert.evidence %}
                      <div class="text-xs font-mono bg-gray-800 text-white p-2 overflow-x-auto rounded-sm">
                        <div class="font-bold text-gray-400 mb-1">Evidence:</div>
                        <code>{{ alert.evidence }}</code>
                      </div>
                    {% endif %}
                    
                    {% if alert.attack %}
                      <div class="text-xs bg-gray-50 p-2 border border-gray-300 rounded-sm">
                        <div class="font-bold">Attack:</div>
                        <div class="font-mono">{{ alert.attack }}</div>
                      </div>
                    {% endif %}
                    
                    {% if alert.reference %}
                      <div class="text-xs bg-gray-50 p-2 border border-gray-300 rounded-sm">
                        <div class="font-bold">Reference:</div>
                        <div class="whitespace-pre-wrap">{{ alert.reference }}</div>
                      </div>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <!-- No Alerts Message -->
          <div class="border border-gray-400 bg-white p-4 text-center rounded-sm shadow-sm">
            {% if error %}
              <div class="inline-block border border-red-700 bg-red-50 p-2 rounded-sm">
                <p class="text-xs font-bold text-red-700">{{ error }}</p>
              </div>
            {% else %}
              <div class="inline-block border border-gray-700 bg-gray-50 p-2 rounded-sm">
                <p class="text-xs font-bold text-gray-700">No alerts found. Start a scan to begin.</p>
              </div>
            {% endif %}
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Right Sidebar -->
  <aside class="w-64 bg-gray-200 border-l border-gray-400 flex flex-col">
    <div class="p-2 space-y-2 flex-1 overflow-auto">
      <!-- Scan Information Card -->
      <div class="border border-gray-400 bg-white rounded-sm shadow-sm">
        <div class="bg-gray-100 border-b border-gray-400 px-2 py-1">
          <h2 class="font-bold text-xs">Scan Information</h2>
        </div>
        <div class="p-2 text-xs space-y-1">
          <div class="flex justify-between">
            <span class="text-gray-600">Model:</span><span class="font-bold">{{ model }}</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600">App:</span><span class="font-bold">{{ app_num }}</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600">Target:</span><span class="font-bold" id="targetUrl"></span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600">Last Scan:</span><span class="font-bold" id="lastScanTime">Never</span>
          </div>
        </div>
      </div>

      <!-- Scan Configuration Card -->
      <div class="border border-gray-400 bg-white rounded-sm shadow-sm">
        <div class="bg-gray-100 border-b border-gray-400 px-2 py-1">
          <h2 class="font-bold text-xs">Scan Configuration</h2>
        </div>
        <div class="p-2 text-xs space-y-1">
          <div class="flex justify-between"><span class="text-gray-600">Scan Mode:</span><span class="font-bold">Comprehensive</span></div>
          <div class="flex justify-between"><span class="text-gray-600">Spider:</span><span class="font-bold">Enabled</span></div>
          <div class="flex justify-between"><span class="text-gray-600">Passive Scan:</span><span class="font-bold">Enabled</span></div>
          <div class="flex justify-between"><span class="text-gray-600">Active Scan:</span><span class="font-bold">Enabled</span></div>
          <div class="flex justify-between"><span class="text-gray-600">Scan Depth:</span><span class="font-bold">Comprehensive</span></div>
          <div class="flex justify-between"><span class="text-gray-600">Policy:</span><span class="font-bold">Default Policy</span></div>
          <div class="flex justify-between"><span class="text-gray-600">Code Analysis:</span><span class="font-bold text-purple-700">Enabled</span></div>
          <div class="mt-2 p-2 bg-gray-50 border border-gray-300 rounded-sm">
            <p class="text-xs text-gray-700">This scanner runs a comprehensive security assessment including spider crawling, passive analysis, active vulnerability testing, and source code analysis.</p>
          </div>
        </div>
      </div>
      
      <!-- Scan Statistics Card -->
      <div class="border border-gray-400 bg-white rounded-sm shadow-sm">
        <div class="bg-gray-100 border-b border-gray-400 px-2 py-1">
          <h2 class="font-bold text-xs">Scan Statistics</h2>
        </div>
        <div class="p-2 text-xs space-y-1">
          <div class="flex justify-between"><span class="text-gray-600">Start Time:</span><span class="font-bold" id="scanStartTime">-</span></div>
          <div class="flex justify-between"><span class="text-gray-600">Duration:</span><span class="font-bold" id="scanDuration">-</span></div>
          <div class="flex justify-between"><span class="text-gray-600">Total Alerts:</span><span class="font-bold" id="totalAlerts">0</span></div>
          <div class="flex justify-between"><span class="text-gray-600">With Code:</span><span class="font-bold text-purple-700" id="alertsWithCode">0</span></div>
        </div>
      </div>
      
      <!-- Code Report Card -->
      <div class="border border-gray-400 bg-white rounded-sm shadow-sm">
        <div class="bg-gray-100 border-b border-gray-400 px-2 py-1">
          <h2 class="font-bold text-xs">Code Analysis Report</h2>
        </div>
        <div class="p-2 text-xs space-y-2">
          <p class="text-gray-700">A detailed source code analysis report is available for this scan, highlighting affected code for identified vulnerabilities.</p>
          <a href="{{ url_for('zap.download_code_report', model=model, app_num=app_num) }}" 
             class="block w-full py-1 px-2 bg-purple-100 text-purple-800 border border-purple-400 rounded-sm text-center hover:bg-purple-200 transition-colors">
            Download Code Report
          </a>
        </div>
      </div>
    </div>
  </aside>
</div>

<script>
// ZapScan integration - Structure matches ZapScan class in dashboard.js
$(document).ready(function() {
  // Use dashboard.js Feature Manager integration if available
  if (typeof App !== 'undefined' && App.Features && App.Features.zapScan) {
    App.Features.zapScan.init();
  } else {
    // Fallback implementation
    const zapScan = {
      pollingActive: false,
      pollingErrorCount: 0,
      scanStartTimestamp: null,
      durationInterval: null,
      filterTimeout: null,
      
      init: function() {
        this.updateTargetUrl();
        this.setupEventListeners();
        this.initializeData();
        this.appendToLog('ZAP Scanner interface ready. Click "Start Scan" to begin security assessment.');
      },
      
      setupEventListeners: function() {
        // Main control buttons
        $('#startScan').on('click', this.startScan.bind(this));
        $('#stopScan').on('click', this.stopScan.bind(this));
        $('#clearLog').on('click', () => $('#progressLog').text(''));
        
        // Filter elements
        $('#searchIssues').on('input', () => {
          clearTimeout(this.filterTimeout);
          this.filterTimeout = setTimeout(this.applyFilters.bind(this), 300);
        });
        $('#riskFilter, #confidenceFilter, #codeFilter').on('change', this.applyFilters.bind(this));
        
        // Stats toggle
        $('#toggleStats').on('click', () => {
          $('#statsContent').slideToggle(200, function() {
            const isVisible = $(this).is(':visible');
            $('#toggleStatsText').text(isVisible ? 'Collapse' : 'Expand');
            $('#toggleStatsIcon').html(isVisible ? 
              '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />' : 
              '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />');
          });
        });
        
        // Expand buttons for alert details
        $('.expand-btn').on('click', function() {
          const $details = $(this).closest('div').next().find('.alert-details');
          $details.toggleClass('hidden');
          $(this).text($details.hasClass('hidden') ? 'Expand' : 'Collapse');
        });
      },
      
      updateTargetUrl: function() {
        const urlParts = window.location.pathname.split('/');
        const model = urlParts[urlParts.length - 2] || '';
        const appNum = parseInt(urlParts[urlParts.length - 1]) || 1;
        const port = this.calculatePort(model, appNum);
        $('#targetUrl').text(`http://localhost:${port}`);
      },
      
      calculatePort: function(model, appNum) {
        // Constants matching those in PortManager
        const BASE_FRONTEND_PORT = 5501;
        const PORTS_PER_APP = 2;
        const BUFFER_PORTS = 20;
        const APPS_PER_MODEL = 30;
        const TOTAL_PORTS_PER_MODEL = APPS_PER_MODEL * PORTS_PER_APP + BUFFER_PORTS;
        
        // AI_MODELS array for model indexing
        const AI_MODELS = ["Llama", "Mistral", "DeepSeek", "GPT4o", "Claude", "Gemini", "Grok", "R1", "O3"];
        
        let modelIdx = AI_MODELS.indexOf(model);
        if (modelIdx === -1) {
          console.warn(`Model "${model}" not found in AI_MODELS list. Using default index 0.`);
          modelIdx = 0;
        }
        
        const frontendPortRangeStart = BASE_FRONTEND_PORT + (modelIdx * TOTAL_PORTS_PER_MODEL);
        return frontendPortRangeStart + ((appNum - 1) * PORTS_PER_APP);
      },
      
      initializeData: function() {
        // Initialize counters and statistics
        this.updateCodeCounter();
        this.initVulnerabilityChart();
        
        // Set estimated values if this is a completed scan
        if ($('#scanStatus').text() === 'Complete') {
          if ($('#urlsDiscovered').text() === '-') $('#urlsDiscovered').text('50+');
          if ($('#requestsSent').text() === '-') $('#requestsSent').text('2000+');
          if ($('#spiderTime').text() === '-') $('#spiderTime').text('~1m 30s');
          if ($('#passiveScanTime').text() === '-') $('#passiveScanTime').text('~2m 15s');
          if ($('#activeScanTime').text() === '-') $('#activeScanTime').text('~10m');
          if ($('#totalDuration').text() === '-') {
            const durationText = $('#scanDuration').text();
            $('#totalDuration').text(durationText !== '-' ? durationText : '~15m');
          }
        }
      },
      
      updateCodeCounter: function() {
        let withCodeCount = 0;
        $('.alert-item').each(function() {
          if ($(this).data('has-code')) withCodeCount++;
        });
        $('#alertsWithCode').text(withCodeCount);
      },
      
      initVulnerabilityChart: function() {
        if (typeof Chart === 'undefined' || !document.getElementById('vulnerabilityChart')) return;
        
        const highCount = parseInt($('#highCount').text()) || 0;
        const mediumCount = parseInt($('#mediumCount').text()) || 0;
        const lowCount = parseInt($('#lowCount').text()) || 0;
        const infoCount = parseInt($('#infoCount').text()) || 0;
        
        new Chart(document.getElementById('vulnerabilityChart'), {
          type: 'bar',
          data: {
            labels: ['High', 'Medium', 'Low', 'Info'],
            datasets: [{
              label: 'Vulnerabilities',
              data: [highCount, mediumCount, lowCount, infoCount],
              backgroundColor: ['rgba(220, 38, 38, 0.7)', 'rgba(252, 211, 77, 0.7)', 'rgba(59, 130, 246, 0.7)', 'rgba(156, 163, 175, 0.7)'],
              borderColor: ['rgba(185, 28, 28, 1)', 'rgba(217, 119, 6, 1)', 'rgba(37, 99, 235, 1)', 'rgba(107, 114, 128, 1)'],
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true, ticks: { precision: 0 } } },
            plugins: { legend: { display: false } }
          }
        });
      },
      
      applyFilters: function() {
        const searchTerm = $('#searchIssues').val().toLowerCase();
        const selectedRisk = $('#riskFilter').val();
        const selectedConfidence = $('#confidenceFilter').val();
        const codeFilter = $('#codeFilter').val();
        
        let visibleCount = 0;
        let withCodeCount = 0;
        
        $('.alert-item').each(function() {
          const $alert = $(this);
          const risk = $alert.data('risk');
          const confidence = $alert.data('confidence');
          const hasCode = $alert.data('has-code');
          const searchText = $alert.data('searchable').toLowerCase();
          
          const riskMatch = selectedRisk === 'all' || risk === selectedRisk;
          const confidenceMatch = selectedConfidence === 'all' || confidence === selectedConfidence;
          const searchMatch = !searchTerm || searchText.includes(searchTerm);
          const codeMatch = codeFilter === 'all' || (codeFilter === 'hasCode' && hasCode) || (codeFilter === 'noCode' && !hasCode);
          
          const isVisible = riskMatch && confidenceMatch && searchMatch && codeMatch;
          $alert.toggle(isVisible);
          
          if (isVisible) {
            visibleCount++;
            if (hasCode) withCodeCount++;
          }
        });
        
        $('#alertsWithCode').text(withCodeCount);
      },
      
      appendToLog: function(message) {
        const timestamp = new Date().toLocaleTimeString();
        const logElem = $('#progressLog');
        logElem.append(`[${timestamp}] ${message}\n`);
        logElem.scrollTop(logElem[0].scrollHeight);
      },
      
      formatDuration: function(totalSeconds) {
        if (!totalSeconds) return "-";
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;
        
        if (hours > 0) return `${hours}h ${minutes}m ${seconds}s`;
        else if (minutes > 0) return `${minutes}m ${seconds}s`;
        else return `${seconds}s`;
      },
      
      updateDuration: function() {
        if (!this.scanStartTimestamp) return;
        const durationSeconds = Math.floor((new Date() - this.scanStartTimestamp) / 1000);
        $('#scanDuration').text(this.formatDuration(durationSeconds));
      },
      
      startScan: function() {
        // Get model and app from URL
        const urlParts = window.location.pathname.split('/');
        const model = urlParts[urlParts.length - 2] || '';
        const appNum = urlParts[urlParts.length - 1] || '';
        
        // Update UI state
        $('#startScan').prop('disabled', true);
        $('#stopScan').removeClass('hidden');
        $('#scanProgress').removeClass('hidden');
        $('#scanStatus').text('Starting...');
        
        // Reset progress elements
        $('#progressPercentage').text('0%');
        $('#progressBar').css('width', '0%');
        $('#spiderProgress, #passiveProgress, #activeProgress').text('0%');
        $('#spiderProgressBar, #passiveProgressBar, #activeProgressBar').css('width', '0%');
        
        // Reset counters
        $('#highCount, #mediumCount, #lowCount, #infoCount, #totalAlerts, #alertsWithCode').text('0');
        
        // Track timing
        this.scanStartTimestamp = new Date();
        const startTimeStr = this.scanStartTimestamp.toLocaleString();
        $('#scanStartTime').text(startTimeStr);
        $('#scanDuration').text('0s');
        
        if (this.durationInterval) clearInterval(this.durationInterval);
        this.durationInterval = setInterval(this.updateDuration.bind(this), 1000);
        
        this.appendToLog(`Starting comprehensive scan of target: http://localhost:${this.calculatePort(model, appNum)}`);
        
        // Send request to server
        $.ajax({
          url: `/zap/scan/${model}/${appNum}`,
          method: 'POST',
          contentType: 'application/json',
          data: JSON.stringify({})
        })
        .done(() => {
          this.appendToLog('Scan initiated successfully. Starting spider phase...');
          this.pollProgress(model, appNum);
        })
        .fail((jqXHR) => {
          const errorMsg = jqXHR.responseJSON?.error || `HTTP ${jqXHR.status}: ${jqXHR.statusText}`;
          this.appendToLog(`Error: ${errorMsg}`);
          
          // Reset UI
          $('#startScan').prop('disabled', false);
          $('#stopScan').addClass('hidden');
          $('#scanStatus').text('Error');
          
          if (this.durationInterval) {
            clearInterval(this.durationInterval);
            this.durationInterval = null;
          }
        });
      },
      
      stopScan: function() {
        const urlParts = window.location.pathname.split('/');
        const model = urlParts[urlParts.length - 2] || '';
        const appNum = urlParts[urlParts.length - 1] || '';
        
        this.appendToLog('Stopping scan...');
        
        $.ajax({
          url: `/zap/scan/${model}/${appNum}/stop`,
          method: 'POST'
        })
        .done(() => {
          this.pollingActive = false;
          $('#stopScan').addClass('hidden');
          $('#startScan').prop('disabled', false);
          $('#scanStatus').text('Stopped');
          
          if (this.durationInterval) {
            clearInterval(this.durationInterval);
            this.durationInterval = null;
          }
          
          this.appendToLog('Scan stopped successfully');
        })
        .fail((jqXHR) => {
          const errorMsg = jqXHR.responseJSON?.error || `HTTP ${jqXHR.status}: ${jqXHR.statusText}`;
          this.appendToLog(`Error stopping scan: ${errorMsg}`);
        });
      },
      
      pollProgress: function(model, appNum) {
        if (this.pollingActive) return;
        this.pollingActive = true;
        this.pollingErrorCount = 0;
        
        // Phase timing tracking
        const phaseStartTimes = { spider: null, passive: null, active: null, code: null };
        
        const updateUI = () => {
          $.ajax({
            url: `/zap/scan/${model}/${appNum}/status`,
            method: 'GET'
          })
          .done((data) => {
            // Update progress
            const progress = Math.min(Math.max(data.progress || 0, 0), 100);
            $('#progressBar').css('width', `${progress}%`);
            $('#progressPercentage').text(`${progress}%`);
            
            // Update detailed progress
            if (data.spider_progress !== undefined) {
              const spiderProgress = Math.min(Math.max(data.spider_progress || 0, 0), 100);
              const passiveProgress = Math.min(Math.max(data.passive_progress || 0, 0), 100);
              const activeProgress = Math.min(Math.max(data.active_progress || 0, 0), 100);
              
              $('#spiderProgress').text(`${spiderProgress}%`);
              $('#passiveProgress').text(`${passiveProgress}%`);
              $('#activeProgress').text(`${activeProgress}%`);
              
              $('#spiderProgressBar').css('width', `${spiderProgress}%`);
              $('#passiveProgressBar').css('width', `${passiveProgress}%`);
              $('#activeProgressBar').css('width', `${activeProgress}%`);
            }
            
            // Update status
            $('#scanStatus').text(data.status || 'Unknown');
            
            // Update counts
            $('#highCount').text(data.high_count || 0);
            $('#mediumCount').text(data.medium_count || 0);
            $('#lowCount').text(data.low_count || 0);
            $('#infoCount').text(data.info_count || 0);
            
            const total = (parseInt(data.high_count) || 0) + 
                          (parseInt(data.medium_count) || 0) + 
                          (parseInt(data.low_count) || 0) + 
                          (parseInt(data.info_count) || 0);
            $('#totalAlerts').text(total);
            
            // Track phase timings
            const prevStatus = $('#scanStatus').data('prev-status');
            if (data.status !== prevStatus) {
              this.appendToLog(`Status changed to: ${data.status}`);
              $('#scanStatus').data('prev-status', data.status);
              
              // Process phase transition
              const now = new Date();
              this.handlePhaseTransition(prevStatus, data.status, phaseStartTimes, now);
            }
            
            // Check completion
            if (data.status === 'Complete') {
              this.pollingActive = false;
              $('#stopScan').addClass('hidden');
              $('#startScan').prop('disabled', false);
              $('#lastScanTime').text(new Date().toLocaleString());
              
              if (this.durationInterval) {
                clearInterval(this.durationInterval);
                this.durationInterval = null;
              }
              
              this.appendToLog('Scan completed successfully. Reloading page to show results...');
              setTimeout(() => window.location.reload(), 2000);
              return;
            }
            
            // Continue polling
            if (this.pollingActive) setTimeout(updateUI, 2000);
          })
          .fail((jqXHR) => {
            this.appendToLog(`Error updating status: ${jqXHR.responseJSON?.error || jqXHR.statusText}`);
            this.pollingErrorCount++;
            
            if (this.pollingErrorCount >= 3) {
              this.pollingActive = false;
              this.appendToLog('Stopped polling due to repeated errors');
              return;
            }
            
            if (this.pollingActive) setTimeout(updateUI, 5000);
          });
        };
        
        updateUI();
      },
      
      handlePhaseTransition: function(prevStatus, newStatus, phaseStartTimes, now) {
        // End timing for previous phase if applicable
        if (prevStatus) {
          if (prevStatus.includes('Spider') && phaseStartTimes.spider) {
            const spiderTime = Math.round((now - phaseStartTimes.spider) / 1000);
            $('#spiderTime').text(this.formatDuration(spiderTime));
            this.appendToLog(`Spider phase completed in ${this.formatDuration(spiderTime)}`);
          } else if (prevStatus.includes('Passive') && phaseStartTimes.passive) {
            const passiveTime = Math.round((now - phaseStartTimes.passive) / 1000);
            $('#passiveScanTime').text(this.formatDuration(passiveTime));
            this.appendToLog(`Passive scan phase completed in ${this.formatDuration(passiveTime)}`);
          } else if (prevStatus.includes('Active') && phaseStartTimes.active) {
            const activeTime = Math.round((now - phaseStartTimes.active) / 1000);
            $('#activeScanTime').text(this.formatDuration(activeTime));
            this.appendToLog(`Active scan phase completed in ${this.formatDuration(activeTime)}`);
          }
        }
        
        // Start timing for new phase
        if (newStatus.includes('Spider')) {
          phaseStartTimes.spider = now;
          this.appendToLog('Spider phase started - discovering web content...');
          $('#urlsDiscovered').text('Discovering...');
        } else if (newStatus.includes('Passive')) {
          phaseStartTimes.passive = now;
          this.appendToLog('Passive scanning in progress - analyzing responses...');
        } else if (newStatus.includes('Active')) {
          phaseStartTimes.active = now;
          this.appendToLog('Active scanning in progress - testing for vulnerabilities...');
          $('#requestsSent').text('~1000+');
        } else if (newStatus.includes('Code')) {
          phaseStartTimes.code = now;
          this.appendToLog('Code analysis in progress - identifying affected source code...');
        }
      }
    };
    
    // Initialize ZAP Scan
    zapScan.init();
  }
});
</script>

<style>
.code-block { font-family: 'Consolas', 'Monaco', 'Menlo', 'Ubuntu Mono', monospace; tab-size: 4; }
.vulnerable-line { position: relative; }
.line-number { user-select: none; -webkit-user-select: none; -moz-user-select: none; }
.code-line:hover { background-color: rgba(255, 255, 255, 0.05); }
.vulnerable-line .line-content { font-weight: bold; color: #ff7b72; }
</style>
{% endblock %}