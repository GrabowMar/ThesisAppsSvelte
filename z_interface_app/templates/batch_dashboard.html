{% extends "base.html" %}

{% block content %}
<div class="space-y-2 max-w-7xl mx-auto">
  <!-- Dashboard Header Section -->
  <div class="border border-gray-400 bg-white p-2 rounded-md">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="font-bold text-xl text-gray-900">Batch Security Analysis</h1>
        <p class="text-xs text-gray-600 mt-1">Run security analysis on multiple applications at once</p>
      </div>
      <div class="flex items-center space-x-2">
        <a href="{{ url_for('main.index') }}" class="action-btn h-6 px-2 text-xs flex items-center">
          <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
          </svg>
          Dashboard
        </a>
        <button id="toggleCreateForm" class="action-btn h-6 px-2 text-xs flex items-center bg-blue-600 text-white hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition duration-150" aria-expanded="false" aria-controls="createJobForm">
          <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
          </svg>
          New Batch Job
        </button>
      </div>
    </div>
  </div>

  <!-- Job Creation Form (hidden by default) -->
  <div id="createJobForm" class="border border-gray-400 bg-white rounded-md shadow-md hidden" aria-hidden="true">
    <div class="bg-gray-100 border-b border-gray-400 px-2 py-1">
      <h2 class="font-bold text-sm">Create New Batch Job</h2>
    </div>
    <div class="p-4">
      <form method="POST" action="{{ url_for('batch_analysis.create_batch_job') }}" id="batchJobForm" novalidate>
        <!-- Basic Information -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <div>
            <label for="name" class="block text-xs font-medium text-gray-700 mb-1">Job Name <span class="text-red-600">*</span></label>
            <input type="text" id="name" name="name" 
                  class="w-full h-8 px-2 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                  value="{% if model %}Security Scan - {{ model }}{% elif selected_model %}Security Scan - {{ selected_model }}{% else %}Security Scan{% endif %}"
                  required aria-required="true">
            <p class="form-error-msg hidden text-xs text-red-600 mt-1">Job name is required</p>
          </div>
          <div>
            <label for="description" class="block text-xs font-medium text-gray-700 mb-1">Description</label>
            <input type="text" id="description" name="description" 
                  class="w-full h-8 px-2 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                  value="{% if model %}Security analysis for {{ model }} applications{% elif selected_model %}Security analysis for {{ selected_model }} applications{% else %}Comprehensive security analysis{% endif %}">
          </div>
        </div>

        <!-- Scan Type -->
        <div class="mb-4">
          <h3 class="text-xs font-medium text-gray-700 mb-2">Scan Type <span class="text-red-600">*</span></h3>
          <div class="flex flex-wrap gap-4">
            <div class="flex items-center">
              <input type="radio" id="scan_type_frontend" name="scan_type" value="frontend" class="mr-2 focus:ring-2 focus:ring-blue-500" checked>
              <label for="scan_type_frontend" class="text-xs text-gray-700">
                Frontend
                <span class="ml-1 text-xs text-gray-500">(Analyze JavaScript/HTML/CSS files)</span>
              </label>
            </div>
            <div class="flex items-center">
              <input type="radio" id="scan_type_backend" name="scan_type" value="backend" class="mr-2 focus:ring-2 focus:ring-blue-500">
              <label for="scan_type_backend" class="text-xs text-gray-700">
                Backend
                <span class="ml-1 text-xs text-gray-500">(Analyze Python files)</span>
              </label>
            </div>
            <div class="flex items-center">
              <input type="radio" id="scan_type_both" name="scan_type" value="both" class="mr-2 focus:ring-2 focus:ring-blue-500">
              <label for="scan_type_both" class="text-xs text-gray-700">
                Both
                <span class="ml-1 text-xs text-gray-500">(Analyze both Frontend and Backend)</span>
              </label>
            </div>
          </div>
        </div>

        <!-- Scan Options -->
        <div class="mb-4">
          <h3 class="text-xs font-medium text-gray-700 mb-2">Scan Options</h3>
          <div class="flex items-center">
            <input type="checkbox" id="full_scan" name="full_scan" class="mr-2 focus:ring-2 focus:ring-blue-500">
            <label for="full_scan" class="text-xs text-gray-700">
              Full Scan (Run all analysis tools)
            </label>
            <div class="ml-2 text-xs text-gray-500">
              (Quick scan only runs essential tools)
            </div>
          </div>
        </div>

        <!-- Model Selection -->
        <div class="mb-4">
          <h3 class="text-xs font-medium text-gray-700 mb-2">Select Models <span class="text-red-600">*</span></h3>
          <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
            {% for model_name in all_models %}
              <div class="flex items-center">
                <input type="checkbox" id="model_{{ model_name }}" name="models" value="{{ model_name }}" 
                       class="model-checkbox mr-2 focus:ring-2 focus:ring-blue-500" {% if model_name == model or model_name == selected_model %}checked{% endif %}>
                <label for="model_{{ model_name }}" class="text-xs text-gray-700">{{ model_name }}</label>
              </div>
            {% endfor %}
          </div>
          <p class="models-error-msg hidden text-xs text-red-600 mt-1">Select at least one model</p>
        </div>

        <!-- App Ranges (Dynamic) -->
        <div class="mb-4">
          <h3 class="text-xs font-medium text-gray-700 mb-2">App Ranges</h3>
          <p class="text-xs text-gray-500 mb-2">Specify which app numbers to scan for each model. Format: 1-3,5,7-9 (leave empty for all apps)</p>
          
          <div id="appRangeFields" class="space-y-2">
            {% for model_name in all_models %}
              <div class="app-range-field {% if model_name != model and model_name != selected_model %}hidden{% endif %}" data-model="{{ model_name }}">
                <div class="flex items-center">
                  <label for="app_range_{{ model_name }}" class="min-w-[100px] text-xs text-gray-700">{{ model_name }}:</label>
                  <input type="text" id="app_range_{{ model_name }}" name="app_range_{{ model_name }}" 
                        placeholder="e.g., 1-3,5,7-9 (empty for all)"
                        value="{% if model_name == model and app_num %}{{ app_num }}{% endif %}"
                        pattern="^(\d+(-\d+)?)(,\d+(-\d+)?)*$"
                        class="w-full h-8 px-2 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <p class="app-range-error hidden text-xs text-red-600 mt-1">Invalid format. Use pattern like: 1-3,5,7-9</p>
              </div>
            {% endfor %}
          </div>
        </div>

        <!-- Submit Button -->
        <div class="flex justify-end space-x-2">
          <button type="button" id="cancelCreateForm" class="action-btn h-8 px-4 text-xs rounded focus:ring-2 focus:ring-gray-300 transition">
            Cancel
          </button>
          <button type="submit" id="submitJobBtn" class="action-btn h-8 px-4 text-xs bg-blue-600 text-white hover:bg-blue-700 rounded focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition">
            Create and Start Job
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Dashboard Stats Overview -->
  <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
    <div class="border border-gray-400 bg-white p-2 rounded-md shadow-sm">
      <div class="text-xs text-gray-600">Total Jobs</div>
      <div class="text-lg font-bold">{{ jobs|length }}</div>
    </div>
    <div class="border border-gray-400 bg-white p-2 rounded-md shadow-sm">
      <div class="text-xs text-green-600">Active Jobs</div>
      <div class="text-lg font-bold text-green-700">{{ active_jobs }}</div>
    </div>
    <div class="border border-gray-400 bg-white p-2 rounded-md shadow-sm">
      <div class="text-xs text-blue-600">Completed Jobs</div>
      <div class="text-lg font-bold text-blue-700">{{ completed_jobs }}</div>
    </div>
    <div class="border border-gray-400 bg-white p-2 rounded-md shadow-sm">
      <div class="text-xs text-red-600">Failed Jobs</div>
      <div class="text-lg font-bold text-red-700">{{ failed_jobs }}</div>
    </div>
  </div>

  <!-- Filters Section -->
  <div class="border border-gray-400 bg-white rounded-md shadow-sm">
    <div class="bg-gray-100 border-b border-gray-400 px-2 py-1">
      <h2 class="font-bold text-sm">Filters</h2>
    </div>
    <div class="p-2 flex flex-wrap items-center gap-2">
      <div class="relative">
        <input type="text" id="searchJobs" placeholder="Search jobs..." 
             class="h-6 pl-6 pr-2 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
        <svg class="w-3 h-3 absolute left-2 top-1.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
        </svg>
      </div>
      <select id="modelFilter" class="h-6 px-2 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500" aria-label="Filter by model">
        <option value="all">All Models</option>
        {% for model_name in all_models %}
          <option value="{{ model_name }}">{{ model_name }}</option>
        {% endfor %}
      </select>
      <select id="scanTypeFilter" class="h-6 px-2 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500" aria-label="Filter by scan type">
        <option value="all">All Scan Types</option>
        <option value="frontend">Frontend</option>
        <option value="backend">Backend</option>
        <option value="both">Both</option>
      </select>
      <select id="statusFilter" class="h-6 px-2 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500" aria-label="Filter by status">
        <option value="all">All Statuses</option>
        <option value="running">Running</option>
        <option value="completed">Completed</option>
        <option value="failed">Failed</option>
        <option value="cancelled">Cancelled</option>
        <option value="pending">Pending</option>
      </select>
      <button id="clearFilters" class="h-6 px-2 text-xs border border-gray-300 rounded hover:bg-gray-100 focus:outline-none focus:ring-1 focus:ring-blue-500 transition">
        Clear Filters
      </button>
    </div>
  </div>

  <!-- Job List -->
  <div class="border border-gray-400 bg-white rounded-md shadow-sm">
    <div class="bg-gray-100 border-b border-gray-400 px-2 py-1 flex justify-between items-center">
      <h2 class="font-bold text-sm">Job List</h2>
      <div class="text-xs text-gray-600" id="jobsCounter">
        Showing <span id="visibleJobsCount">{{ jobs|length }}</span> of {{ jobs|length }} jobs
      </div>
    </div>
    <div class="p-2">
      {% if jobs %}
        <div class="overflow-x-auto">
          <table class="min-w-full border border-gray-300">
            <thead>
              <tr class="bg-gray-100">
                <th class="border border-gray-300 px-2 py-1 text-xs text-left">ID</th>
                <th class="border border-gray-300 px-2 py-1 text-xs text-left">Name</th>
                <th class="border border-gray-300 px-2 py-1 text-xs text-left">Status</th>
                <th class="border border-gray-300 px-2 py-1 text-xs text-left">Scan Type</th>
                <th class="border border-gray-300 px-2 py-1 text-xs text-left">Models</th>
                <th class="border border-gray-300 px-2 py-1 text-xs text-left">Created</th>
                <th class="border border-gray-300 px-2 py-1 text-xs text-left">Progress</th>
                <th class="border border-gray-300 px-2 py-1 text-xs text-left">Issues</th>
                <th class="border border-gray-300 px-2 py-1 text-xs text-left">Actions</th>
              </tr>
            </thead>
            <tbody id="jobsTableBody">
              {% for job in jobs %}
                <tr class="hover:bg-gray-50 job-row" data-job-id="{{ job.id }}" data-status="{{ job.status }}" data-scan-type="{{ job.scan_type }}" data-models="{{ job.models|join(',') }}" data-name="{{ job.name }}">
                  <td class="border border-gray-300 px-2 py-1 text-xs">{{ job.id }}</td>
                  <td class="border border-gray-300 px-2 py-1 text-xs font-medium">
                    <a href="#" class="view-job-btn text-blue-700 hover:underline" data-job-id="{{ job.id }}">
                      {{ job.name }}
                    </a>
                  </td>
                  <td class="border border-gray-300 px-2 py-1 text-xs">
                    <span class="px-2 py-0.5 rounded-md text-white
                      {% if job.status == 'running' %}
                        bg-green-600
                      {% elif job.status == 'completed' %}
                        bg-blue-600
                      {% elif job.status == 'pending' %}
                        bg-gray-600
                      {% else %}
                        bg-red-600
                      {% endif %}">
                      {{ job.status }}
                    </span>
                  </td>
                  <td class="border border-gray-300 px-2 py-1 text-xs">
                    <span class="px-2 py-0.5 rounded-md 
                      {% if job.scan_type == 'frontend' %}
                        bg-purple-100 text-purple-800 border border-purple-700
                      {% elif job.scan_type == 'backend' %}
                        bg-indigo-100 text-indigo-800 border border-indigo-700
                      {% else %}
                        bg-teal-100 text-teal-800 border border-teal-700
                      {% endif %}">
                      {{ job.scan_type }}
                    </span>
                  </td>
                  <td class="border border-gray-300 px-2 py-1 text-xs">
                    {{ job.models|join(', ') }}
                  </td>
                  <td class="border border-gray-300 px-2 py-1 text-xs">
                    {{ job.created_at.strftime('%Y-%m-%d %H:%M') if job.created_at else 'N/A' }}
                  </td>
                  <td class="border border-gray-300 px-2 py-1 text-xs">
                    <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                      <div class="bg-blue-600 rounded-full h-2 transition-all duration-300" style="width: {{ (job.completed_tasks / job.total_tasks * 100) if job.total_tasks > 0 else 0 }}%"></div>
                    </div>
                    <span class="text-xs text-gray-600">{{ job.completed_tasks }}/{{ job.total_tasks }}</span>
                  </td>
                  <td class="border border-gray-300 px-2 py-1 text-xs">
                    {% if job.status == 'completed' %}
                      <div class="flex space-x-1">
                        <span class="px-1 bg-red-100 text-red-800 border border-red-700 rounded" title="High severity issues">{{ job.high_issues or 0 }}</span>
                        <span class="px-1 bg-yellow-100 text-yellow-800 border border-yellow-700 rounded" title="Medium severity issues">{{ job.medium_issues or 0 }}</span>
                        <span class="px-1 bg-blue-100 text-blue-800 border border-blue-700 rounded" title="Low severity issues">{{ job.low_issues or 0 }}</span>
                      </div>
                    {% else %}
                      -
                    {% endif %}
                  </td>
                  <td class="border border-gray-300 px-2 py-1 text-xs">
                    <div class="flex space-x-1">
                      <button class="view-job-btn action-btn h-6 px-2 text-xs focus:ring-2 focus:ring-blue-500 transition" data-job-id="{{ job.id }}" aria-label="View details for job {{ job.id }}">
                        View
                      </button>
                      {% if job.status == 'running' %}
                        <button class="cancel-job-btn action-btn h-6 px-2 text-xs bg-red-600 text-white hover:bg-red-700 focus:ring-2 focus:ring-red-500 transition" data-job-id="{{ job.id }}" aria-label="Cancel job {{ job.id }}">
                          Cancel
                        </button>
                      {% endif %}
                    </div>
                  </td>
                </tr>
              {% endfor %}
              <tr id="noResultsRow" class="hidden">
                <td colspan="9" class="border border-gray-300 px-2 py-4 text-xs text-center text-gray-500">
                  No jobs match your current filters
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="p-4 text-center border border-gray-300 rounded-md">
          <p class="text-xs text-gray-600">No batch jobs found</p>
          <button id="noJobsCreateBtn" class="mt-2 inline-block action-btn h-6 px-2 text-xs bg-blue-600 text-white hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition">
            Create First Job
          </button>
        </div>
      {% endif %}
    </div>
  </div>

  <!-- Job Details Section (hidden by default) -->
  <div id="jobDetailsSection" class="border border-gray-400 bg-white rounded-md shadow-md hidden" role="dialog" aria-modal="true" aria-labelledby="jobDetailsTitle" aria-hidden="true">
    <div class="bg-gray-100 border-b border-gray-400 px-2 py-1 flex justify-between items-center">
      <h2 class="font-bold text-sm" id="jobDetailsTitle">Job Details</h2>
      <button id="closeJobDetails" class="text-gray-500 hover:text-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-400 rounded-md" aria-label="Close job details">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
    <div class="p-2" id="jobDetailsContent">
      <!-- Job details will be loaded here -->
      <div class="flex justify-center p-4">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
      </div>
    </div>
  </div>

  <!-- Result Details Section (hidden by default) -->
  <div id="resultDetailsSection" class="border border-gray-400 bg-white rounded-md shadow-md hidden" role="dialog" aria-modal="true" aria-labelledby="resultDetailsTitle" aria-hidden="true">
    <div class="bg-gray-100 border-b border-gray-400 px-2 py-1 flex justify-between items-center">
      <h2 class="font-bold text-sm" id="resultDetailsTitle">Result Details</h2>
      <button id="closeResultDetails" class="text-gray-500 hover:text-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-400 rounded-md" aria-label="Close result details">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
    <div class="p-2" id="resultDetailsContent">
      <!-- Result details will be loaded here -->
      <div class="flex justify-center p-4">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
      </div>
    </div>
  </div>
  
  <!-- Toast notification container -->
  <div id="toastContainer" class="fixed bottom-4 right-4 z-50"></div>
</div>

<!-- Templates for dynamic content -->
<template id="jobDetailsTpl">
  <div class="space-y-2">
    <!-- Job Status -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
      <!-- Left column -->
      <div class="border border-gray-400 bg-white rounded-md shadow-sm">
        <div class="bg-gray-100 border-b border-gray-400 px-2 py-1">
          <h2 class="font-bold text-sm">Job Information</h2>
        </div>
        <div class="p-2">
          <table class="w-full text-xs">
            <tr>
              <td class="font-medium text-gray-600 py-1">ID:</td>
              <td id="job-id"></td>
            </tr>
            <tr>
              <td class="font-medium text-gray-600 py-1">Name:</td>
              <td id="job-name"></td>
            </tr>
            <tr>
              <td class="font-medium text-gray-600 py-1">Status:</td>
              <td id="job-status-cell">
                <span class="px-2 py-0.5 rounded-md text-white" id="job-status"></span>
              </td>
            </tr>
            <tr>
              <td class="font-medium text-gray-600 py-1">Scan Type:</td>
              <td id="job-scan-type-cell">
                <span class="px-2 py-0.5 rounded-md" id="job-scan-type"></span>
              </td>
            </tr>
            <tr>
              <td class="font-medium text-gray-600 py-1">Created:</td>
              <td id="job-created"></td>
            </tr>
            <tr>
              <td class="font-medium text-gray-600 py-1">Started:</td>
              <td id="job-started"></td>
            </tr>
            <tr>
              <td class="font-medium text-gray-600 py-1">Completed:</td>
              <td id="job-completed"></td>
            </tr>
            <tr>
              <td class="font-medium text-gray-600 py-1">Models:</td>
              <td id="job-models"></td>
            </tr>
            <tr>
              <td class="font-medium text-gray-600 py-1">Full Scan:</td>
              <td id="job-full-scan"></td>
            </tr>
          </table>
        </div>
      </div>

      <!-- Middle column -->
      <div class="border border-gray-400 bg-white rounded-md shadow-sm">
        <div class="bg-gray-100 border-b border-gray-400 px-2 py-1">
          <h2 class="font-bold text-sm">Progress</h2>
        </div>
        <div class="p-2">
          <div class="mb-2">
            <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
              <div class="bg-blue-600 rounded-full h-4 flex items-center justify-center text-xs text-white transition-all duration-300"
                  id="progress-bar">
                0%
              </div>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-2 text-xs">
            <div class="border border-gray-300 p-2 rounded-md">
              <div class="text-gray-600">Completed</div>
              <div class="font-bold" id="completed-tasks">0/0 tasks</div>
            </div>
            <div class="border border-gray-300 p-2 rounded-md">
              <div class="text-gray-600">Runtime</div>
              <div class="font-bold" id="runtime">Calculating...</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right column -->
      <div class="border border-gray-400 bg-white rounded-md shadow-sm">
        <div class="bg-gray-100 border-b border-gray-400 px-2 py-1">
          <h2 class="font-bold text-sm">Issues Found</h2>
        </div>
        <div class="p-2">
          <div class="grid grid-cols-3 gap-2 text-xs">
            <div class="border border-gray-300 p-2 rounded-md">
              <div class="text-red-600">High</div>
              <div class="font-bold text-red-700" id="high-issues">0</div>
            </div>
            <div class="border border-gray-300 p-2 rounded-md">
              <div class="text-yellow-600">Medium</div>
              <div class="font-bold text-yellow-700" id="medium-issues">0</div>
            </div>
            <div class="border border-gray-300 p-2 rounded-md">
              <div class="text-blue-600">Low</div>
              <div class="font-bold text-blue-700" id="low-issues">0</div>
            </div>
          </div>
          <div class="mt-2 border border-gray-300 p-2 rounded-md text-xs">
            <div class="text-gray-600">Total Issues</div>
            <div class="font-bold" id="total-issues">0</div>
          </div>
          
          <!-- Scan Type-specific stats (shown only for 'both' scan type) -->
          <div id="scan-type-stats" class="mt-2 hidden">
            <div class="border-t border-gray-300 pt-2">
              <div class="text-xs font-medium text-purple-700 mb-1">Frontend Issues</div>
              <div class="flex space-x-2">
                <span class="px-1 bg-red-100 text-red-800 border border-red-700 rounded" id="frontend-high-issues">0</span>
                <span class="px-1 bg-yellow-100 text-yellow-800 border border-yellow-700 rounded" id="frontend-medium-issues">0</span>
                <span class="px-1 bg-blue-100 text-blue-800 border border-blue-700 rounded" id="frontend-low-issues">0</span>
                <span class="px-1 bg-gray-100 text-gray-800 border border-gray-700 rounded" id="frontend-total-issues">0 total</span>
              </div>
            </div>
            <div class="border-t border-gray-300 mt-2 pt-2">
              <div class="text-xs font-medium text-indigo-700 mb-1">Backend Issues</div>
              <div class="flex space-x-2">
                <span class="px-1 bg-red-100 text-red-800 border border-red-700 rounded" id="backend-high-issues">0</span>
                <span class="px-1 bg-yellow-100 text-yellow-800 border border-yellow-700 rounded" id="backend-medium-issues">0</span>
                <span class="px-1 bg-blue-100 text-blue-800 border border-blue-700 rounded" id="backend-low-issues">0</span>
                <span class="px-1 bg-gray-100 text-gray-800 border border-gray-700 rounded" id="backend-total-issues">0 total</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Results Table -->
    <div class="border border-gray-400 bg-white rounded-md shadow-sm">
      <div class="bg-gray-100 border-b border-gray-400 px-2 py-1 flex justify-between items-center">
        <h2 class="font-bold text-sm">Results</h2>
        <div class="flex flex-wrap items-center gap-2">
          <div class="relative">
            <input type="text" id="searchResults" placeholder="Search results..." 
                  class="h-6 pl-6 pr-2 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
            <svg class="w-3 h-3 absolute left-2 top-1.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
            </svg>
          </div>
          <select id="resultStatusFilter" class="h-6 px-2 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
            <option value="all">All Statuses</option>
            <option value="completed">Completed</option>
            <option value="failed">Failed</option>
          </select>
          <select id="resultModelFilter" class="h-6 px-2 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
            <option value="all">All Models</option>
          </select>
          <select id="resultScanTypeFilter" class="h-6 px-2 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
            <option value="all">All Scan Types</option>
            <option value="frontend">Frontend</option>
            <option value="backend">Backend</option>
          </select>
          <button id="exportResultsBtn" class="h-6 px-2 text-xs border border-gray-300 rounded hover:bg-gray-100 focus:outline-none focus:ring-1 focus:ring-blue-500 transition flex items-center">
            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
            </svg>
            Export
          </button>
        </div>
      </div>
      <div class="p-2">
        <div class="overflow-x-auto">
          <table class="min-w-full border border-gray-300">
            <thead>
              <tr class="bg-gray-100">
                <th class="border border-gray-300 px-2 py-1 text-xs text-left">Model</th>
                <th class="border border-gray-300 px-2 py-1 text-xs text-left">App</th>
                <th class="border border-gray-300 px-2 py-1 text-xs text-left">Scan Type</th>
                <th class="border border-gray-300 px-2 py-1 text-xs text-left">Status</th>
                <th class="border border-gray-300 px-2 py-1 text-xs text-left">High</th>
                <th class="border border-gray-300 px-2 py-1 text-xs text-left">Medium</th>
                <th class="border border-gray-300 px-2 py-1 text-xs text-left">Low</th>
                <th class="border border-gray-300 px-2 py-1 text-xs text-left">Total</th>
                <th class="border border-gray-300 px-2 py-1 text-xs text-left">Scan Time</th>
                <th class="border border-gray-300 px-2 py-1 text-xs text-left">Actions</th>
              </tr>
            </thead>
            <tbody id="results-table-body">
              <!-- Results will be loaded here -->
            </tbody>
          </table>
        </div>
        <div id="resultsCounter" class="mt-2 text-xs text-gray-600 text-right">
          Showing <span id="visibleResultsCount">0</span> of <span id="totalResultsCount">0</span> results
        </div>
      </div>
    </div>

    <!-- Error Section (shown only if errors exist) -->
    <div id="errors-section" class="border border-gray-400 bg-white rounded-md shadow-sm hidden">
      <div class="bg-gray-100 border-b border-gray-400 px-2 py-1">
        <h2 class="font-bold text-sm">Errors</h2>
      </div>
      <div class="p-2">
        <ul class="list-disc pl-4 text-xs text-red-700 space-y-1" id="errors-list">
        </ul>
      </div>
    </div>
  </div>
</template>

<template id="resultItemTpl">
  <tr class="hover:bg-gray-50 result-row">
    <td class="border border-gray-300 px-2 py-1 text-xs result-model"></td>
    <td class="border border-gray-300 px-2 py-1 text-xs">App <span class="result-app-num"></span></td>
    <td class="border border-gray-300 px-2 py-1 text-xs">
      <span class="result-scan-type px-2 py-0.5 rounded-md"></span>
    </td>
    <td class="border border-gray-300 px-2 py-1 text-xs">
      <span class="result-status px-2 py-0.5 rounded-md"></span>
    </td>
    <td class="border border-gray-300 px-2 py-1 text-xs text-red-700 result-high">0</td>
    <td class="border border-gray-300 px-2 py-1 text-xs text-yellow-700 result-medium">0</td>
    <td class="border border-gray-300 px-2 py-1 text-xs text-blue-700 result-low">0</td>
    <td class="border border-gray-300 px-2 py-1 text-xs font-bold result-total">0</td>
    <td class="border border-gray-300 px-2 py-1 text-xs result-time">N/A</td>
    <td class="border border-gray-300 px-2 py-1 text-xs">
      <button class="view-result-btn action-btn h-6 px-2 text-xs focus:ring-2 focus:ring-blue-500 transition">
        Details
      </button>
    </td>
  </tr>
</template>

<template id="resultDetailsTpl">
  <div class="space-y-2">
    <!-- Result Summary -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
      <!-- Left column -->
      <div class="border border-gray-400 bg-white rounded-md shadow-sm">
        <div class="bg-gray-100 border-b border-gray-400 px-2 py-1">
          <h2 class="font-bold text-sm">Result Information</h2>
        </div>
        <div class="p-2">
          <table class="w-full text-xs">
            <tr>
              <td class="font-medium text-gray-600 py-1">Result ID:</td>
              <td id="result-id"></td>
            </tr>
            <tr>
              <td class="font-medium text-gray-600 py-1">Model:</td>
              <td id="result-model"></td>
            </tr>
            <tr>
              <td class="font-medium text-gray-600 py-1">App Number:</td>
              <td id="result-app-num"></td>
            </tr>
            <tr>
              <td class="font-medium text-gray-600 py-1">Scan Type:</td>
              <td id="result-scan-type-cell">
                <span class="px-2 py-0.5 rounded-md" id="result-scan-type"></span>
              </td>
            </tr>
            <tr>
              <td class="font-medium text-gray-600 py-1">Status:</td>
              <td id="result-status-cell">
                <span class="px-2 py-0.5 rounded-md" id="result-status"></span>
              </td>
            </tr>
            <tr>
              <td class="font-medium text-gray-600 py-1">Scan Time:</td>
              <td id="result-scan-time"></td>
            </tr>
            <tr>
              <td class="font-medium text-gray-600 py-1">Total Issues:</td>
              <td id="result-issues-count"></td>
            </tr>
          </table>
        </div>
      </div>

      <!-- Right column -->
      <div class="border border-gray-400 bg-white rounded-md shadow-sm">
        <div class="bg-gray-100 border-b border-gray-400 px-2 py-1">
          <h2 class="font-bold text-sm">Issue Counts</h2>
        </div>
        <div class="p-2">
          <div class="grid grid-cols-3 gap-2 text-xs">
            <div class="border border-gray-300 p-2 rounded-md">
              <div class="text-red-600">High Severity</div>
              <div class="font-bold text-red-700" id="result-high-severity"></div>
            </div>
            <div class="border border-gray-300 p-2 rounded-md">
              <div class="text-yellow-600">Medium Severity</div>
              <div class="font-bold text-yellow-700" id="result-medium-severity"></div>
            </div>
            <div class="border border-gray-300 p-2 rounded-md">
              <div class="text-blue-600">Low Severity</div>
              <div class="font-bold text-blue-700" id="result-low-severity"></div>
            </div>
          </div>
          
          <!-- Tool Status Section -->
          <div class="mt-2 border border-gray-300 p-2 rounded-md">
            <div class="text-xs font-medium text-gray-600 mb-1">Tool Status</div>
            <div class="space-y-1" id="tool-status-container">
              <!-- Tool status items will be added here -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Issues List -->
    <div id="issues-container" class="border border-gray-400 bg-white rounded-md shadow-sm">
      <div class="bg-gray-100 border-b border-gray-400 px-2 py-1 flex justify-between items-center">
        <h2 class="font-bold text-sm">Issues Found</h2>
        <div class="flex flex-wrap items-center gap-2">
          <div class="relative">
            <input type="text" id="searchIssues" placeholder="Search issues..." 
                  class="h-6 pl-6 pr-2 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
            <svg class="w-3 h-3 absolute left-2 top-1.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
            </svg>
          </div>
          <select id="severityFilter" class="h-6 px-2 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
            <option value="all">All Severities</option>
            <option value="HIGH">High</option>
            <option value="MEDIUM">Medium</option>
            <option value="LOW">Low</option>
          </select>
          <select id="fileFilter" class="h-6 px-2 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
            <option value="all">All Files</option>
          </select>
          <select id="toolFilter" class="h-6 px-2 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
            <option value="all">All Tools</option>
          </select>
          <button id="expandAllIssues" class="h-6 px-2 text-xs border border-gray-300 rounded hover:bg-gray-100 focus:outline-none focus:ring-1 focus:ring-blue-500 transition">
            Expand All
          </button>
        </div>
      </div>
      <div class="p-2">
        <div id="issueList" class="space-y-2">
          <!-- Issues will be loaded here -->
        </div>
        <div id="issuesCounter" class="mt-2 text-xs text-gray-600 text-right">
          Showing <span id="visibleIssuesCount">0</span> of <span id="totalIssuesCount">0</span> issues
        </div>
      </div>
    </div>

    <!-- Error container (shown when analysis failed) -->
    <div id="analysis-error-container" class="border border-gray-400 bg-white rounded-md shadow-sm hidden">
      <div class="bg-gray-100 border-b border-gray-400 px-2 py-1">
        <h2 class="font-bold text-sm">Analysis Error</h2>
      </div>
      <div class="p-4">
        <div class="bg-red-50 border border-red-300 p-3 rounded-md">
          <h3 class="text-sm font-bold text-red-700 mb-1">Analysis Failed</h3>
          <p class="text-xs text-red-600" id="analysis-error-message"></p>
        </div>
      </div>
    </div>

    <!-- No issues message (shown when analysis succeeded but found no issues) -->
    <div id="no-issues-container" class="border border-gray-400 bg-white rounded-md shadow-sm hidden">
      <div class="bg-gray-100 border-b border-gray-400 px-2 py-1">
        <h2 class="font-bold text-sm">Issues</h2>
      </div>
      <div class="p-4 text-center">
        <div class="inline-block border border-green-700 bg-green-50 p-2 rounded-md">
          <p class="text-xs font-bold text-green-700">No security issues found in this application.</p>
        </div>
      </div>
    </div>
  </div>
</template>

<template id="issueItemTpl">
  <div class="border border-gray-300 bg-white rounded-md shadow-sm issue-item">
    <!-- Issue Header -->
    <div class="p-2">
      <div class="flex items-center space-x-2 mb-1">
        <!-- Severity Badge -->
        <span class="text-xs px-2 py-0.5 border rounded-md issue-severity"></span>
        
        <!-- Tool and Confidence Badges -->
        <span class="text-xs px-2 py-0.5 bg-gray-100 border border-gray-400 rounded-md issue-tool"></span>
        <span class="text-xs px-2 py-0.5 bg-gray-100 border border-gray-400 rounded-md issue-confidence"></span>
        
        <!-- Expand Button -->
        <button class="ml-auto action-btn h-6 px-2 text-xs toggle-issue rounded-md focus:ring-2 focus:ring-blue-500 transition" aria-expanded="false">Expand</button>
      </div>
      
      <!-- Issue Content -->
      <div class="space-y-2">
        <div>
          <div class="text-xs font-bold issue-type"></div>
          <div class="text-xs text-gray-600 issue-text"></div>
        </div>
        
        <!-- Collapsible Details -->
        <div class="issue-details hidden space-y-2">
          <div class="fix-suggestion-container text-xs bg-white border border-gray-300 p-2 rounded-md hidden">
            <span class="font-bold">Fix:</span> <span class="fix-suggestion"></span>
          </div>
          
          <!-- File and Code Information -->
          <div>
            <div class="text-xs font-mono text-gray-600 issue-filename"></div>
            <div class="mt-1">
              <pre class="text-xs font-mono bg-gray-800 text-white p-1 overflow-x-auto rounded-md"><code class="issue-code"></code></pre>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<template id="toastTpl">
  <div class="toast-notification mb-2 p-3 rounded-md shadow-lg transition-all duration-300 transform translate-x-full opacity-0 flex items-center">
    <div class="toast-icon mr-2">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"></svg>
    </div>
    <div class="toast-content flex-grow">
      <div class="toast-title font-bold text-sm"></div>
      <div class="toast-message text-xs"></div>
    </div>
    <button class="toast-close ml-2 text-gray-500 hover:text-gray-700 focus:outline-none">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
      </svg>
    </button>
  </div>
</template>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    "use strict";
    
    // Cache DOM Element references
    const elements = {
      // Form toggle buttons
      toggleCreateForm: document.getElementById('toggleCreateForm'),
      createJobForm: document.getElementById('createJobForm'),
      batchJobForm: document.getElementById('batchJobForm'),
      cancelCreateForm: document.getElementById('cancelCreateForm'),
      noJobsCreateBtn: document.getElementById('noJobsCreateBtn'),
      
      // Job table elements
      jobsTableBody: document.getElementById('jobsTableBody'),
      
      // Job details elements
      jobDetailsSection: document.getElementById('jobDetailsSection'),
      jobDetailsTitle: document.getElementById('jobDetailsTitle'),
      jobDetailsContent: document.getElementById('jobDetailsContent'),
      closeJobDetails: document.getElementById('closeJobDetails'),
      
      // Result details elements
      resultDetailsSection: document.getElementById('resultDetailsSection'),
      resultDetailsTitle: document.getElementById('resultDetailsTitle'),
      resultDetailsContent: document.getElementById('resultDetailsContent'),
      closeResultDetails: document.getElementById('closeResultDetails'),
      
      // Filter elements
      searchJobs: document.getElementById('searchJobs'),
      modelFilter: document.getElementById('modelFilter'),
      scanTypeFilter: document.getElementById('scanTypeFilter'),
      statusFilter: document.getElementById('statusFilter'),
      clearFilters: document.getElementById('clearFilters'),
      
      // Counter elements
      jobsCounter: document.getElementById('jobsCounter'),
      visibleJobsCount: document.getElementById('visibleJobsCount'),
      
      // Templates
      jobDetailsTpl: document.getElementById('jobDetailsTpl'),
      resultItemTpl: document.getElementById('resultItemTpl'),
      resultDetailsTpl: document.getElementById('resultDetailsTpl'),
      issueItemTpl: document.getElementById('issueItemTpl'),
      toastTpl: document.getElementById('toastTpl'),
      
      // Toast container
      toastContainer: document.getElementById('toastContainer')
    };
    
    // Constants
    const POLLING_INTERVAL = 5000; // 5 seconds
    const MAX_POLLING_ERRORS = 3;
    const DEBOUNCE_DELAY = 200; // ms
    
    // State variables
    let activeJobPollingInterval = null;
    let pollingErrorCount = 0;
    let activeFilters = {
      search: '',
      model: 'all',
      scanType: 'all',
      status: 'all'
    };
    let lastFocusedElement = null;
    let eventListeners = {}; // For tracking event listeners
    
    // Utility functions
    const utils = {
      // Format date/time
      formatDateTime: function(dateString) {
        if (!dateString) return 'N/A';
        
        try {
          const date = new Date(dateString);
          if (isNaN(date.getTime())) return 'N/A';
          
          return date.toLocaleString();
        } catch (error) {
          console.warn('Error formatting date:', error);
          return 'N/A';
        }
      },
      
      // Calculate runtime for a job
      calculateRuntime: function(data) {
        try {
          const startedAt = data.started_at ? new Date(data.started_at) : null;
          const completedAt = data.completed_at ? new Date(data.completed_at) : null;
          const now = new Date();
          
          let runtime;
          if (data.status === 'completed' || data.status === 'failed' || data.status === 'canceled') {
            // Use completed time if available
            if (completedAt && !isNaN(completedAt) && startedAt && !isNaN(startedAt)) {
              runtime = Math.floor((completedAt - startedAt) / 1000);
            } else {
              runtime = "N/A";
            }
          } else if (startedAt && !isNaN(startedAt)) {
            // Running job - calculate current runtime
            runtime = Math.floor((now - startedAt) / 1000);
          } else {
            runtime = "Not started";
          }
          
          // Format runtime
          if (typeof runtime === 'number') {
            const hours = Math.floor(runtime / 3600);
            const minutes = Math.floor((runtime % 3600) / 60);
            const seconds = runtime % 60;
            
            let formattedRuntime = '';
            if (hours > 0) formattedRuntime += `${hours}h `;
            if (minutes > 0 || hours > 0) formattedRuntime += `${minutes}m `;
            formattedRuntime += `${seconds}s`;
            
            return formattedRuntime;
          } else {
            return runtime;
          }
        } catch (error) {
          console.warn('Error calculating runtime:', error);
          return 'N/A';
        }
      },
      
      // Get CSS class for job status
      getStatusClass: function(status) {
        if (!status) return 'bg-gray-600';
        
        switch (status.toLowerCase()) {
          case 'running':
            return 'bg-green-600';
          case 'completed':
            return 'bg-blue-600';
          case 'pending':
            return 'bg-gray-600';
          default:
            return 'bg-red-600';
        }
      },
      
      // Get CSS class for scan type
      getScanTypeClass: function(scanType) {
        if (!scanType) return 'bg-gray-100 text-gray-800 border border-gray-700';
        
        switch (scanType.toLowerCase()) {
          case 'frontend':
            return 'bg-purple-100 text-purple-800 border border-purple-700';
          case 'backend':
            return 'bg-indigo-100 text-indigo-800 border border-indigo-700';
          case 'both':
            return 'bg-teal-100 text-teal-800 border border-teal-700';
          default:
            return 'bg-gray-100 text-gray-800 border border-gray-700';
        }
      },
      
      // Get CSS class for result status
      getResultStatusClass: function(status) {
        return status === 'completed' 
          ? 'bg-green-100 text-green-800 border border-green-700'
          : 'bg-red-100 text-red-800 border border-red-700';
      },
      
      // Validate app range format
      validateAppRange: function(value) {
        if (!value) return true; // Empty is valid
        
        // Format: 1-3,5,7-9
        const regex = /^(\d+(-\d+)?)(,\d+(-\d+)?)*$/;
        return regex.test(value);
      },
      
      // Count visible rows in a table
      countVisibleRows: function(tableBody, rowClass) {
        let visibleCount = 0;
        if (!tableBody) return visibleCount;
        
        const rows = tableBody.querySelectorAll(rowClass);
        
        rows.forEach(row => {
          if (row.style.display !== 'none') {
            visibleCount++;
          }
        });
        
        return visibleCount;
      },
      
      // Add event listener with tracking for easier cleanup
      addEventListenerWithTracking: function(element, eventType, handler, identifier) {
        if (!element) return;
        
        // Create unique identifier if not provided
        const id = identifier || `${eventType}-${Math.random().toString(36).substr(2, 9)}`;
        
        // Remove any existing handler with this ID
        this.removeEventListener(id);
        
        // Create wrapped handler that logs errors
        const wrappedHandler = function(event) {
          try {
            handler.call(this, event);
          } catch (error) {
            console.error(`Error in ${eventType} handler:`, error);
          }
        };
        
        // Store reference to the handler
        eventListeners[id] = {
          element: element,
          eventType: eventType,
          handler: wrappedHandler
        };
        
        // Add the event listener
        element.addEventListener(eventType, wrappedHandler);
        
        return id;
      },
      
      // Remove event listener by ID
      removeEventListener: function(id) {
        const listener = eventListeners[id];
        if (listener) {
          const { element, eventType, handler } = listener;
          if (element) {
            element.removeEventListener(eventType, handler);
          }
          delete eventListeners[id];
        }
      },
      
      // Clean up all event listeners for a specific element
      cleanupElementListeners: function(element) {
        if (!element) return;
        
        Object.keys(eventListeners).forEach(id => {
          if (eventListeners[id].element === element) {
            this.removeEventListener(id);
          }
        });
      },
      
      // Clean up all event listeners
      cleanupAllListeners: function() {
        Object.keys(eventListeners).forEach(id => {
          this.removeEventListener(id);
        });
      },
      
      // Show toast notification
      showToast: function(type, title, message, duration = 3000) {
        if (!elements.toastTpl || !elements.toastContainer) return null;
        
        const template = elements.toastTpl.content.cloneNode(true);
        const toast = template.querySelector('.toast-notification');
        
        // Set content
        template.querySelector('.toast-title').textContent = title;
        template.querySelector('.toast-message').textContent = message;
        
        // Set styles based on type
        const iconPath = template.querySelector('.toast-icon svg path');
        iconPath.setAttribute('stroke-linecap', 'round');
        iconPath.setAttribute('stroke-linejoin', 'round');
        iconPath.setAttribute('stroke-width', '2');
        
        switch (type) {
          case 'success':
            toast.classList.add('bg-green-50', 'border-l-4', 'border-green-600', 'text-green-800');
            iconPath.setAttribute('d', 'M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z');
            break;
          case 'error':
            toast.classList.add('bg-red-50', 'border-l-4', 'border-red-600', 'text-red-800');
            iconPath.setAttribute('d', 'M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z');
            break;
          case 'warning':
            toast.classList.add('bg-yellow-50', 'border-l-4', 'border-yellow-600', 'text-yellow-800');
            iconPath.setAttribute('d', 'M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z');
            break;
          case 'info':
          default:
            toast.classList.add('bg-blue-50', 'border-l-4', 'border-blue-600', 'text-blue-800');
            iconPath.setAttribute('d', 'M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z');
            break;
        }
        
        // Add close button event listener
        const closeButton = template.querySelector('.toast-close');
        this.addEventListenerWithTracking(closeButton, 'click', () => {
          toast.classList.add('translate-x-full', 'opacity-0');
          setTimeout(() => {
            if (toast.parentNode) {
              elements.toastContainer.removeChild(toast);
            }
          }, 300);
        }, `toast-close-${Date.now()}`);
        
        // Add to container
        elements.toastContainer.appendChild(template);
        
        // Animate in
        setTimeout(() => {
          toast.classList.remove('translate-x-full', 'opacity-0');
        }, 10);
        
        // Auto-dismiss
        if (duration > 0) {
          setTimeout(() => {
            if (toast.parentNode) {
              toast.classList.add('translate-x-full', 'opacity-0');
              setTimeout(() => {
                if (toast.parentNode) {
                  elements.toastContainer.removeChild(toast);
                }
              }, 300);
            }
          }, duration);
        }
        
        return toast;
      },
      
      // Export data to CSV
      exportToCSV: function(data, filename) {
        if (!data || !data.length) return;
        
        const csvContent = data.map(row => {
          return Object.values(row).map(value => {
            // Wrap strings with commas in quotes
            if (typeof value === 'string' && value.includes(',')) {
              return `"${value}"`;
            }
            return value;
          }).join(',');
        }).join('\n');
        
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        
        const link = document.createElement('a');
        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.visibility = 'hidden';
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // Clean up
        setTimeout(() => {
          URL.revokeObjectURL(url);
        }, 100);
      },
      
      // Trap focus within a modal for accessibility
      trapFocus: function(element) {
        if (!element) return;
        
        // Save last focused element
        lastFocusedElement = document.activeElement;
        
        // Find focusable elements
        const focusableElements = element.querySelectorAll(
          'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
        );
        
        if (focusableElements.length === 0) return;
        
        const firstElement = focusableElements[0];
        const lastElement = focusableElements[focusableElements.length - 1];
        
        // Focus first element
        firstElement.focus();
        
        // Handle keydown for tab key
        const handleTabKey = function(e) {
          if (e.key === 'Tab') {
            if (e.shiftKey && document.activeElement === firstElement) {
              e.preventDefault();
              lastElement.focus();
            } else if (!e.shiftKey && document.activeElement === lastElement) {
              e.preventDefault();
              firstElement.focus();
            }
          } else if (e.key === 'Escape') {
            // Close the modal on Escape
            if (element === elements.jobDetailsSection) {
              elements.closeJobDetails.click();
            } else if (element === elements.resultDetailsSection) {
              elements.closeResultDetails.click();
            }
          }
        };
        
        // Add event listener for keydown
        this.addEventListenerWithTracking(element, 'keydown', handleTabKey, `trap-focus-${element.id}`);
      },
      
      // Restore focus when modal is closed
      restoreFocus: function() {
        if (lastFocusedElement && typeof lastFocusedElement.focus === 'function') {
          lastFocusedElement.focus();
        }
      },
      
      // Debounce function for input handlers
      debounce: function(func, wait = DEBOUNCE_DELAY) {
        let timeout;
        return function(...args) {
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(this, args), wait);
        };
      },
      
      // Handle API errors consistently
      handleApiError: function(error, retryCallback = null) {
        console.error('API Error:', error);
        
        let errorMessage = 'An unexpected error occurred.';
        
        if (error.response) {
          // Server returned an error response
          errorMessage = `Server error: ${error.response.status} ${error.response.statusText}`;
        } else if (error.request) {
          // Request made but no response received
          errorMessage = 'No response from server. Please check your connection.';
        } else {
          // Error setting up the request
          errorMessage = error.message || errorMessage;
        }
        
        const errorHtml = `
          <div class="p-4 text-center">
            <div class="inline-block border border-red-700 bg-red-50 p-2 rounded-md">
              <p class="text-xs font-bold text-red-700">${errorMessage}</p>
              ${retryCallback ? `
                <button id="retryBtn" class="mt-2 px-3 py-1 text-xs bg-red-700 text-white rounded hover:bg-red-800 transition">
                  Retry
                </button>
              ` : ''}
            </div>
          </div>
        `;
        
        return { message: errorMessage, html: errorHtml, addRetryButton: retryCallback };
      },
      
      // Stop job polling safely
      stopJobPolling: function() {
        if (activeJobPollingInterval) {
          clearInterval(activeJobPollingInterval);
          activeJobPollingInterval = null;
          pollingErrorCount = 0;
        }
      },
      
      // Parse app ranges safely
      parseAppRanges: function(rangeStr) {
        if (!rangeStr || typeof rangeStr !== 'string' || rangeStr.trim() === '') {
          return null; // No specific ranges, use all apps
        }
        
        try {
          // Split by commas
          const parts = rangeStr.split(',');
          let ranges = [];
          
          for (const part of parts) {
            // Check if it's a range (contains a hyphen)
            if (part.includes('-')) {
              const [start, end] = part.split('-').map(num => parseInt(num.trim(), 10));
              if (isNaN(start) || isNaN(end)) continue;
              
              // Add all numbers in the range
              for (let i = start; i <= end; i++) {
                ranges.push(i);
              }
            } else {
              // Single number
              const num = parseInt(part.trim(), 10);
              if (!isNaN(num)) {
                ranges.push(num);
              }
            }
          }
          
          // Remove duplicates and sort
          return [...new Set(ranges)].sort((a, b) => a - b);
        } catch (error) {
          console.warn('Error parsing app ranges:', error);
          return null;
        }
      }
    };
    
    // Centralized filter function - works for jobs, results, and issues
    function setupFilter(options) {
      const { 
        searchInput, 
        filters, 
        container, 
        itemSelector, 
        counterElement, 
        totalCountElement,
        visibleCountElement,
        noResultsElement,
        getSearchData
      } = options;
      
      // Initialize filter values
      const filterValues = {};
      filters.forEach(filter => {
        filterValues[filter.id] = filter.element?.value || 'all';
      });
      
      // Create debounced filter function
      const debouncedFilter = utils.debounce(() => {
        if (!container) return;
        
        // Get current search text
        const searchText = searchInput?.value?.toLowerCase() || '';
        
        // Get current filter values
        filters.forEach(filter => {
          if (filter.element) {
            filterValues[filter.id] = filter.element.value;
          }
        });
        
        // Apply filters to items
        const items = container.querySelectorAll(itemSelector);
        let visibleCount = 0;
        
        items.forEach(item => {
          // Check if item matches search
          const itemText = getSearchData ? getSearchData(item) : item.textContent.toLowerCase();
          const matchesSearch = !searchText || itemText.includes(searchText);
          
          // Check if item matches all filters
          let matchesAllFilters = true;
          filters.forEach(filter => {
            if (filter.getValue) {
              const filterValue = filterValues[filter.id];
              if (filterValue !== 'all') {
                const itemValue = filter.getValue(item);
                matchesAllFilters = matchesAllFilters && (itemValue === filterValue);
              }
            }
          });
          
          // Update visibility
          const isVisible = matchesSearch && matchesAllFilters;
          item.style.display = isVisible ? '' : 'none';
          
          if (isVisible) visibleCount++;
        });
        
        // Update counter if provided
        if (visibleCountElement) {
          visibleCountElement.textContent = visibleCount;
        }
        
        if (totalCountElement) {
          totalCountElement.textContent = items.length;
        }
        
        // Show/hide no results message
        if (noResultsElement) {
          noResultsElement.style.display = visibleCount === 0 ? '' : 'none';
        }
        
        // Update counter element if provided
        if (counterElement) {
          counterElement.textContent = `Showing ${visibleCount} of ${items.length} ${options.itemName || 'items'}`;
        }
      });
      
      // Add event listeners
      if (searchInput) {
        utils.addEventListenerWithTracking(searchInput, 'input', debouncedFilter, `filter-search-${searchInput.id}`);
      }
      
      filters.forEach(filter => {
        if (filter.element) {
          utils.addEventListenerWithTracking(filter.element, 'change', debouncedFilter, `filter-${filter.id}`);
        }
      });
      
      // Initial filter
      debouncedFilter();
      
      // Return control methods
      return {
        filter: debouncedFilter,
        reset: function() {
          if (searchInput) searchInput.value = '';
          
          filters.forEach(filter => {
            if (filter.element) {
              filter.element.value = 'all';
            }
          });
          
          debouncedFilter();
        }
      };
    }
    
    // Event handlers for form toggle and submission
    function setupFormEvents() {
      // Toggle create form visibility
      if (elements.toggleCreateForm) {
        utils.addEventListenerWithTracking(elements.toggleCreateForm, 'click', () => {
          const isHidden = elements.createJobForm.classList.contains('hidden');
          
          // Toggle visibility
          elements.createJobForm.classList.toggle('hidden');
          elements.toggleCreateForm.innerHTML = isHidden ? `
            <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>Cancel` 
            : `
            <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
            </svg>New Batch Job`;
          
          // Update ARIA attributes
          elements.toggleCreateForm.setAttribute('aria-expanded', isHidden);
          elements.createJobForm.setAttribute('aria-hidden', !isHidden);
          
          // Focus first input if showing form
          if (isHidden) {
            setTimeout(() => {
              const firstInput = elements.createJobForm.querySelector('input, select, textarea');
              if (firstInput) firstInput.focus();
            }, 100);
          }
        }, 'toggle-create-form');
      }
      
      // Cancel button in form
      if (elements.cancelCreateForm) {
        utils.addEventListenerWithTracking(elements.cancelCreateForm, 'click', () => {
          elements.createJobForm.classList.add('hidden');
          elements.toggleCreateForm.innerHTML = `
            <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
            </svg>New Batch Job`;
          elements.toggleCreateForm.setAttribute('aria-expanded', 'false');
          elements.createJobForm.setAttribute('aria-hidden', 'true');
          elements.toggleCreateForm.focus();
        }, 'cancel-create-form');
      }
      
      // No jobs create button
      if (elements.noJobsCreateBtn) {
        utils.addEventListenerWithTracking(elements.noJobsCreateBtn, 'click', () => {
          elements.createJobForm.classList.remove('hidden');
          elements.toggleCreateForm.innerHTML = `
            <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>Cancel`;
          elements.toggleCreateForm.setAttribute('aria-expanded', 'true');
          elements.createJobForm.setAttribute('aria-hidden', 'false');
          
          setTimeout(() => {
            const firstInput = elements.createJobForm.querySelector('input, select, textarea');
            if (firstInput) firstInput.focus();
          }, 100);
        }, 'no-jobs-create-btn');
      }
      
      // Form validation and submission
      if (elements.batchJobForm) {
        // Validate model checkboxes
        const validateModels = () => {
          const modelCheckboxes = document.querySelectorAll('.model-checkbox');
          const isValid = Array.from(modelCheckboxes).some(cb => cb.checked);
          const errorMsg = document.querySelector('.models-error-msg');
          
          if (errorMsg) {
            errorMsg.classList.toggle('hidden', isValid);
          }
          
          return isValid;
        };
        
        // Validate app ranges
        const validateAppRanges = () => {
          const visibleAppRanges = document.querySelectorAll('.app-range-field:not(.hidden) input');
          let isValid = true;
          
          visibleAppRanges.forEach(input => {
            const value = input.value.trim();
            const errorMsg = input.parentNode.nextElementSibling;
            const validFormat = utils.validateAppRange(value);
            
            if (errorMsg) {
              errorMsg.classList.toggle('hidden', validFormat);
            }
            
            isValid = isValid && validFormat;
          });
          
          return isValid;
        };
        
        // Handle form submission
        utils.addEventListenerWithTracking(elements.batchJobForm, 'submit', function(e) {
          // Validate models
          if (!validateModels()) {
            e.preventDefault();
            document.querySelector('.models-error-msg').scrollIntoView({ behavior: 'smooth', block: 'center' });
            return;
          }
          
          // Validate app ranges
          if (!validateAppRanges()) {
            e.preventDefault();
            const firstError = document.querySelector('.app-range-error:not(.hidden)');
            if (firstError) {
              firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            return;
          }
          
          // Set create button to loading state
          const submitBtn = this.querySelector('button[type="submit"]');
          if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.innerHTML = `
              <svg class="animate-spin w-3 h-3 inline mr-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>Creating...`;
          }
        }, 'batch-job-form-submit');
        
        // Monitor model checkboxes to show/hide app range fields
        const modelCheckboxes = document.querySelectorAll('input[name="models"]');
        const appRangeFields = document.querySelectorAll('.app-range-field');
        
        function updateAppRangeFields() {
          const selectedModels = Array.from(modelCheckboxes)
            .filter(cb => cb.checked)
            .map(cb => cb.value);
          
          appRangeFields.forEach(field => {
            const model = field.dataset.model;
            field.classList.toggle('hidden', !selectedModels.includes(model));
          });
          
          // Validate models whenever selection changes
          validateModels();
        }
        
        modelCheckboxes.forEach((cb, index) => {
          utils.addEventListenerWithTracking(cb, 'change', updateAppRangeFields, `model-checkbox-${index}`);
        });
        
        // Validate app ranges when inputs change
        appRangeFields.forEach((field, index) => {
          const input = field.querySelector('input');
          if (input) {
            utils.addEventListenerWithTracking(input, 'input', () => {
              const value = input.value.trim();
              const errorMsg = input.parentNode.nextElementSibling;
              const validFormat = utils.validateAppRange(value);
              
              if (errorMsg) {
                errorMsg.classList.toggle('hidden', validFormat);
              }
            }, `app-range-${index}`);
          }
        });
        
        // Initial update
        updateAppRangeFields();
      }
    }
    
    // Set up job/result section toggle and close buttons
    function setupSectionToggles() {
      // Job details close button
      if (elements.closeJobDetails) {
        utils.addEventListenerWithTracking(elements.closeJobDetails, 'click', () => {
          elements.jobDetailsSection.classList.add('hidden');
          elements.jobDetailsSection.setAttribute('aria-hidden', 'true');
          
          // Stop polling if active
          utils.stopJobPolling();
          
          // Restore focus
          utils.restoreFocus();
        }, 'close-job-details');
      }
      
      // Result details close button
      if (elements.closeResultDetails) {
        utils.addEventListenerWithTracking(elements.closeResultDetails, 'click', () => {
          elements.resultDetailsSection.classList.add('hidden');
          elements.resultDetailsSection.setAttribute('aria-hidden', 'true');
          
          // Restore focus
          utils.restoreFocus();
        }, 'close-result-details');
      }
      
      // Global click handler for dynamic buttons
      document.addEventListener('click', function(e) {
        // View job button clicked
        if (e.target.classList.contains('view-job-btn') || e.target.closest('.view-job-btn')) {
          e.preventDefault();
          
          const button = e.target.classList.contains('view-job-btn') ? e.target : e.target.closest('.view-job-btn');
          const jobId = button.dataset.jobId;
          if (jobId) {
            // Store the button as last focused element
            lastFocusedElement = button;
            loadJobDetails(jobId);
          }
        }
        
        // Cancel job button clicked
        if (e.target.classList.contains('cancel-job-btn') || e.target.closest('.cancel-job-btn')) {
          const button = e.target.classList.contains('cancel-job-btn') ? e.target : e.target.closest('.cancel-job-btn');
          const jobId = button.dataset.jobId;
          if (jobId) {
            cancelJob(jobId, button);
          }
        }
        
        // View result button clicked
        if (e.target.classList.contains('view-result-btn') || e.target.closest('.view-result-btn')) {
          const button = e.target.classList.contains('view-result-btn') ? e.target : e.target.closest('.view-result-btn');
          const resultId = button.dataset.resultId;
          if (resultId) {
            // Store the button as last focused element
            lastFocusedElement = button;
            loadResultDetails(resultId);
          }
        }
        
        // Toggle issue details button
        if (e.target.classList.contains('toggle-issue') || e.target.closest('.toggle-issue')) {
          const button = e.target.classList.contains('toggle-issue') ? e.target : e.target.closest('.toggle-issue');
          const issueDetails = button.closest('.space-y-2').querySelector('.issue-details');
          
          if (issueDetails) {
            const isExpanded = !issueDetails.classList.contains('hidden');
            issueDetails.classList.toggle('hidden');
            button.textContent = isExpanded ? 'Expand' : 'Collapse';
            button.setAttribute('aria-expanded', !isExpanded);
          }
        }
        
        // Export results button
        if (e.target.id === 'exportResultsBtn' || e.target.closest('#exportResultsBtn')) {
          const jobId = document.querySelector('#job-id')?.textContent;
          if (jobId) {
            exportJobResults(jobId);
          }
        }
        
        // Expand all issues button
        if (e.target.id === 'expandAllIssues' || e.target.closest('#expandAllIssues')) {
          const button = e.target.id === 'expandAllIssues' ? e.target : e.target.closest('#expandAllIssues');
          const issueContainer = button.closest('#issues-container');
          
          if (issueContainer) {
            const issuesToggles = issueContainer.querySelectorAll('.toggle-issue');
            const allExpanded = Array.from(issuesToggles).every(btn => btn.textContent === 'Collapse');
            
            issuesToggles.forEach(toggle => {
              const issueDetails = toggle.closest('.space-y-2').querySelector('.issue-details');
              if (issueDetails) {
                if (allExpanded) {
                  // Collapse all
                  issueDetails.classList.add('hidden');
                  toggle.textContent = 'Expand';
                  toggle.setAttribute('aria-expanded', 'false');
                } else {
                  // Expand all
                  issueDetails.classList.remove('hidden');
                  toggle.textContent = 'Collapse';
                  toggle.setAttribute('aria-expanded', 'true');
                }
              }
            });
            
            // Update button text
            button.textContent = allExpanded ? 'Expand All' : 'Collapse All';
          }
        }
      });
    }
    
    // Filter functionality for job list
    function setupJobFilters() {
      if (!elements.searchJobs || !elements.modelFilter || !elements.statusFilter || !elements.scanTypeFilter) return;
      
      const jobFilters = setupFilter({
        searchInput: elements.searchJobs,
        filters: [
          {
            id: 'model',
            element: elements.modelFilter,
            getValue: (item) => {
              return item.dataset.models ? item.dataset.models.toLowerCase() : '';
            }
          },
          {
            id: 'scanType',
            element: elements.scanTypeFilter,
            getValue: (item) => {
              return item.dataset.scanType ? item.dataset.scanType.toLowerCase() : '';
            }
          },
          {
            id: 'status',
            element: elements.statusFilter,
            getValue: (item) => {
              return item.dataset.status ? item.dataset.status.toLowerCase() : '';
            }
          }
        ],
        container: elements.jobsTableBody,
        itemSelector: '.job-row',
        visibleCountElement: elements.visibleJobsCount,
        noResultsElement: document.getElementById('noResultsRow'),
        getSearchData: (item) => {
          return [
            item.dataset.name || '',
            item.dataset.models || '',
            item.dataset.scanType || '',
            item.textContent
          ].join(' ').toLowerCase();
        },
        itemName: 'jobs'
      });
      
      // Clear filters button
      if (elements.clearFilters) {
        utils.addEventListenerWithTracking(elements.clearFilters, 'click', () => {
          jobFilters.reset();
          
          // Focus search input after clearing
          elements.searchJobs.focus();
        }, 'clear-job-filters');
      }
    }
    
    // Load job details and populate the details panel
    async function loadJobDetails(jobId) {
      // Stop any existing polling
      utils.stopJobPolling();
      
      // Show the job details section and set loading state
      elements.jobDetailsSection.classList.remove('hidden');
      elements.jobDetailsSection.setAttribute('aria-hidden', 'false');
      elements.jobDetailsTitle.textContent = `Job Details: #${jobId}`;
      elements.jobDetailsContent.innerHTML = `
        <div class="flex justify-center p-4">
          <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
        </div>
      `;
      
      // Trap focus in the modal
      utils.trapFocus(elements.jobDetailsSection);
      
      try {
        // Fetch job details from API
        const response = await fetch(`/batch-analysis/job/${jobId}/status`);
        if (!response.ok) {
          throw new Error(`Failed to load job details: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        // Clone the template
        const template = elements.jobDetailsTpl.content.cloneNode(true);
        
        // Populate job information
        template.getElementById('job-id').textContent = data.id;
        template.getElementById('job-name').textContent = data.name || `Job #${data.id}`;
        
        // Status with correct styling
        const statusElement = template.getElementById('job-status');
        statusElement.textContent = data.status;
        statusElement.className = `px-2 py-0.5 rounded-md text-white ${utils.getStatusClass(data.status)}`;
        
        // Scan type with correct styling
        const scanTypeElement = template.getElementById('job-scan-type');
        scanTypeElement.textContent = data.scan_type || 'frontend';
        scanTypeElement.className = `px-2 py-0.5 rounded-md ${utils.getScanTypeClass(data.scan_type)}`;
        
        template.getElementById('job-created').textContent = utils.formatDateTime(data.created_at);
        template.getElementById('job-started').textContent = utils.formatDateTime(data.started_at);
        template.getElementById('job-completed').textContent = utils.formatDateTime(data.completed_at);
        template.getElementById('job-models').textContent = Array.isArray(data.models) ? data.models.join(', ') : 'None';
        template.getElementById('job-full-scan').textContent = data.scan_options?.full_scan ? 'Yes' : 'No (Quick Scan)';
        
        // Progress information
        const progressBar = template.getElementById('progress-bar');
        const progress = data.progress?.percent || 0;
        progressBar.style.width = `${progress}%`;
        progressBar.textContent = `${progress}%`;
        
        template.getElementById('completed-tasks').textContent = `${data.progress?.completed || 0}/${data.progress?.total || 0} tasks`;
        
        // Calculate and set runtime
        const runtime = utils.calculateRuntime(data);
        template.getElementById('runtime').textContent = runtime;
        
        // Issue counts
        template.getElementById('high-issues').textContent = data.results_summary?.issues?.high || 0;
        template.getElementById('medium-issues').textContent = data.results_summary?.issues?.medium || 0;
        template.getElementById('low-issues').textContent = data.results_summary?.issues?.low || 0;
        template.getElementById('total-issues').textContent = data.results_summary?.issues?.total || 0;
        
        // Show scan type-specific stats for "both" scan type
        const scanTypeStats = template.getElementById('scan-type-stats');
        if (data.scan_type === 'both') {
          scanTypeStats.classList.remove('hidden');
          
          // Frontend issues
          template.getElementById('frontend-high-issues').textContent = data.results_summary?.frontend?.issues?.high || 0;
          template.getElementById('frontend-medium-issues').textContent = data.results_summary?.frontend?.issues?.medium || 0;
          template.getElementById('frontend-low-issues').textContent = data.results_summary?.frontend?.issues?.low || 0;
          template.getElementById('frontend-total-issues').textContent = `${data.results_summary?.frontend?.issues?.total || 0} total`;
          
          // Backend issues
          template.getElementById('backend-high-issues').textContent = data.results_summary?.backend?.issues?.high || 0;
          template.getElementById('backend-medium-issues').textContent = data.results_summary?.backend?.issues?.medium || 0;
          template.getElementById('backend-low-issues').textContent = data.results_summary?.backend?.issues?.low || 0;
          template.getElementById('backend-total-issues').textContent = `${data.results_summary?.backend?.issues?.total || 0} total`;
        }
        
        // Populate results table
        await loadJobResults(jobId, template.getElementById('results-table-body'), 
                            template.getElementById('resultModelFilter'),
                            template.getElementById('resultScanTypeFilter'));
        
        // Show/hide errors section
        const errorsSection = template.getElementById('errors-section');
        const errorsList = template.getElementById('errors-list');
        
        if (data.errors && data.errors.length > 0) {
          errorsSection.classList.remove('hidden');
          errorsList.innerHTML = '';
          
          data.errors.forEach(error => {
            const li = document.createElement('li');
            li.textContent = error;
            errorsList.appendChild(li);
          });
        }
        
        // Replace the content with the populated template
        elements.jobDetailsContent.innerHTML = '';
        elements.jobDetailsContent.appendChild(template);
        
        // Set up result filters
        setupResultFilters();
        
        // If job is still running, set up polling
        if (data.status === 'running') {
          // Reset error count
          pollingErrorCount = 0;
          
          // Set up new polling interval
          activeJobPollingInterval = setInterval(() => {
            refreshJobDetails(jobId);
          }, POLLING_INTERVAL);
        }
        
      } catch (error) {
        console.error('Error loading job details:', error);
        
        const errorResult = utils.handleApiError(error, () => loadJobDetails(jobId));
        
        elements.jobDetailsContent.innerHTML = errorResult.html;
        
        // Add retry button functionality
        const retryBtn = document.getElementById('retryBtn');
        if (retryBtn && errorResult.addRetryButton) {
          utils.addEventListenerWithTracking(retryBtn, 'click', errorResult.addRetryButton, 'retry-job-details');
        }
      }
    }
    
    // Load job results for the given job ID
    async function loadJobResults(jobId, tableBody, modelFilterSelect, scanTypeFilterSelect) {
      if (!tableBody) return;
      
      try {
        // Fetch results from API
        const response = await fetch(`/batch-analysis/job/${jobId}/results`);
        if (!response.ok) {
          throw new Error(`Failed to load job results: ${response.statusText}`);
        }
        
        const data = await response.json();
        const results = data.results || [];
        
        if (results.length === 0) {
          tableBody.innerHTML = `
            <tr>
              <td colspan="10" class="border border-gray-300 px-2 py-4 text-xs text-center text-gray-500">
                No results available yet
              </td>
            </tr>
          `;
          
          // Update result counter
          updateResultsCounter(0, 0);
          return;
        }
        
        // Clear table and filter options
        tableBody.innerHTML = '';
        
        // Set up model filter options
        if (modelFilterSelect) {
          // Keep the "All Models" option
          modelFilterSelect.innerHTML = '<option value="all">All Models</option>';
          
          // Add unique model options
          const models = [...new Set(results.map(r => r.model))].sort();
          models.forEach(model => {
            const option = document.createElement('option');
            option.value = model;
            option.textContent = model;
            modelFilterSelect.appendChild(option);
          });
        }
        
        // Set up scan type filter options (if both frontend and backend results exist)
        if (scanTypeFilterSelect) {
          // Keep the "All Scan Types" option
          scanTypeFilterSelect.innerHTML = '<option value="all">All Scan Types</option>';
          
          // Get unique scan types
          const scanTypes = [...new Set(results.map(r => r.scan_type))].sort();
          
          // Only add options if there are multiple scan types
          if (scanTypes.length > 0) {
            scanTypes.forEach(scanType => {
              const option = document.createElement('option');
              option.value = scanType;
              option.textContent = scanType.charAt(0).toUpperCase() + scanType.slice(1); // Capitalize
              scanTypeFilterSelect.appendChild(option);
            });
          }
        }
        
        // Add each result to the table
        results.forEach(result => {
          const template = elements.resultItemTpl.content.cloneNode(true);
          const row = template.querySelector('tr');
          
          // Set data attributes for filtering
          row.dataset.model = result.model || '';
          row.dataset.status = result.status || '';
          row.dataset.scanType = result.scan_type || 'frontend';
          row.dataset.searchText = `${result.model} app ${result.app_num} ${result.scan_type}`.toLowerCase();
          
          // Set content
          template.querySelector('.result-model').textContent = result.model || 'Unknown';
          template.querySelector('.result-app-num').textContent = result.app_num || 'N/A';
          
          // Scan type with appropriate styling
          const scanTypeElement = template.querySelector('.result-scan-type');
          scanTypeElement.textContent = result.scan_type || 'frontend';
          scanTypeElement.className = `px-2 py-0.5 rounded-md ${utils.getScanTypeClass(result.scan_type)}`;
          
          // Status with appropriate styling
          const statusElement = template.querySelector('.result-status');
          statusElement.textContent = result.status || 'Unknown';
          statusElement.className = `px-2 py-0.5 rounded-md ${utils.getResultStatusClass(result.status)}`;
          
          // Issues counts
          template.querySelector('.result-high').textContent = result.high_severity || 0;
          template.querySelector('.result-medium').textContent = result.medium_severity || 0;
          template.querySelector('.result-low').textContent = result.low_severity || 0;
          template.querySelector('.result-total').textContent = result.issues_count || 0;
          
          // Scan time
          template.querySelector('.result-time').textContent = utils.formatDateTime(result.scan_time);
          
          // Set result ID on the view button
          const viewButton = template.querySelector('.view-result-btn');
          viewButton.dataset.resultId = result.id;
          viewButton.setAttribute('aria-label', `View details for ${result.model} App ${result.app_num} (${result.scan_type})`);
          
          tableBody.appendChild(template);
        });
        
        // Update results counter
        updateResultsCounter(results.length, results.length);
        
      } catch (error) {
        console.error('Error loading job results:', error);
        
        const errorResult = utils.handleApiError(error, () => loadJobResults(jobId, tableBody, modelFilterSelect, scanTypeFilterSelect));
        
        tableBody.innerHTML = `
          <tr>
            <td colspan="10" class="border border-gray-300 px-2 py-4 text-xs text-center text-red-600">
              ${errorResult.message}
              <button class="retry-results-btn ml-2 px-2 py-0.5 bg-red-600 text-white rounded hover:bg-red-700 transition" data-job-id="${jobId}">
                Retry
              </button>
            </td>
          </tr>
        `;
        
        // Add retry button functionality
        const retryBtn = tableBody.querySelector('.retry-results-btn');
        if (retryBtn) {
          utils.addEventListenerWithTracking(retryBtn, 'click', () => {
            loadJobResults(jobId, tableBody, modelFilterSelect, scanTypeFilterSelect);
          }, `retry-results-${jobId}`);
        }
        
        // Update results counter
        updateResultsCounter(0, 0);
      }
    }
    
    // Update results counter
    function updateResultsCounter(visibleCount, totalCount) {
      const visibleCountElement = document.getElementById('visibleResultsCount');
      const totalCountElement = document.getElementById('totalResultsCount');
      
      if (visibleCountElement) {
        visibleCountElement.textContent = visibleCount;
      }
      
      if (totalCountElement) {
        totalCountElement.textContent = totalCount;
      }
    }
    
    // Update issues counter
    function updateIssuesCounter(visibleCount, totalCount) {
      const visibleCountElement = document.getElementById('visibleIssuesCount');
      const totalCountElement = document.getElementById('totalIssuesCount');
      
      if (visibleCountElement) {
        visibleCountElement.textContent = visibleCount;
      }
      
      if (totalCountElement) {
        totalCountElement.textContent = totalCount;
      }
    }
    
    // Set up filters for results table
    function setupResultFilters() {
      const searchInput = document.getElementById('searchResults');
      const statusFilter = document.getElementById('resultStatusFilter');
      const modelFilter = document.getElementById('resultModelFilter');
      const scanTypeFilter = document.getElementById('resultScanTypeFilter');
      
      if (!searchInput || !statusFilter || !modelFilter) return;
      
      const filters = [
        {
          id: 'status',
          element: statusFilter,
          getValue: (item) => item.dataset.status || ''
        },
        {
          id: 'model',
          element: modelFilter,
          getValue: (item) => item.dataset.model || ''
        }
      ];
      
      // Add scan type filter if it exists
      if (scanTypeFilter) {
        filters.push({
          id: 'scanType',
          element: scanTypeFilter,
          getValue: (item) => item.dataset.scanType || ''
        });
      }
      
      setupFilter({
        searchInput: searchInput,
        filters: filters,
        container: document.getElementById('results-table-body'),
        itemSelector: '.result-row',
        visibleCountElement: document.getElementById('visibleResultsCount'),
        totalCountElement: document.getElementById('totalResultsCount'),
        getSearchData: (item) => item.dataset.searchText || item.textContent.toLowerCase(),
        itemName: 'results'
      });
    }
    
    // Set up filters for issues list
    function setupIssueFilters() {
      const searchInput = document.getElementById('searchIssues');
      const severityFilter = document.getElementById('severityFilter');
      const fileFilter = document.getElementById('fileFilter');
      const toolFilter = document.getElementById('toolFilter');
      
      if (!searchInput || !severityFilter || !fileFilter) return;
      
      const filters = [
        {
          id: 'severity',
          element: severityFilter,
          getValue: (item) => item.dataset.severity || ''
        },
        {
          id: 'file',
          element: fileFilter,
          getValue: (item) => item.dataset.file || ''
        }
      ];
      
      // Add tool filter if it exists
      if (toolFilter) {
        filters.push({
          id: 'tool',
          element: toolFilter,
          getValue: (item) => item.dataset.tool || ''
        });
      }
      
      setupFilter({
        searchInput: searchInput,
        filters: filters,
        container: document.getElementById('issueList'),
        itemSelector: '.issue-item',
        visibleCountElement: document.getElementById('visibleIssuesCount'),
        totalCountElement: document.getElementById('totalIssuesCount'),
        getSearchData: (item) => item.dataset.searchable || item.textContent.toLowerCase(),
        itemName: 'issues'
      });
    }
    
    // Export job results to CSV
    async function exportJobResults(jobId) {
      try {
        // Show loading toast
        const loadingToast = utils.showToast('info', 'Preparing Export', 'Generating CSV file...', 0);
        
        // Fetch results from API
        const response = await fetch(`/batch-analysis/job/${jobId}/results`);
        if (!response.ok) {
          throw new Error(`Failed to fetch results for export: ${response.statusText}`);
        }
        
        const data = await response.json();
        const results = data.results || [];
        
        if (results.length === 0) {
          utils.showToast('warning', 'Export Failed', 'No results available to export');
          if (loadingToast && loadingToast.parentNode) {
            elements.toastContainer.removeChild(loadingToast);
          }
          return;
        }
        
        // Prepare CSV data
        const csvData = [
          // Header row
          {
            Model: 'Model',
            App: 'App',
            ScanType: 'Scan Type',
            Status: 'Status',
            High: 'High Issues',
            Medium: 'Medium Issues',
            Low: 'Low Issues',
            Total: 'Total Issues',
            ScanTime: 'Scan Time'
          }
        ];
        
        // Add result rows
        results.forEach(result => {
          csvData.push({
            Model: result.model || '',
            App: `App ${result.app_num || ''}`,
            ScanType: result.scan_type || 'frontend',
            Status: result.status || '',
            High: result.high_severity || 0,
            Medium: result.medium_severity || 0,
            Low: result.low_severity || 0,
            Total: result.issues_count || 0,
            ScanTime: utils.formatDateTime(result.scan_time)
          });
        });
        
        // Generate filename
        const jobName = document.getElementById('job-name')?.textContent || `Job-${jobId}`;
        const dateStr = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
        const filename = `${jobName.replace(/[^a-z0-9]/gi, '-')}-results-${dateStr}.csv`;
        
        // Export to CSV
        utils.exportToCSV(csvData, filename);
        
        // Remove loading toast and show success
        if (loadingToast && loadingToast.parentNode) {
          elements.toastContainer.removeChild(loadingToast);
        }
        
        utils.showToast('success', 'Export Complete', `Results exported to ${filename}`);
        
      } catch (error) {
        console.error('Error exporting results:', error);
        utils.showToast('error', 'Export Failed', `Error: ${error.message}`);
      }
    }
    
    // Refresh job details for active polling
    async function refreshJobDetails(jobId) {
      try {
        const response = await fetch(`/batch-analysis/job/${jobId}/status`);
        if (!response.ok) {
          throw new Error(`Failed to refresh job status: ${response.statusText}`);
        }
        
        // Reset error count on successful request
        pollingErrorCount = 0;
        
        const data = await response.json();
        
        // Update progress information
        const progressBar = document.getElementById('progress-bar');
        if (progressBar) {
          const progress = data.progress?.percent || 0;
          progressBar.style.width = `${progress}%`;
          progressBar.textContent = `${progress}%`;
        }
        
        // Update completed tasks
        const completedTasks = document.getElementById('completed-tasks');
        if (completedTasks) {
          completedTasks.textContent = `${data.progress?.completed || 0}/${data.progress?.total || 0} tasks`;
        }
        
        // Update runtime
        const runtimeElement = document.getElementById('runtime');
        if (runtimeElement) {
          runtimeElement.textContent = utils.calculateRuntime(data);
        }
        
        // Update issue counts
        const highIssues = document.getElementById('high-issues');
        const mediumIssues = document.getElementById('medium-issues');
        const lowIssues = document.getElementById('low-issues');
        const totalIssues = document.getElementById('total-issues');
        
        if (highIssues) highIssues.textContent = data.results_summary?.issues?.high || 0;
        if (mediumIssues) mediumIssues.textContent = data.results_summary?.issues?.medium || 0;
        if (lowIssues) lowIssues.textContent = data.results_summary?.issues?.low || 0;
        if (totalIssues) totalIssues.textContent = data.results_summary?.issues?.total || 0;
        
        // Update scan type-specific issues for 'both' scan type
        if (data.scan_type === 'both') {
          const frontendHighIssues = document.getElementById('frontend-high-issues');
          const frontendMediumIssues = document.getElementById('frontend-medium-issues');
          const frontendLowIssues = document.getElementById('frontend-low-issues');
          const frontendTotalIssues = document.getElementById('frontend-total-issues');
          
          if (frontendHighIssues) frontendHighIssues.textContent = data.results_summary?.frontend?.issues?.high || 0;
          if (frontendMediumIssues) frontendMediumIssues.textContent = data.results_summary?.frontend?.issues?.medium || 0;
          if (frontendLowIssues) frontendLowIssues.textContent = data.results_summary?.frontend?.issues?.low || 0;
          if (frontendTotalIssues) frontendTotalIssues.textContent = `${data.results_summary?.frontend?.issues?.total || 0} total`;
          
          const backendHighIssues = document.getElementById('backend-high-issues');
          const backendMediumIssues = document.getElementById('backend-medium-issues');
          const backendLowIssues = document.getElementById('backend-low-issues');
          const backendTotalIssues = document.getElementById('backend-total-issues');
          
          if (backendHighIssues) backendHighIssues.textContent = data.results_summary?.backend?.issues?.high || 0;
          if (backendMediumIssues) backendMediumIssues.textContent = data.results_summary?.backend?.issues?.medium || 0;
          if (backendLowIssues) backendLowIssues.textContent = data.results_summary?.backend?.issues?.low || 0;
          if (backendTotalIssues) backendTotalIssues.textContent = `${data.results_summary?.backend?.issues?.total || 0} total`;
        }
        
        // Update job status
        const statusElement = document.getElementById('job-status');
        if (statusElement) {
          statusElement.textContent = data.status;
          statusElement.className = `px-2 py-0.5 rounded-md text-white ${utils.getStatusClass(data.status)}`;
        }
        
        // If job is no longer running
        if (data.status !== 'running') {
          // Update completed time
          const completedElement = document.getElementById('job-completed');
          if (completedElement) {
            completedElement.textContent = utils.formatDateTime(data.completed_at);
          }
          
          // Refresh the results table
          const resultsTableBody = document.getElementById('results-table-body');
          const modelFilterSelect = document.getElementById('resultModelFilter');
          const scanTypeFilterSelect = document.getElementById('resultScanTypeFilter');
          if (resultsTableBody) {
            await loadJobResults(jobId, resultsTableBody, modelFilterSelect, scanTypeFilterSelect);
            setupResultFilters();
          }
          
          // Stop polling
          utils.stopJobPolling();
          
          // Show toast notification
          utils.showToast(
            data.status === 'completed' ? 'success' : 'warning',
            'Job Update',
            `Job #${jobId} ${data.status}`,
            5000
          );
          
          // Update main job list if it exists
          const jobRow = document.querySelector(`.job-row[data-job-id="${jobId}"]`);
          if (jobRow) {
            // Update status cell
            const statusCell = jobRow.querySelector('td:nth-child(3) span');
            if (statusCell) {
              statusCell.textContent = data.status;
              statusCell.className = `px-2 py-0.5 rounded-md text-white ${utils.getStatusClass(data.status)}`;
            }
            
            // Update progress bar
            const progressBar = jobRow.querySelector('td:nth-child(7) .bg-blue-600');
            const progressText = jobRow.querySelector('td:nth-child(7) .text-xs.text-gray-600');
            
            if (progressBar) {
              progressBar.style.width = `${data.progress?.percent || 0}%`;
            }
            
            if (progressText) {
              progressText.textContent = `${data.progress?.completed || 0}/${data.progress?.total || 0}`;
            }
            
            // Update issues counts if completed
            if (data.status === 'completed') {
              const issuesCell = jobRow.querySelector('td:nth-child(8)');
              if (issuesCell && data.results_summary?.issues) {
                issuesCell.innerHTML = `
                  <div class="flex space-x-1">
                    <span class="px-1 bg-red-100 text-red-800 border border-red-700 rounded" title="High severity issues">${data.results_summary.issues.high || 0}</span>
                    <span class="px-1 bg-yellow-100 text-yellow-800 border border-yellow-700 rounded" title="Medium severity issues">${data.results_summary.issues.medium || 0}</span>
                    <span class="px-1 bg-blue-100 text-blue-800 border border-blue-700 rounded" title="Low severity issues">${data.results_summary.issues.low || 0}</span>
                  </div>
                `;
              }
            }
            
            // Remove cancel button if present
            const cancelBtn = jobRow.querySelector('.cancel-job-btn');
            if (cancelBtn) {
              cancelBtn.remove();
            }
            
            // Update dataset status
            jobRow.dataset.status = data.status;
            
            // Reapply filters
            filterJobs();
          }
        }
        
      } catch (error) {
        console.error('Error refreshing job details:', error);
        
        // Increment error count
        pollingErrorCount++;
        
        // Stop polling if there are persistent errors
        if (pollingErrorCount >= MAX_POLLING_ERRORS) {
          console.warn(`Stopping polling after ${MAX_POLLING_ERRORS} consecutive errors`);
          
          utils.stopJobPolling();
          
          // Show error toast
          utils.showToast('error', 'Connection Lost', 'Failed to update job status. Please refresh the page.');
        }
      }
    }
    
    // Cancel a running job
    async function cancelJob(jobId, button) {
      if (!confirm('Are you sure you want to cancel this job?')) {
        return;
      }
      
      // Set button to loading state
      const originalText = button.textContent;
      button.disabled = true;
      button.innerHTML = `
        <svg class="animate-spin w-3 h-3 inline mr-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>Canceling...`;
      
      try {
        // Send cancel request to API
        const response = await fetch(`/batch-analysis/job/${jobId}/cancel`, {
          method: 'POST',
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/json'
          }
        });
        
        if (!response.ok) {
          throw new Error(`Failed to cancel job: ${response.statusText}`);
        }
        
        // Update the UI
        const data = await response.json();
        
        if (data.status === 'canceled' || data.status === 'cancelled') {
          // Update job row status
          const jobRow = document.querySelector(`.job-row[data-job-id="${jobId}"]`);
          if (jobRow) {
            const statusCell = jobRow.querySelector('td:nth-child(3) span');
            if (statusCell) {
              statusCell.textContent = 'canceled';
              statusCell.className = 'px-2 py-0.5 rounded-md text-white bg-red-600';
            }
            
            jobRow.dataset.status = 'canceled';
            
            // Remove the cancel button
            button.remove();
          }
          
          // If job details are open, update them
          if (elements.jobDetailsSection && !elements.jobDetailsSection.classList.contains('hidden')) {
            // Refresh job details
            loadJobDetails(jobId);
          }
          
          // Show success toast
          utils.showToast('success', 'Job Canceled', `Job #${jobId} has been successfully canceled`);
        } else {
          utils.showToast('error', 'Cancel Failed', data.error || 'Failed to cancel job');
          
          // Reset button state if it still exists
          if (button.parentNode) {
            button.disabled = false;
            button.textContent = originalText;
          }
        }
        
      } catch (error) {
        console.error('Error canceling job:', error);
        utils.showToast('error', 'Cancel Failed', `Error: ${error.message}`);
        
        // Reset button state if it still exists
        if (button.parentNode) {
          button.disabled = false;
          button.textContent = originalText;
        }
      }
    }
    
    // Load result details
    async function loadResultDetails(resultId) {
      // Show the result details section and set loading state
      elements.resultDetailsSection.classList.remove('hidden');
      elements.resultDetailsSection.setAttribute('aria-hidden', 'false');
      elements.resultDetailsTitle.textContent = `Result Details: #${resultId}`;
      elements.resultDetailsContent.innerHTML = `
        <div class="flex justify-center p-4">
          <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
        </div>
      `;
      
      // Trap focus in the modal
      utils.trapFocus(elements.resultDetailsSection);
      
      try {
        // Fetch result details from API
        const response = await fetch(`/batch-analysis/result/${resultId}/data`);
        if (!response.ok) {
          throw new Error(`Failed to load result details: ${response.statusText}`);
        }
        
        const result = await response.json();
        
        // Clone the template
        const template = elements.resultDetailsTpl.content.cloneNode(true);
        
        // Populate result information
        template.getElementById('result-id').textContent = result.id;
        template.getElementById('result-model').textContent = result.model || 'Unknown';
        template.getElementById('result-app-num').textContent = result.app_num || 'N/A';
        
        // Scan type with correct styling
        const scanTypeElement = template.getElementById('result-scan-type');
        scanTypeElement.textContent = result.scan_type || 'frontend';
        scanTypeElement.className = `px-2 py-0.5 rounded-md ${utils.getScanTypeClass(result.scan_type)}`;
        
        // Status with correct styling
        const statusElement = template.getElementById('result-status');
        statusElement.textContent = result.status || 'Unknown';
        statusElement.className = `px-2 py-0.5 rounded-md ${utils.getResultStatusClass(result.status)}`;
        
        template.getElementById('result-scan-time').textContent = utils.formatDateTime(result.scan_time);
        template.getElementById('result-issues-count').textContent = result.issues_count || 0;
        
        // Issue counts
        template.getElementById('result-high-severity').textContent = result.high_severity || 0;
        template.getElementById('result-medium-severity').textContent = result.medium_severity || 0;
        template.getElementById('result-low-severity').textContent = result.low_severity || 0;
        
        // Tool status
        const toolStatusContainer = template.getElementById('tool-status-container');
        toolStatusContainer.innerHTML = '';
        
        if (result.details && result.details.tool_status) {
          Object.entries(result.details.tool_status).forEach(([tool, status]) => {
            const div = document.createElement('div');
            div.className = 'flex justify-between text-xs';
            
            const toolSpan = document.createElement('span');
            toolSpan.textContent = tool;
            
            const statusSpan = document.createElement('span');
            statusSpan.textContent = status;
            statusSpan.className = 
              status.includes('No issues') ? 'text-green-700' :
              status.includes('Not run') ? 'text-gray-600' :
              status.includes('Error') ? 'text-red-700' :
              'text-yellow-700';
            
            div.appendChild(toolSpan);
            div.appendChild(statusSpan);
            toolStatusContainer.appendChild(div);
          });
        }
        
        // Determine which containers to show based on result status
        const issuesContainer = template.getElementById('issues-container');
        const analysisErrorContainer = template.getElementById('analysis-error-container');
        const noIssuesContainer = template.getElementById('no-issues-container');
        
        if (result.status === 'failed') {
          // Show error message
          issuesContainer.classList.add('hidden');
          noIssuesContainer.classList.add('hidden');
          analysisErrorContainer.classList.remove('hidden');
          
          const errorMessage = template.getElementById('analysis-error-message');
          errorMessage.textContent = result.details?.error || 'Unknown error occurred during analysis';
        } else if (result.issues_count === 0) {
          // Show no issues message
          issuesContainer.classList.add('hidden');
          analysisErrorContainer.classList.add('hidden');
          noIssuesContainer.classList.remove('hidden');
        } else {
          // Show issues list
          analysisErrorContainer.classList.add('hidden');
          noIssuesContainer.classList.add('hidden');
          issuesContainer.classList.remove('hidden');
          
          // Get unique tools for tool filter
          const issues = result.details?.issues || [];
          const tools = [...new Set(issues.map(issue => issue.tool))].filter(Boolean);
          
          // Set up tool filter if there are multiple tools
          const toolFilter = template.getElementById('toolFilter');
          if (toolFilter && tools.length > 1) {
            toolFilter.innerHTML = '<option value="all">All Tools</option>';
            tools.forEach(tool => {
              const option = document.createElement('option');
              option.value = tool;
              option.textContent = tool;
              toolFilter.appendChild(option);
            });
          }
          
          // Populate issues list
          await populateIssuesList(
            issues, 
            template.getElementById('issueList'),
            template.getElementById('fileFilter')
          );
        }
        
        // Replace the content with the populated template
        elements.resultDetailsContent.innerHTML = '';
        elements.resultDetailsContent.appendChild(template);
        
        // Set up issue filters
        setupIssueFilters();
        
      } catch (error) {
        console.error('Error loading result details:', error);
        
        const errorResult = utils.handleApiError(error, () => loadResultDetails(resultId));
        
        elements.resultDetailsContent.innerHTML = errorResult.html;
        
        // Add retry button functionality
        const retryBtn = document.getElementById('retryBtn');
        if (retryBtn && errorResult.addRetryButton) {
          utils.addEventListenerWithTracking(retryBtn, 'click', errorResult.addRetryButton, 'retry-result-details');
        }
      }
    }
    
    // Populate issues list for a result
    async function populateIssuesList(issues, issuesList, fileFilterSelect) {
      if (!issuesList) return;
      
      // Clear current issues
      issuesList.innerHTML = '';
      
      // Set up file filter
      if (fileFilterSelect) {
        // Keep the "All Files" option
        fileFilterSelect.innerHTML = '<option value="all">All Files</option>';
        
        // Get unique filenames
        const files = [...new Set(issues.map(issue => issue.filename))].sort();
        
        // Add file options
        files.forEach(file => {
          const option = document.createElement('option');
          option.value = file;
          option.textContent = file;
          fileFilterSelect.appendChild(option);
        });
      }
      
      // Sort issues by severity (high to low)
      const sortedIssues = [...issues].sort((a, b) => {
        const severityOrder = { 'HIGH': 0, 'MEDIUM': 1, 'LOW': 2 };
        return severityOrder[a.severity || 'LOW'] - severityOrder[b.severity || 'LOW'];
      });
      
      // Add each issue
      sortedIssues.forEach((issue, index) => {
        const template = elements.issueItemTpl.content.cloneNode(true);
        const issueItem = template.querySelector('.issue-item');
        
        // Generate unique ID for this issue
        const issueId = `issue-${index}-${Date.now()}`;
        
        // Set data attributes for filtering
        issueItem.dataset.severity = issue.severity || 'LOW';
        issueItem.dataset.file = issue.filename || '';
        issueItem.dataset.tool = issue.tool || '';
        issueItem.dataset.searchable = `${issue.issue_type || ''} ${issue.issue_text || ''} ${issue.filename || ''} ${issue.tool || ''}`.toLowerCase();
        
        // Set background color based on severity
        const severity = issue.severity || 'LOW';
        if (severity === 'HIGH') {
          issueItem.classList.add('bg-red-50');
        } else if (severity === 'MEDIUM') {
          issueItem.classList.add('bg-yellow-50');
        } else {
          issueItem.classList.add('bg-blue-50');
        }
        
        // Severity badge
        const severityBadge = template.querySelector('.issue-severity');
        severityBadge.textContent = severity;
        severityBadge.className = `text-xs px-2 py-0.5 border rounded-md ${
          severity === 'HIGH' ? 'bg-red-100 text-red-800 border-red-700' :
          severity === 'MEDIUM' ? 'bg-yellow-100 text-yellow-800 border-yellow-700' :
          'bg-blue-100 text-blue-800 border-blue-700'
        }`;
        
        // Tool and confidence badges
        template.querySelector('.issue-tool').textContent = issue.tool || 'Unknown';
        template.querySelector('.issue-confidence').textContent = issue.confidence || 'Unknown';
        
        // Issue content
        template.querySelector('.issue-type').textContent = issue.issue_type || 'Unknown Issue';
        template.querySelector('.issue-text').textContent = issue.issue_text || 'No description available';
        
        // Fix suggestion (if available)
        const fixContainer = template.querySelector('.fix-suggestion-container');
        const fixText = template.querySelector('.fix-suggestion');
        
        if (issue.fix_suggestion) {
          fixContainer.classList.remove('hidden');
          fixText.textContent = issue.fix_suggestion;
        }
        
        // File information
        const filenameElement = template.querySelector('.issue-filename');
        filenameElement.textContent = `${issue.filename || 'Unknown file'}${issue.line_number > 0 ? ':' + issue.line_number : ''}`;
        
        // Code sample
        template.querySelector('.issue-code').textContent = issue.code || 'No code sample available';
        
        // Make toggle button accessible
        const toggleButton = template.querySelector('.toggle-issue');
        toggleButton.setAttribute('aria-controls', `issue-details-${issueId}`);
        
        // Set ID for details section
        const detailsSection = template.querySelector('.issue-details');
        detailsSection.id = `issue-details-${issueId}`;
        
        issuesList.appendChild(template);
      });
      
      // If no issues, show a message
      if (sortedIssues.length === 0) {
        const message = document.createElement('div');
        message.className = 'p-4 text-center';
        message.innerHTML = `
          <div class="inline-block border border-green-700 bg-green-50 p-2 rounded-md">
            <p class="text-xs font-bold text-green-700">No security issues found.</p>
          </div>
        `;
        issuesList.appendChild(message);
      }
      
      // Update issues counter
      updateIssuesCounter(sortedIssues.length, sortedIssues.length);
    }
    
    // Filter jobs based on active filters (kept for backwards compatibility)
    function filterJobs() {
      if (!elements.jobsTableBody) return;
      
      const searchText = elements.searchJobs?.value?.toLowerCase() || '';
      const selectedModel = elements.modelFilter?.value || 'all';
      const selectedScanType = elements.scanTypeFilter?.value || 'all';
      const selectedStatus = elements.statusFilter?.value || 'all';
      
      const jobRows = elements.jobsTableBody.querySelectorAll('.job-row');
      let visibleCount = 0;
      
      jobRows.forEach(row => {
        // Get row data
        const models = (row.dataset.models || '').toLowerCase();
        const scanType = (row.dataset.scanType || '').toLowerCase();
        const status = (row.dataset.status || '').toLowerCase();
        const name = (row.dataset.name || '').toLowerCase();
        const text = row.textContent.toLowerCase();
        
        // Apply filters
        const matchesSearch = !searchText || text.includes(searchText) || name.includes(searchText);
        const matchesModel = selectedModel === 'all' || models.includes(selectedModel.toLowerCase());
        const matchesScanType = selectedScanType === 'all' || scanType === selectedScanType;
        const matchesStatus = selectedStatus === 'all' || status === selectedStatus;
        
        // Update visibility
        row.style.display = matchesSearch && matchesModel && matchesScanType && matchesStatus ? '' : 'none';
        if (matchesSearch && matchesModel && matchesScanType && matchesStatus) visibleCount++;
      });
      
      // Update counter
      if (elements.visibleJobsCount) {
        elements.visibleJobsCount.textContent = visibleCount;
      }
      
      // Show/hide no results row
      const noResultsRow = document.getElementById('noResultsRow');
      if (noResultsRow) {
        noResultsRow.style.display = visibleCount === 0 ? '' : 'none';
      }
    }
    
    // Initialize all components
    function init() {
      // Set up form events
      setupFormEvents();
      
      // Set up section toggles
      setupSectionToggles();
      
      // Set up job filters
      setupJobFilters();
      
      // Check for URL parameters to pre-populate form
      const urlParams = new URLSearchParams(window.location.search);
      const model = urlParams.get('model');
      const app = urlParams.get('app');
      
      if (model) {
        // Pre-select the model checkbox
        const modelCheckbox = document.querySelector(`input[name="models"][value="${model}"]`);
        if (modelCheckbox) {
          modelCheckbox.checked = true;
          
          // Show the app range field
          const appRangeField = document.querySelector(`.app-range-field[data-model="${model}"]`);
          if (appRangeField) {
            appRangeField.classList.remove('hidden');
          }
          
          // If app number is specified, pre-fill the range
          if (app) {
            const appRangeInput = document.querySelector(`#app_range_${model}`);
            if (appRangeInput) {
              appRangeInput.value = app;
            }
          }
          
          // Show the form
          elements.createJobForm.classList.remove('hidden');
          elements.createJobForm.setAttribute('aria-hidden', 'false');
          
          if (elements.toggleCreateForm) {
            elements.toggleCreateForm.innerHTML = `
              <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>Cancel`;
            elements.toggleCreateForm.setAttribute('aria-expanded', 'true');
          }
        }
      }
      
      // Set up keyboard navigation and accessibility
      document.addEventListener('keydown', function(e) {
        // Close modals on Escape
        if (e.key === 'Escape') {
          if (!elements.jobDetailsSection.classList.contains('hidden')) {
            elements.closeJobDetails.click();
          } else if (!elements.resultDetailsSection.classList.contains('hidden')) {
            elements.closeResultDetails.click();
          } else if (!elements.createJobForm.classList.contains('hidden')) {
            elements.cancelCreateForm.click();
          }
        }
      });
      
      // Clean up event listeners on page unload
      window.addEventListener('beforeunload', function() {
        utils.stopJobPolling();
        utils.cleanupAllListeners();
      });
    }
    
    // Start initialization when DOM is ready
    init();
  });
  </script>

  {% endblock %}