{% extends "base.html" %}

{% block styles %}
<style>
  /* Status indicator styles */
  .task-row-completed { background-color: #eff6ff; }
  .task-row-failed { background-color: #fee2e2; }
  .task-row-cancelled { background-color: #fffbeb; }
  .task-row-skipped { background-color: #f3f4f6; }
  .task-row-timed_out { background-color: #fef2f2; }
  .task-row-pending, .task-row-running { background-color: #f9fafb; }

  /* Loading animation for running tasks */
  .task-running-indicator::after {
    content: '...';
    display: inline-block;
    animation: dots 1.5s infinite steps(3, end);
    margin-left: 4px;
  }
  @keyframes dots {
    0%, 20% { color: rgba(0,0,0,0); text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0);}
    40% { color: gray; text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0);}
    60% { text-shadow: .25em 0 0 gray, .5em 0 0 rgba(0,0,0,0);}
    80%, 100% { text-shadow: .25em 0 0 gray, .5em 0 0 gray;}
  }

  /* Error tooltip */
  .error-tooltip {
    position: relative;
    cursor: help;
  }
  .error-tooltip .tooltip-text {
    visibility: hidden;
    width: 300px;
    background-color: #ef4444;
    color: #fff;
    text-align: left;
    border-radius: 6px;
    padding: 5px 8px;
    position: absolute;
    z-index: 10;
    bottom: 125%;
    left: 50%;
    margin-left: -150px;
    opacity: 0;
    transition: opacity 0.3s;
    font-size: 11px;
    white-space: pre-wrap;
  }
  .error-tooltip:hover .tooltip-text {
    visibility: visible;
    opacity: 1;
  }
  
  /* View selector styles */
  .view-container {
    display: none;
  }
  .view-container.active {
    display: block;
  }
  
  /* Auto-refresh spinning animation */
  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }
  .spinning {
    animation: spin 1s linear infinite;
    display: inline-block;
  }

  /* Toggle switch for auto-refresh */
  .toggle-checkbox:checked {
    right: 0;
    border-color: #68D391;
  }
  .toggle-checkbox:checked + .toggle-label {
    background-color: #68D391;
  }
  .toggle-label {
    transition: background-color 0.2s ease;
  }
</style>
{% endblock %}

{# Define macro for humanizing duration #}
{% macro humanize_duration(seconds) %}
{% if seconds is none or seconds < 0 %}N/A{% else %}{% set seconds = seconds|int %}{% if seconds < 60 %}{{ seconds }}s{% elif seconds < 3600 %}{{ '%dm %ds'|format(seconds // 60, seconds % 60) }}{% else %}{{ '%dh %dm'|format(seconds // 3600, (seconds % 3600) // 60) }}{% endif %}{% endif %}
{% endmacro %}

{% block content %}
<div class="space-y-4 max-w-7xl mx-auto p-4" id="batchAnalysisDashboard">

  {# View Navigation Controls #}
  <div id="viewControls" class="border border-gray-400 bg-white rounded-md shadow-sm">
    <div class="bg-gray-100 border-b border-gray-400 px-4 py-2 flex justify-between items-center">
      <div class="flex space-x-4">
        <button id="showDashboardBtn" class="h-8 px-3 text-sm bg-blue-600 text-white rounded focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition view-selector-btn active" data-target="dashboardView">
          Dashboard
        </button>
        <button id="showJobDetailsBtn" class="h-8 px-3 text-sm bg-gray-200 text-gray-700 rounded focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition view-selector-btn" data-target="jobDetailsView">
          Job Details
        </button>
        <button id="showResultDetailsBtn" class="h-8 px-3 text-sm bg-gray-200 text-gray-700 rounded focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition view-selector-btn" data-target="resultDetailsView">
          Result Details
        </button>
      </div>
      <div id="viewBreadcrumbs" class="text-sm">
        <span id="dashboardBreadcrumb" class="font-medium">Batch Analysis Dashboard</span>
        <span id="jobDetailsBreadcrumb" class="hidden">
          <span class="mx-2">></span>
          <span class="job-name-display">Job Details</span> 
          (<span class="job-id-display"></span>)
        </span>
        <span id="resultDetailsBreadcrumb" class="hidden">
          <span class="mx-2">></span>
          <span class="result-details-display">Result Details</span>
        </span>
      </div>
    </div>
  </div>

  {# =================== DASHBOARD VIEW =================== #}
  <div id="dashboardView" class="view-container active">
    <div class="border border-gray-400 bg-white p-3 rounded-md shadow-sm">
      <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2">
        <div>
          <h1 class="font-bold text-xl text-gray-900">Batch Analysis</h1>
          <p class="text-sm text-gray-600 mt-1">Run analysis on multiple applications at once</p>
        </div>
        <div class="flex items-center space-x-2 flex-shrink-0">
          <a href="{{ url_for('main.index') }}" class="action-btn h-7 px-3 text-xs flex items-center">
            <svg class="w-3.5 h-3.5 inline mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
            </svg>
            Dashboard
          </a>
          <button id="toggleCreateForm" class="action-btn h-7 px-3 text-xs flex items-center bg-blue-600 text-white hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition duration-150" aria-expanded="false" aria-controls="createJobForm">
            <svg class="w-3.5 h-3.5 inline mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
            </svg>
            New Batch Job
          </button>
        </div>
      </div>
    </div>

    <div id="createJobForm" class="border border-gray-400 bg-white rounded-md shadow-md hidden" aria-hidden="true">
      <div class="bg-gray-100 border-b border-gray-400 px-4 py-2">
        <h2 class="font-bold text-base">Create New Batch Job</h2>
      </div>
      <div class="p-4">
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <div class="mb-4 p-3 rounded-md text-sm {% if category == 'error' %}bg-red-100 border border-red-300 text-red-800{% elif category == 'warning' %}bg-yellow-100 border border-yellow-300 text-yellow-800{% else %}bg-blue-100 border border-blue-300 text-blue-800{% endif %}" role="alert">
                {{ message }}
              </div>
            {% endfor %}
          {% endif %}
        {% endwith %}

        <form method="POST" action="{{ url_for('batch_analysis.create_batch_job') }}" id="batchJobForm">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div>
              <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Job Name <span class="text-red-600">*</span></label>
              <input type="text" id="name" name="name"
                     class="w-full h-9 px-3 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                     value="{{ submitted_data.name if submitted_data else default_job_name }}"
                     required aria-required="true">
              <p class="form-error-msg hidden text-xs text-red-600 mt-1">Job name is required</p>
            </div>
            <div>
              <label for="description" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
              <input type="text" id="description" name="description"
                     class="w-full h-9 px-3 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                     value="{{ submitted_data.description if submitted_data else '' }}">
            </div>
          </div>

          <div class="mb-6">
            <h3 class="text-sm font-medium text-gray-700 mb-2">Analysis Types <span class="text-red-600">*</span></h3>
            <div class="flex flex-wrap gap-x-6 gap-y-3 bg-gray-50 p-3 border border-gray-200 rounded">
              <!-- Change this to checkboxes to match batch_analysis.py expected input -->
              {% for analysis_type in AnalysisType %}
              <div class="flex items-center">
                <input type="checkbox" id="analysis_{{ analysis_type.value }}" name="analysis_types" value="{{ analysis_type.value }}"
                       class="analysis-checkbox h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 mr-2"
                       {% if submitted_data and analysis_type.value in submitted_data.getlist('analysis_types') %}checked{% endif %}>
                <label for="analysis_{{ analysis_type.value }}" class="text-sm text-gray-700">
                  {{ analysis_type.value.replace('_', ' ').title() }}
                </label>
              </div>
              {% endfor %}
            </div>
            <p class="analysis-types-error-msg hidden text-xs text-red-600 mt-1">Select at least one analysis type</p>
          </div>

          <div class="mb-6 space-y-4">
              <h3 class="text-sm font-medium text-gray-700 mb-2">Analysis Options</h3>
              
              <div id="frontend_security_options" class="analysis-option-group hidden pl-4 border-l-2 border-gray-200">
                <h4 class="text-sm font-semibold text-gray-600 mb-2">Frontend Security Options</h4>
                <div class="flex items-center">
                    <input type="checkbox" id="frontend_full_scan" name="frontend_full_scan" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 mr-2"
                           {% if submitted_data and submitted_data.get('frontend_full_scan') == 'on' %}checked{% endif %}>
                    <label for="frontend_full_scan" class="text-sm text-gray-700">Full Scan (Run all frontend tools)</label>
                    <span class="ml-2 text-xs text-gray-500">(Quick scan only runs essential tools)</span>
                </div>
              </div>
              
              <div id="backend_security_options" class="analysis-option-group hidden pl-4 border-l-2 border-gray-200">
                  <h4 class="text-sm font-semibold text-gray-600 mb-2">Backend Security Options</h4>
                  <div class="flex items-center">
                      <input type="checkbox" id="backend_full_scan" name="backend_full_scan" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 mr-2"
                             {% if submitted_data and submitted_data.get('backend_full_scan') == 'on' %}checked{% endif %}>
                      <label for="backend_full_scan" class="text-sm text-gray-700">Full Scan (Run all backend tools)</label>
                      <span class="ml-2 text-xs text-gray-500">(Quick scan only runs essential tools)</span>
                  </div>
              </div>
              
              <div id="performance_options" class="analysis-option-group hidden pl-4 border-l-2 border-gray-200">
                   <h4 class="text-sm font-semibold text-gray-600 mb-2">Performance Test Options</h4>
                   <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                       <div>
                           <label for="perf_users" class="block text-sm text-gray-600 mb-1">Users</label>
                           <input type="number" id="perf_users" name="perf_users" min="1" value="{{ submitted_data.perf_users if submitted_data else 10 }}" class="w-full h-9 px-3 text-sm border border-gray-300 rounded">
                       </div>
                       <div>
                           <label for="perf_duration" class="block text-sm text-gray-600 mb-1">Duration (s)</label>
                           <input type="number" id="perf_duration" name="perf_duration" min="1" value="{{ submitted_data.perf_duration if submitted_data else 30 }}" class="w-full h-9 px-3 text-sm border border-gray-300 rounded">
                       </div>
                       <div>
                           <label for="perf_spawn_rate" class="block text-sm text-gray-600 mb-1">Spawn Rate</label>
                           <input type="number" id="perf_spawn_rate" name="perf_spawn_rate" min="1" value="{{ submitted_data.perf_spawn_rate if submitted_data else 1 }}" class="w-full h-9 px-3 text-sm border border-gray-300 rounded">
                       </div>
                   </div>
              </div>
              
              <div id="zap_options" class="analysis-option-group hidden pl-4 border-l-2 border-gray-200">
                  <h4 class="text-sm font-semibold text-gray-600 mb-2">ZAP Scan Options</h4>
                  <div class="flex items-center">
                      <input type="checkbox" id="zap_quick_scan" name="zap_quick_scan" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 mr-2"
                             {% if submitted_data and submitted_data.get('zap_quick_scan') == 'on' %}checked{% endif %}>
                      <label for="zap_quick_scan" class="text-sm text-gray-700">Quick Scan (Spider + Active Scan)</label>
                      <span class="ml-2 text-xs text-gray-500">(Full scan includes AJAX spider)</span>
                  </div>
              </div>
              
              <div id="gpt4all_options" class="analysis-option-group hidden pl-4 border-l-2 border-gray-200">
                  <h4 class="text-sm font-semibold text-gray-600 mb-2">GPT4All Options</h4>
                   <p class="text-sm text-gray-500">Uses default requirements file for each app.</p>
               </div>
              
              <div class="pl-4 border-l-2 border-gray-200">
                  <h4 class="text-sm font-semibold text-gray-600 mb-2">Advanced Options</h4>
                  <div>
                      <label for="task_timeout_override" class="block text-sm text-gray-600 mb-1">Task Timeout Override (seconds)</label>
                      <input type="number" id="task_timeout_override" name="task_timeout_override" min="10" placeholder="Default: 1800"
                             value="{{ submitted_data.task_timeout_override if submitted_data else '' }}"
                             class="w-full sm:w-1/2 h-9 px-3 text-sm border border-gray-300 rounded">
                      <span class="ml-2 text-xs text-gray-500 block sm:inline mt-1 sm:mt-0">Leave empty for default.</span>
                  </div>
              </div>
          </div>

          <div class="mb-6">
            <h3 class="text-sm font-medium text-gray-700 mb-2">Select Models <span class="text-red-600">*</span></h3>
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-x-6 gap-y-3 bg-gray-50 p-3 border border-gray-200 rounded">
              {% for model_name in all_models %}
                <div class="flex items-center">
                  <input type="checkbox" id="model_{{ model_name }}" name="models" value="{{ model_name }}"
                         class="model-checkbox h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 mr-2"
                         {% if submitted_data and model_name in submitted_data.getlist('models') %}checked{% endif %}>
                  <label for="model_{{ model_name }}" class="text-sm text-gray-700">{{ model_name }}</label>
                </div>
              {% else %}
                <p class="text-sm text-gray-500 col-span-full">No models available.</p>
              {% endfor %}
            </div>
            <p class="models-error-msg hidden text-xs text-red-600 mt-1">Select at least one model</p>
          </div>

          <div class="mb-6">
            <h3 class="text-sm font-medium text-gray-700 mb-2">App Ranges</h3>
            <p class="text-sm text-gray-500 mb-2">Specify which app numbers to scan for each selected model. Format: 1-3,5,7-9 (leave empty for all apps)</p>
            <div id="appRangeFields" class="space-y-3 bg-gray-50 p-3 border border-gray-200 rounded">
              {% for model_name in all_models %}
                <div class="app-range-field hidden" data-model="{{ model_name }}">
                  <div class="flex flex-col sm:flex-row sm:items-center gap-2">
                    <label for="app_range_{{ model_name }}" class="w-full sm:w-auto sm:min-w-[120px] text-sm text-gray-700 flex-shrink-0">{{ model_name }}:</label>
                    <input type="text" id="app_range_{{ model_name }}" name="app_range_{{ model_name }}"
                           placeholder="e.g., 1-3,5,7-9 (empty for all)"
                           value="{{ submitted_data.get('app_range_' + model_name) if submitted_data else '' }}"
                           class="w-full h-9 px-3 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                  </div>
                  <p class="app-range-error hidden text-xs text-red-600 mt-1 pl-0 sm:pl-[128px]">Invalid format. Use numbers, commas, hyphens (e.g., 1-3, 5, 7-9). Ensure start <= end.</p>
                </div>
              {% endfor %}
              <p id="noModelSelectedMsg" class="text-sm text-gray-500 hidden">Select one or more models above to specify app ranges.</p>
            </div>
          </div>

          <div class="flex justify-end space-x-3 border-t border-gray-200 pt-4">
            <button type="button" id="cancelCreateForm" class="action-btn h-9 px-4 text-sm bg-gray-100 hover:bg-gray-200 rounded focus:ring-2 focus:ring-gray-300 transition">
              Cancel
            </button>
            <button type="submit" id="submitJobBtn" class="action-btn h-9 px-4 text-sm bg-blue-600 text-white hover:bg-blue-700 rounded focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition">
              Create and Start Job
            </button>
          </div>
        </form>
      </div>
    </div>

    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
      <div class="border border-gray-400 bg-white p-3 rounded-md shadow-sm text-center stats-card" data-stat="total-jobs">
        <div class="text-sm text-gray-600">Total Jobs</div>
        <div class="text-xl font-bold mt-1">{{ stats.get('total', jobs|length) }}</div>
      </div>
      <div class="border border-gray-400 bg-white p-3 rounded-md shadow-sm text-center stats-card" data-stat="pending-jobs">
        <div class="text-sm text-gray-600">Pending</div>
        <div class="text-xl font-bold text-gray-700 mt-1">{{ stats.get('pending', 0) + stats.get('queued', 0) }}</div>
      </div>
      <div class="border border-gray-400 bg-white p-3 rounded-md shadow-sm text-center stats-card" data-stat="running-jobs">
        <div class="text-sm text-green-600">Running</div>
        <div class="text-xl font-bold text-green-700 mt-1">{{ stats.get('running', 0) + stats.get('initializing', 0) }}</div>
      </div>
      <div class="border border-gray-400 bg-white p-3 rounded-md shadow-sm text-center stats-card" data-stat="completed-jobs">
        <div class="text-sm text-blue-600">Completed</div>
        <div class="text-xl font-bold text-blue-700 mt-1">{{ stats.get('completed', 0) }}</div>
      </div>
      <div class="border border-gray-400 bg-white p-3 rounded-md shadow-sm text-center stats-card" data-stat="failed-jobs">
        <div class="text-sm text-red-600">Failed/Canceled</div>
        <div class="text-xl font-bold text-red-700 mt-1">{{ stats.get('failed', 0) + stats.get('cancelled', 0) + stats.get('error', 0) }}</div>
      </div>
    </div>

    <div class="border border-gray-400 bg-white rounded-md shadow-sm">
      <div class="bg-gray-100 border-b border-gray-400 px-4 py-2">
        <h2 class="font-bold text-base">Filters</h2>
      </div>
      <div class="p-3 flex flex-wrap items-center gap-3">
        <div class="relative flex-grow sm:flex-grow-0">
          <input type="text" id="searchJobs" placeholder="Search jobs by name..."
                 class="h-8 pl-8 pr-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 w-full sm:w-auto">
          <svg class="w-4 h-4 absolute left-2.5 top-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
          </svg>
        </div>
        <select id="modelFilter" class="h-8 px-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500" aria-label="Filter by model">
          <option value="all">All Models</option>
          {% for model_name in all_models %}
            <option value="{{ model_name }}">{{ model_name }}</option>
          {% endfor %}
        </select>
        <select id="analysisTypeFilter" class="h-8 px-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500" aria-label="Filter by analysis type">
          <option value="all">All Analysis Types</option>
           {% for type in AnalysisType %}
               <option value="{{ type.value }}">{{ type.value.replace('_', ' ').title() }}</option>
           {% endfor %}
        </select>
        <select id="statusFilter" class="h-8 px-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500" aria-label="Filter by status">
          <option value="all">All Statuses</option>
           {% for status in JobStatus %}
               <option value="{{ status.value }}">{{ status.value.title() }}</option>
           {% endfor %}
        </select>
        <button id="clearFilters" class="h-8 px-3 text-sm border border-gray-300 rounded hover:bg-gray-100 focus:outline-none focus:ring-1 focus:ring-blue-500 transition">
          Clear Filters
        </button>
      </div>
    </div>

    <div class="border border-gray-400 bg-white rounded-md shadow-sm">
      <div class="bg-gray-100 border-b border-gray-400 px-4 py-2 flex justify-between items-center">
        <h2 class="font-bold text-base">Job List</h2>
        <div class="text-sm text-gray-600" id="jobsCounter">
          Showing <span id="visibleJobsCount">{{ jobs|length }}</span> of {{ jobs|length }} jobs
        </div>
      </div>
      <div class="p-2">
        {% if jobs %}
          <div class="overflow-x-auto">
            <table class="min-w-full border border-gray-300 text-sm" id="jobsTable">
              <thead>
                <tr class="bg-gray-100">
                  <th class="border border-gray-300 px-3 py-2 text-left">ID</th>
                  <th class="border border-gray-300 px-3 py-2 text-left">Name</th>
                  <th class="border border-gray-300 px-3 py-2 text-left">Status</th>
                  <th class="border border-gray-300 px-3 py-2 text-left">Analysis Types</th>
                  <th class="border border-gray-300 px-3 py-2 text-left">Models</th>
                  <th class="border border-gray-300 px-3 py-2 text-left">Created</th>
                  <th class="border border-gray-300 px-3 py-2 text-left">Progress</th>
                  <th class="border border-gray-300 px-3 py-2 text-left">Actions</th>
                </tr>
              </thead>
              <tbody id="jobsTableBody">
                {% for job in jobs %}
                  <tr class="hover:bg-gray-50 job-row"
                      data-job-id="{{ job.id }}"
                      data-status="{{ job.status }}"
                      data-analysis-types="{{ job.analysis_types|join(',') }}"
                      data-models="{{ job.models|join(',') }}"
                      data-name="{{ job.name }}">
                    <td class="border border-gray-300 px-3 py-2">{{ job.id }}</td>
                    <td class="border border-gray-300 px-3 py-2 font-medium">
                      <a href="{{ url_for('batch_analysis.view_job', job_id=job.id) }}" class="text-blue-700 hover:underline view-job-link" data-job-id="{{ job.id }}">
                        {{ job.name }}
                      </a>
                    </td>
                    <td class="border border-gray-300 px-3 py-2">
                      <span class="px-2 py-1 rounded-full text-white text-xs font-semibold
                        {% if job.status == 'running' %} bg-green-600
                        {% elif job.status == 'completed' %} bg-blue-600
                        {% elif job.status == 'pending' %} bg-gray-500
                        {% elif job.status == 'initializing' %} bg-indigo-500
                        {% elif job.status == 'queued' %} bg-yellow-500 text-yellow-900
                        {% elif job.status == 'cancelling' %} bg-orange-500
                        {% elif job.status == 'cancelled' %} bg-orange-600
                        {% else %} bg-red-600 {% endif %}">
                        {{ job.status.upper() }}
                      </span>
                    </td>
                    <td class="border border-gray-300 px-3 py-2">
                      <div class="flex flex-wrap gap-1">
                           {% for analysis_type_str in job.analysis_types %}
                             <span class="px-1.5 py-0.5 rounded text-xs font-medium
                                   {% if analysis_type_str == 'frontend_security' %} bg-purple-100 text-purple-800 border border-purple-300
                                   {% elif analysis_type_str == 'backend_security' %} bg-indigo-100 text-indigo-800 border border-indigo-300
                                   {% elif analysis_type_str == 'performance' %} bg-pink-100 text-pink-800 border border-pink-300
                                   {% elif analysis_type_str == 'gpt4all' %} bg-cyan-100 text-cyan-800 border border-cyan-300
                                   {% elif analysis_type_str == 'zap' %} bg-orange-100 text-orange-800 border border-orange-300
                                   {% else %} bg-gray-100 text-gray-800 border border-gray-300 {% endif %}">
                                   {{ analysis_type_str.replace('_', ' ').title() }}
                             </span>
                           {% endfor %}
                      </div>
                    </td>
                    <td class="border border-gray-300 px-3 py-2">
                      {{ job.models|join(', ') }}
                    </td>
                    <td class="border border-gray-300 px-3 py-2 whitespace-nowrap">
                      {{ job.created_at_formatted if job.created_at_formatted else 'N/A' }}
                    </td>
                    <td class="border border-gray-300 px-3 py-2">
                      {% set percent = (job.completed_tasks / job.total_tasks * 100) if job.total_tasks > 0 else (100 if job.status == 'completed' else 0) %}
                      <div class="w-full bg-gray-200 rounded-full h-2.5 overflow-hidden" title="{{ job.completed_tasks }}/{{ job.total_tasks }}">
                        <div class="bg-blue-600 rounded-full h-2.5 transition-all duration-300" style="width: {{ percent }}%"></div>
                      </div>
                      <span class="text-xs text-gray-600">{{ '%d%%' % percent }}</span>
                    </td>
                    <td class="border border-gray-300 px-3 py-2">
                      <div class="flex space-x-2">
                        <a href="{{ url_for('batch_analysis.view_job', job_id=job.id) }}" class="action-btn h-7 px-3 text-xs flex items-center">
                          View
                        </a>
                        {% if job.status in ['running', 'initializing', 'queued'] %}
                          <form method="POST" action="{{ url_for('batch_analysis.cancel_job_api', job_id=job.id) }}" class="inline">
                            <button type="submit" class="cancel-job-btn action-btn h-7 px-3 text-xs bg-red-600 text-white hover:bg-red-700 focus:ring-2 focus:ring-red-500 transition" data-job-id="{{ job.id }}" aria-label="Cancel job {{ job.id }}">
                              Cancel
                            </button>
                          </form>
                        {% elif job.status not in ['pending', 'cancelling'] %}
                          <form method="POST" action="{{ url_for('batch_analysis.delete_job_api', job_id=job.id) }}" class="inline">
                            <button type="submit" class="delete-job-btn action-btn h-7 px-3 text-xs bg-gray-500 text-white hover:bg-gray-600 focus:ring-2 focus:ring-gray-400 transition" data-job-id="{{ job.id }}" aria-label="Delete job {{ job.id }}">
                              Delete
                            </button>
                          </form>
                        {% endif %}
                      </div>
                    </td>
                  </tr>
                {% endfor %}
                <tr id="noJobsRow" class="hidden">
                  <td colspan="8" class="border border-gray-300 px-3 py-4 text-center text-gray-500">
                    No jobs match your current filters
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="p-6 text-center border border-gray-300 rounded-md">
            <p class="text-base text-gray-600">No batch jobs found</p>
            <button id="noJobsCreateBtn" class="mt-4 inline-block action-btn h-8 px-4 text-sm bg-blue-600 text-white hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition">
              Create First Job
            </button>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  {# =================== JOB DETAILS VIEW =================== #}
  <div id="jobDetailsView" class="view-container">
    <div class="space-y-2 max-w-7xl mx-auto">
      {# --- Header Section --- #}
      <div class="border border-gray-400 bg-white p-2 rounded-md">
        <div class="flex items-center justify-between">
          <div>
            <h1 class="font-bold text-xl text-gray-900">Batch Job Details</h1>
            <p class="text-xs text-gray-600 mt-1" id="jobDetailsHeader">Job Name (ID: 0)</p>
          </div>
          <div class="flex items-center space-x-2">
            <a href="{{ url_for('batch_analysis.batch_dashboard') }}" id="backToDashboardBtn" class="action-btn h-6 px-2 text-xs flex items-center">
              <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>
              Back to Dashboard
            </a>
            <form method="POST" id="cancelJobDetailsForm" action="#" class="hidden inline">
              <button type="submit" id="cancelJobDetailsBtn" class="action-btn h-6 px-2 text-xs flex items-center bg-red-600 text-white hover:bg-red-700 focus:ring-2 focus:ring-red-500 focus:ring-opacity-50 transition">
                <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                Cancel Job
              </button>
            </form>
            <form method="POST" id="deleteJobDetailsForm" action="#" class="hidden inline">
              <button type="submit" id="deleteJobDetailsBtn" class="action-btn h-6 px-2 text-xs bg-gray-500 text-white hover:bg-gray-600 focus:ring-2 focus:ring-gray-400 transition">
                Delete Job
              </button>
            </form>
          </div>
        </div>
      </div>

      {# --- Job Info / Progress / Summary Grid --- #}
      <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
        <div class="border border-gray-400 bg-white rounded-md shadow-sm">
          <div class="bg-gray-100 border-b border-gray-400 px-2 py-1">
            <h2 class="font-bold text-sm">Job Information</h2>
          </div>
          <div class="p-2">
            <table class="w-full text-xs">
              <tr>
                <td class="font-medium text-gray-600 py-1 pr-2">Job ID:</td>
                <td id="jobDetailsId">{{ job.id }}</td>
              </tr>
              <tr>
                <td class="font-medium text-gray-600 py-1 pr-2">Name:</td>
                <td id="jobDetailsName">{{ job.name }}</td>
              </tr>
              <tr>
                <td class="font-medium text-gray-600 py-1 pr-2">Description:</td>
                <td id="jobDetailsDescription">{{ job.description }}</td>
              </tr>
              <tr>
                <td class="font-medium text-gray-600 py-1 pr-2">Models:</td>
                <td id="jobDetailsModels">{{ job.models|join(', ') }}</td>
              </tr>
              <tr>
                <td class="font-medium text-gray-600 py-1 pr-2">Created At:</td>
                <td id="jobDetailsCreatedAt">{{ job.created_at_formatted }}</td>
              </tr>
              <tr>
                <td class="font-medium text-gray-600 py-1 pr-2">Started At:</td>
                <td id="jobDetailsStartedAt">{{ job.started_at if job.started_at else 'Not started' }}</td>
              </tr>
              <tr>
                <td class="font-medium text-gray-600 py-1 pr-2">Completed At:</td>
                <td id="jobDetailsCompletedAt">{{ job.completed_at if job.completed_at else 'Not completed' }}</td>
              </tr>
              <tr>
                <td class="font-medium text-gray-600 py-1 pr-2 align-top">Status:</td>
                <td>
                  <span id="jobDetailsStatus" data-current-status="{{ job.status }}" class="px-2 py-0.5 rounded-md text-white capitalize
                    {% if job.status == 'running' %} bg-green-600
                    {% elif job.status == 'completed' %} bg-blue-600
                    {% elif job.status == 'pending' %} bg-gray-500
                    {% elif job.status == 'initializing' %} bg-indigo-500
                    {% elif job.status == 'queued' %} bg-yellow-500 text-yellow-900
                    {% elif job.status == 'cancelling' %} bg-orange-500
                    {% elif job.status == 'cancelled' %} bg-orange-600
                    {% else %} bg-red-600 {% endif %}">
                    {{ job.status }}
                  </span>
                </td>
              </tr>
              <tr>
                <td class="font-medium text-gray-600 py-1 pr-2 align-top">Analysis Types:</td>
                <td id="jobDetailsAnalysisTypes">
                  <div class="flex flex-wrap gap-1">
                     {% for analysis_type_str in job.analysis_types %}
                       <span class="px-1.5 py-0.5 rounded text-xs font-medium
                             {% if analysis_type_str == 'frontend_security' %} bg-purple-100 text-purple-800 border border-purple-300
                             {% elif analysis_type_str == 'backend_security' %} bg-indigo-100 text-indigo-800 border border-indigo-300
                             {% elif analysis_type_str == 'performance' %} bg-pink-100 text-pink-800 border border-pink-300
                             {% elif analysis_type_str == 'gpt4all' %} bg-cyan-100 text-cyan-800 border border-cyan-300
                             {% elif analysis_type_str == 'zap' %} bg-orange-100 text-orange-800 border border-orange-300
                             {% else %} bg-gray-100 text-gray-800 border border-gray-300 {% endif %}">
                             {{ analysis_type_str.replace('_', ' ').title() }}
                       </span>
                     {% endfor %}
                </div>
                </td>
              </tr>
              <tr>
                <td class="font-medium text-gray-600 py-1 pr-2 align-top">Analysis Options:</td>
                <td>
                  <pre id="jobDetailsOptions" class="text-[10px] bg-gray-50 p-1 rounded border border-gray-200 max-h-20 overflow-auto">{{ job.analysis_options|tojson(indent=2) }}</pre>
                </td>
              </tr>
            </table>
          </div>
        </div>

        {# --- Progress Section --- #}
        <div class="border border-gray-400 bg-white rounded-md shadow-sm">
          <div class="bg-gray-100 border-b border-gray-400 px-2 py-1">
            <h2 class="font-bold text-sm">Progress</h2>
          </div>
          <div class="p-2">
            <div class="mb-2">
              {% set progress_percent = (job.completed_tasks / job.total_tasks * 100) if job.total_tasks > 0 else (100 if job.status == 'completed' else 0) %}
              <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden" id="progressBarContainer">
                <div id="jobDetailsProgressBar" class="bg-blue-600 rounded-full h-4 flex items-center justify-center text-xs text-white transition-all duration-300"
                    style="width: {{ progress_percent }}%">
                  {{ progress_percent|int }}%
                </div>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-2 text-xs">
              <div class="border border-gray-300 p-2 rounded-md">
                <div class="text-gray-600">Completed Tasks</div>
                <div class="font-bold" id="jobDetailsCompletedTasks">{{ job.completed_tasks }}/{{ job.total_tasks }}</div>
              </div>
              <div class="border border-gray-300 p-2 rounded-md">
                <div class="text-gray-600">Runtime</div>
                <div class="font-bold" id="jobDetailsRuntime">
                  <span id="jobDetailsRuntimeValue">{{ humanize_duration(job.duration_seconds) }}</span>
                </div>
              </div>
              <div class="border border-gray-300 p-2 rounded-md col-span-2">
                <div class="text-gray-600">Tasks Failed</div>
                <div class="font-bold text-red-700" id="jobDetailsTasksFailed">{{ job.task_count_by_status.get('failed', 0) + job.task_count_by_status.get('timed_out', 0) }}</div>
              </div>
            </div>
          </div>
        </div>

        {# --- Aggregated Results Section --- #}
        <div class="border border-gray-400 bg-white rounded-md shadow-sm">
          <div class="bg-gray-100 border-b border-gray-400 px-2 py-1">
            <h2 class="font-bold text-sm">Aggregated Results</h2>
          </div>
          <div class="p-2 space-y-2" id="jobDetailsAggregatedResults">
            {% if job.results_summary %}
              <div class="text-xs text-gray-700">
                <div class="grid grid-cols-2 gap-2">
                  {% if job.results_summary.high_total is defined %}
                  <div class="border border-gray-200 p-1 rounded-sm bg-red-50">
                    <div class="text-xs text-gray-600">High Issues</div>
                    <div class="font-bold text-red-700">{{ job.results_summary.high_total }}</div>
                  </div>
                  {% endif %}
                  
                  {% if job.results_summary.medium_total is defined %}
                  <div class="border border-gray-200 p-1 rounded-sm bg-yellow-50">
                    <div class="text-xs text-gray-600">Medium Issues</div>
                    <div class="font-bold text-yellow-700">{{ job.results_summary.medium_total }}</div>
                  </div>
                  {% endif %}
                  
                  {% if job.results_summary.low_total is defined %}
                  <div class="border border-gray-200 p-1 rounded-sm bg-blue-50">
                    <div class="text-xs text-gray-600">Low Issues</div>
                    <div class="font-bold text-blue-700">{{ job.results_summary.low_total }}</div>
                  </div>
                  {% endif %}
                  
                  {% if job.results_summary.issues_total is defined %}
                  <div class="border border-gray-200 p-1 rounded-sm bg-gray-50">
                    <div class="text-xs text-gray-600">Total Issues</div>
                    <div class="font-bold">{{ job.results_summary.issues_total }}</div>
                  </div>
                  {% endif %}
                </div>
                
                {% if job.results_summary.completed_tasks > 0 %}
                <div class="mt-2 pt-2 border-t border-gray-200">
                  <div class="text-gray-600 font-medium">Results by Analysis Type:</div>
                  <div class="mt-1 space-y-1">
                    {% for analysis_type in job.analysis_types %}
                      {% set completed_key = analysis_type + '_tasks_completed' %}
                      {% set issues_key = analysis_type + '_issues_total' %}
                      <div class="flex justify-between">
                        <span>{{ analysis_type.replace('_', ' ').title() }}:</span>
                        <span>{{ job.results_summary.get(issues_key, 0) }} issues</span>
                      </div>
                    {% endfor %}
                  </div>
                </div>
                {% endif %}
              </div>
            {% else %}
              <p class="text-xs text-gray-500 text-center">No results available yet</p>
            {% endif %}
          </div>
        </div>
      </div>

      {# --- Task Results Table --- #}
      <div class="border border-gray-400 bg-white rounded-md shadow-sm">
        <div class="bg-gray-100 border-b border-gray-400 px-2 py-1 flex justify-between items-center">
          <h2 class="font-bold text-sm">Task Results</h2>
          {# Filters for results table #}
          <div class="flex flex-wrap items-center gap-2">
            <div class="relative">
              <input type="text" id="searchResults" placeholder="Search results..." class="h-6 pl-6 pr-2 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
              <svg class="w-3 h-3 absolute left-2 top-1.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
            </div>
            <select id="resultStatusFilter" class="h-6 px-2 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
              <option value="all">All Statuses</option>
              <option value="completed">Completed</option>
              <option value="failed">Failed</option>
              <option value="running">Running</option>
              <option value="cancelled">Cancelled</option>
              <option value="timed_out">Timed Out</option>
              <option value="skipped">Skipped</option>
            </select>
            <select id="resultModelFilter" class="h-6 px-2 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
              <option value="all">All Models</option>
              {% for model in job.models %}
                <option value="{{ model }}">{{ model }}</option>
              {% endfor %}
            </select>
            <select id="resultAnalysisTypeFilter" class="h-6 px-2 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
              <option value="all">All Analysis Types</option>
              {% for analysis_type in job.analysis_types %}
                <option value="{{ analysis_type }}">{{ analysis_type.replace('_', ' ')|title }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="p-2">
          <div class="overflow-x-auto">
            <table class="min-w-full border border-gray-300" id="resultsTable">
              <thead>
                <tr class="bg-gray-100">
                  <th class="border border-gray-300 px-2 py-1 text-xs text-left">Model</th>
                  <th class="border border-gray-300 px-2 py-1 text-xs text-left">App</th>
                  <th class="border border-gray-300 px-2 py-1 text-xs text-left">Analysis Type</th>
                  <th class="border border-gray-300 px-2 py-1 text-xs text-left">Status</th>
                  <th class="border border-gray-300 px-2 py-1 text-xs text-left">Issues/Metric/Error</th>
                  <th class="border border-gray-300 px-2 py-1 text-xs text-left">Duration</th>
                  <th class="border border-gray-300 px-2 py-1 text-xs text-left">Actions</th>
                </tr>
              </thead>
              <tbody id="resultsTableBody">
                {% for result in results %}
                  <tr class="task-row-{{ result.status }} hover:bg-gray-50" 
                      data-result-id="{{ result.id }}"
                      data-status="{{ result.status }}"
                      data-model="{{ result.model }}"
                      data-analysis-type="{{ result.analysis_type }}">
                    <td class="border border-gray-300 px-2 py-1 text-xs">{{ result.model }}</td>
                    <td class="border border-gray-300 px-2 py-1 text-xs">{{ result.app_num }}</td>
                    <td class="border border-gray-300 px-2 py-1 text-xs">
                      <span class="px-1.5 py-0.5 rounded text-xs font-medium
                            {% if result.analysis_type == 'frontend_security' %} bg-purple-100 text-purple-800 border border-purple-300
                            {% elif result.analysis_type == 'backend_security' %} bg-indigo-100 text-indigo-800 border border-indigo-300
                            {% elif result.analysis_type == 'performance' %} bg-pink-100 text-pink-800 border border-pink-300
                            {% elif result.analysis_type == 'gpt4all' %} bg-cyan-100 text-cyan-800 border border-cyan-300
                            {% elif result.analysis_type == 'zap' %} bg-orange-100 text-orange-800 border border-orange-300
                            {% else %} bg-gray-100 text-gray-800 border border-gray-300 {% endif %}">
                            {{ result.analysis_type.replace('_', ' ').title() }}
                      </span>
                    </td>
                    <td class="border border-gray-300 px-2 py-1 text-xs">
                      <span class="px-1.5 py-0.5 rounded-full text-xs
                        {% if result.status == 'completed' %} bg-green-100 text-green-800 border border-green-300
                        {% elif result.status == 'failed' %} bg-red-100 text-red-800 border border-red-300
                        {% elif result.status == 'running' %} bg-blue-100 text-blue-800 border border-blue-300 task-running-indicator
                        {% elif result.status == 'cancelled' %} bg-yellow-100 text-yellow-800 border border-yellow-300
                        {% elif result.status == 'timed_out' %} bg-orange-100 text-orange-800 border border-orange-300
                        {% elif result.status == 'skipped' %} bg-gray-100 text-gray-800 border border-gray-300
                        {% else %} bg-gray-100 text-gray-800 border border-gray-300 {% endif %}">
                        {{ result.status.replace('_', ' ').title() }}
                      </span>
                    </td>
                    <td class="border border-gray-300 px-2 py-1 text-xs">
                      {% if result.status == 'completed' %}
                        {% if result.issues_count is defined %}
                          <span class="font-semibold {% if result.issues_count > 0 %}text-red-600{% endif %}">{{ result.issues_count }} issues</span>
                          {% if result.high_severity or result.medium_severity or result.low_severity %}
                          <div class="flex space-x-1 mt-0.5">
                            {% if result.high_severity %}
                            <span class="px-1 py-0.5 bg-red-100 text-red-800 rounded text-[10px]">{{ result.high_severity }} high</span>
                            {% endif %}
                            {% if result.medium_severity %}
                            <span class="px-1 py-0.5 bg-yellow-100 text-yellow-800 rounded text-[10px]">{{ result.medium_severity }} med</span>
                            {% endif %}
                            {% if result.low_severity %}
                            <span class="px-1 py-0.5 bg-blue-100 text-blue-800 rounded text-[10px]">{{ result.low_severity }} low</span>
                            {% endif %}
                          </div>
                          {% endif %}
                        {% else %}
                          <span class="text-gray-500">N/A</span>
                        {% endif %}
                      {% elif result.status == 'failed' and result.details and result.details.error %}
                        <div class="error-tooltip">
                          <span class="text-red-600">{{ result.details.error|truncate(30) }}</span>
                          <span class="tooltip-text">{{ result.details.error }}</span>
                        </div>
                      {% elif result.status == 'running' %}
                        <span class="text-blue-600">In progress</span>
                      {% else %}
                        <span class="text-gray-500">-</span>
                      {% endif %}
                    </td>
                    <td class="border border-gray-300 px-2 py-1 text-xs">
                      {{ humanize_duration(result.duration_seconds) }}
                    </td>
                    <td class="border border-gray-300 px-2 py-1 text-xs">
                      <a href="{{ url_for('batch_analysis.view_result', result_id=result.id) }}" class="action-btn h-6 px-2 text-xs inline-block">View Details</a>
                    </td>
                  </tr>
                {% else %}
                  <tr id="noResultsPlaceholder">
                    <td colspan="7" class="border border-gray-300 py-4 text-center text-sm text-gray-500">
                      {% if job.status in ['pending', 'queued'] %}
                        Job is queued and waiting to start
                      {% elif job.status == 'initializing' %}
                        Job is initializing
                      {% elif job.status == 'running' %}
                        Job is running, waiting for results
                      {% else %}
                        No results available
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
                <tr id="noResultsRow" class="hidden">
                  <td colspan="7" class="border border-gray-300 py-4 text-center text-sm text-gray-500">No results match your current filters</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div id="resultsCounter" class="mt-2 text-xs text-gray-600 text-right">
            Showing <span id="visibleResultsCount">{{ results|length }}</span> of <span id="totalResultsCount">{{ results|length }}</span> results
          </div>
        </div>
      </div>

      {# --- Job Errors Section --- #}
      <div id="errorsSection" class="border border-red-400 bg-red-50 rounded-md shadow-sm {% if not job.errors %}hidden{% endif %}">
        <div class="bg-red-100 border-b border-red-400 px-2 py-1">
          <h2 class="font-bold text-sm text-red-800">Job Execution Errors</h2>
        </div>
        <div class="p-2">
          <ul id="errorsList" class="list-disc pl-4 text-xs text-red-700 space-y-1 max-h-40 overflow-y-auto">
            {% if job.errors %}
              {% for error in job.errors %}
                <li class="error-tooltip">
                  {{ error.message }}
                  {% if error.traceback %}
                  <span class="tooltip-text">{{ error.traceback }}</span>
                  {% endif %}
                </li>
              {% endfor %}
            {% else %}
              <li class="text-gray-500 italic">No job errors reported.</li>
            {% endif %}
          </ul>
        </div>
      </div>

      {# --- Auto-Refresh Toggle --- #}
      <div id="autoRefreshContainer" class="fixed bottom-4 right-4 bg-white border border-gray-300 rounded-md shadow-md p-2 flex items-center space-x-2 z-40 {% if job.status not in ['running', 'initializing', 'cancelling'] %}hidden{% endif %}">
        <div class="text-xs text-gray-700">Auto-refresh:</div>
        <div class="relative inline-block w-10 h-5 align-middle select-none transition duration-200 ease-in">
          <input type="checkbox" id="autoRefreshToggle" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-2 appearance-none cursor-pointer peer" checked/>
          <label for="autoRefreshToggle" class="toggle-label block overflow-hidden h-5 rounded-full bg-gray-300 cursor-pointer peer-checked:bg-blue-500 peer-checked:border-blue-500"></label>
        </div>
        <div class="text-xs text-gray-700" id="refreshStatus">
          <span class="inline-block mr-1 spinning" id="refreshSpinner">⟳</span>Next: <span id="refreshCountdown">10</span>s
        </div>
      </div>
    </div>
  </div>

  {# =================== RESULT DETAILS VIEW =================== #}
  <div id="resultDetailsView" class="view-container">
    <div class="space-y-4 max-w-7xl mx-auto">
      <div class="border border-gray-400 bg-white p-2 rounded-md">
        <div class="flex items-center justify-between">
          <div>
            <h1 class="font-bold text-xl text-gray-900" id="resultDetailsTitle">Result Details</h1>
            <p class="text-xs text-gray-600 mt-1" id="resultDetailsSubtitle">
              Analysis Type: <span id="resultDetailsAnalysisType" class="font-medium capitalize">{{ result.analysis_type.replace('_', ' ') if result else '-' }}</span> |
              Part of Job: <span id="resultDetailsJobInfo"><a href="{{ url_for('batch_analysis.view_job', job_id=result.job_id) if result else '#' }}" class="text-blue-600 hover:underline" id="resultDetailsJobLink">{{ result.job.name if result and result.job else '-' }}</a></span>
            </p>
          </div>
          <div class="flex items-center space-x-2">
            <a href="{{ url_for('batch_analysis.view_job', job_id=result.job_id) if result else url_for('batch_analysis.batch_dashboard') }}" id="backToJobBtn" class="action-btn h-6 px-2 text-xs flex items-center">
              <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
              </svg>
              {% if result %}Back to Job{% else %}Back{% endif %}
            </a>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="border border-gray-400 bg-white rounded-md shadow-sm">
          <div class="bg-gray-100 border-b border-gray-400 px-2 py-1">
            <h2 class="font-bold text-sm">Result Information</h2>
          </div>
          <div class="p-2">
            <table class="w-full text-xs">
              <tr>
                <td class="font-medium text-gray-600 py-1 pr-2">Result ID:</td>
                <td id="resultDetailsId">{{ result.id if result else '-' }}</td>
              </tr>
              <tr>
                <td class="font-medium text-gray-600 py-1 pr-2">Model:</td>
                <td id="resultDetailsModel">{{ result.model if result else '-' }}</td>
              </tr>
              <tr>
                <td class="font-medium text-gray-600 py-1 pr-2">App Number:</td>
                <td id="resultDetailsAppNum">{{ result.app_num if result else '-' }}</td>
              </tr>
              <tr>
                <td class="font-medium text-gray-600 py-1 pr-2">Analysis Type:</td>
                <td id="resultDetailsAnalysisTypeBadge">
                  {% if result %}
                  <span class="px-1.5 py-0.5 rounded text-white text-[10px] capitalize whitespace-nowrap
                        {% if result.analysis_type == 'frontend_security' %} bg-purple-600
                        {% elif result.analysis_type == 'backend_security' %} bg-indigo-600
                        {% elif result.analysis_type == 'performance' %} bg-pink-600
                        {% elif result.analysis_type == 'gpt4all' %} bg-cyan-600
                        {% elif result.analysis_type == 'zap' %} bg-orange-600
                        {% else %} bg-gray-600 {% endif %}">
                    {{ result.analysis_type.replace('_', ' ') }}
                  </span>
                  {% else %}
                  <span class="px-1.5 py-0.5 rounded text-white text-[10px] capitalize whitespace-nowrap bg-gray-600">-</span>
                  {% endif %}
                </td>
              </tr>
              <tr>
                <td class="font-medium text-gray-600 py-1 pr-2">Status:</td>
                <td id="resultDetailsStatusBadge">
                  {% if result %}
                  <span class="px-2 py-0.5 rounded-md capitalize
                    {% if result.status == 'completed' %} bg-green-100 text-green-800 border border-green-300
                    {% elif result.status == 'failed' %} bg-red-100 text-red-800 border border-red-300
                    {% elif result.status == 'running' %} bg-blue-100 text-blue-800 border border-blue-300
                    {% elif result.status == 'cancelled' %} bg-yellow-100 text-yellow-800 border border-yellow-300
                    {% elif result.status == 'timed_out' %} bg-orange-100 text-orange-800 border border-orange-300
                    {% else %} bg-gray-100 text-gray-800 border border-gray-300 {% endif %}">
                    {{ result.status.replace('_', ' ') }}
                  </span>
                  {% else %}
                  <span class="px-2 py-0.5 rounded-md capitalize bg-gray-100 text-gray-800 border border-gray-300">-</span>
                  {% endif %}
                </td>
              </tr>
              <tr>
                <td class="font-medium text-gray-600 py-1 pr-2">Start Time:</td>
                <td id="resultDetailsStartTime">{{ result.scan_start_time if result and result.scan_start_time else 'N/A' }}</td>
              </tr>
              <tr>
                <td class="font-medium text-gray-600 py-1 pr-2">End Time:</td>
                <td id="resultDetailsEndTime">{{ result.scan_end_time if result and result.scan_end_time else 'N/A' }}</td>
              </tr>
              <tr>
                <td class="font-medium text-gray-600 py-1 pr-2">Duration:</td>
                <td id="resultDetailsDuration">{{ humanize_duration(result.duration_seconds) if result else 'N/A' }}</td>
              </tr>
              <tr id="resultDetailsCountRow" {% if not result or not result.issues_count %}class="hidden"{% endif %}>
                <td class="font-medium text-gray-600 py-1 pr-2">Total Issues:</td>
                <td id="resultDetailsCount">{{ result.issues_count if result else '-' }}</td>
              </tr>
            </table>
          </div>
        </div>

        <div class="border border-gray-400 bg-white rounded-md shadow-sm">
          <div class="bg-gray-100 border-b border-gray-400 px-2 py-1">
            <h2 class="font-bold text-sm">Analysis Metrics</h2>
          </div>
          <div class="p-2" id="resultDetailsMetrics">
            {% if result and result.status == 'completed' %}
              {% if result.analysis_type in ['frontend_security', 'backend_security', 'zap'] %}
                <div class="grid grid-cols-3 gap-2 text-xs">
                  <div class="border border-gray-200 p-1 rounded-sm bg-red-50">
                    <div class="text-xs text-gray-600">High Severity</div>
                    <div class="font-bold text-red-700">{{ result.high_severity }}</div>
                  </div>
                  <div class="border border-gray-200 p-1 rounded-sm bg-yellow-50">
                    <div class="text-xs text-gray-600">Medium Severity</div>
                    <div class="font-bold text-yellow-700">{{ result.medium_severity }}</div>
                  </div>
                  <div class="border border-gray-200 p-1 rounded-sm bg-blue-50">
                    <div class="text-xs text-gray-600">Low Severity</div>
                    <div class="font-bold text-blue-700">{{ result.low_severity }}</div>
                  </div>
                </div>
                
                {% if result.details and result.details.summary %}
                <div class="mt-2 pt-2 border-t border-gray-200">
                  <div class="text-gray-600 font-medium">Security Summary:</div>
                  <div class="mt-1 space-y-1">
                    {% for key, value in result.details.summary.items() %}
                      {% if key not in ['high_severity', 'medium_severity', 'low_severity'] and not key.startswith('_') %}
                      <div class="flex justify-between">
                        <span>{{ key|replace('_', ' ')|title }}:</span>
                        <span>{{ value }}</span>
                      </div>
                      {% endif %}
                    {% endfor %}
                  </div>
                </div>
                {% endif %}
                
              {% elif result.analysis_type == 'performance' %}
                <div class="grid grid-cols-2 gap-2 text-xs">
                  <div class="border border-gray-200 p-1 rounded-sm bg-blue-50">
                    <div class="text-xs text-gray-600">Total Requests</div>
                    <div class="font-bold text-blue-700">{{ result.details.total_requests }}</div>
                  </div>
                  <div class="border border-gray-200 p-1 rounded-sm bg-red-50">
                    <div class="text-xs text-gray-600">Failed Requests</div>
                    <div class="font-bold text-red-700">{{ result.details.total_failures }}</div>
                  </div>
                  <div class="border border-gray-200 p-1 rounded-sm bg-indigo-50">
                    <div class="text-xs text-gray-600">Requests/sec</div>
                    <div class="font-bold text-indigo-700">{{ result.details.requests_per_sec|round(2) }}</div>
                  </div>
                  <div class="border border-gray-200 p-1 rounded-sm bg-green-50">
                    <div class="text-xs text-gray-600">Avg Response (ms)</div>
                    <div class="font-bold text-green-700">{{ result.details.avg_response_time|round(2) }}</div>
                  </div>
                </div>
                
              {% elif result.analysis_type == 'gpt4all' %}
                {% if result.details and result.details.summary %}
                <div class="grid grid-cols-2 gap-2 text-xs">
                  <div class="border border-gray-200 p-1 rounded-sm bg-gray-50">
                    <div class="text-xs text-gray-600">Requirements Checked</div>
                    <div class="font-bold">{{ result.details.summary.requirements_checked }}</div>
                  </div>
                  <div class="border border-gray-200 p-1 rounded-sm bg-green-50">
                    <div class="text-xs text-gray-600">Requirements Met</div>
                    <div class="font-bold text-green-700">{{ result.details.summary.met_count }}</div>
                  </div>
                  <div class="border border-gray-200 p-1 rounded-sm bg-red-50 col-span-2">
                    <div class="text-xs text-gray-600">Requirements Not Met</div>
                    <div class="font-bold text-red-700">{{ result.details.summary.requirements_checked - result.details.summary.met_count }}</div>
                  </div>
                </div>
                {% endif %}
                
              {% else %}
                <p class="text-xs text-gray-500">No specific metrics for this analysis type.</p>
              {% endif %}
            {% else %}
              <p class="text-xs text-gray-500">No metrics available for this result.</p>
            {% endif %}
          </div>
        </div>
      </div>

      {# Detailed Results Section - Will be dynamically populated based on analysis type #}
      <div id="detailedResultsContainer" class="space-y-4">
        {% if result and result.status == 'completed' %}
          {% if result.analysis_type in ['frontend_security', 'backend_security', 'zap'] and result.details and result.details.issues %}
            <div class="border border-gray-400 bg-white rounded-md shadow-sm">
              <div class="bg-gray-100 border-b border-gray-400 px-2 py-1 flex justify-between items-center">
                <h2 class="font-bold text-sm">Security Issues</h2>
                <div class="text-xs text-gray-600">Found {{ result.details.issues|length }} issue(s)</div>
              </div>
              <div class="p-2">
                <div class="space-y-3">
                  {% for issue in result.details.issues %}
                    <div class="border border-gray-300 p-2 rounded-sm
                        {% if issue.severity == 'HIGH' or issue.risk == 'High' %} bg-red-50 border-red-200
                        {% elif issue.severity == 'MEDIUM' or issue.risk == 'Medium' %} bg-yellow-50 border-yellow-200
                        {% elif issue.severity == 'LOW' or issue.risk == 'Low' %} bg-blue-50 border-blue-200
                        {% else %} bg-gray-50 border-gray-200 {% endif %}">
                      <div class="flex justify-between">
                        <h3 class="font-bold text-xs">
                          {{ issue.issue_type or issue.name or "Security Issue" }}
                        </h3>
                        <div class="flex space-x-1">
                          <span class="px-1.5 py-0.5 text-[10px] rounded
                            {% if issue.severity == 'HIGH' or issue.risk == 'High' %} bg-red-100 text-red-800 border border-red-300
                            {% elif issue.severity == 'MEDIUM' or issue.risk == 'Medium' %} bg-yellow-100 text-yellow-800 border border-yellow-300
                            {% elif issue.severity == 'LOW' or issue.risk == 'Low' %} bg-blue-100 text-blue-800 border border-blue-300
                            {% else %} bg-gray-100 text-gray-800 border border-gray-300 {% endif %}">
                            {{ issue.severity or issue.risk or "Unknown" }}
                          </span>
                          {% if issue.confidence %}
                          <span class="px-1.5 py-0.5 text-[10px] rounded bg-gray-100 text-gray-800 border border-gray-300">
                            {{ issue.confidence }}
                          </span>
                          {% endif %}
                        </div>
                      </div>
                      <p class="text-xs mt-1">{{ issue.issue_text or issue.description or "" }}</p>
                      {% if issue.filename or issue.url %}
                      <div class="text-[10px] font-mono mt-1 text-gray-600">
                        {{ issue.filename or issue.url }}{% if issue.line_number %}:{{ issue.line_number }}{% endif %}
                      </div>
                      {% endif %}
                      {% if issue.code or issue.evidence %}
                      <div class="mt-2 bg-gray-800 text-white p-1 rounded text-[10px] font-mono overflow-x-auto">
                        <pre>{{ issue.code or issue.evidence }}</pre>
                      </div>
                      {% endif %}
                      {% if issue.fix_suggestion or issue.solution %}
                      <div class="mt-2 bg-green-50 border border-green-200 p-1 rounded text-xs">
                        <span class="font-semibold">Fix:</span> {{ issue.fix_suggestion or issue.solution }}
                      </div>
                      {% endif %}
                    </div>
                  {% endfor %}
                </div>
              </div>
            </div>
          {% elif result.analysis_type == 'gpt4all' and result.details and result.details.results %}
            <div class="border border-gray-400 bg-white rounded-md shadow-sm">
              <div class="bg-gray-100 border-b border-gray-400 px-2 py-1">
                <h2 class="font-bold text-sm">Requirement Analysis</h2>
              </div>
              <div class="p-2">
                <div class="space-y-3">
                  {% for check in result.details.results %}
                    <div class="border border-gray-300 p-2 rounded-sm {% if check.result.met %}bg-green-50 border-green-200{% else %}bg-red-50 border-red-200{% endif %}">
                      <div class="flex justify-between">
                        <h3 class="font-bold text-xs">{{ check.requirement }}</h3>
                        <span class="px-1.5 py-0.5 text-[10px] rounded
                          {% if check.result.met %} bg-green-100 text-green-800 border border-green-300
                          {% else %} bg-red-100 text-red-800 border border-red-300 {% endif %}">
                          {{ 'Met' if check.result.met else 'Not Met' }}
                        </span>
                      </div>
                      <div class="text-xs mt-2">
                        <p>{{ check.result.explanation }}</p>
                        {% if check.result.code_evidence %}
                        <div class="mt-2 bg-gray-800 text-white p-1 rounded text-[10px] font-mono overflow-x-auto">
                          <pre>{{ check.result.code_evidence }}</pre>
                        </div>
                        {% endif %}
                        {% if check.result.recommendations %}
                        <div class="mt-2 bg-blue-50 border border-blue-200 p-1 rounded text-xs">
                          <span class="font-semibold">Recommendations:</span>
                          <p>{{ check.result.recommendations }}</p>
                        </div>
                        {% endif %}
                      </div>
                    </div>
                  {% endfor %}
                </div>
              </div>
            </div>
          {% elif result.analysis_type == 'performance' and result.details %}
            <div class="border border-gray-400 bg-white rounded-md shadow-sm">
              <div class="bg-gray-100 border-b border-gray-400 px-2 py-1">
                <h2 class="font-bold text-sm">Performance Results</h2>
              </div>
              <div class="p-2">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div class="border border-gray-300 p-2 rounded-sm">
                    <h3 class="font-bold text-xs mb-2">Response Times</h3>
                    <table class="w-full text-xs">
                      <tr>
                        <td class="font-medium text-gray-600 py-1 pr-2">Average:</td>
                        <td>{{ result.details.avg_response_time|round(2) }} ms</td>
                      </tr>
                      <tr>
                        <td class="font-medium text-gray-600 py-1 pr-2">Median:</td>
                        <td>{{ result.details.median_response_time|round(2) }} ms</td>
                      </tr>
                      <tr>
                        <td class="font-medium text-gray-600 py-1 pr-2">95th Percentile:</td>
                        <td>{{ result.details.percentile_95|round(2) }} ms</td>
                      </tr>
                      <tr>
                        <td class="font-medium text-gray-600 py-1 pr-2">99th Percentile:</td>
                        <td>{{ result.details.percentile_99|round(2) }} ms</td>
                      </tr>
                    </table>
                  </div>
                  
                  <div class="border border-gray-300 p-2 rounded-sm">
                    <h3 class="font-bold text-xs mb-2">Test Parameters</h3>
                    <table class="w-full text-xs">
                      <tr>
                        <td class="font-medium text-gray-600 py-1 pr-2">Simulated Users:</td>
                        <td>{{ result.details.users }}</td>
                      </tr>
                      <tr>
                        <td class="font-medium text-gray-600 py-1 pr-2">Duration:</td>
                        <td>{{ result.details.duration }} seconds</td>
                      </tr>
                      <tr>
                        <td class="font-medium text-gray-600 py-1 pr-2">Requests/sec:</td>
                        <td>{{ result.details.requests_per_sec|round(2) }}</td>
                      </tr>
                      <tr>
                        <td class="font-medium text-gray-600 py-1 pr-2">Total Requests:</td>
                        <td>{{ result.details.total_requests }}</td>
                      </tr>
                    </table>
                  </div>
                </div>
                
                {% if result.details.endpoints %}
                <div class="mt-4 border border-gray-300 p-2 rounded-sm">
                  <h3 class="font-bold text-xs mb-2">Endpoint Performance</h3>
                  <table class="w-full text-xs border-collapse">
                    <thead>
                      <tr class="bg-gray-100">
                        <th class="border border-gray-300 px-2 py-1 text-left">Endpoint</th>
                        <th class="border border-gray-300 px-2 py-1 text-left">Method</th>
                        <th class="border border-gray-300 px-2 py-1 text-right">Requests</th>
                        <th class="border border-gray-300 px-2 py-1 text-right">Failures</th>
                        <th class="border border-gray-300 px-2 py-1 text-right">Avg (ms)</th>
                        <th class="border border-gray-300 px-2 py-1 text-right">Median (ms)</th>
                        <th class="border border-gray-300 px-2 py-1 text-right">RPS</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for endpoint in result.details.endpoints %}
                      <tr>
                        <td class="border border-gray-300 px-2 py-1">{{ endpoint.name }}</td>
                        <td class="border border-gray-300 px-2 py-1">{{ endpoint.method }}</td>
                        <td class="border border-gray-300 px-2 py-1 text-right">{{ endpoint.num_requests }}</td>
                        <td class="border border-gray-300 px-2 py-1 text-right {% if endpoint.num_failures > 0 %}text-red-600{% endif %}">{{ endpoint.num_failures }}</td>
                        <td class="border border-gray-300 px-2 py-1 text-right">{{ endpoint.avg_response_time|round(2) }}</td>
                        <td class="border border-gray-300 px-2 py-1 text-right">{{ endpoint.median_response_time|round(2) }}</td>
                        <td class="border border-gray-300 px-2 py-1 text-right">{{ endpoint.current_rps|round(2) }}</td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
                {% endif %}
                
                {% if result.details.graph_urls %}
                <div class="mt-4">
                  <h3 class="font-bold text-xs mb-2">Performance Graphs</h3>
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {% for graph in result.details.graph_urls %}
                    <div class="border border-gray-300 p-2 rounded-sm">
                      <h4 class="text-xs font-semibold text-center mb-2">{{ graph.name }}</h4>
                      <img src="{{ graph.url }}" alt="{{ graph.name }}" class="w-full h-auto max-h-60 object-contain">
                    </div>
                    {% endfor %}
                  </div>
                </div>
                {% endif %}
              </div>
            </div>
          {% else %}
            <div class="border border-gray-400 bg-white rounded-md shadow-sm">
              <div class="bg-gray-100 border-b border-gray-400 px-2 py-1">
                <h2 class="font-bold text-sm">Detailed Results</h2>
              </div>
              <div class="p-2">
                <pre class="text-xs font-mono bg-gray-50 p-2 rounded-sm border border-gray-300 max-h-96 overflow-auto">{{ result.details|tojson(indent=2) }}</pre>
              </div>
            </div>
          {% endif %}
        {% elif result and result.status == 'failed' and result.details %}
          <div class="border border-red-400 bg-red-50 rounded-md shadow-sm">
            <div class="bg-red-100 border-b border-red-400 px-2 py-1">
              <h2 class="font-bold text-sm text-red-800">Error Details</h2>
            </div>
            <div class="p-2">
              <div class="text-xs text-red-700">{{ result.details.error }}</div>
              {% if result.details.traceback %}
              <pre class="mt-2 text-[10px] font-mono bg-gray-50 p-2 rounded-sm border border-gray-300 max-h-96 overflow-auto text-red-600">{{ result.details.traceback }}</pre>
              {% endif %}
            </div>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <div id="toastContainer" class="fixed bottom-4 right-4 z-50 flex flex-col gap-2"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // ====== VIEW SWITCHING ======
  const viewContainers = document.querySelectorAll('.view-container');
  const viewButtons = document.querySelectorAll('.view-selector-btn');
  const breadcrumbs = {
    dashboard: document.getElementById('dashboardBreadcrumb'),
    jobDetails: document.getElementById('jobDetailsBreadcrumb'),
    resultDetails: document.getElementById('resultDetailsBreadcrumb')
  };

  function switchView(viewId) {
    // Hide all views
    viewContainers.forEach(container => {
      container.classList.remove('active');
    });
    
    // Show selected view
    const selectedView = document.getElementById(viewId);
    if (selectedView) {
      selectedView.classList.add('active');
    }
    
    // Update buttons
    viewButtons.forEach(btn => {
      if (btn.dataset.target === viewId) {
        btn.classList.add('active', 'bg-blue-600', 'text-white');
        btn.classList.remove('bg-gray-200', 'text-gray-700');
      } else {
        btn.classList.remove('active', 'bg-blue-600', 'text-white');
        btn.classList.add('bg-gray-200', 'text-gray-700');
      }
    });
    
    // Update breadcrumbs
    if (viewId === 'dashboardView') {
      breadcrumbs.dashboard.classList.remove('hidden');
      breadcrumbs.jobDetails.classList.add('hidden');
      breadcrumbs.resultDetails.classList.add('hidden');
    } else if (viewId === 'jobDetailsView') {
      breadcrumbs.dashboard.classList.remove('hidden');
      breadcrumbs.jobDetails.classList.remove('hidden');
      breadcrumbs.resultDetails.classList.add('hidden');
    } else if (viewId === 'resultDetailsView') {
      breadcrumbs.dashboard.classList.remove('hidden');
      breadcrumbs.jobDetails.classList.remove('hidden');
      breadcrumbs.resultDetails.classList.remove('hidden');
    }
  }
  
  // Add click handlers to view buttons
  viewButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      const targetView = btn.dataset.target;
      switchView(targetView);
      
      // Update browser history for better navigation
      if (targetView === 'dashboardView') {
        history.pushState({view: 'dashboard'}, 'Dashboard', '{{ url_for("batch_analysis.batch_dashboard") }}');
      }
    });
  });
  
  // ====== FORM HANDLING ======
  const batchJobForm = document.getElementById('batchJobForm');
  const toggleCreateFormBtn = document.getElementById('toggleCreateForm');
  const cancelCreateFormBtn = document.getElementById('cancelCreateForm');
  const noJobsCreateBtn = document.getElementById('noJobsCreateBtn');
  const createJobForm = document.getElementById('createJobForm');
  
  // Toggle create form visibility
  if (toggleCreateFormBtn && createJobForm) {
    toggleCreateFormBtn.addEventListener('click', function() {
      const isHidden = createJobForm.classList.contains('hidden');
      createJobForm.classList.toggle('hidden', !isHidden);
      toggleCreateFormBtn.setAttribute('aria-expanded', !isHidden);
    });
  }
  
  if (cancelCreateFormBtn && createJobForm) {
    cancelCreateFormBtn.addEventListener('click', function() {
      createJobForm.classList.add('hidden');
      if (toggleCreateFormBtn) toggleCreateFormBtn.setAttribute('aria-expanded', false);
    });
  }
  
  if (noJobsCreateBtn && toggleCreateFormBtn) {
    noJobsCreateBtn.addEventListener('click', function() {
      toggleCreateFormBtn.click();
    });
  }
  
  // Form validation
  if (batchJobForm) {
    batchJobForm.addEventListener('submit', function(e) {
      const formValid = validateForm();
      
      if (!formValid) {
        e.preventDefault();
        showToast('Please fix the errors in the form', 'error');
      } else {
        // Show loading state on submit button
        const submitBtn = document.getElementById('submitJobBtn');
        if (submitBtn) {
          submitBtn.innerHTML = 'Creating...';
          submitBtn.disabled = true;
        }
      }
    });
  }
  
  function validateForm() {
    let isValid = true;
    
    // Validate job name
    const nameInput = document.getElementById('name');
    const nameError = document.querySelector('.form-error-msg');
    if (nameInput && nameInput.value.trim() === '') {
      nameError.classList.remove('hidden');
      isValid = false;
    } else if (nameError) {
      nameError.classList.add('hidden');
    }
    
    // Validate analysis types
    const analysisCheckboxes = document.querySelectorAll('input[name="analysis_types"]:checked');
    const analysisError = document.querySelector('.analysis-types-error-msg');
    if (analysisCheckboxes.length === 0) {
      analysisError.classList.remove('hidden');
      isValid = false;
    } else {
      analysisError.classList.add('hidden');
    }
    
    // Validate models
    const modelCheckboxes = document.querySelectorAll('input[name="models"]:checked');
    const modelsError = document.querySelector('.models-error-msg');
    if (modelCheckboxes.length === 0) {
      modelsError.classList.remove('hidden');
      isValid = false;
    } else {
      modelsError.classList.add('hidden');
    }
    
    // Validate app ranges
    const appRangeFields = document.querySelectorAll('.app-range-field:not(.hidden) input');
    const rangeRegex = /^(\d+(-\d+)?)(,\s*\d+(-\d+)?)*$/;
    let hasRangeError = false;
    
    appRangeFields.forEach(field => {
      const value = field.value.trim();
      const errorMsg = field.parentElement.nextElementSibling;
      
      // Empty is valid (means "all apps")
      if (value === '') {
        errorMsg.classList.add('hidden');
        return;
      }
      
      // Check format with regex
      if (!rangeRegex.test(value)) {
        errorMsg.classList.remove('hidden');
        hasRangeError = true;
        isValid = false;
      } else {
        // Check that ranges are valid (start <= end)
        const ranges = value.split(',');
        let rangeError = false;
        
        ranges.forEach(range => {
          if (range.includes('-')) {
            const [start, end] = range.split('-').map(num => parseInt(num.trim()));
            if (start > end) {
              rangeError = true;
            }
          }
        });
        
        if (rangeError) {
          errorMsg.classList.remove('hidden');
          hasRangeError = true;
          isValid = false;
        } else {
          errorMsg.classList.add('hidden');
        }
      }
    });
    
    return isValid;
  }
  
  // ====== ANALYSIS TYPE OPTION HANDLING ======
  function updateAnalysisTypeOptions() {
    const analysisCheckboxes = document.querySelectorAll('input[name="analysis_types"]');
    
    analysisCheckboxes.forEach(checkbox => {
      const optionsId = `${checkbox.value}_options`;
      const optionsElement = document.getElementById(optionsId);
      
      if (optionsElement) {
        optionsElement.classList.toggle('hidden', !checkbox.checked);
      }
    });
  }
  
  // Initialize analysis options visibility
  updateAnalysisTypeOptions();
  
  // Add change event listeners to analysis checkboxes
  const analysisCheckboxes = document.querySelectorAll('input[name="analysis_types"]');
  analysisCheckboxes.forEach(checkbox => {
    checkbox.addEventListener('change', updateAnalysisTypeOptions);
  });
  
  // ====== MODEL SELECTION HANDLING ======
  function updateAppRangeVisibility() {
    const modelCheckboxes = document.querySelectorAll('.model-checkbox');
    const appRangeFields = document.querySelectorAll('.app-range-field');
    const noModelSelectedMsg = document.getElementById('noModelSelectedMsg');
    let anyModelSelected = false;
    
    modelCheckboxes.forEach(checkbox => {
      const model = checkbox.value;
      appRangeFields.forEach(field => {
        if (field.dataset.model === model) {
          field.classList.toggle('hidden', !checkbox.checked);
          if (checkbox.checked) anyModelSelected = true;
        }
      });
    });
    
    if (noModelSelectedMsg) {
      noModelSelectedMsg.classList.toggle('hidden', anyModelSelected);
    }
  }
  
  // Initialize model selection
  updateAppRangeVisibility();
  
  // Add change event listeners to model checkboxes
  const modelCheckboxes = document.querySelectorAll('.model-checkbox');
  modelCheckboxes.forEach(checkbox => {
    checkbox.addEventListener('change', updateAppRangeVisibility);
  });
  
  // ====== JOB LIST FILTERING ======
  const searchJobsInput = document.getElementById('searchJobs');
  const modelFilterSelect = document.getElementById('modelFilter');
  const analysisTypeFilterSelect = document.getElementById('analysisTypeFilter');
  const statusFilterSelect = document.getElementById('statusFilter');
  const clearFiltersBtn = document.getElementById('clearFilters');
  const jobRows = document.querySelectorAll('.job-row');
  const visibleJobsCount = document.getElementById('visibleJobsCount');
  const noJobsRow = document.getElementById('noJobsRow');
  
  function filterJobs() {
    const searchTerm = searchJobsInput?.value.toLowerCase() || '';
    const selectedModel = modelFilterSelect?.value || 'all';
    const selectedAnalysisType = analysisTypeFilterSelect?.value || 'all';
    const selectedStatus = statusFilterSelect?.value || 'all';
    
    let visibleCount = 0;
    
    jobRows.forEach(row => {
      const jobName = row.dataset.name?.toLowerCase() || '';
      const jobModels = (row.dataset.models || '').split(',');
      const jobAnalysisTypes = (row.dataset.analysisTypes || '').split(',');
      const jobStatus = row.dataset.status || '';
      
      const matchesSearch = searchTerm === '' || jobName.includes(searchTerm);
      const matchesModel = selectedModel === 'all' || jobModels.includes(selectedModel);
      const matchesAnalysisType = selectedAnalysisType === 'all' || jobAnalysisTypes.includes(selectedAnalysisType);
      const matchesStatus = selectedStatus === 'all' || jobStatus === selectedStatus;
      
      const isVisible = matchesSearch && matchesModel && matchesAnalysisType && matchesStatus;
      row.style.display = isVisible ? '' : 'none';
      
      if (isVisible) visibleCount++;
    });
    
    // Update visible count and show/hide "no jobs" message
    if (visibleJobsCount) visibleJobsCount.textContent = visibleCount;
    if (noJobsRow) noJobsRow.style.display = visibleCount === 0 ? '' : 'none';
  }
  
  // Add event listeners to filtering elements
  if (searchJobsInput) searchJobsInput.addEventListener('input', filterJobs);
  if (modelFilterSelect) modelFilterSelect.addEventListener('change', filterJobs);
  if (analysisTypeFilterSelect) analysisTypeFilterSelect.addEventListener('change', filterJobs);
  if (statusFilterSelect) statusFilterSelect.addEventListener('change', filterJobs);
  
  if (clearFiltersBtn) {
    clearFiltersBtn.addEventListener('click', function() {
      if (searchJobsInput) searchJobsInput.value = '';
      if (modelFilterSelect) modelFilterSelect.value = 'all';
      if (analysisTypeFilterSelect) analysisTypeFilterSelect.value = 'all';
      if (statusFilterSelect) statusFilterSelect.value = 'all';
      filterJobs();
    });
  }
  
  // ====== RESULT FILTERING ======
  const searchResultsInput = document.getElementById('searchResults');
  const resultStatusFilterSelect = document.getElementById('resultStatusFilter');
  const resultModelFilterSelect = document.getElementById('resultModelFilter');
  const resultAnalysisTypeFilterSelect = document.getElementById('resultAnalysisTypeFilter');
  const resultRows = document.querySelectorAll('[data-result-id]');
  const visibleResultsCount = document.getElementById('visibleResultsCount');
  const totalResultsCount = document.getElementById('totalResultsCount');
  const noResultsRow = document.getElementById('noResultsRow');
  
  function filterResults() {
    const searchTerm = searchResultsInput?.value.toLowerCase() || '';
    const selectedStatus = resultStatusFilterSelect?.value || 'all';
    const selectedModel = resultModelFilterSelect?.value || 'all';
    const selectedAnalysisType = resultAnalysisTypeFilterSelect?.value || 'all';
    
    let visibleCount = 0;
    
    resultRows.forEach(row => {
      const resultModel = row.dataset.model || '';
      const resultStatus = row.dataset.status || '';
      const resultAnalysisType = row.dataset.analysisType || '';
      const resultText = row.textContent.toLowerCase();
      
      const matchesSearch = searchTerm === '' || resultText.includes(searchTerm);
      const matchesStatus = selectedStatus === 'all' || resultStatus === selectedStatus;
      const matchesModel = selectedModel === 'all' || resultModel === selectedModel;
      const matchesAnalysisType = selectedAnalysisType === 'all' || resultAnalysisType === selectedAnalysisType;
      
      const isVisible = matchesSearch && matchesStatus && matchesModel && matchesAnalysisType;
      row.style.display = isVisible ? '' : 'none';
      
      if (isVisible) visibleCount++;
    });
    
    // Update visible count and show/hide "no results" message
    if (visibleResultsCount) visibleResultsCount.textContent = visibleCount;
    if (noResultsRow) noResultsRow.style.display = visibleCount === 0 ? '' : 'none';
  }
  
  // Add event listeners to result filtering elements
  if (searchResultsInput) searchResultsInput.addEventListener('input', filterResults);
  if (resultStatusFilterSelect) resultStatusFilterSelect.addEventListener('change', filterResults);
  if (resultModelFilterSelect) resultModelFilterSelect.addEventListener('change', filterResults);
  if (resultAnalysisTypeFilterSelect) resultAnalysisTypeFilterSelect.addEventListener('change', filterResults);
  
  // ====== AUTO-REFRESH JOB DETAILS ======
  const autoRefreshToggle = document.getElementById('autoRefreshToggle');
  const refreshCountdown = document.getElementById('refreshCountdown');
  const refreshSpinner = document.getElementById('refreshSpinner');
  const autoRefreshContainer = document.getElementById('autoRefreshContainer');
  const jobDetailsStatus = document.getElementById('jobDetailsStatus');
  
  let autoRefreshInterval;
  let countdownTimer;
  const REFRESH_INTERVAL = 10; // seconds
  
  function startAutoRefresh() {
    if (autoRefreshInterval) clearInterval(autoRefreshInterval);
    if (countdownTimer) clearInterval(countdownTimer);
    
    let countdown = REFRESH_INTERVAL;
    
    // Update countdown display
    function updateCountdown() {
      if (refreshCountdown) refreshCountdown.textContent = countdown;
      countdown--;
      
      if (countdown < 0) {
        countdown = REFRESH_INTERVAL;
      }
    }
    
    // Initial update
    updateCountdown();
    
    // Start countdown timer
    countdownTimer = setInterval(updateCountdown, 1000);
    
    // Start auto-refresh interval
    autoRefreshInterval = setInterval(function() {
      const jobId = document.querySelector('#jobDetailsView').dataset.jobId;
      if (!jobId) return;
      
      refreshJobStatus(jobId);
    }, REFRESH_INTERVAL * 1000);
    
    // Add spinning animation to refresh icon
    if (refreshSpinner) refreshSpinner.classList.add('spinning');
  }
  
  function stopAutoRefresh() {
    if (autoRefreshInterval) clearInterval(autoRefreshInterval);
    if (countdownTimer) clearInterval(countdownTimer);
    
    // Remove spinning animation
    if (refreshSpinner) refreshSpinner.classList.remove('spinning');
  }
  
  // Toggle auto-refresh on checkbox change
  if (autoRefreshToggle) {
    autoRefreshToggle.addEventListener('change', function() {
      if (this.checked) {
        startAutoRefresh();
      } else {
        stopAutoRefresh();
      }
    });
  }
  
  // Check if job is in a state that requires auto-refresh
  function shouldAutoRefresh(status) {
    return ['running', 'initializing', 'cancelling', 'queued'].includes(status);
  }
  
  // Function to refresh job status via AJAX
  function refreshJobStatus(jobId) {
    if (!jobId) return;
    
    fetch(`/batch-analysis/job/${jobId}/status`)
      .then(response => response.json())
      .then(data => {
        updateJobDetails(data);
        
        // Check if we should stop auto-refreshing
        const currentStatus = data.job?.status || '';
        
        if (!shouldAutoRefresh(currentStatus)) {
          stopAutoRefresh();
          if (autoRefreshToggle) autoRefreshToggle.checked = false;
          if (autoRefreshContainer) autoRefreshContainer.classList.add('hidden');
          
          // Show toast notification for completed job
          const jobName = data.job?.name || `Job ${jobId}`;
          if (currentStatus === 'completed') {
            showToast(`${jobName} completed successfully`, 'success');
          } else if (currentStatus === 'failed') {
            showToast(`${jobName} failed`, 'error');
          } else if (currentStatus === 'cancelled') {
            showToast(`${jobName} was cancelled`, 'warning');
          }
        }
      })
      .catch(error => {
        console.error('Error refreshing job status:', error);
        // Don't stop auto-refresh on temporary errors
      });
  }
  
  // Function to update job details in the UI
  function updateJobDetails(data) {
    if (!data || !data.job) return;
    
    const job = data.job;
    
    // Update header
    const jobDetailsHeader = document.getElementById('jobDetailsHeader');
    if (jobDetailsHeader) {
      jobDetailsHeader.textContent = `${job.name} (ID: ${job.id})`;
    }
    
    // Update breadcrumb
    const jobNameDisplay = document.querySelector('.job-name-display');
    const jobIdDisplay = document.querySelector('.job-id-display');
    if (jobNameDisplay) jobNameDisplay.textContent = job.name;
    if (jobIdDisplay) jobIdDisplay.textContent = job.id;
    
    // Update job details
    const jobDetailsId = document.getElementById('jobDetailsId');
    const jobDetailsName = document.getElementById('jobDetailsName');
    const jobDetailsDescription = document.getElementById('jobDetailsDescription');
    const jobDetailsModels = document.getElementById('jobDetailsModels');
    const jobDetailsCreatedAt = document.getElementById('jobDetailsCreatedAt');
    const jobDetailsStartedAt = document.getElementById('jobDetailsStartedAt');
    const jobDetailsCompletedAt = document.getElementById('jobDetailsCompletedAt');
    const jobDetailsStatus = document.getElementById('jobDetailsStatus');
    const jobDetailsOptions = document.getElementById('jobDetailsOptions');
    
    if (jobDetailsId) jobDetailsId.textContent = job.id;
    if (jobDetailsName) jobDetailsName.textContent = job.name;
    if (jobDetailsDescription) jobDetailsDescription.textContent = job.description || 'No description';
    if (jobDetailsModels) jobDetailsModels.textContent = job.models.join(', ');
    if (jobDetailsCreatedAt) jobDetailsCreatedAt.textContent = job.created_at_formatted || 'N/A';
    if (jobDetailsStartedAt) jobDetailsStartedAt.textContent = job.started_at || 'Not started';
    if (jobDetailsCompletedAt) jobDetailsCompletedAt.textContent = job.completed_at || 'Not completed';
    
    if (jobDetailsStatus) {
      const oldStatus = jobDetailsStatus.dataset.currentStatus;
      jobDetailsStatus.dataset.currentStatus = job.status;
      jobDetailsStatus.textContent = job.status;
      
      // Update status style
      jobDetailsStatus.className = 'px-2 py-0.5 rounded-md text-white capitalize';
      
      if (job.status === 'running') {
        jobDetailsStatus.classList.add('bg-green-600');
      } else if (job.status === 'completed') {
        jobDetailsStatus.classList.add('bg-blue-600');
      } else if (job.status === 'pending') {
        jobDetailsStatus.classList.add('bg-gray-500');
      } else if (job.status === 'initializing') {
        jobDetailsStatus.classList.add('bg-indigo-500');
      } else if (job.status === 'queued') {
        jobDetailsStatus.classList.add('bg-yellow-500', 'text-yellow-900');
      } else if (job.status === 'cancelling') {
        jobDetailsStatus.classList.add('bg-orange-500');
      } else if (job.status === 'cancelled') {
        jobDetailsStatus.classList.add('bg-orange-600');
      } else {
        jobDetailsStatus.classList.add('bg-red-600');
      }
      
      // Show/hide action buttons based on status
      updateActionButtons(job.status, job.id);
    }
    
    if (jobDetailsOptions) {
      jobDetailsOptions.textContent = JSON.stringify(job.analysis_options, null, 2);
    }
    
    // Update progress
    const jobDetailsProgressBar = document.getElementById('jobDetailsProgressBar');
    const jobDetailsCompletedTasks = document.getElementById('jobDetailsCompletedTasks');
    const jobDetailsRuntime = document.getElementById('jobDetailsRuntimeValue');
    const jobDetailsTasksFailed = document.getElementById('jobDetailsTasksFailed');
    
    if (jobDetailsProgressBar) {
      const progress = data.progress?.percent || 0;
      jobDetailsProgressBar.style.width = `${progress}%`;
      jobDetailsProgressBar.textContent = `${Math.round(progress)}%`;
    }
    
    if (jobDetailsCompletedTasks) {
      jobDetailsCompletedTasks.textContent = `${job.completed_tasks}/${job.total_tasks}`;
    }
    
    if (jobDetailsRuntime) {
      jobDetailsRuntime.textContent = formatDuration(job.duration_seconds);
    }
    
    if (jobDetailsTasksFailed) {
      const failedTasks = (job.task_count_by_status?.failed || 0) + (job.task_count_by_status?.timed_out || 0);
      jobDetailsTasksFailed.textContent = failedTasks;
    }
    
    // Update aggregated results
    const jobDetailsAggregatedResults = document.getElementById('jobDetailsAggregatedResults');
    if (jobDetailsAggregatedResults && job.results_summary) {
      updateAggregatedResults(jobDetailsAggregatedResults, job.results_summary);
    }
    
    // Update errors section
    const errorsSection = document.getElementById('errorsSection');
    const errorsList = document.getElementById('errorsList');
    
    if (errorsSection && errorsList) {
      if (job.errors && job.errors.length > 0) {
        errorsSection.classList.remove('hidden');
        
        // Clear and rebuild errors list
        errorsList.innerHTML = '';
        job.errors.forEach(error => {
          const li = document.createElement('li');
          li.className = 'error-tooltip';
          li.textContent = error.message;
          
          if (error.traceback) {
            const span = document.createElement('span');
            span.className = 'tooltip-text';
            span.textContent = error.traceback;
            li.appendChild(span);
          }
          
          errorsList.appendChild(li);
        });
      } else {
        errorsSection.classList.add('hidden');
        errorsList.innerHTML = '<li class="text-gray-500 italic">No job errors reported.</li>';
      }
    }
    
    // Add code to refresh task results here
    // This might require a separate API endpoint
  }
  
  function updateAggregatedResults(container, summary) {
    // This is a simple implementation - in a real app, you'd generate a more detailed summary
    if (!container || !summary) return;
    
    if (Object.keys(summary).length === 0) {
      container.innerHTML = '<p class="text-xs text-gray-500 text-center">No results available yet</p>';
      return;
    }
    
    let html = '<div class="text-xs text-gray-700">';
    html += '<div class="grid grid-cols-2 gap-2">';
    
    // Security metrics
    if (summary.high_total !== undefined) {
      html += `<div class="border border-gray-200 p-1 rounded-sm bg-red-50">
        <div class="text-xs text-gray-600">High Issues</div>
        <div class="font-bold text-red-700">${summary.high_total}</div>
      </div>`;
    }
    
    if (summary.medium_total !== undefined) {
      html += `<div class="border border-gray-200 p-1 rounded-sm bg-yellow-50">
        <div class="text-xs text-gray-600">Medium Issues</div>
        <div class="font-bold text-yellow-700">${summary.medium_total}</div>
      </div>`;
    }
    
    if (summary.low_total !== undefined) {
      html += `<div class="border border-gray-200 p-1 rounded-sm bg-blue-50">
        <div class="text-xs text-gray-600">Low Issues</div>
        <div class="font-bold text-blue-700">${summary.low_total}</div>
      </div>`;
    }
    
    if (summary.issues_total !== undefined) {
      html += `<div class="border border-gray-200 p-1 rounded-sm bg-gray-50">
        <div class="text-xs text-gray-600">Total Issues</div>
        <div class="font-bold">${summary.issues_total}</div>
      </div>`;
    }
    
    html += '</div>'; // End grid
    
    // Results by analysis type
    if (summary.total_tasks_processed > 0) {
      html += '<div class="mt-2 pt-2 border-t border-gray-200">';
      html += '<div class="text-gray-600 font-medium">Results by Analysis Type:</div>';
      html += '<div class="mt-1 space-y-1">';
      
      // Get analysis types by looking for keys ending with _tasks_processed
      const analysisTypes = Object.keys(summary)
        .filter(key => key.endsWith('_tasks_processed'))
        .map(key => key.replace('_tasks_processed', ''));
      
      analysisTypes.forEach(type => {
        const issuesKey = `${type}_issues_total`;
        const issuesCount = summary[issuesKey] || 0;
        const displayName = type.replace('_', ' ').replace(/\b\w/g, c => c.toUpperCase());
        
        html += `<div class="flex justify-between">
          <span>${displayName}:</span>
          <span>${issuesCount} issues</span>
        </div>`;
      });
      
      html += '</div></div>'; // End analysis types section
    }
    
    html += '</div>'; // End container
    
    container.innerHTML = html;
  }
  
  function updateActionButtons(status, jobId) {
    const cancelJobBtn = document.getElementById('cancelJobDetailsBtn');
    const deleteJobBtn = document.getElementById('deleteJobDetailsBtn');
    const cancelJobForm = document.getElementById('cancelJobDetailsForm');
    const deleteJobForm = document.getElementById('deleteJobDetailsForm');
    
    // Only show cancel button for running/initializing/queued jobs
    if (cancelJobBtn && cancelJobForm) {
      if (['running', 'initializing', 'queued'].includes(status)) {
        cancelJobForm.classList.remove('hidden');
        cancelJobForm.action = `/batch-analysis/job/${jobId}/cancel`;
      } else {
        cancelJobForm.classList.add('hidden');
      }
    }
    
    // Only show delete button for completed/failed/canceled jobs
    if (deleteJobBtn && deleteJobForm) {
      if (['completed', 'failed', 'cancelled', 'error'].includes(status)) {
        deleteJobForm.classList.remove('hidden');
        deleteJobForm.action = `/batch-analysis/job/${jobId}/delete`;
      } else {
        deleteJobForm.classList.add('hidden');
      }
    }
  }
  
  // ====== UTILITY FUNCTIONS ======
  function formatDuration(seconds) {
    if (seconds === null || seconds === undefined || isNaN(seconds) || seconds < 0) {
      return 'N/A';
    }
    
    seconds = Math.floor(seconds);
    
    if (seconds < 60) {
      return `${seconds}s`;
    } else if (seconds < 3600) {
      const minutes = Math.floor(seconds / 60);
      const remainingSeconds = seconds % 60;
      return `${minutes}m ${remainingSeconds}s`;
    } else {
      const hours = Math.floor(seconds / 3600);
      const remainingMinutes = Math.floor((seconds % 3600) / 60);
      return `${hours}h ${remainingMinutes}m`;
    }
  }
  
  function showToast(message, type = 'info') {
    const toastContainer = document.getElementById('toastContainer');
    if (!toastContainer) return;
    
    const toast = document.createElement('div');
    toast.className = 'rounded-md shadow-lg p-3 mb-2 text-sm transition-all duration-300 opacity-0 transform translate-x-2';
    
    switch(type) {
      case 'success':
        toast.classList.add('bg-green-100', 'text-green-800', 'border', 'border-green-300');
        break;
      case 'error':
        toast.classList.add('bg-red-100', 'text-red-800', 'border', 'border-red-300');
        break;
      case 'warning':
        toast.classList.add('bg-yellow-100', 'text-yellow-800', 'border', 'border-yellow-300');
        break;
      default:
        toast.classList.add('bg-blue-100', 'text-blue-800', 'border', 'border-blue-300');
    }
    
    toast.textContent = message;
    toastContainer.appendChild(toast);
    
    // Animate in
    setTimeout(() => {
      toast.classList.remove('opacity-0', 'translate-x-2');
    }, 10);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
      toast.classList.add('opacity-0', 'translate-x-2');
      setTimeout(() => {
        toast.remove();
      }, 300);
    }, 5000);
  }
  
  // ====== INITIALIZATION ======
  // Start auto-refresh for job status if we're on a job details page and the job is still running
  if (jobDetailsStatus && shouldAutoRefresh(jobDetailsStatus.dataset.currentStatus)) {
    if (autoRefreshContainer) autoRefreshContainer.classList.remove('hidden');
    if (autoRefreshToggle && autoRefreshToggle.checked) {
      startAutoRefresh();
    }
  }
  
  // Apply initial filters
  if (jobRows.length > 0) filterJobs();
  if (resultRows.length > 0) filterResults();
  
  // Set total results count
  if (totalResultsCount) totalResultsCount.textContent = resultRows.length;
});
</script>
{% endblock %}