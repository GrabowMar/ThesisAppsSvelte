{% extends "base.html" %}

{% block content %}
<div class="space-y-2 max-w-7xl mx-auto">
  <div class="border border-gray-400 bg-white p-2 rounded-md">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="font-bold text-xl text-gray-900">Batch Analysis Dashboard</h1>
        <p class="text-xs text-gray-600 mt-1">Manage and monitor batch analysis jobs</p>
      </div>
      <div class="flex items-center space-x-2">
        <a href="{{ url_for('main.index') }}" class="action-btn h-6 px-2 text-xs flex items-center">
          <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
          </svg>
          Main Dashboard
        </a>
        {# Link to create job page instead of toggle #}
        <a href="{{ url_for('batch_analysis.create_batch_job') }}" class="action-btn h-6 px-2 text-xs flex items-center bg-blue-600 text-white hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition duration-150">
           <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
          </svg>
          New Batch Job
        </a>
      </div>
    </div>
  </div>

  <div class="grid grid-cols-2 md:grid-cols-5 gap-2">
    <div class="border border-gray-400 bg-white p-2 rounded-md shadow-sm">
      <div class="text-xs text-gray-600">Total Jobs</div>
      <div class="text-lg font-bold">{{ jobs|length }}</div>
    </div>
     <div class="border border-gray-400 bg-white p-2 rounded-md shadow-sm">
      <div class="text-xs text-gray-600">Pending</div>
      <div class="text-lg font-bold text-gray-700">{{ stats.get('pending', 0) }}</div>
    </div>
    <div class="border border-gray-400 bg-white p-2 rounded-md shadow-sm">
      <div class="text-xs text-green-600">Running</div>
      {# Use stats dictionary #}
      <div class="text-lg font-bold text-green-700">{{ stats.get('running', 0) }}</div>
    </div>
    <div class="border border-gray-400 bg-white p-2 rounded-md shadow-sm">
      <div class="text-xs text-blue-600">Completed</div>
       {# Use stats dictionary #}
      <div class="text-lg font-bold text-blue-700">{{ stats.get('completed', 0) }}</div>
    </div>
    <div class="border border-gray-400 bg-white p-2 rounded-md shadow-sm">
      <div class="text-xs text-red-600">Failed/Canceled</div>
       {# Use stats dictionary #}
      <div class="text-lg font-bold text-red-700">{{ stats.get('failed', 0) + stats.get('canceled', 0) }}</div>
    </div>
  </div>

  <div class="border border-gray-400 bg-white rounded-md shadow-sm">
    <div class="bg-gray-100 border-b border-gray-400 px-2 py-1">
      <h2 class="font-bold text-sm">Filters</h2>
    </div>
    <div class="p-2 flex flex-wrap items-center gap-2">
      <div class="relative">
        <input type="text" id="searchJobs" placeholder="Search jobs..."
             class="h-6 pl-6 pr-2 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
        <svg class="w-3 h-3 absolute left-2 top-1.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
        </svg>
      </div>
      <select id="modelFilter" class="h-6 px-2 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500" aria-label="Filter by model">
        <option value="all">All Models</option>
        {% for model_name in all_models %}
          <option value="{{ model_name }}">{{ model_name }}</option>
        {% endfor %}
      </select>
      <select id="analysisTypeFilter" class="h-6 px-2 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500" aria-label="Filter by analysis type">
        <option value="all">All Analysis Types</option>
        {% for type_enum in AnalysisType %} {# Use AnalysisType enum passed from route #}
          <option value="{{ type_enum.value }}">{{ type_enum.value.replace('_', ' ')|title }}</option>
        {% endfor %}
      </select>
      <select id="statusFilter" class="h-6 px-2 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500" aria-label="Filter by status">
        <option value="all">All Statuses</option>
        {% for status_enum in JobStatus %} {# Use JobStatus enum passed from route #}
         <option value="{{ status_enum.value }}">{{ status_enum.value|title }}</option>
        {% endfor %}
      </select>
      <button id="clearFilters" class="action-btn h-6 px-2 text-xs border border-gray-300 rounded hover:bg-gray-100 focus:outline-none focus:ring-1 focus:ring-blue-500 transition">
        Clear Filters
      </button>
    </div>
  </div>

  <div class="border border-gray-400 bg-white rounded-md shadow-sm">
    <div class="bg-gray-100 border-b border-gray-400 px-2 py-1 flex justify-between items-center">
      <h2 class="font-bold text-sm">Job List</h2>
      <div class="text-xs text-gray-600" id="jobsCounter">
        Showing <span id="visibleJobsCount">{{ jobs|length }}</span> of {{ jobs|length }} jobs
      </div>
    </div>
    <div class="p-2">
      {% if jobs %}
        <div class="overflow-x-auto">
          <table class="min-w-full border border-gray-300">
            <thead>
              <tr class="bg-gray-100">
                <th class="border border-gray-300 px-2 py-1 text-xs text-left">ID</th>
                <th class="border border-gray-300 px-2 py-1 text-xs text-left">Name</th>
                <th class="border border-gray-300 px-2 py-1 text-xs text-left">Status</th>
                <th class="border border-gray-300 px-2 py-1 text-xs text-left">Analysis Types</th>
                <th class="border border-gray-300 px-2 py-1 text-xs text-left">Models</th>
                <th class="border border-gray-300 px-2 py-1 text-xs text-left">Created</th>
                <th class="border border-gray-300 px-2 py-1 text-xs text-left">Progress</th>
                <th class="border border-gray-300 px-2 py-1 text-xs text-left">Actions</th>
              </tr>
            </thead>
            <tbody id="jobsTableBody">
              {% for job in jobs %}
                <tr class="hover:bg-gray-50 job-row"
                    data-job-id="{{ job.id }}"
                    data-status="{{ job.status.value }}" {# Use enum value #}
                    data-analysis-types="{{ job.analysis_types|map(attribute='value')|join(',') }}" {# Join enum values #}
                    data-models="{{ job.models|join(',') }}"
                    data-name="{{ job.name }}">
                  <td class="border border-gray-300 px-2 py-1 text-xs">{{ job.id }}</td>
                  <td class="border border-gray-300 px-2 py-1 text-xs font-medium">
                    <a href="{{ url_for('batch_analysis.view_job', job_id=job.id) }}" class="text-blue-700 hover:underline">
                      {{ job.name }}
                    </a>
                  </td>
                  <td class="border border-gray-300 px-2 py-1 text-xs">
                    <span class="px-2 py-0.5 rounded-md text-white capitalize
                      {% if job.status == JobStatus.RUNNING %}bg-green-600
                      {% elif job.status == JobStatus.COMPLETED %}bg-blue-600
                      {% elif job.status == JobStatus.PENDING %}bg-gray-600
                      {% elif job.status == JobStatus.CANCELED %}bg-yellow-600
                      {% else %}bg-red-600{% endif %}">
                      {{ job.status.value }}
                    </span>
                  </td>
                  <td class="border border-gray-300 px-2 py-1 text-xs">
                     {# Display multiple analysis types as badges #}
                     <div class="flex flex-wrap gap-1">
                        {% for analysis_type in job.analysis_types %}
                          <span class="px-1.5 py-0.5 rounded text-white text-[10px] capitalize whitespace-nowrap
                            {% if analysis_type == AnalysisType.FRONTEND_SECURITY %}bg-purple-600
                            {% elif analysis_type == AnalysisType.BACKEND_SECURITY %}bg-indigo-600
                            {% elif analysis_type == AnalysisType.PERFORMANCE %}bg-cyan-600
                            {% elif analysis_type == AnalysisType.GPT4ALL %}bg-orange-600
                            {% elif analysis_type == AnalysisType.ZAP %}bg-lime-600
                            {% else %}bg-gray-500{% endif %}">
                            {{ analysis_type.value.replace('_', ' ') }}
                          </span>
                        {% endfor %}
                     </div>
                  </td>
                  <td class="border border-gray-300 px-2 py-1 text-xs">
                    {{ job.models|join(', ') }}
                  </td>
                  <td class="border border-gray-300 px-2 py-1 text-xs">
                    {# Use the pre-formatted date string from the job object #}
                    {{ job.created_at_formatted }}
                  </td>
                  <td class="border border-gray-300 px-2 py-1 text-xs">
                    <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden" title="{{ job.completed_tasks }}/{{ job.total_tasks }} tasks">
                      <div class="bg-blue-600 rounded-full h-2 transition-all duration-300" style="width: {{ (job.completed_tasks / job.total_tasks * 100) if job.total_tasks > 0 else 0 }}%"></div>
                    </div>
                    <span class="text-[10px] text-gray-600">{{ job.completed_tasks }}/{{ job.total_tasks }}</span>
                  </td>
                  <td class="border border-gray-300 px-2 py-1 text-xs">
                    <div class="flex space-x-1">
                      <a href="{{ url_for('batch_analysis.view_job', job_id=job.id) }}" class="action-btn h-6 px-2 text-xs focus:ring-2 focus:ring-blue-500 transition">
                        View
                      </a>
                      {% if job.status == JobStatus.RUNNING %}
                        <button class="cancel-job-btn action-btn h-6 px-2 text-xs bg-red-600 text-white hover:bg-red-700 focus:ring-2 focus:ring-red-500 transition" data-job-id="{{ job.id }}" aria-label="Cancel job {{ job.id }}">
                          Cancel
                        </button>
                      {% endif %}
                       {# Add delete button for non-running jobs #}
                       {% if job.status != JobStatus.RUNNING %}
                        <form method="POST" action="{{ url_for('batch_analysis.delete_job_api', job_id=job.id) }}" onsubmit="return confirm('Are you sure you want to delete this job and all its results?');" class="inline">
                            <button type="submit" class="action-btn h-6 px-2 text-xs bg-gray-500 text-white hover:bg-gray-600 focus:ring-2 focus:ring-gray-400 transition" aria-label="Delete job {{ job.id }}">
                                Delete
                            </button>
                        </form>
                       {% endif %}
                    </div>
                  </td>
                </tr>
              {% endfor %}
              <tr id="noResultsRow" class="hidden">
                <td colspan="8" class="border border-gray-300 px-2 py-4 text-xs text-center text-gray-500">
                  No jobs match your current filters
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="p-4 text-center border border-gray-300 rounded-md">
          <p class="text-xs text-gray-600">No batch jobs found</p>
          <a href="{{ url_for('batch_analysis.create_batch_job') }}" class="mt-2 inline-block action-btn h-6 px-2 text-xs bg-blue-600 text-white hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition">
            Create First Job
          </a>
        </div>
      {% endif %}
    </div>
  </div>

  <div id="toastContainer" class="fixed bottom-4 right-4 z-50"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Set up filters
  setupFilters();

  // Set up job handling (cancel button)
  setupJobHandling();

  function setupFilters() {
    const searchInput = document.getElementById('searchJobs');
    const modelFilter = document.getElementById('modelFilter');
    const analysisTypeFilter = document.getElementById('analysisTypeFilter'); // Added
    const statusFilter = document.getElementById('statusFilter');
    const clearFiltersBtn = document.getElementById('clearFilters');
    const jobRows = document.querySelectorAll('.job-row');
    const noResultsRow = document.getElementById('noResultsRow');
    const visibleJobsCount = document.getElementById('visibleJobsCount');

    const applyFilters = function() {
      const searchText = searchInput?.value?.toLowerCase() || '';
      const selectedModel = modelFilter?.value || 'all';
      const selectedAnalysisType = analysisTypeFilter?.value || 'all'; // Added
      const selectedStatus = statusFilter?.value || 'all';

      let visibleCount = 0;

      jobRows.forEach(function(row) {
        const models = row.dataset.models?.toLowerCase() || '';
        const analysisTypes = row.dataset.analysisTypes?.toLowerCase() || ''; // Added (comma-separated)
        const status = row.dataset.status?.toLowerCase() || '';
        const name = row.dataset.name?.toLowerCase() || '';

        const matchesSearch = !searchText ||
                              name.includes(searchText) ||
                              row.textContent.toLowerCase().includes(searchText);
        const matchesModel = selectedModel === 'all' || models.includes(selectedModel.toLowerCase());
        // Updated: Check if selected type is in the comma-separated list
        const matchesAnalysisType = selectedAnalysisType === 'all' || analysisTypes.split(',').includes(selectedAnalysisType);
        const matchesStatus = selectedStatus === 'all' || status === selectedStatus;

        const isVisible = matchesSearch && matchesModel && matchesAnalysisType && matchesStatus; // Added analysis type match
        row.style.display = isVisible ? '' : 'none';

        if (isVisible) visibleCount++;
      });

      // Update counter
      if (visibleJobsCount) {
        visibleJobsCount.textContent = visibleCount;
      }

      // Show/hide no results row
      if (noResultsRow) {
        noResultsRow.style.display = visibleCount === 0 ? 'table-row' : 'none';
      }
    };

    // Add event listeners with debounce for search
    let searchTimeout;
    if (searchInput) {
      searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(applyFilters, 300);
      });
    }

    // Add event listeners for filters
    [modelFilter, analysisTypeFilter, statusFilter].forEach(function(filter) { // Added analysisTypeFilter
      if (filter) {
        filter.addEventListener('change', applyFilters);
      }
    });

    // Clear filters button
    if (clearFiltersBtn) {
      clearFiltersBtn.addEventListener('click', function() {
        if (searchInput) searchInput.value = '';
        if (modelFilter) modelFilter.value = 'all';
        if (analysisTypeFilter) analysisTypeFilter.value = 'all'; // Added
        if (statusFilter) statusFilter.value = 'all';
        applyFilters();
        if (searchInput) searchInput.focus();
      });
    }

    // Apply filters on initial load
    applyFilters();
  }

  function setupJobHandling() {
    // Cancel job functionality
    const cancelBtns = document.querySelectorAll('.cancel-job-btn');

    cancelBtns.forEach(function(btn) {
      btn.addEventListener('click', function() {
        if (!confirm('Are you sure you want to cancel this job?')) {
          return;
        }

        const jobId = this.dataset.jobId;
        const button = this;

        button.disabled = true;
        button.innerHTML = `
          <svg class="animate-spin w-3 h-3 inline mr-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>Canceling...`;

        // Send cancel request
        fetch(`/batch/job/${jobId}/cancel`, { // Ensure URL prefix is correct
          method: 'POST',
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/json'
            // ** REMOVED Jinja expression causing error **
            // Add CSRF token if needed: 'X-CSRFToken': '...'
          }
        })
        .then(response => {
            if (!response.ok) {
                // Try to parse error from JSON response if possible
                return response.json().then(errData => {
                    throw new Error(errData.error || `HTTP error ${response.status}`);
                }).catch(() => {
                    // Fallback if JSON parsing fails
                    throw new Error(`HTTP error ${response.status}`);
                });
            }
            return response.json();
        })
        .then(data => {
          // Check for explicit success or specific status
          if (data.status === 'canceled' || data.success === true) {
            showToast('Job marked for cancellation.', 'info');
            // Consider updating the row status visually instead of full reload
             const row = button.closest('tr');
             if (row) {
                 const statusCell = row.querySelector('td:nth-child(3) span'); // Assuming status is 3rd cell
                 if (statusCell) {
                     statusCell.textContent = 'canceling'; // Or 'canceled'
                     statusCell.className = 'px-2 py-0.5 rounded-md text-white capitalize bg-yellow-600';
                 }
             }
             button.remove(); // Remove cancel button after request
            // Optionally reload after a delay: setTimeout(() => window.location.reload(), 1500);
          } else {
            showToast(data.error || 'Failed to cancel job', 'error');
            button.disabled = false;
            button.innerHTML = 'Cancel';
          }
        })
        .catch(error => {
          console.error('Error canceling job:', error);
          showToast('Error: ' + error.message, 'error');
          button.disabled = false;
          button.innerHTML = 'Cancel';
        });
      });
    });
  }

  // Toast notification helper (reuse from view_job.html or define globally)
  window.showToast = function(message, type = 'success') {
    if (!message) return;
    let toastContainer = document.getElementById('toastContainer');
    if (!toastContainer) {
      toastContainer = document.createElement('div');
      toastContainer.id = 'toastContainer';
      toastContainer.className = 'fixed bottom-4 right-4 z-50 flex flex-col gap-2';
      document.body.appendChild(toastContainer);
    }
    const toast = document.createElement('div');
    toast.className = `px-4 py-2 rounded-md shadow-md text-sm ${
      type === 'success' ? 'bg-green-100 border border-green-300 text-green-800' :
      type === 'error' ? 'bg-red-100 border border-red-300 text-red-800' :
      type === 'info' ? 'bg-blue-100 border border-blue-300 text-blue-800' :
      'bg-gray-100 border border-gray-300 text-gray-800'
    } transition-opacity duration-300`;
    toast.textContent = message;
    toastContainer.appendChild(toast);
    setTimeout(function() {
      toast.style.opacity = 0;
      setTimeout(function() { toast.remove(); }, 300);
    }, 3000);
    return toast;
  };
});
</script>
{% endblock %}
