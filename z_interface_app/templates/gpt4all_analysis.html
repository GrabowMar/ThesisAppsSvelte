{% extends "base.html" %}
{% block content %}
<!-- Expose summary to JS if available -->
<script>
  window.summary = {{ summary|tojson|safe }};
</script>

<div class="flex min-h-screen bg-gray-100">
  <!-- Main Content -->
  <div class="flex-1 flex flex-col overflow-hidden">
    <!-- Top Bar -->
    <div class="bg-gray-200 border-b border-gray-400 p-1">
      <div class="flex justify-between items-center">
        <div class="flex items-center space-x-2">
          <a href="{{ url_for('main.index') }}" class="action-btn h-6 px-2 text-xs">Back</a>
          <button id="toggleForm" class="action-btn h-6 px-2 text-xs">Show Requirements Form</button>
        </div>
        <div class="flex items-center space-x-2">
          <input type="text" id="searchIssues" placeholder="Search issues..." class="h-6 px-2 text-xs border border-gray-300">
          <select id="severityFilter" class="h-6 px-2 text-xs border border-gray-300">
            <option value="all">All Severities</option>
            <option value="HIGH">High</option>
            <option value="MEDIUM">Medium</option>
            <option value="LOW">Low</option>
          </select>
          <select id="fileFilter" class="h-6 px-2 text-xs border border-gray-300">
            <option value="all">All Files</option>
            {% set files = [] %}
            {% for issue in issues %}
              {% if issue.filename not in files %}
                {% set _ = files.append(issue.filename) %}
                <option value="{{ issue.filename }}">{{ issue.filename }}</option>
              {% endif %}
            {% endfor %}
          </select>
        </div>
      </div>
    </div>

    <!-- Requirements Input Form -->
    <div id="requirementsFormContainer" class="p-2 hidden">
      <form id="requirementsForm" method="POST" action="{{ url_for('gpt4all.gpt4all_analysis') }}">
        <div class="border border-gray-400 bg-white p-2">
          <label for="requirements" class="block text-xs font-bold mb-2">Requirements List (one per line)</label>
          <textarea id="requirements" name="requirements" rows="6" class="w-full p-2 text-xs border border-gray-300">{% if requirements %}{{ '\n'.join(requirements) }}{% else %}1. The application must handle errors gracefully
2. The application must sanitize user inputs
3. The application must implement proper authentication
4. The application must have adequate test coverage
5. The application must follow secure coding practices{% endif %}</textarea>
          
          <input type="hidden" name="model" value="{{ model }}">
          <input type="hidden" name="app_num" value="{{ app_num }}">
          <input type="hidden" name="type" value="requirements">
          
          <div class="mt-2 flex justify-between items-center">
            <button type="submit" class="action-btn bg-blue-600 text-white hover:bg-blue-700">
              <span id="submitBtnText">Analyze Requirements</span>
              <span id="loadingIndicator" class="hidden ml-1">
                <svg class="animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
              </span>
            </button>
            <button type="button" id="cancelForm" class="action-btn">Cancel</button>
          </div>
        </div>
      </form>
    </div>

    <!-- Analysis Progress -->
    <div id="analysisProgress" class="hidden p-2">
      <div class="border border-gray-400 bg-white p-2">
        <div class="flex justify-between items-center mb-2">
          <div class="text-xs font-bold">Analysis in Progress</div>
          <div class="text-xs" id="progressStatus">Starting...</div>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-2">
          <div id="progressBar" class="bg-blue-600 rounded-full h-2 transition-all duration-500" style="width: 0%"></div>
        </div>
      </div>
    </div>

    <!-- Analysis Grid -->
    <div class="p-2 grid grid-cols-4 gap-2">
      <div class="border border-gray-400 bg-white p-2" data-type="met">
        <div class="text-xs text-green-800">Met Conditions</div>
        <div class="text-xs font-bold text-green-700">
          {{ summary.met_conditions.total if summary and summary.get('met_conditions') else 0 }}
        </div>
        <div class="mt-1 text-xs">
          <span class="text-gray-600">Frontend: </span>
          <span class="font-bold text-green-700">{{ summary.met_conditions.frontend if summary and summary.get('met_conditions') else 0 }}</span>
        </div>
        <div class="text-xs">
          <span class="text-gray-600">Backend: </span>
          <span class="font-bold text-green-700">{{ summary.met_conditions.backend if summary and summary.get('met_conditions') else 0 }}</span>
        </div>
      </div>
      
      <div class="border border-gray-400 bg-white p-2" data-type="unmet">
        <div class="text-xs text-red-800">Unmet Conditions</div>
        <div class="text-xs font-bold text-red-700">
          {{ summary.unmet_conditions.total if summary and summary.get('unmet_conditions') else 0 }}
        </div>
        <div class="mt-1 text-xs">
          <span class="text-gray-600">Frontend: </span>
          <span class="font-bold text-red-700">{{ summary.unmet_conditions.frontend if summary and summary.get('unmet_conditions') else 0 }}</span>
        </div>
        <div class="text-xs">
          <span class="text-gray-600">Backend: </span>
          <span class="font-bold text-red-700">{{ summary.unmet_conditions.backend if summary and summary.get('unmet_conditions') else 0 }}</span>
        </div>
      </div>
      
      <div class="border border-gray-400 bg-white p-2" data-type="frontend">
        <div class="text-xs text-blue-800">Frontend Files</div>
        <div class="text-xs font-bold text-blue-700">
          {{ summary.frontend_files if summary else 0 }}
        </div>
        <div class="mt-1 text-xs">
          <span class="text-gray-600">Analyzed: </span>
          <span class="font-bold">{{ summary.frontend_files if summary else 0 }}</span>
        </div>
      </div>
      
      <div class="border border-gray-400 bg-white p-2" data-type="backend">
        <div class="text-xs text-purple-800">Backend Files</div>
        <div class="text-xs font-bold text-purple-700">
          {{ summary.backend_files if summary else 0 }}
        </div>
        <div class="mt-1 text-xs">
          <span class="text-gray-600">Analyzed: </span>
          <span class="font-bold">{{ summary.backend_files if summary else 0 }}</span>
        </div>
      </div>
    </div>

    <!-- Requirements List Display -->
    {% if requirements %}
    <div class="p-2">
      <div class="border border-gray-400 bg-white p-2">
        <h2 class="text-xs font-bold mb-2">Current Requirements</h2>
        <ul class="text-xs list-disc pl-4">
          {% for req in requirements %}
          <li>{{ req }}</li>
          {% endfor %}
        </ul>
      </div>
    </div>
    {% endif %}

    <!-- Issue List -->
    <div class="p-2 flex-1 overflow-auto space-y-2">
      {% if issues %}
      <div class="space-y-2" id="issueList">
        {% for issue in issues %}
        <div class="border border-gray-400 bg-white {% if issue.severity == 'HIGH' %}bg-red-50{% elif issue.severity == 'MEDIUM' %}bg-yellow-50{% else %}bg-blue-50{% endif %}"
             data-severity="{{ issue.severity }}" data-file="{{ issue.filename }}"
             data-searchable="{{ issue.issue_type }} {{ issue.issue_text }} {{ issue.filename }}">
          <div class="p-2">
            <div class="flex items-center space-x-2 mb-1">
              <span class="text-xs px-2 py-0.5 border {% if issue.severity == 'HIGH' %}bg-red-100 text-red-800 border-red-700{% elif issue.severity == 'MEDIUM' %}bg-yellow-100 text-yellow-800 border-yellow-700{% else %}bg-blue-100 text-blue-800 border-blue-700{% endif %}">
                {{ issue.severity }}
              </span>
              <span class="text-xs px-2 py-0.5 bg-gray-100 border border-gray-400">{{ issue.confidence }}</span>
              <span class="text-xs px-2 py-0.5 bg-gray-100 border border-gray-400">{{ issue.issue_type }}</span>
              <button class="ml-auto action-btn h-6 px-2 text-xs expand-btn">Expand</button>
            </div>
            <div class="space-y-2">
              <div>
                <div class="text-xs font-bold">{{ issue.issue_text }}</div>
                <div class="text-xs text-gray-600">{{ issue.filename }}</div>
              </div>
              <div class="issue-details hidden space-y-2">
                <div class="text-xs font-mono text-gray-600">
                  {{ issue.filename }}{% if issue.line_number > 0 %}:{{ issue.line_number }}{% endif %}
                </div>
                {% if issue.code %}
                <pre class="text-xs font-mono bg-gray-800 text-white p-1 overflow-x-auto"><code>{{ issue.code }}</code></pre>
                {% endif %}
                {% if issue.suggested_fix %}
                <div class="text-xs bg-green-50 border border-green-300 p-2">
                  <div class="font-bold text-green-800">Suggested Fix:</div>
                  <div class="whitespace-pre-wrap">{{ issue.suggested_fix }}</div>
                </div>
                {% endif %}
                {% if issue.explanation %}
                <div class="text-xs bg-blue-50 border border-blue-300 p-2">
                  <div class="font-bold text-blue-800">Explanation:</div>
                  <div class="whitespace-pre-wrap">{{ issue.explanation }}</div>
                </div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="border border-gray-400 bg-white p-4 text-center">
        {% if error %}
        <div class="inline-block border border-red-700 bg-red-50 p-2">
          <p class="text-xs font-bold text-red-700">{{ error }}</p>
        </div>
        {% else %}
        <div class="inline-block border border-gray-700 bg-gray-50 p-2">
          <p class="text-xs font-bold text-gray-700">No requirements issues found. Start an analysis to begin.</p>
        </div>
        {% endif %}
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Right Sidebar -->
  <aside class="w-64 bg-gray-200 border-l border-gray-400 flex flex-col">
    <div class="p-2 space-y-2 flex-1 overflow-auto">
      <!-- Analysis Info -->
      <div class="border border-gray-400 bg-white">
        <div class="bg-gray-100 border-b border-gray-400 px-2 py-1">
          <h2 class="font-bold text-xs">Analysis Info</h2>
        </div>
        <div class="p-2 text-xs space-y-1">
          <div class="flex justify-between">
            <span class="text-gray-600">Model:</span>
            <span class="font-bold">{{ model }}</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600">App:</span>
            <span class="font-bold">{{ app_num }}</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600">Last Analysis:</span>
            <span class="font-bold">{{ summary.scan_time if summary else 'Never' }}</span>
          </div>
        </div>
      </div>

      <!-- Model Information -->
      <div class="border border-gray-400 bg-white">
        <div class="bg-gray-100 border-b border-gray-400 px-2 py-1">
          <h2 class="font-bold text-xs">Model Information</h2>
        </div>
        <div class="p-2 space-y-2">
          <div class="text-xs">
            <div class="font-bold mb-1">{{ model_info.name }}</div>
            <div class="space-y-1">
              <div class="flex justify-between">
                <span class="text-gray-600">RAM Required:</span>
                <span>{{ model_info.ram_required }}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">Parameters:</span>
                <span>{{ model_info.parameters }}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">Type:</span>
                <span>{{ model_info.type }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Requirements Summary -->
      <div class="border border-gray-400 bg-white">
        <div class="bg-gray-100 border-b border-gray-400 px-2 py-1">
          <h2 class="font-bold text-xs">Requirements Summary</h2>
        </div>
        <div class="p-2 text-xs">
          <div class="space-y-1">
            <div class="flex justify-between">
              <span class="text-gray-600">Total Requirements:</span>
              <span class="font-bold">{{ summary.total_requirements if summary and summary.get('total_requirements') else 0 }}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">Met Frontend:</span>
              <span class="font-bold text-green-700">{{ summary.met_conditions.frontend if summary and summary.get('met_conditions') else 0 }}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">Met Backend:</span>
              <span class="font-bold text-green-700">{{ summary.met_conditions.backend if summary and summary.get('met_conditions') else 0 }}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">Unmet Frontend:</span>
              <span class="font-bold text-red-700">{{ summary.unmet_conditions.frontend if summary and summary.get('unmet_conditions') else 0 }}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">Unmet Backend:</span>
              <span class="font-bold text-red-700">{{ summary.unmet_conditions.backend if summary and summary.get('unmet_conditions') else 0 }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Analysis Stats -->
      <div class="border border-gray-400 bg-white">
        <div class="bg-gray-100 border-b border-gray-400 px-2 py-1">
          <h2 class="font-bold text-xs">Analysis Stats</h2>
        </div>
        <div class="p-2 text-xs">
          {% if summary %}
          <div class="space-y-1">
            <div class="flex justify-between">
              <span class="text-gray-600">Files Analyzed:</span>
              <span class="font-bold">{{ (summary.frontend_files|default(0)) + (summary.backend_files|default(0)) }}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">Analysis Duration:</span>
              <span class="font-bold" id="analysisDuration">-</span>
            </div>
            <div class="border-t border-gray-200 pt-1 mt-1">
              {% if summary.issue_types %}
                <div class="font-bold mb-1">Issue Types:</div>
                {% for type, count in summary.issue_types.items() %}
                <div class="flex justify-between">
                  <span>{{ type }}</span>
                  <span class="font-bold">{{ count }}</span>
                </div>
                {% endfor %}
              {% else %}
                <div class="text-center text-gray-600">
                  No issue type data available
                </div>
              {% endif %}
            </div>
          </div>
          {% else %}
          <div class="text-center text-gray-600">
            No analysis data available
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </aside>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Form toggle functionality
  const formContainer = document.getElementById('requirementsFormContainer');
  const toggleFormBtn = document.getElementById('toggleForm');
  const cancelFormBtn = document.getElementById('cancelForm');
  
  if (toggleFormBtn) {
    toggleFormBtn.addEventListener('click', function() {
      formContainer.classList.toggle('hidden');
      this.textContent = formContainer.classList.contains('hidden') ? 
        'Show Requirements Form' : 'Hide Requirements Form';
    });
  }
  
  if (cancelFormBtn) {
    cancelFormBtn.addEventListener('click', function() {
      formContainer.classList.add('hidden');
      toggleFormBtn.textContent = 'Show Requirements Form';
    });
  }

  // Add loading indicator when form is submitted
  const requirementsForm = document.getElementById('requirementsForm');
  const submitBtnText = document.getElementById('submitBtnText');
  const loadingIndicator = document.getElementById('loadingIndicator');
  const progressBar = document.getElementById('progressBar');
  const analysisProgress = document.getElementById('analysisProgress');
  
  if (requirementsForm) {
    requirementsForm.addEventListener('submit', function() {
      // Show loading state
      if (submitBtnText) submitBtnText.textContent = 'Analyzing...';
      if (loadingIndicator) loadingIndicator.classList.remove('hidden');
      
      // Show progress bar
      if (analysisProgress) analysisProgress.classList.remove('hidden');
      
      // Simulate progress (since we don't have real-time updates)
      let progress = 0;
      const interval = setInterval(() => {
        progress += 1;
        if (progress <= 95 && progressBar) {
          progressBar.style.width = progress + '%';
        } else {
          clearInterval(interval);
        }
      }, 500);
      
      // Disable form to prevent double submission
      this.querySelectorAll('button, input, textarea, select').forEach(el => {
        el.disabled = true;
      });
      
      // Let the form submit proceed
      return true;
    });
  }

  // Expand/collapse functionality.
  document.querySelectorAll('.expand-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const details = this.closest('div').nextElementSibling.querySelector('.issue-details');
      details.classList.toggle('hidden');
      this.textContent = details.classList.contains('hidden') ? 'Expand' : 'Collapse';
    });
  });

  // Filtering functionality.
  function applyFilters() {
    const searchTerm = document.getElementById('searchIssues').value.toLowerCase();
    const selectedSeverity = document.getElementById('severityFilter').value;
    const selectedFile = document.getElementById('fileFilter').value;
    document.querySelectorAll('#issueList > div').forEach(issue => {
      const severityMatch = selectedSeverity === 'all' || issue.dataset.severity === selectedSeverity;
      const fileMatch = selectedFile === 'all' || issue.dataset.file === selectedFile;
      const searchMatch = !searchTerm || issue.dataset.searchable.toLowerCase().includes(searchTerm);
      issue.style.display = (severityMatch && fileMatch && searchMatch) ? 'block' : 'none';
    });
  }
  document.getElementById('searchIssues').addEventListener('input', function() {
    clearTimeout(this.timeout);
    this.timeout = setTimeout(applyFilters, 300);
  });
  document.getElementById('severityFilter').addEventListener('change', applyFilters);
  document.getElementById('fileFilter').addEventListener('change', applyFilters);

  // Update analysis duration if available.
  function updateAnalysisDuration() {
    const durationElement = document.getElementById('analysisDuration');
    if (durationElement && window.summary && window.summary.start_time && window.summary.end_time) {
      const start = new Date(window.summary.start_time);
      const end = new Date(window.summary.end_time);
      durationElement.textContent = `${Math.round((end - start) / 1000)}s`;
    } else if (durationElement) {
      durationElement.textContent = 'N/A';
    }
  }
  updateAnalysisDuration();
  
  // Show form if no issues are found
  if (document.querySelectorAll('#issueList > div').length === 0 && formContainer) {
    formContainer.classList.remove('hidden');
    if (toggleFormBtn) {
      toggleFormBtn.textContent = 'Hide Requirements Form';
    }
  }
});
</script>
{% endblock %}