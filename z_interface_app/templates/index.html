{% extends "base.html" %}

{% block content %}
<div class="space-y-3">
  <!-- Control Toolbar - Aligned with UIController -->
  <div class="bg-gray-100 border border-gray-300 p-2 rounded-md shadow-sm">
    <div class="flex flex-wrap items-center gap-2">
      <!-- Core Controls - Managed by CoreController -->
      <button id="refreshAll" class="action-btn bg-blue-600 hover:bg-blue-700 text-white text-xs py-1 px-2">
        <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
        </svg>Refresh All
      </button>
      <button id="toggleAutorefresh" class="action-btn text-xs py-1 px-2 {{ 'bg-green-600 hover:bg-green-700 text-white' if autorefresh_enabled else '' }}" data-enabled="{{ 'true' if autorefresh_enabled else 'false' }}">
        <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg><span id="autorefreshText">Auto: {{ "On" if autorefresh_enabled else "Off" }}</span>
      </button>
      <div class="border-l border-gray-400 h-5 mx-1"></div>

      <!-- Search and Filters - UIController.filterApps -->
      <div class="relative">
        <input type="text" id="searchApps" class="h-6 pl-7 pr-2 text-xs rounded border border-gray-300 focus:ring-1 focus:ring-blue-500" style="width: 180px" placeholder="Search apps..." />
        <svg class="w-3.5 h-3.5 text-gray-500 absolute left-2 top-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
      </div>
      <select id="filterModel" class="h-6 px-2 text-xs rounded border border-gray-300 focus:ring-1 focus:ring-blue-500">
        <option value="">All Models</option>
        {% for model in models %}<option value="{{ model.name }}">{{ model.name }}</option>{% endfor %}
      </select>
      <select id="filterStatus" class="h-6 px-2 text-xs rounded border border-gray-300 focus:ring-1 focus:ring-blue-500">
        <option value="">All Statuses</option>
        <option value="running">Running</option>
        <option value="partial">Partial</option>
        <option value="stopped">Stopped</option>
      </select>
      <div class="border-l border-gray-400 h-5 mx-1"></div>

      <!-- Security Features - SecurityAnalysis class -->
      <select id="securitySummaryFilter" class="h-6 px-2 text-xs rounded border border-gray-300 focus:ring-1 focus:ring-blue-500">
        <option value="all">All Security</option>
        <option value="high">High Risk Only</option>
        <option value="critical">Critical Issues</option>
      </select>
      <div class="border-l border-gray-400 h-5 mx-1"></div>

      <!-- Batch Analysis - FeatureManager.requirementsAnalysis -->
      <a href="{{ url_for('batch_analysis.batch_dashboard') }}" class="action-btn py-1 px-2 text-xs bg-indigo-600 hover:bg-indigo-700 text-white">
        <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
        </svg>Batch Analysis
      </a>
    </div>
  </div>

  <!-- System Status Overview - SystemInfoService metrics -->
  <div class="border border-gray-300 bg-white rounded-md shadow-sm">
    <div class="bg-gray-50 border-b border-gray-300 px-3 py-1.5">
      <h2 class="font-semibold text-xs text-gray-700">System Status</h2>
    </div>
    <div class="p-2">
      <div class="grid grid-cols-6 gap-2">
        <!-- App Status Cards - StateManager data -->
        <div class="col-span-4 grid grid-cols-4 gap-2">
          {% set running_apps = apps|selectattr('backend_status.running','true')|selectattr('frontend_status.running','true')|list %}
          {% set partial_apps = (apps|selectattr('backend_status.running','true')|rejectattr('frontend_status.running','true')|list) + (apps|rejectattr('backend_status.running','true')|selectattr('frontend_status.running','true')|list) %}
          {% set stopped_apps = apps|rejectattr('backend_status.running','true')|rejectattr('frontend_status.running','true')|list %}

          <div class="border border-gray-200 p-2 rounded bg-gray-50 shadow-sm">
            <div class="text-xs text-gray-500 mb-0.5">Total Apps</div>
            <div class="text-base font-bold">{{ apps|length }}</div>
          </div>
          <div class="border border-green-200 p-2 rounded bg-green-50 shadow-sm">
            <div class="text-xs text-gray-500 mb-0.5">Running</div>
            <div class="text-base font-bold text-green-700">{{ running_apps|length }}</div>
          </div>
          <div class="border border-yellow-200 p-2 rounded bg-yellow-50 shadow-sm">
            <div class="text-xs text-gray-500 mb-0.5">Partial</div>
            <div class="text-base font-bold text-yellow-700">{{ partial_apps|length }}</div>
          </div>
          <div class="border border-red-200 p-2 rounded bg-red-50 shadow-sm">
            <div class="text-xs text-gray-500 mb-0.5">Stopped</div>
            <div class="text-base font-bold text-red-700">{{ stopped_apps|length }}</div>
          </div>
        </div>

        <!-- Security Overview - SecurityAnalysis feature -->
        <div class="col-span-2 grid grid-cols-2 gap-2">
          <div class="border border-gray-200 p-2 rounded bg-gray-50 shadow-sm">
            <div class="text-xs text-gray-500 mb-0.5">Security Status</div>
            <div class="grid grid-cols-3 gap-1 mt-1">
              <div class="text-center rounded bg-red-50 py-0.5" title="High Severity Issues">
                <div class="text-xs font-bold text-red-700" id="totalHighIssues">-</div>
                <div class="text-2xs text-gray-500">High</div>
              </div>
              <div class="text-center rounded bg-yellow-50 py-0.5" title="Medium Severity Issues">
                <div class="text-xs font-bold text-yellow-700" id="totalMediumIssues">-</div>
                <div class="text-2xs text-gray-500">Med</div>
              </div>
              <div class="text-center rounded bg-blue-50 py-0.5" title="Low Severity Issues">
                <div class="text-xs font-bold text-blue-700" id="totalLowIssues">-</div>
                <div class="text-2xs text-gray-500">Low</div>
              </div>
            </div>
          </div>
          <div class="border border-gray-200 p-2 rounded bg-gray-50 shadow-sm">
            <div class="text-xs text-gray-500 mb-0.5">Last Scan</div>
            <div class="text-xs font-bold mt-1" id="lastGlobalScan">Never</div>
            <div class="text-2xs text-gray-500" id="globalScanStatus">No active scans</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Model Sections - CoreController/FeatureManager managed -->
  {% for model in models %}
  <div class="border border-gray-300 bg-white rounded-md shadow-sm" data-model-section="{{ model.name }}">
    <!-- Model Header with Batch Operations -->
    <div class="bg-gray-50 border-b border-gray-300 px-3 py-1.5">
      <div class="flex justify-between items-center">
        <div class="flex items-center">
          <h2 class="font-semibold text-xs model-color-{{ model.name|lower }}">{{ model.name }}</h2>
          <!-- Batch Operations - CoreController.performBatchOperation -->
          <div class="ml-3 relative inline-block text-left" data-model="{{ model.name }}">
            <button type="button" class="batch-menu-button inline-flex justify-center items-center text-2xs bg-gray-100 hover:bg-gray-200 border border-gray-300 rounded px-2 py-0.5 transition-colors duration-150">
              <span>Batch</span>
              <svg class="w-3 h-3 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
            <!-- Dropdown Menu -->
            <div class="batch-menu-items hidden absolute z-10 mt-1 w-40 bg-white border border-gray-300 rounded shadow-lg">
              <div class="py-0.5">
                <button class="batch-action w-full text-left px-3 py-1 text-2xs hover:bg-gray-100 transition-colors duration-150" data-action="start" data-model="{{ model.name }}">Start All Apps</button>
                <button class="batch-action w-full text-left px-3 py-1 text-2xs hover:bg-gray-100 transition-colors duration-150" data-action="stop" data-model="{{ model.name }}">Stop All Apps</button>
                <button class="batch-action w-full text-left px-3 py-1 text-2xs hover:bg-gray-100 transition-colors duration-150" data-action="reload" data-model="{{ model.name }}">Reload All Apps</button>
                <button class="batch-action w-full text-left px-3 py-1 text-2xs hover:bg-gray-100 transition-colors duration-150" data-action="rebuild" data-model="{{ model.name }}">Rebuild All Apps</button>
                <hr class="my-0.5 border-gray-200">
                <button class="batch-action w-full text-left px-3 py-1 text-2xs hover:bg-gray-100 transition-colors duration-150" data-action="health-check" data-model="{{ model.name }}">Health Check All</button>
              </div>
            </div>
          </div>
          <!-- Batch Status - UIController.updateBatchProgress -->
          <div class="batch-status ml-2 hidden">
            <span class="px-1.5 py-0.5 text-2xs bg-blue-100 text-blue-800 border border-blue-300 rounded">
              <span class="batch-status-text">Processing...</span>
              <span class="batch-progress ml-1">0/0</span>
            </span>
          </div>
        </div>
        <div class="flex items-center space-x-1">
          <span class="text-2xs text-gray-600">Security:</span>
          <div class="security-badges flex space-x-1">
            <span class="security-high px-1.5 py-0.5 text-2xs rounded hidden"></span>
            <span class="security-medium px-1.5 py-0.5 text-2xs rounded hidden"></span>
            <span class="security-low px-1.5 py-0.5 text-2xs rounded hidden"></span>
          </div>
        </div>
      </div>
    </div>

    <!-- App Cards Grid - UIController.updateStatusDisplay targets -->
    <div class="p-2 grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-2">
      {% for app in apps if app.model == model.name %}
      <div class="border border-gray-300 relative rounded shadow-sm hover:shadow-md transition-shadow" data-app-id="{{ app.app_num }}" data-model="{{ app.model }}" data-app-name="{{ app.name }}" data-status="{{ app.backend_status.running and app.frontend_status.running and 'running' or app.backend_status.running or app.frontend_status.running and 'partial' or 'stopped' }}">
        <!-- App Header -->
        <div class="bg-gray-50 border-b border-gray-300 px-2 py-1 flex justify-between items-center rounded-t">
          <div class="flex items-center">
            <span class="font-semibold text-xs truncate max-w-[110px]" title="{{ app.name }}">{{ app.name }}</span>
            <span class="ml-1.5 text-2xs text-gray-500">#{{ app.app_num }}</span>
          </div>
          <div class="flex items-center space-x-1">
            <span class="status-badge text-2xs px-1.5 py-0.5 border rounded
              {% if app.backend_status.running and app.frontend_status.running %}
                bg-green-100 text-green-800 border-green-700
              {% elif app.backend_status.running or app.frontend_status.running %}
                bg-yellow-100 text-yellow-800 border-yellow-700
              {% else %}
                bg-red-100 text-red-800 border-red-700
              {% endif %}">
              {{ "Running" if app.backend_status.running and app.frontend_status.running
              else "Partial" if app.backend_status.running or app.frontend_status.running
              else "Stopped" }}
            </span>
            <span class="security-indicator hidden text-2xs px-1 py-0.5 rounded"></span>
          </div>
        </div>

        <!-- App Details -->
        <div class="p-2">
          <!-- Status Information -->
          <div class="grid grid-cols-2 gap-2 text-2xs mb-2">
            <div class="flex flex-col">
              <div class="text-gray-500">Backend:</div>
              <div class="flex items-center">
                <span class="w-2 h-2 rounded-full {{ 'bg-green-500' if app.backend_status.running else 'bg-red-500' }} mr-1.5"></span>
                <a href="{{ app.backend_url }}" target="_blank" class="font-medium text-blue-700 hover:underline">{{ app.backend_port }}</a>
              </div>
            </div>
            <div class="flex flex-col">
              <div class="text-gray-500">Frontend:</div>
              <div class="flex items-center">
                <span class="w-2 h-2 rounded-full {{ 'bg-green-500' if app.frontend_status.running else 'bg-red-500' }} mr-1.5"></span>
                <a href="{{ app.frontend_url }}" target="_blank" class="font-medium text-blue-700 hover:underline">{{ app.frontend_port }}</a>
              </div>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="grid grid-cols-4 gap-1">
            <!-- Control Row - CoreController.performAppAction targets -->
            <button class="app-action-btn bg-green-600 hover:bg-green-700 text-white text-2xs py-1" title="Start App" data-action="start" data-model="{{ app.model }}" data-app-num="{{ app.app_num }}">Start</button>
            <button class="app-action-btn bg-red-600 hover:bg-red-700 text-white text-2xs py-1" title="Stop App" data-action="stop" data-model="{{ app.model }}" data-app-num="{{ app.app_num }}">Stop</button>
            <button class="app-action-btn bg-yellow-600 hover:bg-yellow-700 text-white text-2xs py-1" title="Reload App" data-action="reload" data-model="{{ app.model }}" data-app-num="{{ app.app_num }}">Reload</button>
            <button class="app-action-btn bg-gray-200 hover:bg-gray-300 text-2xs py-1" title="Check Status" data-action="status" data-model="{{ app.model }}" data-app-num="{{ app.app_num }}">Status</button>

            <!-- Feature Links - FeatureManager components -->
            <a href="{{ url_for('main.view_logs', model=app.model, app_num=app.app_num) }}" class="action-btn text-center text-2xs py-1 bg-blue-50 hover:bg-blue-100 text-blue-700">Logs</a>
            <a href="{{ url_for('performance.performance_test', model=app.model, port=app.frontend_port) }}" class="action-btn text-center text-2xs py-1 bg-purple-50 hover:bg-purple-100 text-purple-700">Perf</a>
            <a href="{{ url_for('analysis.security_analysis', model=app.model, app_num=app.app_num) }}" class="action-btn text-center text-2xs py-1 bg-rose-50 hover:bg-rose-100 text-rose-700">API</a>
            <a href="{{ url_for('analysis.frontend_security_analysis', model=app.model, app_num=app.app_num) }}" class="action-btn text-center text-2xs py-1 bg-indigo-50 hover:bg-indigo-100 text-indigo-700">UI</a>
            
            <!-- Advanced Tools -->
            <a href="{{ url_for('zap.zap_scan_page', model=app.model, app_num=app.app_num) }}" class="action-btn text-center text-2xs py-1 bg-amber-50 hover:bg-amber-100 text-amber-700">ZAP</a>
            <button class="app-action-btn bg-purple-600 hover:bg-purple-700 text-white text-2xs py-1 col-span-2" title="Rebuild App" data-action="rebuild" data-model="{{ app.model }}" data-app-num="{{ app.app_num }}">Rebuild</button>
            <a href="{{ url_for('gpt4all.gpt4all_analysis', model=app.model, app_num=app.app_num) }}" class="action-btn text-center text-2xs py-1 bg-emerald-50 hover:bg-emerald-100 text-emerald-700">Reqs</a>
          </div>
        </div>

        <!-- Security Status - SecurityAnalysis feature indicator -->
        <div class="security-status absolute top-0 right-0 mt-0.5 mr-0.5 hidden">
          <div class="rounded-full w-2.5 h-2.5 shadow-sm"></div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endfor %}

  <!-- No Results Message - UIController.toggleNoResultsMessage target -->
  <div id="noResultsMessage" class="hidden border border-gray-300 bg-white p-3 text-center text-xs text-gray-600 rounded-md shadow-sm">
    No apps match your search criteria
  </div>
</div>

<!-- Loading overlay -->
<div id="loadingOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white p-4 rounded-lg shadow-lg">
    <div class="flex items-center">
      <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      <span id="loadingText">Processing...</span>
    </div>
  </div>
</div>

<!-- Notification container -->
<div id="notificationContainer" class="fixed top-4 right-4 z-40"></div>

{% block extra_scripts %}
<script>
// Dashboard Application Controller
$(document).ready(function() {
  
  // Utility functions
  function showNotification(message, type = 'info', duration = 5000) {
    const alertClass = type === 'success' ? 'alert-success bg-green-100 text-green-800 border-green-300' : 
                      type === 'error' ? 'alert-danger bg-red-100 text-red-800 border-red-300' : 
                      type === 'warning' ? 'alert-warning bg-yellow-100 text-yellow-800 border-yellow-300' :
                      'alert-info bg-blue-100 text-blue-800 border-blue-300';
    
    const alert = $(`
      <div class="alert ${alertClass} border px-4 py-3 rounded mb-2 shadow-lg max-w-sm">
        <div class="flex justify-between items-start">
          <div class="text-sm">${message}</div>
          <button type="button" class="ml-2 text-lg leading-none hover:opacity-75">&times;</button>
        </div>
      </div>
    `);
    
    $('#notificationContainer').append(alert);
    
    // Auto-remove after duration
    setTimeout(() => alert.fadeOut(() => alert.remove()), duration);
    
    // Manual close
    alert.find('button').on('click', () => alert.fadeOut(() => alert.remove()));
  }

  function showLoading(text = 'Processing...') {
    $('#loadingText').text(text);
    $('#loadingOverlay').removeClass('hidden');
  }

  function hideLoading() {
    $('#loadingOverlay').addClass('hidden');
  }

  function setButtonLoading(button, loading = true) {
    const $btn = $(button);
    if (loading) {
      $btn.prop('disabled', true).addClass('opacity-50 cursor-not-allowed');
      const originalText = $btn.text();
      $btn.data('original-text', originalText).text('...');
    } else {
      $btn.prop('disabled', false).removeClass('opacity-50 cursor-not-allowed');
      const originalText = $btn.data('original-text');
      if (originalText) {
        $btn.text(originalText);
      }
    }
  }

  // Individual App Action Handler
  $(document).on('click', '.app-action-btn', function(e) {
    e.preventDefault();
    
    const $btn = $(this);
    const action = $btn.data('action');
    const model = $btn.data('model');
    const appNum = $btn.data('app-num');
    
    if (!action || !model || !appNum) {
      showNotification('Missing required parameters for action', 'error');
      return;
    }

    // Special handling for status action (GET request)
    if (action === 'status') {
      setButtonLoading($btn);
      $.ajax({
        url: `/status/${model}/${appNum}`,
        method: 'GET',
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        },
        success: function(response) {
          console.log('Status response:', response);
          showNotification(`Status retrieved for ${model}/app${appNum}`, 'success');
          // Optionally update the UI with the status info
          setTimeout(() => location.reload(), 1000);
        },
        error: function(xhr, status, error) {
          console.error('Status check failed:', error);
          showNotification(`Failed to get status: ${error}`, 'error');
        },
        complete: function() {
          setButtonLoading($btn, false);
        }
      });
      return;
    }

    // For all other actions, use POST
    setButtonLoading($btn);
    
    $.ajax({
      url: `/${action}/${model}/${appNum}`,
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Requested-With': 'XMLHttpRequest'
      },
      data: JSON.stringify({
        action: action
      }),
      success: function(response) {
        console.log('Action response:', response);
        
        if (response.success) {
          showNotification(`${action.charAt(0).toUpperCase() + action.slice(1)} successful for ${model}/app${appNum}`, 'success');
          // Refresh the page after a short delay to show updated status
          setTimeout(() => location.reload(), 1500);
        } else {
          showNotification(`${action} failed: ${response.message || response.error}`, 'error');
        }
      },
      error: function(xhr, status, error) {
        console.error('Action failed:', error);
        let errorMessage = error;
        
        if (xhr.responseJSON && xhr.responseJSON.error) {
          errorMessage = xhr.responseJSON.error;
        } else if (xhr.responseJSON && xhr.responseJSON.message) {
          errorMessage = xhr.responseJSON.message;
        }
        
        showNotification(`${action} failed: ${errorMessage}`, 'error');
      },
      complete: function() {
        setButtonLoading($btn, false);
      }
    });
  });

  // Batch Action Handler
  $(document).on('click', '.batch-action', function(e) {
    e.preventDefault();
    
    const $btn = $(this);
    const action = $btn.data('action');
    const model = $btn.data('model');
    
    if (!action || !model) {
      showNotification('Missing required parameters for batch action', 'error');
      return;
    }

    // Hide the dropdown menu
    $btn.closest('.batch-menu-items').addClass('hidden');
    
    // Show loading
    showLoading(`Running batch ${action} for ${model}...`);
    
    $.ajax({
      url: `/batch/${action}/${model}`,
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Requested-With': 'XMLHttpRequest'
      },
      data: JSON.stringify({
        action: action
      }),
      success: function(response) {
        console.log('Batch action response:', response);
        
        const successCount = response.success_count || 0;
        const totalCount = response.total || 0;
        const failureCount = response.failure_count || 0;
        
        if (response.status === 'success') {
          showNotification(`Batch ${action} completed successfully for all ${totalCount} apps`, 'success');
        } else if (response.status === 'partial') {
          showNotification(`Batch ${action} partially completed: ${successCount}/${totalCount} apps succeeded`, 'warning');
        } else {
          showNotification(`Batch ${action} failed: ${failureCount}/${totalCount} apps failed`, 'error');
        }
        
        // Show detailed results if available
        if (response.results && response.results.length > 0) {
          console.log('Detailed batch results:', response.results);
        }
        
        // Refresh the page after a short delay
        setTimeout(() => location.reload(), 2000);
      },
      error: function(xhr, status, error) {
        console.error('Batch action failed:', error);
        let errorMessage = error;
        
        if (xhr.responseJSON && xhr.responseJSON.error) {
          errorMessage = xhr.responseJSON.error;
        }
        
        showNotification(`Batch ${action} failed: ${errorMessage}`, 'error');
      },
      complete: function() {
        hideLoading();
      }
    });
  });

  // Batch Menu Toggle
  $(document).on('click', '.batch-menu-button', function(e) {
    e.preventDefault();
    e.stopPropagation();
    
    const $menu = $(this).siblings('.batch-menu-items');
    
    // Hide all other open menus
    $('.batch-menu-items').not($menu).addClass('hidden');
    
    // Toggle this menu
    $menu.toggleClass('hidden');
  });

  // Close batch menus when clicking outside
  $(document).on('click', function(e) {
    if (!$(e.target).closest('.relative').length) {
      $('.batch-menu-items').addClass('hidden');
    }
  });

  // Refresh All Button
  $('#refreshAll').on('click', function() {
    location.reload();
  });

  // Auto-refresh Toggle
  $('#toggleAutorefresh').on('click', function() {
    const $btn = $(this);
    const currentEnabled = $btn.data('enabled') === 'true';
    const newEnabled = !currentEnabled;
    
    // Update button state
    $btn.data('enabled', newEnabled.toString());
    $('#autorefreshText').text(`Auto: ${newEnabled ? 'On' : 'Off'}`);
    
    if (newEnabled) {
      $btn.addClass('bg-green-600 hover:bg-green-700 text-white');
    } else {
      $btn.removeClass('bg-green-600 hover:bg-green-700 text-white');
    }
    
    // Set cookie
    document.cookie = `autorefresh=${newEnabled}; path=/; max-age=31536000`; // 1 year
    
    showNotification(`Auto-refresh ${newEnabled ? 'enabled' : 'disabled'}`, 'info');
  });

  // Search and Filter functionality
  function filterApps() {
    const searchTerm = $('#searchApps').val().toLowerCase();
    const modelFilter = $('#filterModel').val();
    const statusFilter = $('#filterStatus').val();
    const securityFilter = $('#securitySummaryFilter').val();
    
    let visibleCount = 0;
    
    $('[data-app-id]').each(function() {
      const $app = $(this);
      const appName = $app.data('app-name').toLowerCase();
      const appModel = $app.data('model');
      const appStatus = $app.data('status');
      
      let visible = true;
      
      // Search filter
      if (searchTerm && !appName.includes(searchTerm)) {
        visible = false;
      }
      
      // Model filter
      if (modelFilter && appModel !== modelFilter) {
        visible = false;
      }
      
      // Status filter
      if (statusFilter && appStatus !== statusFilter) {
        visible = false;
      }
      
      // Security filter (placeholder - would need actual security data)
      if (securityFilter !== 'all') {
        // This would need to be implemented with actual security data
        // For now, just show all apps
      }
      
      if (visible) {
        $app.show();
        visibleCount++;
      } else {
        $app.hide();
      }
    });
    
    // Show/hide no results message
    $('#noResultsMessage').toggle(visibleCount === 0);
    
    // Show/hide model sections based on visible apps
    $('[data-model-section]').each(function() {
      const $section = $(this);
      const modelName = $section.data('model-section');
      const hasVisibleApps = $section.find('[data-app-id]:visible').length > 0;
      $section.toggle(hasVisibleApps);
    });
  }

  // Attach filter event handlers
  $('#searchApps').on('input', filterApps);
  $('#filterModel').on('change', filterApps);
  $('#filterStatus').on('change', filterApps);
  $('#securitySummaryFilter').on('change', filterApps);

  // Security filter specific functionality (from original code)
  $('#securitySummaryFilter').on('change', function() {
    const value = $(this).val();
    const selector = value === 'high' ? '.high-risk' : 
                    value === 'critical' ? '.critical' : '';
    
    if (selector) {
      $('[data-app-id]').hide();
      $(`.security-indicator${selector}`).closest('[data-app-id]').show();
    } else {
      // Use the general filter function instead
      filterApps();
      return;
    }
    
    // Show/hide no results message
    const visibleApps = $('[data-app-id]:visible').length;
    $('#noResultsMessage').toggle(visibleApps === 0);
  });

  // Initialize tooltips if using Bootstrap or similar
  if (typeof $().tooltip === 'function') {
    $('[title]').tooltip();
  }

  console.log('Dashboard initialized successfully');
});
</script>
{% endblock %}
{% endblock %}