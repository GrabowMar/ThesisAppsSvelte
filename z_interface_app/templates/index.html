{% extends "base.html" %}

{% block content %}
<div class="space-y-2">
  <!-- Control Toolbar -->
  <div class="bg-gray-200 border border-gray-400 p-1 rounded-sm">
    <div class="flex items-center space-x-2">
      <!-- Refresh Controls -->
      <button id="refreshAll" class="action-btn">
        <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
        </svg>
        Refresh All
      </button>

      <button id="toggleAutorefresh" class="action-btn" data-enabled="{{ 'true' if autorefresh_enabled else 'false' }}">
        <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <span id="autorefreshText">
          Auto Refresh: {{ "On" if autorefresh_enabled else "Off" }}
        </span>
      </button>

      <div class="border-l border-gray-400 h-4 mx-2"></div>

      <!-- Search and Filters -->
      <input type="text" id="searchApps" class="h-6 px-2 rounded-sm" style="width: 200px" placeholder="Search apps..." />

      <select id="filterModel" class="h-6 rounded-sm">
        <option value="">All Models</option>
        {% for model in models %}
        <option value="{{ model.name }}">{{ model.name }}</option>
        {% endfor %}
      </select>

      <select id="filterStatus" class="h-6 rounded-sm">
        <option value="">All Statuses</option>
        <option value="running">Running</option>
        <option value="partial">Partial</option>
        <option value="stopped">Stopped</option>
      </select>

      <div class="border-l border-gray-400 h-4 mx-2"></div>

      <!-- Security Filters -->
      <select id="securitySummaryFilter" class="h-6 rounded-sm">
        <option value="all">All Security</option>
        <option value="high">High Risk Only</option>
        <option value="critical">Critical Issues</option>
      </select>

      <div class="border-l border-gray-400 h-4 mx-2"></div>

      <!-- Batch Analysis Link -->
      <a href="{{ url_for('batch_analysis.batch_dashboard') }}" class="action-btn h-6 px-2 text-xs flex items-center">
        <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
        </svg>
        Batch Analysis
      </a>
    </div>
  </div>

  <!-- System Status Overview -->
  <div class="border border-gray-400 bg-white rounded-sm shadow-sm">
    <div class="bg-gray-100 border-b border-gray-400 px-2 py-1">
      <h2 class="font-bold text-sm">System Status</h2>
    </div>
    <div class="p-2">
      <div class="grid grid-cols-6 gap-2">
        <!-- App Status Cards -->
        <div class="col-span-4 grid grid-cols-4 gap-2">
          {% set running_apps =
          apps|selectattr('backend_status.running','true')|selectattr('frontend_status.running','true')|list %}
          {% set partial_apps =
          (apps|selectattr('backend_status.running','true')|rejectattr('frontend_status.running','true')|list) +
          (apps|rejectattr('backend_status.running','true')|selectattr('frontend_status.running','true')|list) %}
          {% set stopped_apps =
          apps|rejectattr('backend_status.running','true')|rejectattr('frontend_status.running','true')|list %}

          <div class="border border-gray-300 p-2 rounded-sm">
            <div class="text-xs text-gray-600">Total Apps</div>
            <div class="text-lg font-bold">{{ apps|length }}</div>
          </div>
          <div class="border border-gray-300 p-2 rounded-sm">
            <div class="text-xs text-gray-600">Running</div>
            <div class="text-lg font-bold text-green-700">{{ running_apps|length }}</div>
          </div>
          <div class="border border-gray-300 p-2 rounded-sm">
            <div class="text-xs text-gray-600">Partial</div>
            <div class="text-lg font-bold text-yellow-700">{{ partial_apps|length }}</div>
          </div>
          <div class="border border-gray-300 p-2 rounded-sm">
            <div class="text-xs text-gray-600">Stopped</div>
            <div class="text-lg font-bold text-red-700">{{ stopped_apps|length }}</div>
          </div>
        </div>

        <!-- Security Overview Cards -->
        <div class="col-span-2 grid grid-cols-2 gap-2">
          <div class="border border-gray-300 p-2 rounded-sm">
            <div class="text-xs text-gray-600">Security Status</div>
            <div class="grid grid-cols-3 gap-1 mt-1">
              <div class="text-center" title="High Severity Issues">
                <div class="text-xs font-bold text-red-700" id="totalHighIssues">-</div>
                <div class="text-xs text-gray-500">High</div>
              </div>
              <div class="text-center" title="Medium Severity Issues">
                <div class="text-xs font-bold text-yellow-700" id="totalMediumIssues">-</div>
                <div class="text-xs text-gray-500">Med</div>
              </div>
              <div class="text-center" title="Low Severity Issues">
                <div class="text-xs font-bold text-blue-700" id="totalLowIssues">-</div>
                <div class="text-xs text-gray-500">Low</div>
              </div>
            </div>
          </div>
          <div class="border border-gray-300 p-2 rounded-sm">
            <div class="text-xs text-gray-600">Last Scan</div>
            <div class="text-xs font-bold mt-1" id="lastGlobalScan">Never</div>
            <div class="text-xs text-gray-500 mt-1" id="globalScanStatus">No active scans</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Model Sections -->
  {% for model in models %}
<div class="border border-gray-400 bg-white rounded-sm shadow-sm" data-model-section="{{ model.name }}">
  <!-- Model Header with Batch Operations -->
  <div class="bg-gray-100 border-b border-gray-400 px-2 py-1">
    <div class="flex justify-between items-center">
      <div class="flex items-center">
        <h2 class="font-bold text-sm" style="color: {{ model.color }};">{{ model.name }}</h2>
        <!-- Batch Operations Dropdown -->
        <div class="ml-4 relative inline-block text-left" data-model="{{ model.name }}">
          <button type="button" class="batch-menu-button inline-flex justify-center items-center text-xs bg-gray-200 hover:bg-gray-300 border border-gray-400 rounded-sm px-2 py-0.5">
            <span>Batch Operations</span>
            <svg class="w-3 h-3 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
          </button>
          <!-- Dropdown Menu -->
          <div class="batch-menu-items hidden absolute z-10 mt-1 w-48 bg-white border border-gray-300 rounded-sm shadow-lg">
            <div class="py-1">
              <button class="batch-action w-full text-left px-4 py-1 text-xs hover:bg-gray-100" data-action="start" data-model="{{ model.name }}">
                Start All Apps
              </button>
              <button class="batch-action w-full text-left px-4 py-1 text-xs hover:bg-gray-100" data-action="stop" data-model="{{ model.name }}">
                Stop All Apps
              </button>
              <button class="batch-action w-full text-left px-4 py-1 text-xs hover:bg-gray-100" data-action="reload" data-model="{{ model.name }}">
                Reload All Apps
              </button>
              <button class="batch-action w-full text-left px-4 py-1 text-xs hover:bg-gray-100" data-action="rebuild" data-model="{{ model.name }}">
                Rebuild All Apps
              </button>
              <hr class="my-1 border-gray-200">
              <button class="batch-action w-full text-left px-4 py-1 text-xs hover:bg-gray-100" data-action="health-check" data-model="{{ model.name }}">
                Health Check All
              </button>
            </div>
          </div>
        </div>
        <!-- Batch Operation Status Indicator -->
        <div class="batch-status ml-2 hidden">
          <span class="px-2 py-0.5 text-xs bg-blue-100 text-blue-800 border border-blue-300 rounded-sm">
            <span class="batch-status-text">Processing...</span>
            <span class="batch-progress ml-1">0/0</span>
          </span>
        </div>
      </div>
      <div class="flex items-center space-x-2">
        <span class="text-xs text-gray-600">Security Status:</span>
        <div class="security-badges flex space-x-1">
          <span class="security-high px-1 rounded hidden"></span>
          <span class="security-medium px-1 rounded hidden"></span>
          <span class="security-low px-1 rounded hidden"></span>
        </div>
      </div>
    </div>
  </div>

    <!-- App Cards Grid -->
    <div class="p-2 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
      {% for app in apps if app.model == model.name %}
      <div class="border border-gray-300 relative rounded-sm" data-app-id="{{ app.app_num }}" data-model="{{ app.model }}">
        <!-- App Header -->
        <div class="bg-gray-100 border-b border-gray-300 p-1 flex justify-between items-center">
          <span class="font-bold text-xs">{{ app.name }}</span>
          <div class="flex items-center space-x-2">
            <span class="status-badge text-xs px-1 border rounded-sm
              {% if app.backend_status.running and app.frontend_status.running %}
                bg-green-100 text-green-800 border-green-700
              {% elif app.backend_status.running or app.frontend_status.running %}
                bg-yellow-100 text-yellow-800 border-yellow-700
              {% else %}
                bg-red-100 text-red-800 border-red-700
              {% endif %}">
              {{ "Running" if app.backend_status.running and app.frontend_status.running
              else "Partial" if app.backend_status.running or app.frontend_status.running
              else "Stopped" }}
            </span>
            <span class="security-indicator hidden text-xs px-1 rounded-sm"></span>
          </div>
        </div>

        <!-- App Details -->
        <div class="p-2">
          <!-- Status Information -->
          <div class="grid grid-cols-2 gap-1 text-xs mb-2">
            <div>
              <div class="text-gray-600">Backend Status:</div>
              <div class="font-medium {{ 'text-green-700' if app.backend_status.running else 'text-red-700' }}"
                data-status="backend">
                {{ "Running" if app.backend_status.running else "Stopped" }}
              </div>
            </div>
            <div>
              <div class="text-gray-600">Frontend Status:</div>
              <div class="font-medium {{ 'text-green-700' if app.frontend_status.running else 'text-red-700' }}"
                data-status="frontend">
                {{ "Running" if app.frontend_status.running else "Stopped" }}
              </div>
            </div>
            <div>
              <div class="text-gray-600">Backend Port:</div>
              <a href="{{ app.backend_url }}" target="_blank" class="text-blue-700 hover:underline">
                {{ app.backend_port }}
              </a>
            </div>
            <div>
              <div class="text-gray-600">Frontend Port:</div>
              <a href="{{ app.frontend_url }}" target="_blank" class="text-blue-700 hover:underline">
                {{ app.frontend_port }}
              </a>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="grid grid-cols-4 gap-1">
            <!-- Core Actions Row -->
            <button class="action-btn" title="Start" data-action="start" data-model="{{ app.model }}"
              data-app-num="{{ app.app_num }}">Start</button>
            <button class="action-btn" title="Stop" data-action="stop" data-model="{{ app.model }}"
              data-app-num="{{ app.app_num }}">Stop</button>
            <button class="action-btn" title="Reload" data-action="reload" data-model="{{ app.model }}"
              data-app-num="{{ app.app_num }}">Reload</button>
            <button class="action-btn" title="Status" data-action="status" data-model="{{ app.model }}"
              data-app-num="{{ app.app_num }}">Status</button>

            <!-- Advanced Actions Row -->
            <button class="action-btn" title="Rebuild" data-action="rebuild" data-model="{{ app.model }}"
              data-app-num="{{ app.app_num }}">Rebuild</button>

            <!-- Monitoring Row -->
            <a href="{{ url_for('main.view_logs', model=app.model, app_num=app.app_num) }}"
              class="action-btn text-center">Logs</a>
            <a href="{{ url_for('performance.performance_test', model=app.model, port=app.frontend_port) }}"
              class="action-btn text-center">Performance</a>
            <a href="{{ url_for('analysis.security_analysis', model=app.model, app_num=app.app_num) }}"
              class="action-btn text-center">Backend</a>
            <a href="{{ url_for('analysis.frontend_security_analysis', model=app.model, app_num=app.app_num) }}"
              class="action-btn text-center">Frontend</a>

            <!-- Analysis Tools Row -->
            <a href="{{ url_for('zap.zap_scan', model=app.model, app_num=app.app_num) }}"
              class="action-btn text-center">ZAP</a>
            <!-- Change this link to point to our new requirements check page -->
            <a href="{{ url_for('gpt4all.gpt4all_analysis', model=app.model, app_num=app.app_num) }}"
   class="action-btn text-center">Requirements</a>
          </div>
        </div>

        <!-- Security Status Overlay -->
        <div class="security-status absolute top-0 right-0 mt-1 mr-1 hidden">
          <div class="rounded-full w-2 h-2"></div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endfor %}

  <!-- No Results Message -->
  <div id="noResultsMessage" class="hidden border border-gray-400 bg-white p-2 text-center text-xs text-gray-600 rounded-sm">
    No apps match your search criteria
  </div>
</div>

{% block extra_scripts %}
<script>
  // Initialize when DOM is ready
$(document).ready(function() {
  // Initialize core App functionality
  if (typeof App !== 'undefined') {
    // Additional dashboard-specific functionality
    setupModelSections();
    setupSecurityFilters();
  }

  function setupModelSections() {
    // Handle model section toggles
    $('.model-section-toggle').on('click', function() {
      const targetId = $(this).data('target');
      $(`#${targetId}`).slideToggle(200);
      $(this).find('.toggle-icon').toggleClass('rotate-180');
    });
    
    // Set up batch operation dropdowns (already handled in core App)
    $('.batch-menu-button').each(function() {
      // Additional model-specific initialization if needed
    });
  }
  
  function setupSecurityFilters() {
    $('#securitySummaryFilter').on('change', function() {
      const value = $(this).val();
      
      switch (value) {
        case 'high':
          $('.security-badge:not(.high-risk)').closest('.app-card').hide();
          $('.security-badge.high-risk').closest('.app-card').show();
          break;
        case 'critical':
          $('.app-card').hide();
          $('.security-badge.critical').closest('.app-card').show();
          break;
        default:
          $('.app-card').show();
          break;
      }
      
      // Update visible count
      updateVisibleCount();
    });
  }
  
  function updateVisibleCount() {
    const visibleApps = $('.app-card:visible').length;
    const totalApps = $('.app-card').length;
    $('#visibleAppCount').text(visibleApps);
    $('#totalAppCount').text(totalApps);
    
    // Show/hide no results message
    $('#noResultsMessage').toggle(visibleApps === 0);
  }
});
</script>
{% endblock %}{% endblock %}