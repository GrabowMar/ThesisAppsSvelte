{% extends "base.html" %}

{% block content %}
<div class="space-y-6">
  <!-- Search & Filters -->
  <div class="bg-white shadow rounded-lg p-4">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div>
        <label for="searchApps" class="block text-sm font-medium text-gray-700">Search Apps</label>
        <input
          type="text"
          id="searchApps"
          class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
          placeholder="Search by name, port, status..."
        />
      </div>
      <div>
        <label for="filterModel" class="block text-sm font-medium text-gray-700">Filter by Model</label>
        <select
          id="filterModel"
          class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
        >
          <option value="">All Models</option>
          {% for model in models %}
            <option value="{{ model.name }}">{{ model.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label for="filterStatus" class="block text-sm font-medium text-gray-700">Filter by Status</label>
        <select
          id="filterStatus"
          class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
        >
          <option value="">All Statuses</option>
          <option value="running">Running</option>
          <option value="partial">Partial</option>
          <option value="stopped">Stopped</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Dashboard Overview -->
  <div class="bg-white shadow rounded-lg p-6">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-bold text-gray-900">AI Model Dashboard</h1>
      <div class="flex space-x-4">
        <!-- Auto-refresh Toggle -->
        <button
          id="toggleAutorefresh"
          class="inline-flex items-center px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-200
          {% if autorefresh_enabled %}bg-green-500 hover:bg-green-600{% else %}bg-gray-500 hover:bg-gray-600{% endif %} text-white"
          data-enabled="{{ 'true' if autorefresh_enabled else 'false' }}"
        >
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
            />
          </svg>
          <span id="autorefreshText">
            Auto Refresh: {{ "On" if autorefresh_enabled else "Off" }}
          </span>
        </button>

        <!-- Manual Refresh -->
        <button
          id="refreshAll"
          class="inline-flex items-center px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-200"
        >
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
            />
          </svg>
          <span>Refresh All</span>
        </button>
      </div>
    </div>

    <!-- Status Overview -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      {% set running_apps = apps
          |selectattr('backend_status.running','true')
          |selectattr('frontend_status.running','true')
          |list %}
      {% set partial_apps = (apps
          |selectattr('backend_status.running','true')
          |rejectattr('frontend_status.running','true')
          |list)
        + (apps
          |rejectattr('backend_status.running','true')
          |selectattr('frontend_status.running','true')
          |list) %}
      {% set stopped_apps = apps
          |rejectattr('backend_status.running','true')
          |rejectattr('frontend_status.running','true')
          |list %}

      <div class="bg-white p-4 rounded-lg border" role="status">
        <h3 class="text-sm font-medium text-gray-500">Total Apps</h3>
        <p class="mt-1 text-2xl font-semibold text-gray-900">{{ apps|length }}</p>
      </div>
      <div class="bg-white p-4 rounded-lg border" role="status">
        <h3 class="text-sm font-medium text-gray-500">Running Apps</h3>
        <p class="mt-1 text-2xl font-semibold text-green-600">{{ running_apps|length }}</p>
      </div>
      <div class="bg-white p-4 rounded-lg border" role="status">
        <h3 class="text-sm font-medium text-gray-500">Partial Status</h3>
        <p class="mt-1 text-2xl font-semibold text-yellow-600">{{ partial_apps|length }}</p>
      </div>
      <div class="bg-white p-4 rounded-lg border" role="status">
        <h3 class="text-sm font-medium text-gray-500">Stopped Apps</h3>
        <p class="mt-1 text-2xl font-semibold text-red-600">{{ stopped_apps|length }}</p>
      </div>
    </div>
  </div>

  <!-- Model Sections (No Batch Operations) -->
  {% for model in models %}
  <div class="bg-white shadow rounded-lg p-6" data-model-section="{{ model.name }}">
    <div class="flex items-center justify-between mb-6">
      <h2 class="text-xl font-bold" style="color: '{{ model.color }}';">{{ model.name }}</h2>
    </div>

    <div class="grid gap-6 grid-cols-1 md:grid-cols-2 lg:grid-cols-3">
      {% for app in apps if app.model == model.name %}
      <div
        class="border rounded-lg p-4 relative"
        data-app-id="{{ app.app_num }}"
        data-model="{{ app.model }}"
      >
        <!-- Status Badge -->
        <div class="absolute top-4 right-4">
          <span
            class="px-2 py-1 text-sm rounded-full
            {% if app.backend_status.running and app.frontend_status.running %}
              bg-green-100 text-green-800
            {% elif app.backend_status.running or app.frontend_status.running %}
              bg-yellow-100 text-yellow-800
            {% else %}
              bg-red-100 text-red-800
            {% endif %}"
          >
            {{
              "Running"
              if app.backend_status.running and app.frontend_status.running
              else "Partial"
              if app.backend_status.running or app.frontend_status.running
              else "Stopped"
            }}
          </span>
        </div>

        <!-- App Details -->
        <h3 class="text-lg font-medium text-gray-900 mb-4">{{ app.name }}</h3>
        <div class="space-y-3 mb-4">
          <div class="flex justify-between items-center text-sm">
            <span class="text-gray-500">Backend Status:</span>
            <span
              class="font-medium {{ 'text-green-600' if app.backend_status.running else 'text-red-600' }}"
              data-status="backend"
            >
              {{ "Running" if app.backend_status.running else "Stopped" }}
            </span>
          </div>
          <div class="flex justify-between items-center text-sm">
            <span class="text-gray-500">Frontend Status:</span>
            <span
              class="font-medium {{ 'text-green-600' if app.frontend_status.running else 'text-red-600' }}"
              data-status="frontend"
            >
              {{ "Running" if app.frontend_status.running else "Stopped" }}
            </span>
          </div>
          <div class="flex justify-between items-center text-sm">
            <span class="text-gray-500">Backend Port:</span>
            <a
              href="{{ app.backend_url }}"
              target="_blank"
              class="text-blue-500 hover:text-blue-600"
            >
              {{ app.backend_port }}
            </a>
          </div>
          <div class="flex justify-between items-center text-sm">
            <span class="text-gray-500">Frontend Port:</span>
            <a
              href="{{ app.frontend_url }}"
              target="_blank"
              class="text-blue-500 hover:text-blue-600"
            >
              {{ app.frontend_port }}
            </a>
          </div>
        </div>

        <!-- Individual Action Buttons -->
        <div class="grid grid-cols-3 gap-2">
          <button
            class="action-btn bg-green-500 text-white px-3 py-2 rounded hover:bg-green-600 transition-colors"
            data-action="start"
            data-model="{{ app.model }}"
            data-app-num="{{ app.app_num }}"
          >
            <span class="button-text">Start</span>
          </button>
          <button
            class="action-btn bg-red-500 text-white px-3 py-2 rounded hover:bg-red-600 transition-colors"
            data-action="stop"
            data-model="{{ app.model }}"
            data-app-num="{{ app.app_num }}"
          >
            <span class="button-text">Stop</span>
          </button>
          <button
            class="action-btn bg-yellow-500 text-white px-3 py-2 rounded hover:bg-yellow-600 transition-colors"
            data-action="reload"
            data-model="{{ app.model }}"
            data-app-num="{{ app.app_num }}"
          >
            <span class="button-text">Reload</span>
          </button>
          <button
            class="action-btn bg-purple-500 text-white px-3 py-2 rounded hover:bg-purple-600 transition-colors"
            data-action="rebuild"
            data-model="{{ app.model }}"
            data-app-num="{{ app.app_num }}"
          >
            <span class="button-text">Rebuild</span>
          </button>
          <a
            href="{{ url_for('view_logs', model=app.model, app_num=app.app_num) }}"
            class="bg-indigo-500 text-white px-3 py-2 rounded text-center hover:bg-indigo-600 transition-colors"
          >
            Logs
          </a>
          <button
            class="action-btn bg-blue-500 text-white px-3 py-2 rounded hover:bg-blue-600 transition-colors"
            data-action="status"
            data-model="{{ app.model }}"
            data-app-num="{{ app.app_num }}"
          >
            <span class="button-text">Status</span>
          </button>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endfor %}

  <!-- No Results Message -->
  <div
    id="noResultsMessage"
    class="hidden bg-white shadow rounded-lg p-6 text-center"
  >
    <p class="text-gray-500">No apps match your search criteria</p>
  </div>
</div>

{% block extra_scripts %}
<script>
  /** Modal management */
  class ModalManager {
    constructor() {
      this.modal = null;
      this.modalTitle = null;
      this.modalContent = null;
      this.closeButtons = [];
      this.focusedElementBeforeModal = null;
      this.boundTrapFocus = this.trapFocus.bind(this);
    }
    init() {
      this.modal = document.getElementById('modal');
      this.modalTitle = document.getElementById('modalTitle');
      this.modalContent = document.getElementById('modalContent');
      this.closeButtons = document.querySelectorAll('.modal-close');
      this.closeButtons.forEach(btn => {
        btn.addEventListener('click', () => this.hideModal());
      });
      if (this.modal) {
        this.modal.addEventListener('click', (e) => {
          if (e.target === this.modal) this.hideModal();
        });
      }
    }
    showModal(title, content) {
      if (!this.modal) return;
      this.focusedElementBeforeModal = document.activeElement;
      this.modalTitle.textContent = title;
      this.modalContent.innerHTML = content;
      this.modal.classList.remove('hidden');
      const closeButton = this.modal.querySelector('.modal-close');
      if (closeButton) closeButton.focus();
      this.modal.addEventListener('keydown', this.boundTrapFocus);
    }
    hideModal() {
      if (!this.modal) return;
      this.modal.classList.add('hidden');
      this.modal.removeEventListener('keydown', this.boundTrapFocus);
      if (this.focusedElementBeforeModal) {
        this.focusedElementBeforeModal.focus();
      }
    }
    trapFocus(e) {
      if (e.key === 'Escape') {
        this.hideModal();
        return;
      }
      if (e.key !== 'Tab') return;
      const focusable = this.modal.querySelectorAll(
        'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
      );
      const first = focusable[0];
      const last = focusable[focusable.length - 1];
      if (e.shiftKey && document.activeElement === first) {
        last.focus();
        e.preventDefault();
      } else if (!e.shiftKey && document.activeElement === last) {
        first.focus();
        e.preventDefault();
      }
    }
  }

  /** Status indicator polling */
  class StatusMonitor {
    constructor() {
      this.indicator = document.getElementById('statusIndicator');
      this.checkInterval = 30000;
      this.intervalId = null;
    }
    updateStatus(state, msg) {
      if (!this.indicator) return;
      const map = { healthy: 'bg-green-400', warning: 'bg-yellow-400', error: 'bg-red-400' };
      const dot = this.indicator.querySelector('.rounded-full');
      if (dot) {
        Object.values(map).forEach(c => dot.classList.remove(c));
        dot.classList.add(map[state] || map.error);
      }
      this.indicator.querySelector('.text-sm').textContent = msg;
    }
    async checkStatus() {
      try {
        const res = await fetch('/api/status');
        const data = await res.json();
        data.status === 'healthy'
          ? this.updateStatus('healthy', 'System Active')
          : this.updateStatus('warning', 'System Warning');
      } catch {
        this.updateStatus('error', 'Connection Error');
      }
    }
    startMonitoring() {
      this.checkStatus();
      this.intervalId = setInterval(() => this.checkStatus(), this.checkInterval);
    }
    stopMonitoring() {
      if (this.intervalId) clearInterval(this.intervalId);
      this.intervalId = null;
    }
  }

  /** Performance tracking (optional) */
  class PerformanceMonitor {
    constructor() {
      this.metrics = {};
    }
    startMeasure(name) {
      performance.mark?.(`${name}-start`);
    }
    endMeasure(name) {
      if (!performance.mark) return;
      performance.mark(`${name}-end`);
      performance.measure(name, `${name}-start`, `${name}-end`);
      const entry = performance.getEntriesByName(name)[0];
      if (entry) {
        this.metrics[name] = entry.duration;
        console.debug(`[${name}] ${entry.duration.toFixed(2)}ms`);
      }
    }
    clearMetrics() {
      performance.clearMarks?.();
      performance.clearMeasures?.();
      this.metrics = {};
    }
  }

  /** Global error handling */
  const ErrorHandler = {
    init() {
      window.addEventListener('error', this.onError.bind(this));
      window.addEventListener('unhandledrejection', this.onPromiseError.bind(this));
    },
    onError(e) {
      console.error('Global error:', e.error);
      this.displayError(e.error?.message || 'An error occurred');
      return false;
    },
    onPromiseError(e) {
      console.error('Unhandled promise rejection:', e.reason);
      this.displayError(e.reason?.message || 'An async operation failed');
      return false;
    },
    displayError(msg) {
      const indicator = document.getElementById('statusIndicator');
      if (indicator && window.AppUtils?.statusMonitor) {
        window.AppUtils.statusMonitor.updateStatus('error', 'Error Detected');
      }
      PageController.showToast(msg, 'error');
    }
  };

  /** Utility helpers */
  const Utils = {
    debounce(fn, wait) {
      let timeout;
      return (...args) => {
        clearTimeout(timeout);
        timeout = setTimeout(() => fn(...args), wait);
      };
    },
    throttle(fn, limit) {
      let inThrottle;
      return (...args) => {
        if (!inThrottle) {
          fn(...args);
          inThrottle = true;
          setTimeout(() => (inThrottle = false), limit);
        }
      };
    },
    capitalize(str) {
      if (!str || typeof str !== 'string') return '';
      return str.charAt(0).toUpperCase() + str.slice(1);
    }
  };

  /** Core page logic */
  const PageController = {
    modalManager: new ModalManager(),
    statusMonitor: new StatusMonitor(),
    performanceMonitor: new PerformanceMonitor(),
    isAutoRefreshEnabled: false,
    refreshTimer: null,
    AUTO_REFRESH_INTERVAL: 30000,
    STATUS_CLASSES: {
      running: 'bg-green-100 text-green-800',
      partial: 'bg-yellow-100 text-yellow-800',
      stopped: 'bg-red-100 text-red-800'
    },

    init() {
      ErrorHandler.init();
      this.modalManager.init();
      this.statusMonitor.startMonitoring();

      const yearEl = document.getElementById('currentYear');
      if (yearEl) yearEl.textContent = new Date().getFullYear();

      const sysInfoBtn = document.getElementById('showSystemInfo');
      if (sysInfoBtn) {
        sysInfoBtn.addEventListener('click', () => {
          const content = `
            <div class="space-y-4">
              <div>
                <h4 class="font-medium text-gray-700">Version</h4>
                <p class="text-sm text-gray-600">1.0.0</p>
              </div>
              <div>
                <h4 class="font-medium text-gray-700">Environment</h4>
                <p class="text-sm text-gray-600">Production</p>
              </div>
              <div>
                <h4 class="font-medium text-gray-700">Last Updated</h4>
                <p class="text-sm text-gray-600">${new Date().toLocaleString()}</p>
              </div>
            </div>
          `;
          this.modalManager.showModal('System Information', content);
        });
      }

      document.addEventListener('visibilitychange', () => {
        document.hidden
          ? this.statusMonitor.stopMonitoring()
          : this.statusMonitor.startMonitoring();
      });

      document.querySelectorAll('.action-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          const { action, model, appNum } = btn.dataset;
          console.log(`Button clicked: action=${action}, model=${model}, appNum=${appNum}`);
          if (action === 'status') {
            this.checkAppStatus(model, appNum);
          } else {
            this.controlApp(model, appNum, action, btn);
          }
        });
      });

      const searchInput = document.getElementById('searchApps');
      const modelFilter = document.getElementById('filterModel');
      const statusFilter = document.getElementById('filterStatus');
      if (searchInput) {
        searchInput.addEventListener('input', Utils.debounce(() => this.filterApps(), 300));
      }
      if (modelFilter) modelFilter.addEventListener('change', () => this.filterApps());
      if (statusFilter) statusFilter.addEventListener('change', () => this.filterApps());

      const autoRefreshBtn = document.getElementById('toggleAutorefresh');
      if (autoRefreshBtn) {
        this.isAutoRefreshEnabled = (autoRefreshBtn.dataset.enabled === 'true');
        autoRefreshBtn.addEventListener('click', () => {
          this.isAutoRefreshEnabled = !this.isAutoRefreshEnabled;
          this.isAutoRefreshEnabled ? this.startAutoRefresh() : this.stopAutoRefresh();
        });
        if (this.isAutoRefreshEnabled) this.startAutoRefresh();
        this.updateAutoRefreshUI(this.isAutoRefreshEnabled);
      }

      const refreshAllBtn = document.getElementById('refreshAll');
      if (refreshAllBtn) {
        refreshAllBtn.addEventListener('click', () => this.refreshAllStatuses());
      }

      // Expose some utilities globally
      window.AppUtils = {
        modalManager: this.modalManager,
        statusMonitor: this.statusMonitor,
        performanceMonitor: this.performanceMonitor,
        utils: Utils
      };
    },

    async controlApp(model, appNum, action, button) {
      const buttonText = button.querySelector('.button-text');
      const originalText = buttonText ? buttonText.textContent.trim() : button.textContent.trim();
      let workingText = 'Working...';
      if (action === 'start') workingText = 'Starting...';
      else if (action === 'stop') workingText = 'Stopping...';
      else if (action === 'remove') workingText = 'Removing...';

      button.disabled = true;
      if (buttonText) {
        buttonText.textContent = workingText;
      } else {
        button.textContent = workingText;
      }

      try {
        const res = await fetch(`/${action}/${model}/${appNum}`, {
          headers: { 'X-Requested-With': 'XMLHttpRequest' }
        });
        if (!res.ok) throw new Error(`HTTP error: ${res.status}`);
        await this.checkAppStatus(model, appNum);
        this.showToast(`${Utils.capitalize(action)} operation successful`, 'success');
      } catch (err) {
        console.error(`Error during ${action}:`, err);
        this.showToast(`Error: ${err.message}`, 'error');
      } finally {
        button.disabled = false;
        if (buttonText) {
          buttonText.textContent = originalText;
        } else {
          button.textContent = originalText;
        }
      }
    },

    async checkAppStatus(model, appNum) {
      try {
        const res = await fetch(`/api/container/${model}/${appNum}/status`);
        if (!res.ok) throw new Error(`HTTP error: ${res.status}`);
        const data = await res.json();
        const appEl = document.querySelector(`[data-app-id="${appNum}"][data-model="${model}"]`);
        if (appEl) this.updateStatusUI(appEl, data);
      } catch (err) {
        console.error('Status check failed:', err);
        this.showToast('Failed to check status', 'error');
      }
    },

    updateStatusUI(appEl, { backend, frontend }) {
      const badge = appEl.querySelector('[class*="bg-"][class*="text-"]');
      if (badge) {
        Object.values(this.STATUS_CLASSES).forEach(cls => cls.split(' ').forEach(c => badge.classList.remove(c)));
        const newCls = this.getStatusClass(backend, frontend);
        newCls.split(' ').forEach(c => badge.classList.add(c));
        badge.textContent = this.getStatusText(backend, frontend);
      }
      this.updateServiceStatus(appEl, 'backend', backend);
      this.updateServiceStatus(appEl, 'frontend', frontend);
    },

    updateServiceStatus(appEl, service, statusObj) {
      const el = appEl.querySelector(`[data-status="${service}"]`);
      if (!el) return;
      el.className = el.className.replace(/text-\w+-\d+/g, '').trim(); 
      const { text, colorClass } = this.getDisplayStatus(statusObj);
      el.classList.add('font-medium', colorClass);
      el.textContent = text;
    },

    getDisplayStatus(s) {
      if (!s.exists) return { text: 'No Container', colorClass: 'text-gray-600' };
      switch (s.status) {
        case 'running': return { text: 'Running', colorClass: 'text-green-600' };
        case 'created': return { text: 'Created', colorClass: 'text-yellow-600' };
        case 'stopped': return { text: 'Stopped', colorClass: 'text-red-600' };
        default: return { text: s.status || 'Unknown', colorClass: 'text-gray-600' };
      }
    },

    getStatusClass(b, f) {
      if (b.running && f.running) return this.STATUS_CLASSES.running;
      if (b.running || f.running) return this.STATUS_CLASSES.partial;
      return this.STATUS_CLASSES.stopped;
    },

    getStatusText(b, f) {
      if (b.running && f.running) return 'Running';
      if (b.running || f.running) return 'Partial';
      return 'Stopped';
    },

    filterApps() {
      const searchTerm = (document.getElementById('searchApps')?.value || '').toLowerCase();
      const modelFilter = document.getElementById('filterModel')?.value || '';
      const statusFilter = document.getElementById('filterStatus')?.value || '';
      let count = 0;

      document.querySelectorAll('[data-app-id]').forEach(app => {
        const section = app.closest('[data-model-section]');
        const nameEl = app.querySelector('h3');
        const badge = app.querySelector('[class*="bg-"][class*="text-"]');
        if (!nameEl || !badge) return;

        const nameTxt = nameEl.textContent.toLowerCase();
        const modelName = app.dataset.model;
        const statusTxt = badge.textContent.toLowerCase();

        const visible =
          (nameTxt.includes(searchTerm) || app.textContent.toLowerCase().includes(searchTerm)) &&
          (!modelFilter || modelName === modelFilter) &&
          (!statusFilter || statusTxt.includes(statusFilter.toLowerCase()));

        app.style.display = visible ? '' : 'none';
        if (visible) count++;

        if (section) {
          const hasVisibleApps = Array.from(section.querySelectorAll('[data-app-id]'))
            .some(a => a.style.display !== 'none');
          section.style.display = hasVisibleApps ? '' : 'none';
        }
      });

      const noResults = document.getElementById('noResultsMessage');
      if (noResults) noResults.classList.toggle('hidden', count > 0);
    },

    startAutoRefresh() {
      this.refreshAllStatuses();
      this.refreshTimer = setInterval(() => this.refreshAllStatuses(), this.AUTO_REFRESH_INTERVAL);
      this.updateAutoRefreshUI(true);
      this.showToast('Auto-refresh enabled', 'success');
    },

    stopAutoRefresh() {
      if (this.refreshTimer) clearInterval(this.refreshTimer);
      this.refreshTimer = null;
      this.updateAutoRefreshUI(false);
      this.showToast('Auto-refresh disabled', 'info');
    },

    async refreshAllStatuses() {
      const btn = document.getElementById('refreshAll');
      const originalHTML = btn?.innerHTML;
      try {
        if (btn) {
          btn.disabled = true;
          btn.innerHTML = `
            <svg class="animate-spin h-4 w-4 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Refreshing...
          `;
        }
        const allApps = document.querySelectorAll('[data-app-id]');
        await Promise.all([...allApps].map(a => this.checkAppStatus(a.dataset.model, a.dataset.appId)));
        this.showToast('All statuses refreshed', 'success');
      } catch (err) {
        console.error('Refresh failed:', err);
        this.showToast('Failed to refresh statuses', 'error');
      } finally {
        if (btn) {
          btn.disabled = false;
          if (originalHTML) btn.innerHTML = originalHTML;
        }
      }
    },

    updateAutoRefreshUI(enabled) {
      const btn = document.getElementById('toggleAutorefresh');
      if (!btn) return;
      btn.dataset.enabled = enabled.toString();
      btn.setAttribute('aria-pressed', enabled.toString());

      btn.classList.toggle('bg-gray-500', !enabled);
      btn.classList.toggle('hover:bg-gray-600', !enabled);
      btn.classList.toggle('bg-green-500', enabled);
      btn.classList.toggle('hover:bg-green-600', enabled);

      const textSpan = document.getElementById('autorefreshText');
      if (textSpan) textSpan.textContent = `Auto Refresh: ${enabled ? 'On' : 'Off'}`;
    },

    showToast(msg, type = 'info') {
      const colors = {
        error: 'bg-red-500',
        success: 'bg-green-500',
        warning: 'bg-yellow-500',
        info: 'bg-blue-500'
      };
      const toast = document.createElement('div');
      toast.className = `
        fixed bottom-4 right-4
        ${colors[type] || colors.info} text-white px-6 py-3
        rounded-lg shadow-lg transform translate-y-full transition duration-300 z-50
      `.trim();
      toast.textContent = msg;
      document.body.appendChild(toast);

      // Animate in
      requestAnimationFrame(() => {
        toast.style.transform = 'translateY(0)';
        setTimeout(() => {
          toast.style.transform = 'translateY(100%)';
          toast.addEventListener('transitionend', () => document.body.removeChild(toast));
        }, 3000);
      });
    }
  };

  document.addEventListener('DOMContentLoaded', () => PageController.init());
</script>

{% endblock %}
{% endblock %}
