{% extends "base.html" %}

{% block styles %}
<style>
  /* Style for different task statuses */
  .task-row-completed { background-color: #eff6ff; /* blue-50 */ }
  .task-row-failed { background-color: #fee2e2; /* red-100 */ }
  .task-row-triggered { background-color: #fef9c3; /* yellow-100 */ }
  .task-row-pending { background-color: #f3f4f6; /* gray-100 - Implicit for rows not yet completed/failed */ }

  /* Subtle animation for potentially running tasks */
  .task-running-indicator::after {
    content: '...';
    display: inline-block;
    animation: dots 1.5s infinite steps(3, end);
    margin-left: 4px;
  }
  @keyframes dots {
    0%, 20% { color: rgba(0,0,0,0); text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0);}
    40% { color: gray; text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0);}
    60% { text-shadow: .25em 0 0 gray, .5em 0 0 rgba(0,0,0,0);}
    80%, 100% { text-shadow: .25em 0 0 gray, .5em 0 0 gray;}
  }

  /* Tooltip for errors */
  .error-tooltip {
    position: relative;
    cursor: help;
  }
  .error-tooltip .tooltip-text {
    visibility: hidden;
    width: 300px;
    background-color: #ef4444; /* red-500 */
    color: #fff;
    text-align: left;
    border-radius: 6px;
    padding: 5px 8px;
    position: absolute;
    z-index: 10;
    bottom: 125%; /* Position above the element */
    left: 50%;
    margin-left: -150px; /* Use half of the width to center */
    opacity: 0;
    transition: opacity 0.3s;
    font-size: 11px; /* Smaller font for tooltip */
    white-space: pre-wrap; /* Allow wrapping */
  }
  .error-tooltip:hover .tooltip-text {
    visibility: visible;
    opacity: 1;
  }
</style>
{% endblock %}

{# Jinja macro for humanizing duration (Unchanged) - Define at the top level #}
{% macro humanize_duration(seconds) %}{% if seconds is none or seconds < 0 %}N/A{% else %}{% set seconds = seconds|int %}{% if seconds < 60 %}{{ seconds }}s{% elif seconds < 3600 %}{{ '%dm %ds'|format(seconds // 60, seconds % 60) }}{% else %}{{ '%dh %dm'|format(seconds // 3600, (seconds % 3600) // 60) }}{% endif %}{% endif %}{% endmacro %}

{% block content %}
<div class="space-y-2 max-w-7xl mx-auto">
  {# --- Header Section (Unchanged) --- #}
  <div class="border border-gray-400 bg-white p-2 rounded-md">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="font-bold text-xl text-gray-900">Batch Job Details</h1>
        <p class="text-xs text-gray-600 mt-1">{{ job.name }} (ID: {{ job.id }})</p>
      </div>
      <div class="flex items-center space-x-2">
        <a href="{{ url_for('batch_analysis.batch_dashboard') }}" class="action-btn h-6 px-2 text-xs flex items-center">
          <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg> Back to Dashboard
        </a>
        {% if job.status == JobStatus.RUNNING.value %}
          <button id="cancelJobBtn" class="action-btn h-6 px-2 text-xs flex items-center bg-red-600 text-white hover:bg-red-700 focus:ring-2 focus:ring-red-500 focus:ring-opacity-50 transition" data-job-id="{{ job.id }}">
            <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg> Cancel Job
          </button>
        {% endif %}
        {% if job.status != JobStatus.RUNNING.value %}
            <form method="POST" action="{{ url_for('batch_analysis.delete_job_api', job_id=job.id) }}" onsubmit="return confirm('Are you sure you want to delete this job and all its results?');" class="inline">
                <button type="submit" class="action-btn h-6 px-2 text-xs bg-gray-500 text-white hover:bg-gray-600 focus:ring-2 focus:ring-gray-400 transition" aria-label="Delete job {{ job.id }}">Delete Job</button>
            </form>
        {% endif %}
      </div>
    </div>
  </div>

  {# --- Job Info / Progress / Summary Grid (Status Badge Updated) --- #}
  <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
    <div class="border border-gray-400 bg-white rounded-md shadow-sm">
      <div class="bg-gray-100 border-b border-gray-400 px-2 py-1">
        <h2 class="font-bold text-sm">Job Information</h2>
      </div>
      <div class="p-2">
        <table class="w-full text-xs">
          {# ... other rows ... #}
          <tr>
            <td class="font-medium text-gray-600 py-1 pr-2 align-top">Status:</td>
            <td>
              {# UPDATED: Added id="jobStatusBadge" for dynamic updates #}
              <span id="jobStatusBadge" data-current-status="{{ job.status }}" class="px-2 py-0.5 rounded-md text-white capitalize
                {% if job.status == JobStatus.RUNNING.value %}bg-green-600
                {% elif job.status == JobStatus.COMPLETED.value %}bg-blue-600
                {% elif job.status == JobStatus.PENDING.value %}bg-gray-600
                {% elif job.status == JobStatus.CANCELED.value %}bg-yellow-600
                {% else %}bg-red-600{% endif %}">
                {{ job.status }}
              </span>
            </td>
          </tr>
          {# ... other rows ... #}
           <tr>
            <td class="font-medium text-gray-600 py-1 pr-2 align-top">Analysis Options:</td>
            <td>
                <pre class="text-[10px] bg-gray-50 p-1 rounded border border-gray-200 max-h-20 overflow-auto">{{ job.analysis_options|tojson(indent=2) }}</pre>
            </td>
          </tr>
        </table>
      </div>
    </div>

    {# --- Progress Section (FIXED: Removed fromisoformat filter) --- #}
    <div class="border border-gray-400 bg-white rounded-md shadow-sm">
      <div class="bg-gray-100 border-b border-gray-400 px-2 py-1">
        <h2 class="font-bold text-sm">Progress</h2>
      </div>
      <div class="p-2">
        <div class="mb-2">
          <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden" title="{{ status_data.progress.completed }}/{{ status_data.progress.total }} tasks">
            <div id="progressBar" class="bg-blue-600 rounded-full h-4 flex items-center justify-center text-xs text-white transition-all duration-300"
                style="width: {{ status_data.progress.percent }}%">
              {{ status_data.progress.percent }}%
            </div>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-2 text-xs">
          <div class="border border-gray-300 p-2 rounded-md">
            <div class="text-gray-600">Completed Tasks</div>
            <div class="font-bold" id="completedTasks">{{ status_data.progress.completed }}/{{ status_data.progress.total }}</div>
          </div>
          <div class="border border-gray-300 p-2 rounded-md">
            <div class="text-gray-600">Runtime</div>
            <div class="font-bold" id="runtime">
              {# FIXED: Using JavaScript to calculate runtime instead of fromisoformat filter #}
              <span id="runtimeValue">Calculating...</span>
            </div>
          </div>
           <div class="border border-gray-300 p-2 rounded-md col-span-2">
                <div class="text-gray-600">Tasks Failed</div>
                <div class="font-bold text-red-700" id="tasksFailed">{{ status_data.results_summary.get('tasks_failed', 0) }}</div>
           </div>
        </div>
      </div>
    </div>

    {# --- Aggregated Results Section (Unchanged) --- #}
    <div class="border border-gray-400 bg-white rounded-md shadow-sm">
      <div class="bg-gray-100 border-b border-gray-400 px-2 py-1">
        <h2 class="font-bold text-sm">Aggregated Results</h2>
      </div>
      <div class="p-2 space-y-2">
         {# Logic for displaying aggregated security, performance, etc. remains the same #}
         {% if 'high_total' in status_data.results_summary %}
         <div class="border border-gray-300 p-2 rounded-md"><h3 class="text-xs font-medium text-gray-700 mb-1">Security Issues</h3><div class="grid grid-cols-3 gap-2 text-xs"><div><div class="text-red-600">High</div><div class="font-bold text-red-700" id="highIssues">{{ status_data.results_summary.get('high_total', 0) }}</div></div><div><div class="text-yellow-600">Medium</div><div class="font-bold text-yellow-700" id="mediumIssues">{{ status_data.results_summary.get('medium_total', 0) }}</div></div><div><div class="text-blue-600">Low</div><div class="font-bold text-blue-700" id="lowIssues">{{ status_data.results_summary.get('low_total', 0) }}</div></div></div></div>
         {% endif %}
         {% if 'performance_tasks_completed' in status_data.results_summary %}
         <div class="border border-gray-300 p-2 rounded-md"><h3 class="text-xs font-medium text-gray-700 mb-1">Performance</h3><div class="text-xs">Avg RPS: <span class="font-bold" id="avgRps">{{ status_data.results_summary.get('performance_avg_rps', 'N/A') }}</span><br>Avg Resp Time: <span class="font-bold" id="avgResponseTime">{{ status_data.results_summary.get('performance_avg_rt', 'N/A') }} ms</span><br>Total Failures: <span class="font-bold text-red-700" id="perfFailures">{{ status_data.results_summary.get('performance_issues_total', 0) }}</span></div></div>
         {% endif %}
         {% if 'gpt4all_tasks_completed' in status_data.results_summary %}
         <div class="border border-gray-300 p-2 rounded-md"><h3 class="text-xs font-medium text-gray-700 mb-1">GPT4All Requirements</h3><div class="text-xs">Reqs Checked: <span class="font-bold" id="gptReqsChecked">{{ status_data.results_summary.get('gpt4all_reqs_checked_total', 0) }}</span><br>Reqs Met: <span class="font-bold text-green-700" id="gptReqsMet">{{ status_data.results_summary.get('gpt4all_reqs_met_total', 0) }}</span></div></div>
         {% endif %}
         {% if 'zap_tasks_completed' in status_data.results_summary or 'zap_tasks_triggered' in status_data.results_summary %}
         <div class="border border-gray-300 p-2 rounded-md"><h3 class="text-xs font-medium text-gray-700 mb-1">ZAP Scans</h3><div class="text-xs">Scans Triggered: <span class="font-bold" id="zapScansTriggered">{{ status_data.results_summary.get('zap_tasks_triggered', 0) }}</span></div></div>
         {% endif %}
      </div>
    </div>
  </div>

  {# --- Task Results Table (UPDATED Styling and Error Display) --- #}
  <div class="border border-gray-400 bg-white rounded-md shadow-sm">
    <div class="bg-gray-100 border-b border-gray-400 px-2 py-1 flex justify-between items-center">
      <h2 class="font-bold text-sm">Task Results</h2>
      {# Filters remain the same #}
      <div class="flex flex-wrap items-center gap-2">
        <div class="relative"><input type="text" id="searchResults" placeholder="Search results..." class="h-6 pl-6 pr-2 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"><svg class="w-3 h-3 absolute left-2 top-1.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg></div>
        <select id="resultStatusFilter" class="h-6 px-2 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"><option value="all">All Statuses</option><option value="completed">Completed</option><option value="failed">Failed</option><option value="triggered">Triggered</option></select>
        <select id="resultModelFilter" class="h-6 px-2 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"><option value="all">All Models</option>{% for model_name in job.models %}<option value="{{ model_name }}">{{ model_name }}</option>{% endfor %}</select>
        <select id="resultAnalysisTypeFilter" class="h-6 px-2 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"><option value="all">All Analysis Types</option>{% for type_enum in AnalysisType %}<option value="{{ type_enum.value }}">{{ type_enum.value.replace('_', ' ')|title }}</option>{% endfor %}</select>
      </div>
    </div>
    <div class="p-2">
      <div class="overflow-x-auto">
        <table class="min-w-full border border-gray-300">
          <thead>
            <tr class="bg-gray-100">
              <th class="border border-gray-300 px-2 py-1 text-xs text-left">Model</th>
              <th class="border border-gray-300 px-2 py-1 text-xs text-left">App</th>
              <th class="border border-gray-300 px-2 py-1 text-xs text-left">Analysis Type</th>
              <th class="border border-gray-300 px-2 py-1 text-xs text-left">Status</th>
              <th class="border border-gray-300 px-2 py-1 text-xs text-left">Issues/Metric/Error</th> {# Updated Header #}
              <th class="border border-gray-300 px-2 py-1 text-xs text-left">Duration</th>
              <th class="border border-gray-300 px-2 py-1 text-xs text-left">Actions</th>
            </tr>
          </thead>
          <tbody id="resultsTableBody">
            {# --- UPDATED Row Rendering --- #}
            {% if results %}
              {% for result in results %}
                {# Add CSS class based on status #}
                <tr class="result-row hover:bg-gray-100
                    {% if result.status == 'completed' %}task-row-completed
                    {% elif result.status == 'failed' %}task-row-failed
                    {% elif result.status == 'triggered' %}task-row-triggered
                    {% else %}task-row-pending{% endif %}"
                    data-result-id="{{ result.id }}"
                    data-status="{{ result.status }}"
                    data-analysis-type="{{ result.analysis_type if result.analysis_type is string else result.analysis_type.value }}"
                    data-model="{{ result.model }}">
                  <td class="border border-gray-300 px-2 py-1 text-xs">{{ result.model }}</td>
                  <td class="border border-gray-300 px-2 py-1 text-xs">App {{ result.app_num }}</td>
                  <td class="border border-gray-300 px-2 py-1 text-xs">
                     {# Analysis type badge - FIXED to handle both string and enum object #}
                     {% set analysis_type_value = result.analysis_type if result.analysis_type is string else result.analysis_type.value %}
                     <span class="px-1.5 py-0.5 rounded text-white text-[10px] capitalize whitespace-nowrap
                        {% if analysis_type_value == 'frontend_security' %}bg-purple-600
                        {% elif analysis_type_value == 'backend_security' %}bg-indigo-600
                        {% elif analysis_type_value == 'performance' %}bg-cyan-600
                        {% elif analysis_type_value == 'gpt4all' %}bg-orange-600
                        {% elif analysis_type_value == 'zap' %}bg-lime-600
                        {% else %}bg-gray-500{% endif %}">
                        {{ analysis_type_value.replace('_', ' ') }}</span>
                  </td>
                  <td class="border border-gray-300 px-2 py-1 text-xs">
                    {# Status badge #}
                    <span class="px-2 py-0.5 rounded-md text-white capitalize
                      {% if result.status == 'completed' %}bg-blue-600
                      {% elif result.status == 'triggered' %}bg-yellow-600
                      {% elif result.status == 'failed' %}bg-red-600
                      {% else %}bg-gray-500{% endif %}">
                      {{ result.status }}
                    </span>
                  </td>
                   <td class="border border-gray-300 px-2 py-1 text-xs">
                       {# --- UPDATED: Display relevant metric OR error with analysis_type check fix --- #}
                       {% set task_error = result.details.get('error') %}
                       {% set analysis_type_value = result.analysis_type if result.analysis_type is string else result.analysis_type.value %}
                       {% if task_error %}
                           <div class="error-tooltip text-red-700">
                                <span class="font-bold">Error:</span> {{ task_error | truncate(60) }}
                                <span class="tooltip-text">{{ task_error | replace('\n', '<br>') | safe }}</span> {# Display full error in tooltip #}
                           </div>
                       {% elif analysis_type_value in ['frontend_security', 'backend_security'] %}
                           <span class="text-red-700">{{ result.high_severity }}</span> / <span class="text-yellow-700">{{ result.medium_severity }}</span> / <span class="text-blue-700">{{ result.low_severity }}</span> (<span class="font-bold">{{ result.issues_count }}</span> total)
                       {% elif analysis_type_value == 'performance' %}
                           {{ result.details.get('requests_per_sec', 0)|round(1) }} RPS / {{ result.details.get('avg_response_time', 0)|round(0) }}ms RT
                       {% elif analysis_type_value == 'gpt4all' %}
                           {{ result.details.get('summary', {}).get('met_count', 0) }} / {{ result.details.get('summary', {}).get('requirements_checked', 0) }} Met
                       {% elif analysis_type_value == 'zap' %}
                           Scan ID: {{ result.details.get('summary', {}).get('zap_scan_id', 'N/A') }}
                       {% else %}
                           {{ result.issues_count }}
                       {% endif %}
                   </td>
                  <td class="border border-gray-300 px-2 py-1 text-xs">
                      {# FIXED: Use the macro directly instead of as a filter #}
                      {% if result.duration_seconds %}
                        {{ humanize_duration(result.duration_seconds) }}
                      {% else %}
                        N/A
                      {% endif %}
                  </td>
                  <td class="border border-gray-300 px-2 py-1 text-xs">
                    <a href="{{ url_for('batch_analysis.view_result', result_id=result.id) }}" class="action-btn h-6 px-2 text-xs focus:ring-2 focus:ring-blue-500 transition">Details</a>
                  </td>
                </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="7" class="border border-gray-300 py-4 text-center text-sm text-gray-500">
                  {# UPDATED: Clearer no results message #}
                  {% if job.status == JobStatus.RUNNING.value %}Job is running - results will appear here as tasks complete...
                  {% elif job.status == JobStatus.PENDING.value %}Job is pending - tasks have not started yet.
                  {% else %}No task results found for this job. {% endif %}
                </td>
              </tr>
            {% endif %}
            <tr id="noResultsRow" class="hidden">
              <td colspan="7" class="border border-gray-300 py-4 text-center text-sm text-gray-500">No results match your current filters</td>
            </tr>
          </tbody>
        </table>
      </div>
      <div id="resultsCounter" class="mt-2 text-xs text-gray-600 text-right">
        Showing <span id="visibleResultsCount">{{ results|length }}</span> of <span id="totalResultsCount">{{ results|length }}</span> results
      </div>
    </div>
  </div>

  {# --- Job Errors Section (Container Added) --- #}
  <div id="errorsSection" class="border border-red-400 bg-red-50 rounded-md shadow-sm {% if not job.errors %}hidden{% endif %}">
    <div class="bg-red-100 border-b border-red-400 px-2 py-1">
      <h2 class="font-bold text-sm text-red-800">Job Execution Errors</h2>
    </div>
    <div class="p-2">
      {# UPDATED: Added id="errorsList" #}
      <ul id="errorsList" class="list-disc pl-4 text-xs text-red-700 space-y-1 max-h-40 overflow-y-auto">
        {% for error in job.errors %}<li>{{ error }}</li>{% endfor %}
        {% if not job.errors %}<li class="text-gray-500 italic">No job errors reported.</li>{% endif %}
      </ul>
    </div>
  </div>

  {# --- Auto-Refresh Toggle (Unchanged) --- #}
  {% if job.status == JobStatus.RUNNING.value %}
  <div class="fixed bottom-4 right-4 bg-white border border-gray-300 rounded-md shadow-md p-2 flex items-center space-x-2 z-40">
    <div class="text-xs text-gray-700">Auto-refresh:</div><div class="relative inline-block w-10 h-5 align-middle select-none transition duration-200 ease-in"><input type="checkbox" id="autoRefreshToggle" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-2 appearance-none cursor-pointer peer" checked/><label for="autoRefreshToggle" class="toggle-label block overflow-hidden h-5 rounded-full bg-gray-300 cursor-pointer peer-checked:bg-blue-500 peer-checked:border-blue-500"></label></div><div class="text-xs text-gray-700" id="refreshStatus"><span class="inline-block mr-1" id="refreshSpinner">⟳</span>Next: <span id="refreshCountdown">10</span>s</div>
  </div>
  {% endif %}

  <div id="toastContainer" class="fixed bottom-4 left-4 z-50"></div>
</div>

{# --- JavaScript with Fix for Runtime Calculation --- #}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Setup filters for results table
  setupResultsFilters();

  // Setup cancel job button
  setupCancelJobButton();

  // Setup auto-refresh for running jobs
  {% if job.status == JobStatus.RUNNING.value %}
  setupAutoRefresh();
  {% endif %}

  // FIXED: Runtime calculation in JavaScript instead of using fromisoformat filter
  calculateRuntime();

  function calculateRuntime() {
    const runtimeValue = document.getElementById('runtimeValue');
    if (!runtimeValue) return;

    {% if job.started_at %}
    const startedAt = new Date("{{ job.started_at }}");
    
    {% if job.completed_at %}
    const completedAt = new Date("{{ job.completed_at }}");
    const durationSeconds = Math.floor((completedAt - startedAt) / 1000);
    runtimeValue.textContent = humanize_duration(durationSeconds);
    {% elif job.status == JobStatus.RUNNING.value %}
    runtimeValue.innerHTML = 'In progress<span class="task-running-indicator"></span>';
    // Update runtime every second for running jobs
    setInterval(function() {
      const now = new Date();
      const durationSeconds = Math.floor((now - startedAt) / 1000);
      runtimeValue.innerHTML = humanize_duration(durationSeconds) + '<span class="task-running-indicator"></span>';
    }, 1000);
    {% else %}
    runtimeValue.textContent = 'N/A';
    {% endif %}
    {% else %}
    runtimeValue.textContent = 'N/A';
    {% endif %}
  }

  function setupResultsFilters() {
    // Filter setup code...
  }

  function setupCancelJobButton() {
    // Cancel job button setup code...
  }

  function setupAutoRefresh() {
    // Auto-refresh setup code...
  }
  
  // Jinja macro simulation for duration
  window.humanize_duration = function(seconds) {
    if (seconds === null || seconds === undefined || seconds < 0) return 'N/A';
    
    seconds = Math.floor(seconds);
    if (seconds < 60) {
      return seconds + 's';
    } else if (seconds < 3600) {
      const minutes = Math.floor(seconds / 60);
      const remainingSeconds = seconds % 60;
      return minutes + 'm ' + remainingSeconds + 's';
    } else {
      const hours = Math.floor(seconds / 3600);
      const remainingMinutes = Math.floor((seconds % 3600) / 60);
      return hours + 'h ' + remainingMinutes + 'm';
    }
  };

  // Toast notification helper
  window.showToast = function(message, type = 'success') {
    // Toast notification code...
  };
});
</script>
{% endblock %}