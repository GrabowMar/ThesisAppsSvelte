{% extends "base.html" %}

{% block content %}
<div class="space-y-2 max-w-7xl mx-auto">
  <div class="border border-gray-400 bg-white p-2 rounded-md">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="font-bold text-xl text-gray-900">Batch Job Details</h1>
        <p class="text-xs text-gray-600 mt-1">{{ job.name }} (ID: {{ job.id }})</p>
      </div>
      <div class="flex items-center space-x-2">
        <a href="{{ url_for('batch_analysis.batch_dashboard') }}" class="action-btn h-6 px-2 text-xs flex items-center">
          <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
          </svg>
          Back to Dashboard
        </a>
        {% if job.status == JobStatus.RUNNING.value %} {# Check against enum value #}
          <button id="cancelJobBtn" class="action-btn h-6 px-2 text-xs flex items-center bg-red-600 text-white hover:bg-red-700 focus:ring-2 focus:ring-red-500 focus:ring-opacity-50 transition" data-job-id="{{ job.id }}">
            <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
            Cancel Job
          </button>
        {% endif %}
        {% if job.status != JobStatus.RUNNING.value %} {# Check against enum value #}
            <form method="POST" action="{{ url_for('batch_analysis.delete_job_api', job_id=job.id) }}" onsubmit="return confirm('Are you sure you want to delete this job and all its results?');" class="inline">
                <button type="submit" class="action-btn h-6 px-2 text-xs bg-gray-500 text-white hover:bg-gray-600 focus:ring-2 focus:ring-gray-400 transition" aria-label="Delete job {{ job.id }}">
                    Delete Job
                </button>
            </form>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
    <div class="border border-gray-400 bg-white rounded-md shadow-sm">
      <div class="bg-gray-100 border-b border-gray-400 px-2 py-1">
        <h2 class="font-bold text-sm">Job Information</h2>
      </div>
      <div class="p-2">
        <table class="w-full text-xs">
          <tr>
            <td class="font-medium text-gray-600 py-1 pr-2 align-top">ID:</td>
            <td>{{ job.id }}</td>
          </tr>
          <tr>
            <td class="font-medium text-gray-600 py-1 pr-2 align-top">Name:</td>
            <td>{{ job.name }}</td>
          </tr>
          <tr>
            <td class="font-medium text-gray-600 py-1 pr-2 align-top">Description:</td>
            <td>{{ job.description if job.description else 'N/A' }}</td>
          </tr>
          <tr>
            <td class="font-medium text-gray-600 py-1 pr-2 align-top">Status:</td>
            <td>
              <span class="px-2 py-0.5 rounded-md text-white capitalize
                {% if job.status == JobStatus.RUNNING.value %}bg-green-600
                {% elif job.status == JobStatus.COMPLETED.value %}bg-blue-600
                {% elif job.status == JobStatus.PENDING.value %}bg-gray-600
                {% elif job.status == JobStatus.CANCELED.value %}bg-yellow-600
                {% else %}bg-red-600{% endif %}">
                {{ job.status }}
              </span>
            </td>
          </tr>
          <tr>
            <td class="font-medium text-gray-600 py-1 pr-2 align-top">Analysis Types:</td>
            <td>
                 <div class="flex flex-wrap gap-1">
                    {% for analysis_type_str in job.analysis_types %}
                        {% set analysis_type = AnalysisType(analysis_type_str) %} {# Convert string back to enum if needed #}
                        <span class="px-1.5 py-0.5 rounded text-white text-[10px] capitalize whitespace-nowrap
                        {% if analysis_type == AnalysisType.FRONTEND_SECURITY %}bg-purple-600
                        {% elif analysis_type == AnalysisType.BACKEND_SECURITY %}bg-indigo-600
                        {% elif analysis_type == AnalysisType.PERFORMANCE %}bg-cyan-600
                        {% elif analysis_type == AnalysisType.GPT4ALL %}bg-orange-600
                        {% elif analysis_type == AnalysisType.ZAP %}bg-lime-600
                        {% else %}bg-gray-500{% endif %}">
                        {{ analysis_type.value.replace('_', ' ') }}
                        </span>
                    {% endfor %}
                 </div>
            </td>
          </tr>
          <tr>
            <td class="font-medium text-gray-600 py-1 pr-2 align-top">Created:</td>
            <td>{{ job.created_at if job.created_at else 'N/A' }}</td> {# Already formatted #}
          </tr>
          <tr>
            <td class="font-medium text-gray-600 py-1 pr-2 align-top">Started:</td>
            <td>{{ job.started_at if job.started_at else 'N/A' }}</td> {# Already formatted #}
          </tr>
          <tr>
            <td class="font-medium text-gray-600 py-1 pr-2 align-top">Completed:</td>
            <td>{{ job.completed_at if job.completed_at else 'N/A' }}</td> {# Already formatted #}
          </tr>
          <tr>
            <td class="font-medium text-gray-600 py-1 pr-2 align-top">Models:</td>
            <td>{{ job.models|join(', ') }}</td>
          </tr>
          <tr>
            <td class="font-medium text-gray-600 py-1 pr-2 align-top">Analysis Options:</td>
            <td>
                <pre class="text-[10px] bg-gray-50 p-1 rounded border border-gray-200 max-h-20 overflow-auto">{{ job.analysis_options|tojson(indent=2) }}</pre>
            </td>
          </tr>
        </table>
      </div>
    </div>

    <div class="border border-gray-400 bg-white rounded-md shadow-sm">
      <div class="bg-gray-100 border-b border-gray-400 px-2 py-1">
        <h2 class="font-bold text-sm">Progress</h2>
      </div>
      <div class="p-2">
        <div class="mb-2">
          <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden" title="{{ status_data.progress.completed }}/{{ status_data.progress.total }} tasks">
            <div class="bg-blue-600 rounded-full h-4 flex items-center justify-center text-xs text-white transition-all duration-300"
                style="width: {{ status_data.progress.percent }}%"
                id="progressBar">
              {{ status_data.progress.percent }}%
            </div>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-2 text-xs">
          <div class="border border-gray-300 p-2 rounded-md">
            <div class="text-gray-600">Completed</div>
            <div class="font-bold" id="completedTasks">{{ status_data.progress.completed }}/{{ status_data.progress.total }} tasks</div>
          </div>
          <div class="border border-gray-300 p-2 rounded-md">
            <div class="text-gray-600">Runtime</div>
            <div class="font-bold" id="runtime">
              {% set start = job.started_at|datetime if job.started_at else None %}
              {% set end = job.completed_at|datetime if job.completed_at else now() if job.status == JobStatus.RUNNING.value else None %}
              {% if start and end %}
                  {{ (end - start).total_seconds()|humanize_duration }}
              {% elif job.status == JobStatus.RUNNING.value %}
                  In progress...
              {% else %}
                  N/A
              {% endif %}
            </div>
          </div>
           <div class="border border-gray-300 p-2 rounded-md col-span-2">
                <div class="text-gray-600">Tasks Failed</div>
                <div class="font-bold text-red-700" id="tasksFailed">{{ status_data.results_summary.get('tasks_failed', 0) }}</div>
           </div>
        </div>
      </div>
    </div>

    <div class="border border-gray-400 bg-white rounded-md shadow-sm">
      <div class="bg-gray-100 border-b border-gray-400 px-2 py-1">
        <h2 class="font-bold text-sm">Aggregated Results</h2>
      </div>
      <div class="p-2 space-y-2">
         {# Security Issues Summary (if applicable) #}
         {% if 'high_total' in status_data.results_summary %}
         <div class="border border-gray-300 p-2 rounded-md">
            <h3 class="text-xs font-medium text-gray-700 mb-1">Security Issues</h3>
            <div class="grid grid-cols-3 gap-2 text-xs">
              <div>
                <div class="text-red-600">High</div>
                <div class="font-bold text-red-700" id="highIssues">{{ status_data.results_summary.get('high_total', 0) }}</div>
              </div>
              <div>
                <div class="text-yellow-600">Medium</div>
                <div class="font-bold text-yellow-700" id="mediumIssues">{{ status_data.results_summary.get('medium_total', 0) }}</div>
              </div>
              <div>
                <div class="text-blue-600">Low</div>
                <div class="font-bold text-blue-700" id="lowIssues">{{ status_data.results_summary.get('low_total', 0) }}</div>
              </div>
            </div>
         </div>
         {% endif %}

         {# Performance Summary (if applicable) #}
         {% if 'performance_tasks_completed' in status_data.results_summary %}
         <div class="border border-gray-300 p-2 rounded-md">
            <h3 class="text-xs font-medium text-gray-700 mb-1">Performance</h3>
            <div class="text-xs">
                Avg RPS: <span class="font-bold" id="avgRps">{{ status_data.results_summary.get('performance_avg_rps', 'N/A') }}</span><br>
                Avg Resp Time: <span class="font-bold" id="avgResponseTime">{{ status_data.results_summary.get('performance_avg_rt', 'N/A') }} ms</span><br>
                Total Failures: <span class="font-bold text-red-700" id="perfFailures">{{ status_data.results_summary.get('performance_issues_total', 0) }}</span>
            </div>
            {# Add more performance metrics if aggregated #}
         </div>
         {% endif %}

         {# GPT4All Summary (if applicable) #}
          {% if 'gpt4all_tasks_completed' in status_data.results_summary %}
         <div class="border border-gray-300 p-2 rounded-md">
            <h3 class="text-xs font-medium text-gray-700 mb-1">GPT4All Requirements</h3>
             <div class="text-xs">
                Reqs Checked: <span class="font-bold" id="gptReqsChecked">{{ status_data.results_summary.get('gpt4all_reqs_checked_total', 0) }}</span><br>
                Reqs Met: <span class="font-bold text-green-700" id="gptReqsMet">{{ status_data.results_summary.get('gpt4all_reqs_met_total', 0) }}</span>
            </div>
         </div>
         {% endif %}

         {# ZAP Summary (if applicable) #}
         {% if 'zap_tasks_completed' in status_data.results_summary or 'zap_tasks_triggered' in status_data.results_summary %}
         <div class="border border-gray-300 p-2 rounded-md">
            <h3 class="text-xs font-medium text-gray-700 mb-1">ZAP Scans</h3>
             <div class="text-xs">
                Scans Triggered: <span class="font-bold" id="zapScansTriggered">{{ status_data.results_summary.get('zap_tasks_triggered', 0) }}</span><br>
                {# Add counts if ZAP results are polled and aggregated later #}
                {# High: <span class="font-bold text-red-700">{{ status_data.results_summary.get('zap_high', 0) }}</span> #}
            </div>
         </div>
         {% endif %}

      </div>
    </div>
  </div>

  <div class="border border-gray-400 bg-white rounded-md shadow-sm">
    <div class="bg-gray-100 border-b border-gray-400 px-2 py-1 flex justify-between items-center">
      <h2 class="font-bold text-sm">Task Results</h2>
      <div class="flex flex-wrap items-center gap-2">
        <div class="relative">
          <input type="text" id="searchResults" placeholder="Search results..."
                class="h-6 pl-6 pr-2 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
          <svg class="w-3 h-3 absolute left-2 top-1.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
          </svg>
        </div>
        <select id="resultStatusFilter" class="h-6 px-2 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
          <option value="all">All Statuses</option>
          <option value="completed">Completed</option>
          <option value="failed">Failed</option>
          <option value="triggered">Triggered</option> {# Added for ZAP #}
          {# Add other statuses if needed #}
        </select>
        <select id="resultModelFilter" class="h-6 px-2 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
          <option value="all">All Models</option>
          {% for model_name in job.models %}
            <option value="{{ model_name }}">{{ model_name }}</option>
          {% endfor %}
        </select>
        <select id="resultAnalysisTypeFilter" class="h-6 px-2 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
             <option value="all">All Analysis Types</option>
             {% for type_enum in AnalysisType %} {# Use AnalysisType enum passed from route #}
               <option value="{{ type_enum.value }}">{{ type_enum.value.replace('_', ' ')|title }}</option>
             {% endfor %}
        </select>
      </div>
    </div>
    <div class="p-2">
      <div class="overflow-x-auto">
        <table class="min-w-full border border-gray-300">
          <thead>
            <tr class="bg-gray-100">
              <th class="border border-gray-300 px-2 py-1 text-xs text-left">Model</th>
              <th class="border border-gray-300 px-2 py-1 text-xs text-left">App</th>
              <th class="border border-gray-300 px-2 py-1 text-xs text-left">Analysis Type</th>
              <th class="border border-gray-300 px-2 py-1 text-xs text-left">Status</th>
              <th class="border border-gray-300 px-2 py-1 text-xs text-left">Issues/Metric</th> {# Generic Header #}
              <th class="border border-gray-300 px-2 py-1 text-xs text-left">Duration</th>
              <th class="border border-gray-300 px-2 py-1 text-xs text-left">Actions</th>
            </tr>
          </thead>
          <tbody id="resultsTableBody">
            {% if results %}
              {% for result in results %}
                <tr class="hover:bg-gray-50 result-row"
                    data-result-id="{{ result.id }}"
                    data-status="{{ result.status }}"
                    data-analysis-type="{{ result.analysis_type.value }}" {# Use enum value #}
                    data-model="{{ result.model }}">
                  <td class="border border-gray-300 px-2 py-1 text-xs">{{ result.model }}</td>
                  <td class="border border-gray-300 px-2 py-1 text-xs">App {{ result.app_num }}</td>
                  <td class="border border-gray-300 px-2 py-1 text-xs">
                     {# Display analysis type badge #}
                     <span class="px-1.5 py-0.5 rounded text-white text-[10px] capitalize whitespace-nowrap
                        {% if result.analysis_type == AnalysisType.FRONTEND_SECURITY %}bg-purple-600
                        {% elif result.analysis_type == AnalysisType.BACKEND_SECURITY %}bg-indigo-600
                        {% elif result.analysis_type == AnalysisType.PERFORMANCE %}bg-cyan-600
                        {% elif result.analysis_type == AnalysisType.GPT4ALL %}bg-orange-600
                        {% elif result.analysis_type == AnalysisType.ZAP %}bg-lime-600
                        {% else %}bg-gray-500{% endif %}">
                        {{ result.analysis_type.value.replace('_', ' ') }}
                      </span>
                  </td>
                  <td class="border border-gray-300 px-2 py-1 text-xs">
                    <span class="px-2 py-0.5 rounded-md text-white capitalize
                      {% if result.status == 'completed' %}bg-blue-600
                      {% elif result.status == 'triggered' %}bg-yellow-600
                      {% else %}bg-red-600{% endif %}">
                      {{ result.status }}
                    </span>
                  </td>
                   <td class="border border-gray-300 px-2 py-1 text-xs">
                       {# Display relevant metric based on type #}
                       {% if result.analysis_type in [AnalysisType.FRONTEND_SECURITY, AnalysisType.BACKEND_SECURITY] %}
                           <span class="text-red-700">{{ result.high_severity }}</span> /
                           <span class="text-yellow-700">{{ result.medium_severity }}</span> /
                           <span class="text-blue-700">{{ result.low_severity }}</span>
                           (<span class="font-bold">{{ result.issues_count }}</span> total)
                       {% elif result.analysis_type == AnalysisType.PERFORMANCE %}
                           {{ result.details.get('requests_per_sec', 0)|round(1) }} RPS / {{ result.details.get('avg_response_time', 0)|round(0) }}ms RT
                       {% elif result.analysis_type == AnalysisType.GPT4ALL %}
                           {{ result.details.get('summary', {}).get('met_count', 0) }} / {{ result.details.get('summary', {}).get('requirements_checked', 0) }} Met
                       {% elif result.analysis_type == AnalysisType.ZAP %}
                           Scan ID: {{ result.details.get('summary', {}).get('zap_scan_id', 'N/A') }}
                       {% else %}
                           {{ result.issues_count }}
                       {% endif %}
                   </td>
                  <td class="border border-gray-300 px-2 py-1 text-xs">
                      {{ result.duration_seconds|humanize_duration if result.duration_seconds else 'N/A' }}
                  </td>
                  <td class="border border-gray-300 px-2 py-1 text-xs">
                    <a href="{{ url_for('batch_analysis.view_result', result_id=result.id) }}" class="action-btn h-6 px-2 text-xs focus:ring-2 focus:ring-blue-500 transition">
                      Details
                    </a>
                  </td>
                </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="7" class="border border-gray-300 py-4 text-center text-sm text-gray-500"> {# Adjusted colspan #}
                  {% if job.status == JobStatus.RUNNING.value %}
                    Job is running - results will appear here as they are generated
                  {% elif job.status == JobStatus.PENDING.value %}
                    Job is pending - no results available yet
                  {% else %}
                    No results found for this job
                  {% endif %}
                </td>
              </tr>
            {% endif %}
            <tr id="noResultsRow" class="hidden">
              <td colspan="7" class="border border-gray-300 py-4 text-center text-sm text-gray-500"> {# Adjusted colspan #}
                No results match your current filters
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <div id="resultsCounter" class="mt-2 text-xs text-gray-600 text-right">
        Showing <span id="visibleResultsCount">{{ results|length }}</span> of <span id="totalResultsCount">{{ results|length }}</span> results
      </div>
    </div>
  </div>

  {% if job.errors %}
  <div id="errorsSection" class="border border-gray-400 bg-white rounded-md shadow-sm">
    <div class="bg-red-100 border-b border-red-400 px-2 py-1">
      <h2 class="font-bold text-sm text-red-800">Job Errors</h2>
    </div>
    <div class="p-2">
      <ul class="list-disc pl-4 text-xs text-red-700 space-y-1 max-h-40 overflow-y-auto" id="errorsList">
        {% for error in job.errors %}
          <li>{{ error }}</li>
        {% endfor %}
      </ul>
    </div>
  </div>
  {% endif %}

  {% if job.status == JobStatus.RUNNING.value %}
  <div class="fixed bottom-4 right-4 bg-white border border-gray-300 rounded-md shadow-md p-2 flex items-center space-x-2 z-40">
    <div class="text-xs text-gray-700">Auto-refresh:</div>
    <div class="relative inline-block w-10 h-5 align-middle select-none transition duration-200 ease-in">
        <input type="checkbox" id="autoRefreshToggle" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-2 appearance-none cursor-pointer peer" checked/>
        <label for="autoRefreshToggle" class="toggle-label block overflow-hidden h-5 rounded-full bg-gray-300 cursor-pointer peer-checked:bg-blue-500 peer-checked:border-blue-500"></label>
    </div>
    <div class="text-xs text-gray-700" id="refreshStatus">
      <span class="inline-block mr-1" id="refreshSpinner">‚ü≥</span>
      Next: <span id="refreshCountdown">10</span>s
    </div>
  </div>
  {% endif %}

  <div id="toastContainer" class="fixed bottom-4 left-4 z-50"></div>
</div>

{# Jinja macro for humanizing duration #}
{% macro humanize_duration(seconds) %}
{% if seconds is none or seconds < 0 %}N/A{% else %}{% set seconds = seconds|int %}{% if seconds < 60 %}{{ seconds }}s{% elif seconds < 3600 %}{{ '%dm %ds'|format(seconds // 60, seconds % 60) }}{% else %}{{ '%dh %dm'|format(seconds // 3600, (seconds % 3600) // 60) }}{% endif %}{% endif %}
{% endmacro %}

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Setup filters for results table
  setupResultsFilters();

  // Setup cancel job button
  setupCancelJobButton();

  // Setup auto-refresh for running jobs
  {% if job.status == JobStatus.RUNNING.value %}
  setupAutoRefresh();
  {% endif %}

  function setupResultsFilters() {
    const searchInput = document.getElementById('searchResults');
    const statusFilter = document.getElementById('resultStatusFilter');
    const modelFilter = document.getElementById('resultModelFilter');
    const analysisTypeFilter = document.getElementById('resultAnalysisTypeFilter'); // Updated ID
    const resultRows = document.querySelectorAll('.result-row');
    const noResultsRow = document.getElementById('noResultsRow');
    const visibleResultsCount = document.getElementById('visibleResultsCount');
    const totalResultsCount = document.getElementById('totalResultsCount'); // Assuming this exists or is needed

    const applyFilters = function() {
      const searchText = searchInput?.value?.toLowerCase() || '';
      const selectedStatus = statusFilter?.value || 'all';
      const selectedModel = modelFilter?.value || 'all';
      const selectedAnalysisType = analysisTypeFilter?.value || 'all'; // Updated

      let visibleCount = 0;

      resultRows.forEach(function(row) {
        const status = row.dataset.status?.toLowerCase() || '';
        const model = row.dataset.model?.toLowerCase() || '';
        const analysisType = row.dataset.analysisType?.toLowerCase() || ''; // Updated

        const matchesSearch = !searchText || row.textContent.toLowerCase().includes(searchText);
        const matchesStatus = selectedStatus === 'all' || status === selectedStatus;
        const matchesModel = selectedModel === 'all' || model === selectedModel.toLowerCase();
        const matchesAnalysisType = selectedAnalysisType === 'all' || analysisType === selectedAnalysisType; // Updated

        const isVisible = matchesSearch && matchesStatus && matchesModel && matchesAnalysisType; // Updated
        row.style.display = isVisible ? '' : 'none';

        if (isVisible) visibleCount++;
      });

      // Update counter
      if (visibleResultsCount) {
        visibleResultsCount.textContent = visibleCount;
      }
       if (totalResultsCount) { // Update total if needed (might be static)
           // totalResultsCount.textContent = resultRows.length;
       }


      // Show/hide no results row
      if (noResultsRow) {
        noResultsRow.style.display = (visibleCount === 0 && resultRows.length > 0) ? 'table-row' : 'none';
      }
    };

    // Add event listeners with debounce for search
    let searchTimeout;
    if (searchInput) {
      searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(applyFilters, 300);
      });
    }

    // Add event listeners for filters
    [statusFilter, modelFilter, analysisTypeFilter].forEach(function(filter) { // Updated
      if (filter) {
        filter.addEventListener('change', applyFilters);
      }
    });

    // Apply filters on initial load
    applyFilters();
  }

  function setupCancelJobButton() {
    const cancelBtn = document.getElementById('cancelJobBtn');

    if (cancelBtn) {
      cancelBtn.addEventListener('click', function() {
        if (!confirm('Are you sure you want to cancel this job?')) {
          return;
        }

        const jobId = this.dataset.jobId;
        const button = this;

        button.disabled = true;
        button.innerHTML = `
          <svg class="animate-spin w-3 h-3 inline mr-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>Canceling...`;

        // Send cancel request
        fetch(`/batch/job/${jobId}/cancel`, { // Ensure URL prefix is correct
          method: 'POST',
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/json'
            // Add CSRF token if needed: 'X-CSRFToken': '{{ csrf_token() }}'
          }
        })
        .then(response => {
             if (!response.ok) {
                 return response.json().then(errData => { throw new Error(errData.error || `HTTP error ${response.status}`); });
             }
             return response.json();
         })
        .then(data => {
          // Check for explicit success or specific status
          if (data.status === 'canceled' || data.success === true) {
            showToast('Job marked for cancellation.', 'info');
            // Update UI immediately - change status badge, disable cancel button
             const statusBadge = document.querySelector(`.job-row[data-job-id="${jobId}"] td:nth-child(3) span`); // Adjust selector if needed
             if (statusBadge) {
                 statusBadge.textContent = 'canceling';
                 statusBadge.className = 'px-2 py-0.5 rounded-md text-white capitalize bg-yellow-600';
             }
             button.remove(); // Remove the cancel button
             // Optionally reload after a delay or wait for status update
             // setTimeout(() => window.location.reload(), 1500);
          } else {
            showToast(data.error || 'Failed to cancel job', 'error');
            button.disabled = false;
            button.innerHTML = `
              <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
              Cancel Job`;
          }
        })
        .catch(error => {
          console.error('Error canceling job:', error);
          showToast('Error: ' + error.message, 'error');
          button.disabled = false;
          button.innerHTML = `
            <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
            Cancel Job`;
        });
      });
    }
  }

  function setupAutoRefresh() {
    const toggle = document.getElementById('autoRefreshToggle');
    const countdownEl = document.getElementById('refreshCountdown');
    const refreshSpinner = document.getElementById('refreshSpinner');
    const progressBar = document.getElementById('progressBar');
    const completedTasksEl = document.getElementById('completedTasks');
    const highIssuesEl = document.getElementById('highIssues');
    const mediumIssuesEl = document.getElementById('mediumIssues');
    const lowIssuesEl = document.getElementById('lowIssues');
    const totalIssuesEl = document.getElementById('totalIssues');
    const tasksFailedEl = document.getElementById('tasksFailed'); // Assuming an element with this ID exists
    const errorsListEl = document.getElementById('errorsList'); // Assuming an element with this ID exists
    const errorsSection = document.getElementById('errorsSection');

    let timer;
    let secondsLeft = 10; // Refresh interval

    function startTimer() {
      clearInterval(timer);
      secondsLeft = 10;
      if (countdownEl) countdownEl.textContent = secondsLeft;
      if (refreshSpinner) refreshSpinner.classList.add('animate-spin');

      timer = setInterval(function() {
        secondsLeft--;
        if (countdownEl) countdownEl.textContent = secondsLeft;

        if (secondsLeft <= 0) {
          clearInterval(timer);
          refreshJobStatus();
        }
      }, 1000);
    }

    function refreshJobStatus() {
      if (refreshSpinner) refreshSpinner.classList.add('animate-spin'); // Show spinner during fetch

      fetch(`/batch/job/{{ job.id }}/status`) // Ensure URL prefix is correct
        .then(response => {
            if (!response.ok) { throw new Error(`HTTP error ${response.status}`); }
            return response.json();
        })
        .then(data => {
          if (data.error) {
              console.error("Error fetching status:", data.error);
              showToast(`Error fetching status: ${data.error}`, 'error');
              // Optionally stop refreshing on error: clearInterval(timer); return;
          } else {
              // Update progress
              const percent = data.progress.total > 0
                ? Math.round((data.progress.completed / data.progress.total) * 100)
                : 0;

              if (progressBar) {
                progressBar.style.width = `${percent}%`;
                progressBar.textContent = `${percent}%`;
              }
              if (completedTasksEl) {
                completedTasksEl.textContent = `${data.progress.completed}/${data.progress.total} tasks`;
              }

              // Update issue counts (use .get for safety)
              const summary = data.results_summary || {};
              if (highIssuesEl) highIssuesEl.textContent = summary.get('high_total', 0);
              if (mediumIssuesEl) mediumIssuesEl.textContent = summary.get('medium_total', 0);
              if (lowIssuesEl) lowIssuesEl.textContent = summary.get('low_total', 0);
              if (totalIssuesEl) totalIssuesEl.textContent = summary.get('issues_total', 0);
              if (tasksFailedEl) tasksFailedEl.textContent = summary.get('tasks_failed', 0);

              // Update Errors List
              const errors = data.job?.errors || [];
              if (errorsListEl) {
                  errorsListEl.innerHTML = ''; // Clear previous errors
                  errors.forEach(err => {
                      const li = document.createElement('li');
                      li.textContent = err;
                      errorsListEl.appendChild(li);
                  });
              }
               if (errorsSection) {
                   errorsSection.style.display = errors.length > 0 ? 'block' : 'none';
               }


              // Check if job status has changed from running
              if (data.job?.status !== JobStatus.RUNNING.value) {
                showToast(`Job status changed to ${data.job.status}. Reloading...`, 'info');
                setTimeout(() => window.location.reload(), 2000);
                return; // Stop refreshing
              }

               // Check if new results have been added (simple count check)
               // This might require fetching full results or relying on completed_tasks count
               const currentResultCount = document.querySelectorAll('.result-row').length;
               if (data.progress.completed > currentResultCount) {
                   showToast('New results available, reloading...', 'info');
                   setTimeout(() => window.location.reload(), 1500); // Reload to show new results
                   return; // Stop refreshing
               }
          }

          // Restart timer only if toggle is checked and job is still running
          if (toggle && toggle.checked && data.job?.status === JobStatus.RUNNING.value) {
            startTimer();
          } else {
             if (refreshSpinner) refreshSpinner.classList.remove('animate-spin');
          }
        })
        .catch(error => {
          console.error('Error refreshing job status:', error);
          showToast(`Error refreshing status: ${error.message}`, 'error');
          // Optionally stop refreshing on error: clearInterval(timer);
          if (toggle && toggle.checked) { // Still restart timer on error? Maybe add delay?
              setTimeout(startTimer, 5000); // Retry after 5s on error
          } else {
              if (refreshSpinner) refreshSpinner.classList.remove('animate-spin');
          }
        });
    }

    // Initialize auto-refresh
    const toggle = document.getElementById('autoRefreshToggle');
    if (toggle) {
      toggle.addEventListener('change', function() {
        if (this.checked) {
          startTimer();
        } else {
          clearInterval(timer);
          if (refreshSpinner) refreshSpinner.classList.remove('animate-spin');
          if (countdownEl) countdownEl.textContent = 'Paused';
        }
      });

      // Start initial timer if auto-refresh is enabled
      if (toggle.checked) {
        startTimer();
      } else {
          if (refreshSpinner) refreshSpinner.classList.remove('animate-spin');
          if (countdownEl) countdownEl.textContent = 'Paused';
      }
    }
  }

  // Toast notification helper (reuse or define globally)
  window.showToast = function(message, type = 'success') {
    if (!message) return;
    let toastContainer = document.getElementById('toastContainer');
    if (!toastContainer) {
      toastContainer = document.createElement('div');
      toastContainer.id = 'toastContainer';
      toastContainer.className = 'fixed bottom-4 left-4 z-50 flex flex-col gap-2';
      document.body.appendChild(toastContainer);
    }
    const toast = document.createElement('div');
    toast.className = `px-4 py-2 rounded-md shadow-md text-sm ${
      type === 'success' ? 'bg-green-100 border border-green-300 text-green-800' :
      type === 'error' ? 'bg-red-100 border border-red-300 text-red-800' :
      type === 'info' ? 'bg-blue-100 border border-blue-300 text-blue-800' :
      'bg-gray-100 border border-gray-300 text-gray-800'
    } transition-opacity duration-300`;
    toast.textContent = message;
    toastContainer.appendChild(toast);
    setTimeout(function() {
      toast.style.opacity = 0;
      setTimeout(function() { toast.remove(); }, 300);
    }, 3000);
    return toast;
  };

   // Jinja macro simulation for duration
   window.humanize_duration = function(seconds) {
       if (seconds === null || seconds < 0) return 'N/A';
       seconds = Math.floor(seconds);
       if (seconds < 60) return `${seconds}s`;
       const minutes = Math.floor(seconds / 60);
       const remainingSeconds = seconds % 60;
       if (minutes < 60) return `${minutes}m ${remainingSeconds}s`;
       const hours = Math.floor(minutes / 60);
       const remainingMinutes = minutes % 60;
       return `${hours}h ${remainingMinutes}m`;
   }

});
</script>
{% endblock %}

