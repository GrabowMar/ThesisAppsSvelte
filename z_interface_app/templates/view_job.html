{% extends "base.html" %}

{% block styles %}
<style>
  .task-row-completed { background-color: #eff6ff; /* blue-50 */ }
  .task-row-failed { background-color: #fee2e2; /* red-100 */ }
  .task-row-timed_out { background-color: #fffbeb; /* yellow-50 */ }
  .task-row-cancelled { background-color: #ffedd5; /* orange-50 */ }
  .task-row-skipped { background-color: #f3f4f6; /* gray-100 */ }
  .task-row-running { background-color: #f0fdf4; /* green-50 */ }
  .task-row-pending { background-color: #f9fafb; /* gray-50 */ }


  .task-running-indicator::after {
    content: '...';
    display: inline-block;
    animation: dots 1.5s infinite steps(3, end);
    margin-left: 4px;
  }
  @keyframes dots {
    0%, 20% { color: rgba(0,0,0,0); text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0);}
    40% { color: gray; text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0);}
    60% { text-shadow: .25em 0 0 gray, .5em 0 0 rgba(0,0,0,0);}
    80%, 100% { text-shadow: .25em 0 0 gray, .5em 0 0 gray;}
  }

  .error-tooltip { position: relative; cursor: help; }
  .error-tooltip .tooltip-text {
    visibility: hidden; width: 300px; background-color: #ef4444; color: #fff;
    text-align: left; border-radius: 6px; padding: 5px 8px; position: absolute;
    z-index: 10; bottom: 125%; left: 50%; margin-left: -150px; opacity: 0;
    transition: opacity 0.3s; font-size: 11px; white-space: pre-wrap;
  }
  .error-tooltip:hover .tooltip-text { visibility: visible; opacity: 1; }
</style>
{% endblock %}

{% macro humanize_duration_filter(seconds) %}{% if seconds is none or seconds < 0 %}N/A{% else %}{% set seconds = seconds|int %}{% if seconds < 60 %}{{ seconds }}s{% elif seconds < 3600 %}{{ '%dm %ds'|format(seconds // 60, seconds % 60) }}{% else %}{{ '%dh %dm'|format(seconds // 3600, (seconds % 3600) // 60) }}{% endif %}{% endif %}{% endmacro %}
{% set job_start_time_iso = job.started_at if job.started_at else '' %}
{% set job_completion_time_iso = job.completed_at if job.completed_at else '' %}

{% block content %}
<div class="space-y-2 max-w-7xl mx-auto" data-job-id="{{ job.id }}" data-job-status="{{ job.status }}" data-job-start-time="{{ job_start_time_iso }}" data-job-completion-time="{{ job_completion_time_iso }}">
  <div class="border border-gray-400 bg-white p-2 rounded-md">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="font-bold text-xl text-gray-900">Batch Job Details</h1>
        <p class="text-xs text-gray-600 mt-1">{{ job.name }} (ID: {{ job.id }})</p>
      </div>
      <div class="flex items-center space-x-2">
        <a href="{{ url_for('batch_analysis.batch_dashboard') }}" class="action-btn h-6 px-2 text-xs flex items-center">
          <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg> Back to Dashboard
        </a>
        {% if job.status == JobStatus.RUNNING.value or job.status == JobStatus.INITIALIZING.value or job.status == JobStatus.QUEUED.value %}
          <button id="cancelJobBtn" class="action-btn h-6 px-2 text-xs flex items-center bg-red-600 text-white hover:bg-red-700 focus:ring-2 focus:ring-red-500 focus:ring-opacity-50 transition" data-job-id="{{ job.id }}">
            <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg> Cancel Job
          </button>
        {% endif %}
        {% if job.status not in [JobStatus.RUNNING.value, JobStatus.INITIALIZING.value, JobStatus.QUEUED.value, JobStatus.CANCELLING.value, JobStatus.PENDING.value] %}
            <button id="deleteJobBtn" class="action-btn h-6 px-2 text-xs bg-gray-500 text-white hover:bg-gray-600 focus:ring-2 focus:ring-gray-400 transition" data-job-id="{{ job.id }}">Delete Job</button>
        {% endif %}
        {% if job.status == JobStatus.COMPLETED.value or job.status == JobStatus.FAILED.value or job.status == JobStatus.CANCELLED.value %}
            <button id="archiveJobBtn" class="action-btn h-6 px-2 text-xs bg-purple-500 text-white hover:bg-purple-600 focus:ring-2 focus:ring-purple-400 transition" data-job-id="{{ job.id }}">Archive Job</button>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
    <div class="border border-gray-400 bg-white rounded-md shadow-sm">
      <div class="bg-gray-100 border-b border-gray-400 px-2 py-1"><h2 class="font-bold text-sm">Job Information</h2></div>
      <div class="p-2">
        <table class="w-full text-xs">
          <tr><td class="font-medium text-gray-600 py-1 pr-2 align-top">Name:</td><td>{{ job.name }}</td></tr>
          <tr><td class="font-medium text-gray-600 py-1 pr-2 align-top">Description:</td><td>{{ job.description if job.description else 'N/A' }}</td></tr>
          <tr>
            <td class="font-medium text-gray-600 py-1 pr-2 align-top">Status:</td>
            <td>
              <span id="jobStatusBadge" data-current-status="{{ job.status }}" class="px-2 py-0.5 rounded-md text-white capitalize font-semibold text-[10px]
                {% if job.status == JobStatus.RUNNING.value %}bg-green-600
                {% elif job.status == JobStatus.COMPLETED.value %}bg-blue-600
                {% elif job.status == JobStatus.PENDING.value %}bg-gray-500
                {% elif job.status == JobStatus.QUEUED.value %}bg-gray-400
                {% elif job.status == JobStatus.INITIALIZING.value %}bg-teal-500
                {% elif job.status == JobStatus.CANCELLING.value %}bg-yellow-400 text-gray-800
                {% elif job.status == JobStatus.CANCELLED.value %}bg-yellow-500 text-gray-800
                {% elif job.status == JobStatus.ARCHIVED.value %}bg-purple-600 {% elif job.status == JobStatus.ERROR.value %}bg-red-700
                {% else %}bg-red-600{% endif %}">
                {{ job.status.replace('_', ' ') }}
              </span>
            </td>
          </tr>
          <tr><td class="font-medium text-gray-600 py-1 pr-2 align-top">Created:</td><td>{{ job.created_at_formatted }}</td></tr>
          <tr><td class="font-medium text-gray-600 py-1 pr-2 align-top">Started:</td><td id="jobStartedAt">{{ job.started_at|datetimeformat if job.started_at else 'N/A' }}</td></tr>
          <tr><td class="font-medium text-gray-600 py-1 pr-2 align-top">Completed:</td><td id="jobCompletedAt">{{ job.completed_at|datetimeformat if job.completed_at else 'N/A' }}</td></tr>
          <tr>
            <td class="font-medium text-gray-600 py-1 pr-2 align-top">Analysis Types:</td>
            <td>
                <div class="flex flex-wrap gap-1">
                {% for at_str in job.analysis_types %}
                <span class="px-1.5 py-0.5 rounded text-[10px] font-medium capitalize
                    {% if at_str == AnalysisType.FRONTEND_SECURITY.value %} bg-purple-100 text-purple-800 border border-purple-300
                    {% elif at_str == AnalysisType.BACKEND_SECURITY.value %} bg-indigo-100 text-indigo-800 border border-indigo-300
                    {% elif at_str == AnalysisType.PERFORMANCE.value %} bg-pink-100 text-pink-800 border border-pink-300
                    {% elif at_str == AnalysisType.GPT4ALL.value %} bg-cyan-100 text-cyan-800 border border-cyan-300
                    {% elif at_str == AnalysisType.ZAP.value %} bg-orange-100 text-orange-800 border border-orange-300
                    {% elif at_str == AnalysisType.CODE_QUALITY.value %} bg-teal-100 text-teal-800 border border-teal-300 {% else %} bg-gray-100 text-gray-800 border border-gray-300 {% endif %}">
                    {{ at_str.replace('_', ' ') }}
                </span>
                {% endfor %}
                </div>
            </td>
          </tr>
          <tr>
            <td class="font-medium text-gray-600 py-1 pr-2 align-top">Models:</td>
            <td>{{ job.models|join(', ') }}</td>
          </tr>
          <tr>
            <td class="font-medium text-gray-600 py-1 pr-2 align-top">App Ranges:</td>
            <td>
                <pre class="text-[10px] bg-gray-50 p-1 rounded border border-gray-200 max-h-20 overflow-auto">{{ job.app_ranges|tojson(indent=2) }}</pre>
            </td>
          </tr>
           <tr>
            <td class="font-medium text-gray-600 py-1 pr-2 align-top">Analysis Options:</td>
            <td>
                <pre class="text-[10px] bg-gray-50 p-1 rounded border border-gray-200 max-h-20 overflow-auto">{{ job.analysis_options|tojson(indent=2) }}</pre>
            </td>
          </tr>
        </table>
      </div>
    </div>

    <div class="border border-gray-400 bg-white rounded-md shadow-sm">
      <div class="bg-gray-100 border-b border-gray-400 px-2 py-1"><h2 class="font-bold text-sm">Progress</h2></div>
      <div class="p-2">
        <div class="mb-2">
          <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden" title="{{ status_data.progress.completed }}/{{ status_data.progress.total }} tasks">
            <div id="progressBar" class="bg-blue-600 rounded-full h-4 flex items-center justify-center text-xs text-white transition-all duration-300"
                style="width: {{ status_data.progress.percent }}%">
              {{ status_data.progress.percent }}%
            </div>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-2 text-xs">
          <div class="border border-gray-300 p-2 rounded-md">
            <div class="text-gray-600">Total Tasks</div>
            <div class="font-bold" id="totalTasks">{{ status_data.progress.total }}</div>
          </div>
          <div class="border border-gray-300 p-2 rounded-md">
            <div class="text-gray-600">Completed Tasks</div>
            <div class="font-bold" id="completedTasks">{{ status_data.progress.completed }}</div>
          </div>
          <div class="border border-gray-300 p-2 rounded-md">
            <div class="text-gray-600">Runtime</div>
            <div class="font-bold" id="runtimeDisplay">N/A</div>
          </div>
          <div class="border border-gray-300 p-2 rounded-md">
            <div class="text-gray-600">Active Tasks</div>
            <div class="font-bold" id="activeTasksCount">{{ status_data.active_tasks_count }}</div>
          </div>
        </div>
        <div class="mt-2 text-xs border border-gray-300 p-2 rounded-md">
            <div class="text-gray-600 mb-1">Task Status Breakdown:</div>
            <div id="taskStatusBreakdown" class="space-y-0.5">
                {% for status_val, count in status_data.progress.by_status.items() %}
                    {% if count > 0 %}
                    <div class="flex justify-between">
                        <span class="capitalize">{{ status_val.replace('_', ' ') }}:</span>
                        <span class="font-semibold">{{ count }}</span>
                    </div>
                    {% endif %}
                {% else %}
                    <p class="text-gray-500 italic">No task statuses yet.</p>
                {% endfor %}
            </div>
        </div>
      </div>
    </div>

    <div class="border border-gray-400 bg-white rounded-md shadow-sm">
      <div class="bg-gray-100 border-b border-gray-400 px-2 py-1"><h2 class="font-bold text-sm">Aggregated Results</h2></div>
      <div id="aggregatedResultsContainer" class="p-2 space-y-2">
         {% if status_data.results_summary.get('high_total', 0) > 0 or status_data.results_summary.get('medium_total', 0) > 0 or status_data.results_summary.get('low_total', 0) > 0 or status_data.results_summary.get('frontend_security_tasks_processed',0) > 0 or status_data.results_summary.get('backend_security_tasks_processed',0) > 0 %}
         <div class="border border-gray-300 p-2 rounded-md">
            <h3 class="text-xs font-medium text-gray-700 mb-1">Security Issues</h3>
            <div class="grid grid-cols-3 gap-2 text-xs">
                <div><div class="text-red-600">High</div><div class="font-bold text-red-700" id="aggHighIssues">{{ status_data.results_summary.get('high_total', 0) }}</div></div>
                <div><div class="text-yellow-600">Medium</div><div class="font-bold text-yellow-700" id="aggMediumIssues">{{ status_data.results_summary.get('medium_total', 0) }}</div></div>
                <div><div class="text-blue-600">Low</div><div class="font-bold text-blue-700" id="aggLowIssues">{{ status_data.results_summary.get('low_total', 0) }}</div></div>
            </div>
         </div>
         {% endif %}
         {% if status_data.results_summary.get('performance_tasks_processed',0) > 0 %}
         <div class="border border-gray-300 p-2 rounded-md">
            <h3 class="text-xs font-medium text-gray-700 mb-1">Performance</h3>
            <div class="text-xs">
                Avg RPS: <span class="font-bold" id="aggAvgRps">{{ status_data.results_summary.get('performance_avg_rps', 'N/A') }}</span><br>
                Avg Resp Time: <span class="font-bold" id="aggAvgResponseTime">{{ status_data.results_summary.get('performance_avg_rt', 'N/A') }} ms</span><br>
                Total Failures: <span class="font-bold text-red-700" id="aggPerfFailures">{{ status_data.results_summary.get('performance_total_failures', 0) }}</span>
            </div>
         </div>
         {% endif %}
         {% if status_data.results_summary.get('gpt4all_tasks_processed',0) > 0 %}
         <div class="border border-gray-300 p-2 rounded-md">
            <h3 class="text-xs font-medium text-gray-700 mb-1">GPT4All Requirements</h3>
            <div class="text-xs">
                Reqs Checked: <span class="font-bold" id="aggGptReqsChecked">{{ status_data.results_summary.get('gpt4all_reqs_checked_total', 0) }}</span><br>
                Reqs Met: <span class="font-bold text-green-700" id="aggGptReqsMet">{{ status_data.results_summary.get('gpt4all_reqs_met_total', 0) }}</span>
            </div>
         </div>
         {% endif %}
         {% if status_data.results_summary.get('zap_tasks_processed',0) > 0 %}
         <div class="border border-gray-300 p-2 rounded-md">
            <h3 class="text-xs font-medium text-gray-700 mb-1">ZAP Scans</h3>
            <div class="text-xs">
                Scans Completed: <span class="font-bold" id="aggZapScansCompleted">{{ status_data.results_summary.get('zap_tasks_completed', 0) }}</span><br>
                Total Alerts: <span class="font-bold" id="aggZapTotalAlerts">{{ status_data.results_summary.get('zap_issues_total', 0) }}</span>
            </div>
         </div>
         {% endif %}
         {% if status_data.results_summary.get('code_quality_tasks_processed',0) > 0 %}
         <div class="border border-gray-300 p-2 rounded-md">
            <h3 class="text-xs font-medium text-gray-700 mb-1">Code Quality</h3>
            <div class="text-xs">
                Total Lint Errors: <span class="font-bold" id="aggCQLintErrors">{{ status_data.results_summary.get('code_quality_lint_errors_total', 0) }}</span><br>
                Avg Complexity: <span class="font-bold" id="aggCQAvgComplexity">{{ status_data.results_summary.get('code_quality_avg_complexity', 'N/A') }}</span><br>
                Avg Duplication: <span class="font-bold" id="aggCQAvgDuplication">{{ status_data.results_summary.get('code_quality_avg_duplication_percentage', 'N/A') }}%</span>
            </div>
         </div>
         {% endif %}
         {% if not status_data.results_summary %}
         <p class="text-xs text-gray-500 italic">No aggregated results available yet.</p>
         {% endif %}
      </div>
    </div>
  </div>

  <div class="border border-gray-400 bg-white rounded-md shadow-sm">
    <div class="bg-gray-100 border-b border-gray-400 px-2 py-1 flex justify-between items-center">
      <h2 class="font-bold text-sm">Task Results</h2>
      <div class="flex flex-wrap items-center gap-2">
        <div class="relative"><input type="text" id="searchResults" placeholder="Search tasks..." class="h-6 pl-6 pr-2 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"><svg class="w-3 h-3 absolute left-2 top-1.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg></div>
        <select id="resultStatusFilter" class="h-6 px-2 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
            <option value="all">All Statuses</option>
            {% for ts_enum in TaskStatus %}<option value="{{ ts_enum.value }}">{{ ts_enum.value.replace('_',' ')|title }}</option>{% endfor %}
        </select>
        <select id="resultModelFilter" class="h-6 px-2 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"><option value="all">All Models</option>{% for model_name in job.models %}<option value="{{ model_name }}">{{ model_name }}</option>{% endfor %}</select>
        <select id="resultAnalysisTypeFilter" class="h-6 px-2 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
            <option value="all">All Analysis Types</option>
            {% for type_enum in AnalysisType %}<option value="{{ type_enum.value }}">{{ type_enum.value.replace('_', ' ')|title }}</option>{% endfor %}
        </select>
      </div>
    </div>
    <div class="p-2">
      <div class="overflow-x-auto">
        <table class="min-w-full border border-gray-300">
          <thead>
            <tr class="bg-gray-100">
              <th class="border border-gray-300 px-2 py-1 text-xs text-left">Model</th>
              <th class="border border-gray-300 px-2 py-1 text-xs text-left">App</th>
              <th class="border border-gray-300 px-2 py-1 text-xs text-left">Analysis Type</th>
              <th class="border border-gray-300 px-2 py-1 text-xs text-left">Status</th>
              <th class="border border-gray-300 px-2 py-1 text-xs text-left">Summary/Error</th>
              <th class="border border-gray-300 px-2 py-1 text-xs text-left">Duration</th>
              <th class="border border-gray-300 px-2 py-1 text-xs text-left">Actions</th>
            </tr>
          </thead>
          <tbody id="resultsTableBody">
            {% if results %}
              {% for result_task in results %} {# Assuming 'results' here are task results/details #}
                <tr class="result-row hover:bg-gray-100 task-row-{{ result_task.status }}"
                    data-result-id="{{ result_task.id }}"
                    data-status="{{ result_task.status }}"
                    data-analysis-type="{{ result_task.analysis_type if result_task.analysis_type is string else result_task.analysis_type.value }}"
                    data-model="{{ result_task.model }}">
                  <td class="border border-gray-300 px-2 py-1 text-xs">{{ result_task.model }}</td>
                  <td class="border border-gray-300 px-2 py-1 text-xs">App {{ result_task.app_num }}</td>
                  <td class="border border-gray-300 px-2 py-1 text-xs">
                     {% set at_val = result_task.analysis_type if result_task.analysis_type is string else result_task.analysis_type.value %}
                     <span class="px-1.5 py-0.5 rounded text-white text-[10px] capitalize whitespace-nowrap
                        {% if at_val == AnalysisType.FRONTEND_SECURITY.value %}bg-purple-600
                        {% elif at_val == AnalysisType.BACKEND_SECURITY.value %}bg-indigo-600
                        {% elif at_val == AnalysisType.PERFORMANCE.value %}bg-cyan-600
                        {% elif at_val == AnalysisType.GPT4ALL.value %}bg-orange-600
                        {% elif at_val == AnalysisType.ZAP.value %}bg-lime-600
                        {% elif at_val == AnalysisType.CODE_QUALITY.value %}bg-teal-600 {% else %}bg-gray-500{% endif %}">
                        {{ at_val.replace('_', ' ') }}</span>
                  </td>
                  <td class="border border-gray-300 px-2 py-1 text-xs">
                    <span class="px-2 py-0.5 rounded-md text-white capitalize text-[10px] font-semibold
                      {% if result_task.status == TaskStatus.COMPLETED.value %}bg-blue-600
                      {% elif result_task.status == TaskStatus.RUNNING.value %}bg-green-500
                      {% elif result_task.status == TaskStatus.PENDING.value %}bg-gray-400
                      {% elif result_task.status == TaskStatus.FAILED.value %}bg-red-600
                      {% elif result_task.status == TaskStatus.TIMED_OUT.value %}bg-yellow-600 text-gray-800
                      {% elif result_task.status == TaskStatus.CANCELLED.value %}bg-yellow-500 text-gray-800
                      {% elif result_task.status == TaskStatus.SKIPPED.value %}bg-gray-500
                      {% else %}bg-gray-500{% endif %}">
                      {{ result_task.status.replace('_', ' ') }}
                      {% if result_task.status == TaskStatus.RUNNING.value %}<span class="task-running-indicator"></span>{% endif %}
                    </span>
                  </td>
                   <td class="border border-gray-300 px-2 py-1 text-xs">
                       {% set task_error = result_task.error if result_task.error else result_task.details.get('error') %}
                       {% set at_val = result_task.analysis_type if result_task.analysis_type is string else result_task.analysis_type.value %}
                       {% if task_error %}
                           <div class="error-tooltip text-red-700">
                                <span class="font-bold">Error:</span> {{ (task_error.message if task_error.message else task_error)|truncate(60) }}
                                <span class="tooltip-text">{{ (task_error.message if task_error.message else task_error)|replace('\n', '<br>')|safe }}<br><small>Category: {{ task_error.category if task_error.category else 'N/A' }}</small></span>
                           </div>
                       {% elif at_val == AnalysisType.FRONTEND_SECURITY.value or at_val == AnalysisType.BACKEND_SECURITY.value %}
                           <span class="text-red-700">{{ result_task.high_severity }}H</span>/<span class="text-yellow-600">{{ result_task.medium_severity }}M</span>/<span class="text-blue-700">{{ result_task.low_severity }}L</span> (<span class="font-bold">{{ result_task.issues_count }}</span> total)
                       {% elif at_val == AnalysisType.PERFORMANCE.value %}
                           {{ result_task.details.get('requests_per_sec', 0)|round(1) }} RPS / {{ result_task.details.get('avg_response_time', 0)|round(0) }}ms RT
                       {% elif at_val == AnalysisType.GPT4ALL.value %}
                           {{ result_task.details.get('summary', {}).get('met_count', 0) }} / {{ result_task.details.get('summary', {}).get('requirements_checked', 0) }} Met
                       {% elif at_val == AnalysisType.ZAP.value %}
                           {{ result_task.high_severity }}H / {{ result_task.medium_severity }}M / {{ result_task.low_severity }}L (<span class="font-bold">{{ result_task.issues_count }}</span> total)
                       {% elif at_val == AnalysisType.CODE_QUALITY.value %}
                           {{ result_task.details.get('summary', {}).get('lint_errors', 0) }} Lint / {{ result_task.details.get('summary', {}).get('complexity_score', 'N/A') }} Comp
                       {% else %}
                           {{ result_task.issues_count if result_task.issues_count is not none else (result_task.details.get('message', 'N/A') | truncate(30)) }}
                       {% endif %}
                   </td>
                  <td class="border border-gray-300 px-2 py-1 text-xs">
                      {{ humanize_duration_filter(result_task.duration_seconds) }}
                  </td>
                  <td class="border border-gray-300 px-2 py-1 text-xs">
                    <a href="{{ url_for('batch_analysis.view_result', result_id=result_task.id) }}" class="action-btn h-6 px-2 text-xs focus:ring-2 focus:ring-blue-500 transition">Details</a>
                  </td>
                </tr>
              {% endfor %}
            {% else %}
              <tr><td colspan="7" class="border border-gray-300 py-4 text-center text-sm text-gray-500" id="noTasksMessage">
                  {% if job.status == JobStatus.RUNNING.value %}Job is running - tasks and results will appear here...
                  {% elif job.status == JobStatus.PENDING.value or job.status == JobStatus.QUEUED.value or job.status == JobStatus.INITIALIZING.value %}Job is preparing - tasks will appear soon.
                  {% else %}No task results found for this job. {% endif %}
              </td></tr>
            {% endif %}
            <tr id="noResultsRow" class="hidden"><td colspan="7" class="border border-gray-300 py-4 text-center text-sm text-gray-500">No tasks match your current filters</td></tr>
          </tbody>
        </table>
      </div>
      <div id="resultsCounter" class="mt-2 text-xs text-gray-600 text-right">
        Showing <span id="visibleResultsCount">{{ results|length }}</span> of <span id="totalResultsCount">{{ results|length }}</span> tasks
      </div>
    </div>
  </div>

  <div id="errorsSection" class="border border-red-400 bg-red-50 rounded-md shadow-sm {% if not job.errors %}hidden{% endif %}">
    <div class="bg-red-100 border-b border-red-400 px-2 py-1"><h2 class="font-bold text-sm text-red-800">Job Execution Errors</h2></div>
    <div class="p-2">
      <ul id="errorsList" class="list-disc pl-4 text-xs text-red-700 space-y-1 max-h-40 overflow-y-auto">
        {% for error_obj in job.errors %}<li><strong>{{ error_obj.category }}:</strong> {{ error_obj.message }} {% if error_obj.task_id %}(Task: {{error_obj.task_id}}){% endif %}</li>{% endfor %}
        {% if not job.errors %}<li class="text-gray-500 italic">No job errors reported.</li>{% endif %}
      </ul>
    </div>
  </div>

  {% if job.status == JobStatus.RUNNING.value or job.status == JobStatus.INITIALIZING.value or job.status == JobStatus.QUEUED.value or job.status == JobStatus.CANCELLING.value %}
  <div class="fixed bottom-4 right-4 bg-white border border-gray-300 rounded-md shadow-md p-2 flex items-center space-x-2 z-40">
    <div class="text-xs text-gray-700">Auto-refresh:</div>
    <div class="relative inline-block w-10 h-5 align-middle select-none transition duration-200 ease-in">
        <input type="checkbox" id="autoRefreshToggle" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-2 appearance-none cursor-pointer peer" checked/>
        <label for="autoRefreshToggle" class="toggle-label block overflow-hidden h-5 rounded-full bg-gray-300 cursor-pointer peer-checked:bg-blue-500 peer-checked:border-blue-500"></label>
    </div>
    <div class="text-xs text-gray-700" id="refreshStatus"><span class="inline-block mr-1" id="refreshSpinner">‚ü≥</span>Next: <span id="refreshCountdown">10</span>s</div>
  </div>
  {% endif %}
  <div id="toastContainer" class="fixed bottom-4 left-4 z-50 flex flex-col gap-2"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const jobViewDiv = document.querySelector('.space-y-2.max-w-7xl.mx-auto');
    const jobId = jobViewDiv.dataset.jobId;
    let initialJobStatus = jobViewDiv.dataset.jobStatus;
    const jobStartTimeISO = jobViewDiv.dataset.jobStartTime;
    const jobCompletionTimeISO = jobViewDiv.dataset.jobCompletionTime;

    const progressBar = document.getElementById('progressBar');
    const completedTasksEl = document.getElementById('completedTasks');
    const totalTasksEl = document.getElementById('totalTasks');
    const runtimeDisplayEl = document.getElementById('runtimeDisplay');
    const jobStatusBadgeEl = document.getElementById('jobStatusBadge');
    const activeTasksCountEl = document.getElementById('activeTasksCount');
    const taskStatusBreakdownEl = document.getElementById('taskStatusBreakdown');
    const errorsListEl = document.getElementById('errorsList');
    const errorsSectionEl = document.getElementById('errorsSection');
    const aggregatedResultsContainerEl = document.getElementById('aggregatedResultsContainer');
    
    let jobStartTime = jobStartTimeISO ? new Date(jobStartTimeISO) : null;
    let jobCompletionTime = jobCompletionTimeISO ? new Date(jobCompletionTimeISO) : null;
    let runtimeInterval;

    function humanizeDurationJS(totalSeconds) {
        if (totalSeconds === null || totalSeconds === undefined || totalSeconds < 0) return 'N/A';
        totalSeconds = Math.floor(totalSeconds);
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;
        let parts = [];
        if (hours > 0) parts.push(hours + 'h');
        if (minutes > 0) parts.push(minutes + 'm');
        if (seconds >= 0 && parts.length < 2) parts.push(seconds + 's'); // Show seconds if duration is short or only hours/mins are shown
        return parts.join(' ') || '0s';
    }

    function updateRuntimeDisplay() {
        if (!jobStartTime) {
            runtimeDisplayEl.textContent = 'N/A';
            return;
        }
        const endTime = jobCompletionTime || (initialJobStatus === '{{ JobStatus.RUNNING.value }}' || initialJobStatus === '{{ JobStatus.INITIALIZING.value }}' || initialJobStatus === '{{ JobStatus.CANCELLING.value }}' ? new Date() : null);
        if (endTime) {
            const durationSeconds = Math.floor((endTime - jobStartTime) / 1000);
            runtimeDisplayEl.textContent = humanizeDurationJS(durationSeconds);
            if (initialJobStatus === '{{ JobStatus.RUNNING.value }}' || initialJobStatus === '{{ JobStatus.INITIALIZING.value }}' || initialJobStatus === '{{ JobStatus.CANCELLING.value }}') {
                 runtimeDisplayEl.innerHTML += '<span class="task-running-indicator"></span>';
            }
        } else {
            runtimeDisplayEl.textContent = 'N/A';
        }
    }

    function startRuntimeUpdates() {
        if (initialJobStatus === '{{ JobStatus.RUNNING.value }}' || initialJobStatus === '{{ JobStatus.INITIALIZING.value }}' || initialJobStatus === '{{ JobStatus.CANCELLING.value }}') {
            if (runtimeInterval) clearInterval(runtimeInterval);
            runtimeInterval = setInterval(updateRuntimeDisplay, 1000);
        } else {
            if (runtimeInterval) clearInterval(runtimeInterval);
        }
        updateRuntimeDisplay();
    }
    
    startRuntimeUpdates();


    function setupActionButtons() {
        const cancelBtn = document.getElementById('cancelJobBtn');
        const deleteBtn = document.getElementById('deleteJobBtn');
        const archiveBtn = document.getElementById('archiveJobBtn'); // NEW_FEATURE

        if (cancelBtn) {
            cancelBtn.addEventListener('click', () => handleJobAction(jobId, 'cancel', cancelBtn, 'Cancelling...'));
        }
        if (deleteBtn) {
            deleteBtn.addEventListener('click', () => {
                 if (confirm('Are you sure you want to delete this job and all its results? This cannot be undone.')) {
                    handleJobAction(jobId, 'delete', deleteBtn, 'Deleting...');
                 }
            });
        }
        if (archiveBtn) { // NEW_FEATURE
            archiveBtn.addEventListener('click', () => {
                if (confirm('Are you sure you want to archive this job?')) {
                    handleJobAction(jobId, 'archive', archiveBtn, 'Archiving...');
                }
            });
        }
    }

    function handleJobAction(jobId, action, button, loadingText) {
        const originalText = button.innerHTML;
        button.disabled = true;
        button.innerHTML = `<svg class="animate-spin w-3 h-3 inline mr-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> ${loadingText}`;

        fetch(`/batch-analysis/job/${jobId}/${action}`, {
            method: 'POST',
            headers: { 'X-Requested-With': 'XMLHttpRequest', 'Content-Type': 'application/json' }
        })
        .then(response => response.json().then(data => ({ok: response.ok, status: response.status, data})))
        .then(({ok, status, data}) => {
            if (ok && data.success) {
                showToast(data.message || `Job ${action}d successfully.`, 'info');
                if (action === 'delete') {
                    window.location.href = "{{ url_for('batch_analysis.batch_dashboard') }}";
                } else {
                    // For cancel/archive, we expect the status to update via polling or manual refresh
                    // Optionally, trigger a manual poll immediately
                    fetchJobStatus(true); // Pass true to indicate it's an action response
                }
            } else {
                showToast(data.error || data.message || `Failed to ${action} job (Status: ${status})`, 'error');
                button.disabled = false;
                button.innerHTML = originalText;
            }
        })
        .catch(error => {
            console.error(`Error ${action}ing job:`, error);
            showToast(`Network error ${action}ing job.`, 'error');
            button.disabled = false;
            button.innerHTML = originalText;
        });
    }
    
    setupActionButtons();
    setupResultsFilters();

    {% if job.status == JobStatus.RUNNING.value or job.status == JobStatus.INITIALIZING.value or job.status == JobStatus.QUEUED.value or job.status == JobStatus.CANCELLING.value %}
        setupAutoRefresh();
    {% endif %}

    function setupResultsFilters() {
        const searchInput = document.getElementById('searchResults');
        const statusFilter = document.getElementById('resultStatusFilter');
        const modelFilter = document.getElementById('resultModelFilter');
        const analysisTypeFilter = document.getElementById('resultAnalysisTypeFilter');
        const tableBody = document.getElementById('resultsTableBody');
        const allRows = Array.from(tableBody.querySelectorAll('tr.result-row'));
        const noResultsRow = document.getElementById('noResultsRow');
        const visibleCountEl = document.getElementById('visibleResultsCount');
        const totalCountEl = document.getElementById('totalResultsCount');
        const noTasksMessageRow = tableBody.querySelector('td[colspan="7"]')?.closest('tr');


        function applyResultFilters() {
            const searchText = searchInput.value.toLowerCase();
            const selectedStatus = statusFilter.value;
            const selectedModel = modelFilter.value;
            const selectedAnalysisType = analysisTypeFilter.value;
            let visibleCount = 0;

            allRows.forEach(row => {
                const status = row.dataset.status;
                const model = row.dataset.model;
                const analysisType = row.dataset.analysisType;
                const textContent = row.textContent.toLowerCase();

                const matchesSearch = !searchText || textContent.includes(searchText);
                const matchesStatus = selectedStatus === 'all' || status === selectedStatus;
                const matchesModel = selectedModel === 'all' || model === selectedModel;
                const matchesAnalysisType = selectedAnalysisType === 'all' || analysisType === selectedAnalysisType;

                const isVisible = matchesSearch && matchesStatus && matchesModel && matchesAnalysisType;
                row.style.display = isVisible ? '' : 'none';
                if (isVisible) visibleCount++;
            });
            
            visibleCountEl.textContent = visibleCount;
            noResultsRow.style.display = (visibleCount === 0 && allRows.length > 0) ? 'table-row' : 'none';
            if (noTasksMessageRow) {
                noTasksMessageRow.style.display = (allRows.length === 0) ? 'table-row' : 'none';
            }
        }
        [searchInput, statusFilter, modelFilter, analysisTypeFilter].forEach(el => el.addEventListener('input', applyResultFilters));
        applyResultFilters(); // Initial application
    }


    let refreshInterval;
    let countdownInterval;
    const REFRESH_INTERVAL_SECONDS = 10;

    function setupAutoRefresh() {
        const toggle = document.getElementById('autoRefreshToggle');
        const countdownEl = document.getElementById('refreshCountdown');
        const spinnerEl = document.getElementById('refreshSpinner');
        let countdown = REFRESH_INTERVAL_SECONDS;

        function resetCountdown() {
            countdown = REFRESH_INTERVAL_SECONDS;
            countdownEl.textContent = countdown;
        }

        function stopIntervals() {
            clearInterval(refreshInterval);
            clearInterval(countdownInterval);
            spinnerEl.style.animation = 'none';
        }

        function startIntervals() {
            stopIntervals(); // Clear existing before starting new
            if (!toggle.checked) return;

            resetCountdown();
            spinnerEl.style.animation = 'spin 1s linear infinite'; // Assuming a CSS spin animation

            refreshInterval = setInterval(() => {
                fetchJobStatus();
                resetCountdown();
            }, REFRESH_INTERVAL_SECONDS * 1000);

            countdownInterval = setInterval(() => {
                countdown--;
                countdownEl.textContent = countdown;
                if (countdown <= 0) resetCountdown(); // Should be reset by outer interval
            }, 1000);
        }

        toggle.addEventListener('change', () => {
            if (toggle.checked) {
                startIntervals();
                fetchJobStatus(); // Fetch immediately when toggled on
            } else {
                stopIntervals();
            }
        });
        startIntervals(); // Start on page load if toggle is checked
    }
    
    function getStatusColorClass(statusValue, baseType = 'bg') {
        const statusColors = {
            '{{ JobStatus.RUNNING.value }}': `${baseType}-green-600`,
            '{{ JobStatus.COMPLETED.value }}': `${baseType}-blue-600`,
            '{{ JobStatus.PENDING.value }}': `${baseType}-gray-500`,
            '{{ JobStatus.QUEUED.value }}': `${baseType}-gray-400`,
            '{{ JobStatus.INITIALIZING.value }}': `${baseType}-teal-500`,
            '{{ JobStatus.CANCELLING.value }}': `${baseType}-yellow-400 text-gray-800`, // Ensure text is readable
            '{{ JobStatus.CANCELLED.value }}': `${baseType}-yellow-500 text-gray-800`,
            '{{ JobStatus.ARCHIVED.value }}': `${baseType}-purple-600`, // NEW_FEATURE
            '{{ JobStatus.ERROR.value }}': `${baseType}-red-700`,
            '{{ JobStatus.FAILED.value }}': `${baseType}-red-600`,
        };
        return statusColors[statusValue] || `${baseType}-gray-500`; // Default
    }


    function fetchJobStatus(isActionResponse = false) {
        fetch(`/batch-analysis/job/${jobId}/status`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error("Error fetching status:", data.error);
                    showToast(`Error fetching job status: ${data.error}`, 'error');
                    return;
                }
                updatePageWithStatusData(data, isActionResponse);
            })
            .catch(error => {
                console.error('Network error fetching status:', error);
                showToast('Network error fetching job status.', 'error');
            });
    }

    function updatePageWithStatusData(data, isActionResponse) {
        const jobData = data.job;
        initialJobStatus = jobData.status; // Update global status

        // Update Job Info
        jobStatusBadgeEl.textContent = jobData.status.replace('_', ' ');
        jobStatusBadgeEl.className = `px-2 py-0.5 rounded-md text-white capitalize font-semibold text-[10px] ${getStatusColorClass(jobData.status)}`;
        document.getElementById('jobStartedAt').textContent = jobData.started_at ? new Date(jobData.started_at).toLocaleString() : 'N/A';
        document.getElementById('jobCompletedAt').textContent = jobData.completed_at ? new Date(jobData.completed_at).toLocaleString() : 'N/A';
        
        jobStartTime = jobData.started_at ? new Date(jobData.started_at) : null;
        jobCompletionTime = jobData.completed_at ? new Date(jobData.completed_at) : null;
        startRuntimeUpdates(); // Restart runtime updates with new times/status

        // Update Progress
        progressBar.style.width = `${data.progress.percent}%`;
        progressBar.textContent = `${data.progress.percent}%`;
        progressBar.title = `${data.progress.completed}/${data.progress.total} tasks`;
        totalTasksEl.textContent = data.progress.total;
        completedTasksEl.textContent = data.progress.completed;
        activeTasksCountEl.textContent = data.active_tasks_count;

        // Update Task Status Breakdown
        let breakdownHtml = '';
        if (Object.keys(data.progress.by_status).length > 0) {
            for (const [status_val, count] of Object.entries(data.progress.by_status)) {
                if (count > 0) {
                    breakdownHtml += `<div class="flex justify-between"><span class="capitalize">${status_val.replace('_', ' ')}:</span><span class="font-semibold">${count}</span></div>`;
                }
            }
        } else {
            breakdownHtml = '<p class="text-gray-500 italic">No task statuses yet.</p>';
        }
        taskStatusBreakdownEl.innerHTML = breakdownHtml;
        
        // Update Errors
        let errorsHtml = '';
        if (jobData.errors && jobData.errors.length > 0) {
            jobData.errors.forEach(err => {
                errorsHtml += `<li><strong>${err.category}:</strong> ${err.message} ${err.task_id ? `(Task: ${err.task_id})` : ''}</li>`;
            });
            errorsSectionEl.classList.remove('hidden');
        } else {
            errorsHtml = '<li class="text-gray-500 italic">No job errors reported.</li>';
            if (!isActionResponse) errorsSectionEl.classList.add('hidden'); // Don't hide if an action just occurred, user might want to see it clear
        }
        errorsListEl.innerHTML = errorsHtml;

        // Update Aggregated Results (Simplified: just replacing the content)
        // A more robust solution would update individual elements if their IDs are stable
        // For now, let's assume the summary structure is relatively simple.
        // This part would need to be more granular if you want smooth updates without full re-render.
        // Example for one item:
        document.getElementById('aggHighIssues')?.textContent = data.results_summary.high_total || 0;
        // ... and so on for all aggregated metrics.
        // For new Code Quality aggregated results:
        document.getElementById('aggCQLintErrors')?.textContent = data.results_summary.code_quality_lint_errors_total || 0;
        document.getElementById('aggCQAvgComplexity')?.textContent = data.results_summary.code_quality_avg_complexity || 'N/A';
        document.getElementById('aggCQAvgDuplication')?.textContent = (data.results_summary.code_quality_avg_duplication_percentage || 'N/A') + '%';


        // If job is no longer running, stop auto-refresh
        const autoRefreshToggle = document.getElementById('autoRefreshToggle');
        if (autoRefreshToggle && initialJobStatus !== '{{ JobStatus.RUNNING.value }}' && initialJobStatus !== '{{ JobStatus.INITIALIZING.value }}' && initialJobStatus !== '{{ JobStatus.QUEUED.value }}' && initialJobStatus !== '{{ JobStatus.CANCELLING.value }}') {
            autoRefreshToggle.checked = false;
            clearInterval(refreshInterval);
            clearInterval(countdownInterval);
            document.getElementById('refreshSpinner').style.animation = 'none';
            document.getElementById('refreshStatus').innerHTML = 'Auto-refresh stopped.';
            // Hide refresh controls or disable them
            document.querySelector('.fixed.bottom-4.right-4')?.classList.add('hidden');

            // Show/hide action buttons based on new status
            setupActionButtons(); // Re-evaluate which buttons should be visible
        }
        
        // Fetch and update task list if it's a significant update or first load
        if (isActionResponse || !document.getElementById('resultsTableBody').querySelector('tr.result-row')) {
            fetchJobTasks();
        }
    }

    function fetchJobTasks() {
        fetch(`/batch-analysis/job/${jobId}/results`) // Assuming this endpoint returns task details
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error("Error fetching tasks:", data.error);
                    return;
                }
                updateTasksTable(data.results);
            })
            .catch(error => console.error('Network error fetching tasks:', error));
    }

    function updateTasksTable(tasks) {
        const tableBody = document.getElementById('resultsTableBody');
        tableBody.innerHTML = ''; // Clear existing tasks

        if (tasks && tasks.length > 0) {
            tasks.forEach(task => {
                const errorInfo = task.error ? `<div class="error-tooltip text-red-700"><span class="font-bold">Error:</span> ${(task.error.message || task.error).substring(0,60)}<span class="tooltip-text">${(task.error.message || task.error).replace(/\n/g, '<br>')}<br><small>Category: ${task.error.category || 'N/A'}</small></span></div>` : '';
                
                let summaryHtml = '';
                const at_val = task.analysis_type; // Already a string from to_dict()
                if (task.error) {
                    summaryHtml = errorInfo;
                } else if (at_val === '{{ AnalysisType.FRONTEND_SECURITY.value }}' || at_val === '{{ AnalysisType.BACKEND_SECURITY.value }}') {
                    summaryHtml = `<span class="text-red-700">${task.high_severity}H</span>/<span class="text-yellow-600">${task.medium_severity}M</span>/<span class="text-blue-700">${task.low_severity}L</span> (<span class="font-bold">${task.issues_count}</span> total)`;
                } else if (at_val === '{{ AnalysisType.PERFORMANCE.value }}') {
                    summaryHtml = `${task.details.requests_per_sec !== undefined ? task.details.requests_per_sec.toFixed(1) : 0} RPS / ${task.details.avg_response_time !== undefined ? Math.round(task.details.avg_response_time) : 0}ms RT`;
                } else if (at_val === '{{ AnalysisType.GPT4ALL.value }}') {
                    summaryHtml = `${task.details.summary?.met_count || 0} / ${task.details.summary?.requirements_checked || 0} Met`;
                } else if (at_val === '{{ AnalysisType.ZAP.value }}') {
                     summaryHtml = `${task.high_severity}H / ${task.medium_severity}M / ${task.low_severity}L (<span class="font-bold">${task.issues_count}</span> total)`;
                } else if (at_val === '{{ AnalysisType.CODE_QUALITY.value }}') { // NEW_FEATURE
                    summaryHtml = `${task.details.summary?.lint_errors || 0} Lint / ${task.details.summary?.complexity_score || 'N/A'} Comp`;
                } else {
                    summaryHtml = task.issues_count !== undefined ? task.issues_count : (task.details.message || 'N/A').substring(0,30);
                }

                const taskStatusClassMap = {
                    '{{ TaskStatus.COMPLETED.value }}': 'task-row-completed',
                    '{{ TaskStatus.FAILED.value }}': 'task-row-failed',
                    '{{ TaskStatus.TIMED_OUT.value }}': 'task-row-timed_out',
                    '{{ TaskStatus.CANCELLED.value }}': 'task-row-cancelled',
                    '{{ TaskStatus.SKIPPED.value }}': 'task-row-skipped',
                    '{{ TaskStatus.RUNNING.value }}': 'task-row-running',
                    '{{ TaskStatus.PENDING.value }}': 'task-row-pending',
                };
                const rowClass = taskStatusClassMap[task.status] || 'task-row-pending';

                const analysisTypeClassMap = {
                    '{{ AnalysisType.FRONTEND_SECURITY.value }}': 'bg-purple-600',
                    '{{ AnalysisType.BACKEND_SECURITY.value }}': 'bg-indigo-600',
                    '{{ AnalysisType.PERFORMANCE.value }}': 'bg-cyan-600',
                    '{{ AnalysisType.GPT4ALL.value }}': 'bg-orange-600',
                    '{{ AnalysisType.ZAP.value }}': 'bg-lime-600',
                    '{{ AnalysisType.CODE_QUALITY.value }}': 'bg-teal-600', // NEW_FEATURE
                };
                const atBadgeClass = analysisTypeClassMap[at_val] || 'bg-gray-500';
                
                const taskStatusBadgeClassMap = {
                    '{{ TaskStatus.COMPLETED.value }}': 'bg-blue-600',
                    '{{ TaskStatus.RUNNING.value }}': 'bg-green-500',
                    '{{ TaskStatus.PENDING.value }}': 'bg-gray-400',
                    '{{ TaskStatus.FAILED.value }}': 'bg-red-600',
                    '{{ TaskStatus.TIMED_OUT.value }}': 'bg-yellow-600 text-gray-800',
                    '{{ TaskStatus.CANCELLED.value }}': 'bg-yellow-500 text-gray-800',
                    '{{ TaskStatus.SKIPPED.value }}': 'bg-gray-500',
                };
                const statusBadgeClass = taskStatusBadgeClassMap[task.status] || 'bg-gray-500';


                const rowHtml = `
                    <tr class="result-row hover:bg-gray-100 ${rowClass}" data-result-id="${task.id}" data-status="${task.status}" data-analysis-type="${at_val}" data-model="${task.model}">
                        <td class="border border-gray-300 px-2 py-1 text-xs">${task.model}</td>
                        <td class="border border-gray-300 px-2 py-1 text-xs">App ${task.app_num}</td>
                        <td class="border border-gray-300 px-2 py-1 text-xs">
                            <span class="px-1.5 py-0.5 rounded text-white text-[10px] capitalize whitespace-nowrap ${atBadgeClass}">${at_val.replace(/_/g, ' ')}</span>
                        </td>
                        <td class="border border-gray-300 px-2 py-1 text-xs">
                            <span class="px-2 py-0.5 rounded-md text-white capitalize text-[10px] font-semibold ${statusBadgeClass}">
                                ${task.status.replace(/_/g, ' ')}
                                ${task.status === '{{ TaskStatus.RUNNING.value }}' ? '<span class="task-running-indicator"></span>' : ''}
                            </span>
                        </td>
                        <td class="border border-gray-300 px-2 py-1 text-xs">${summaryHtml}</td>
                        <td class="border border-gray-300 px-2 py-1 text-xs">${humanizeDurationJS(task.duration_seconds)}</td>
                        <td class="border border-gray-300 px-2 py-1 text-xs">
                            <a href="/batch-analysis/result/${task.id}" class="action-btn h-6 px-2 text-xs focus:ring-2 focus:ring-blue-500 transition">Details</a>
                        </td>
                    </tr>`;
                tableBody.innerHTML += rowHtml;
            });
        } else {
            const jobStatus = jobStatusBadgeEl.dataset.currentStatus;
            let message = 'No task results found for this job.';
            if (jobStatus === '{{ JobStatus.RUNNING.value }}') message = 'Job is running - tasks and results will appear here...';
            else if (jobStatus === '{{ JobStatus.PENDING.value }}' || jobStatus === '{{ JobStatus.QUEUED.value }}' || jobStatus === '{{ JobStatus.INITIALIZING.value }}') message = 'Job is preparing - tasks will appear soon.';
            tableBody.innerHTML = `<tr><td colspan="7" class="border border-gray-300 py-4 text-center text-sm text-gray-500" id="noTasksMessage">${message}</td></tr>`;
        }
        document.getElementById('totalResultsCount').textContent = tasks.length;
        setupResultsFilters(); // Re-apply filters to the new content
    }
    
    fetchJobTasks(); // Initial fetch for tasks

    window.showToast = function(message, type = 'success') {
        const toastContainer = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        let bgColor, textColor, borderColor;
        switch(type) {
            case 'error': bgColor = 'bg-red-100'; textColor = 'text-red-800'; borderColor = 'border-red-300'; break;
            case 'info': bgColor = 'bg-blue-100'; textColor = 'text-blue-800'; borderColor = 'border-blue-300'; break;
            default: bgColor = 'bg-green-100'; textColor = 'text-green-800'; borderColor = 'border-green-300';
        }
        toast.className = `px-4 py-2 rounded-md shadow-md text-sm ${bgColor} ${textColor} border ${borderColor} transition-opacity duration-300`;
        toast.textContent = message;
        toastContainer.appendChild(toast);
        setTimeout(() => {
            toast.style.opacity = 0;
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    };
});
</script>
{% endblock %}
