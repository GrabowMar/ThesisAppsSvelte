{% extends "base.html" %}

{% block title %}Requirements Analysis - {{ model }}/app{{ app_num }}{% endblock %}

{% block content %}
<div class="flex min-h-screen bg-gray-100">
  <!-- Main Content Area -->
  <div class="flex-1 flex flex-col overflow-hidden">
    <!-- Top Navigation and Filter Bar -->
    <div class="bg-gray-200 border-b border-gray-400 p-1">
      <div class="flex justify-between items-center">
        <!-- Left Side Controls -->
        <div class="flex items-center space-x-2">
          <a href="{{ url_for('main.index') }}" class="action-btn h-6 px-2 text-xs rounded-sm">Back</a>
          <form method="post" action="{{ url_for('gpt4all.gpt4all_analysis', model=model, app_num=app_num) }}" class="inline-flex">
            <input type="hidden" name="gpt4all_model" id="hiddenModelInput" value="">
            <button type="submit" name="check_requirements" id="runAnalysisBtn" class="action-btn h-6 px-2 text-xs rounded-sm">Run Analysis</button>
          </form>
        </div>
        
        <!-- Right Side - App Info -->
        <div class="flex items-center space-x-3">
          <span class="text-xs font-medium">Model: {{ model }}</span>
          <span class="text-xs font-medium">App: {{ app_num }}</span>
          <span class="text-xs font-medium">Template: {{ template_name or "Unknown" }}</span>
        </div>
      </div>
    </div>

    <!-- Analysis Content Area -->
    <div class="p-2 flex-1 overflow-auto space-y-2">
      <!-- Requirements Overview Card -->
      <div class="border border-gray-400 bg-white rounded-sm shadow-sm">
        <div class="bg-gray-100 border-b border-gray-400 px-2 py-1">
          <h2 class="font-bold text-sm">Requirements</h2>
        </div>
        <div class="p-2">
          <div class="text-xs text-gray-600 mb-2">The following requirements will be checked against the code:</div>
          
          <div class="border border-gray-300 rounded-sm p-2 bg-gray-50">
            <ul class="list-disc pl-4 space-y-1">
              {% for req in requirements %}
              <li class="text-xs">{{ req }}</li>
              {% endfor %}
            </ul>
          </div>
        </div>
      </div>

      <!-- Error Message -->
      {% if error %}
      <div class="border border-red-400 bg-red-50 p-3 rounded-sm">
        <p class="text-xs text-red-700">{{ error }}</p>
      </div>
      {% endif %}

      <!-- Analysis Results -->
      {% if results %}
      <div class="border border-gray-400 bg-white rounded-sm shadow-sm">
        <div class="bg-gray-100 border-b border-gray-400 px-2 py-1">
          <div class="flex justify-between items-center">
            <h2 class="font-bold text-sm">Analysis Results</h2>
            <!-- Filter -->
            <div class="flex items-center space-x-2">
              <input type="text" id="searchRequirements" placeholder="Search..." 
                     class="h-6 px-2 text-xs border border-gray-300 rounded-sm">
              <select id="statusFilter" class="h-6 px-2 text-xs border border-gray-300 rounded-sm">
                <option value="all">All Status</option>
                <option value="met">Met</option>
                <option value="not_met">Not Met</option>
              </select>
            </div>
          </div>
        </div>

        <div class="p-2">
          <!-- Results summary -->
          <div class="mb-3 p-2 border border-gray-300 rounded-sm bg-gray-50">
            {% set met_count = results|selectattr('result.met', 'true')|list|length %}
            {% set total_count = results|length %}
            {% set percentage = (met_count / total_count * 100)|int if total_count > 0 else 0 %}

            <div class="flex items-center justify-between">
              <div class="text-xs font-medium">Requirements Met: {{ met_count }}/{{ total_count }} ({{ percentage }}%)</div>
              
              <div class="flex space-x-2">
                <div class="text-xs flex items-center">
                  <div class="w-3 h-3 rounded-full bg-green-500 mr-1"></div>
                  <span>Met: {{ met_count }}</span>
                </div>
                <div class="text-xs flex items-center">
                  <div class="w-3 h-3 rounded-full bg-red-500 mr-1"></div>
                  <span>Not Met: {{ total_count - met_count }}</span>
                </div>
              </div>
            </div>
            
            <!-- Progress bar -->
            <div class="mt-1 bg-gray-300 rounded-full h-1.5 overflow-hidden">
              <div class="bg-blue-600 h-1.5" style="width: '{{ percentage }}%'"></div>
            </div>
          </div>
          
          <!-- Results list -->
          <div id="requirementList" class="space-y-1">
            {% for check in results %}
            <div class="border border-gray-300 rounded-sm hover:bg-gray-50 requirement-item" 
                 data-status="{{ 'met' if check.result.met else 'not_met' }}" 
                 data-searchable="{{ check.requirement }}">
              <div class="px-2 py-1.5 flex justify-between items-center cursor-pointer" onclick="toggleDetails('details_{{ loop.index }}')">
                <div class="text-xs overflow-hidden">{{ check.requirement }}</div>
                <div class="flex-shrink-0">
                  {% if check.result.met %}
                  <span class="px-2 py-0.5 text-2xs bg-green-100 text-green-800 border border-green-300 rounded-sm">Met</span>
                  {% else %}
                  <span class="px-2 py-0.5 text-2xs bg-red-100 text-red-800 border border-red-300 rounded-sm">Not Met</span>
                  {% endif %}
                </div>
              </div>
              
              <!-- Details Section (initially hidden) -->
              <div id="details_{{ loop.index }}" class="px-2 py-1.5 bg-gray-50 border-t border-gray-200 text-xs hidden">
                {% if check.result.error %}
                  <div class="text-red-600 mb-2">{{ check.result.error }}</div>
                {% endif %}
                
                <div class="grid grid-cols-2 gap-4 mb-2">
                  <div>
                    <p class="font-semibold text-gray-700 mb-1">Result:</p>
                    <p>{{ "Requirement Met" if check.result.met else "Requirement Not Met" }}</p>
                  </div>
                  <div>
                    <p class="font-semibold text-gray-700 mb-1">Confidence:</p>
                    <p>{{ check.result.confidence }}</p>
                  </div>
                </div>
                
                {% if check.result.explanation %}
                <div class="mt-2">
                  <p class="font-semibold text-gray-700 mb-1">Explanation:</p>
                  <div class="whitespace-pre-wrap bg-white p-2 border border-gray-200 rounded-sm">{{ check.result.explanation }}</div>
                </div>
                {% endif %}
                
                <!-- Show Details button -->
                <div class="mt-3">
                  <button type="button" class="expand-btn text-xs text-blue-600 hover:text-blue-800 focus:outline-none" onclick="showAllDetails('{{ loop.index }}')">
                    Show All Details
                  </button>
                </div>
                
                <!-- Detailed Analysis (initially hidden) -->
                <div id="full_details_{{ loop.index }}" class="mt-2 hidden">
                  {% if check.result.frontend_analysis %}
                  <div class="mt-2">
                    <p class="font-semibold text-gray-700 mb-1">Frontend Analysis:</p>
                    <div class="whitespace-pre-wrap bg-white p-2 border border-gray-200 rounded-sm">
                      <p><strong>Met:</strong> {{ "Yes" if check.result.frontend_analysis.met else "No" }}</p>
                      <p><strong>Confidence:</strong> {{ check.result.frontend_analysis.confidence }}</p>
                      <p><strong>Explanation:</strong> {{ check.result.frontend_analysis.explanation }}</p>
                    </div>
                  </div>
                  {% endif %}
                  
                  {% if check.result.backend_analysis %}
                  <div class="mt-2">
                    <p class="font-semibold text-gray-700 mb-1">Backend Analysis:</p>
                    <div class="whitespace-pre-wrap bg-white p-2 border border-gray-200 rounded-sm">
                      <p><strong>Met:</strong> {{ "Yes" if check.result.backend_analysis.met else "No" }}</p>
                      <p><strong>Confidence:</strong> {{ check.result.backend_analysis.confidence }}</p>
                      <p><strong>Explanation:</strong> {{ check.result.backend_analysis.explanation }}</p>
                    </div>
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
      {% else %}
      <!-- No Results Message -->
      <div class="border border-gray-400 bg-white p-3 rounded-sm shadow-sm text-center">
        <p class="text-sm text-gray-700">
          Click the "Run Analysis" button to check if the application meets these requirements.
        </p>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Right Sidebar -->
  <aside class="w-64 bg-gray-200 border-l border-gray-400 flex flex-col">
    <div class="p-2 space-y-2 flex-1 overflow-auto">
      <!-- Analysis Information Card -->
      <div class="border border-gray-400 bg-white rounded-sm shadow-sm">
        <div class="bg-gray-100 border-b border-gray-400 px-2 py-1">
          <h2 class="font-bold text-xs">Analysis Info</h2>
        </div>
        <div class="p-2 text-xs space-y-1">
          {% for label, value in [
            ('Model:', model),
            ('App:', app_num),
            ('Template:', template_name or "Unknown")
          ] %}
          <div class="flex justify-between">
            <span class="text-gray-600">{{ label }}</span>
            <span class="font-bold">{{ value }}</span>
          </div>
          {% endfor %}
        </div>
      </div>

      <!-- Model Selection Card -->
      <div class="border border-gray-400 bg-white rounded-sm shadow-sm">
        <div class="bg-gray-100 border-b border-gray-400 px-2 py-1">
          <h2 class="font-bold text-xs">GPT4All Model</h2>
        </div>
        <div class="p-2 space-y-2">
          <div>
            <label for="modelSelect" class="block text-xs text-gray-600 mb-1">Select GPT4All Model:</label>
            <select id="modelSelect" class="w-full h-7 px-2 text-xs border border-gray-300 rounded-sm">
              <option value="Llama 3 8B Instruct">Llama 3 8B Instruct</option>
              <option value="DeepSeek-R1-Distill-Qwen-7B">DeepSeek-R1-Distill-Qwen-7B</option>
              <option value="DeepSeek-R1-Distill-Qwen-14B">DeepSeek-R1-Distill-Qwen-14B</option>
              <option value="Nous Hermes 2 Mistral DPO">Nous Hermes 2 Mistral DPO</option>
              <option value="GPT4All Falcon">GPT4All Falcon</option>
            </select>
          </div>
          <button id="refreshModels" class="action-btn h-7 px-2 text-xs w-full rounded-sm">Refresh Models</button>
        </div>
      </div>

      <!-- Server Status Card -->
      <div class="border border-gray-400 bg-white rounded-sm shadow-sm">
        <div class="bg-gray-100 border-b border-gray-400 px-2 py-1">
          <h2 class="font-bold text-xs">Server Status</h2>
        </div>
        <div class="p-2">
          <div class="text-xs mb-2" id="serverStatus">Checking server status...</div>
          <div class="flex items-center text-xs">
            <div id="statusIndicator" class="w-3 h-3 rounded-full bg-gray-500 mr-2"></div>
            <span id="statusText">Unknown</span>
          </div>
        </div>
      </div>

      <!-- Help Card -->
      <div class="border border-gray-400 bg-white rounded-sm shadow-sm">
        <div class="bg-gray-100 border-b border-gray-400 px-2 py-1">
          <h2 class="font-bold text-xs">Help</h2>
        </div>
        <div class="p-2 text-xs space-y-2">
          <p><strong>Using Requirements Analysis</strong></p>
          <ol class="list-decimal pl-4 space-y-1">
            <li>Select a GPT4All model from the dropdown</li>
            <li>Click "Run Analysis" to check requirements</li>
            <li>View results showing which requirements are met</li>
            <li>Click on a requirement to see details</li>
          </ol>
        </div>
      </div>
    </div>
  </aside>
</div>

<script>
    /**
 * JavaScript enhancements for requirements_check.html template
 * Add this to the extra_scripts block in your template
 */

// Add this to your requirements_check.html template in the extra_scripts block
document.addEventListener('DOMContentLoaded', function() {
    // Fix form submission
    const form = document.querySelector('form');
    const requirementsTextarea = document.getElementById('requirements');
    const submitBtn = document.getElementById('submitBtn');
    
    if (form) {
      // Make sure we have the correct form action
      const currentUrl = new URL(window.location.href);
      const model = currentUrl.searchParams.get('model');
      const appNum = currentUrl.searchParams.get('app_num');
      
      // Update form action if needed
      if (model && appNum) {
        // Make sure the URL has /gpt4all/analysis not /gpt4all/gpt4all-analysis
        const correctAction = `/gpt4all/analysis?model=${encodeURIComponent(model)}&app_num=${encodeURIComponent(appNum)}`;
        if (form.action !== correctAction) {
          console.log(`Updating form action from ${form.action} to ${correctAction}`);
          form.action = correctAction;
        }
      }
      
      // Add hidden input for check_requirements if not present
      if (!form.querySelector('input[name="check_requirements"]')) {
        const checkRequirementsInput = document.createElement('input');
        checkRequirementsInput.type = 'hidden';
        checkRequirementsInput.name = 'check_requirements';
        checkRequirementsInput.value = 'true';
        form.appendChild(checkRequirementsInput);
      }
      
      // Handle form submission
      form.addEventListener('submit', function(e) {
        // Show loading state
        if (submitBtn) {
          submitBtn.innerHTML = `
            <svg class="animate-spin w-3 h-3 inline mr-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>Checking...`;
          submitBtn.disabled = true;
        }
      });
    }
    
    // Add direct API calling functionality
    window.callRequirementsAPI = function(model, appNum, requirements) {
      if (submitBtn) {
        submitBtn.innerHTML = `
          <svg class="animate-spin w-3 h-3 inline mr-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>Checking...`;
        submitBtn.disabled = true;
      }
      
      // Format requirements as array if it's a string
      if (typeof requirements === 'string') {
        requirements = requirements
          .split('\n')
          .map(line => line.trim())
          .filter(line => line.length > 0);
      }
      
      // Create the request payload
      const payload = {
        model: model,
        app_num: parseInt(appNum, 10),
        requirements: requirements
      };
      
      console.log('Sending API request with data:', payload);
      
      // Make the API call
      fetch('/gpt4all/api/requirements-check', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify(payload)
      })
      .then(response => {
        console.log('API response status:', response.status);
        return response.json().catch(e => {
          throw new Error(`Failed to parse response: ${e.message}`);
        });
      })
      .then(data => {
        console.log('API response data:', data);
        
        if (data.status === 'success') {
          // Success - reload the page to show results
          window.location.reload();
        } else {
          // Error - show message and reset button
          alert('Error: ' + (data.error || 'Unknown error occurred'));
          if (submitBtn) {
            submitBtn.innerHTML = 'Check Requirements';
            submitBtn.disabled = false;
          }
        }
      })
      .catch(error => {
        console.error('API request failed:', error);
        alert('Request failed: ' + error.message);
        
        if (submitBtn) {
          submitBtn.innerHTML = 'Check Requirements';
          submitBtn.disabled = false;
        }
      });
    };
    
    // Check server status and show indicator
    function checkServerStatus() {
      fetch('/gpt4all/server-status')
        .then(response => response.json())
        .then(data => {
          const statusElement = document.getElementById('serverStatus');
          if (statusElement) {
            if (data.available) {
              statusElement.className = 'text-green-500';
              statusElement.textContent = 'Server Available';
            } else {
              statusElement.className = 'text-red-500';
              statusElement.textContent = 'Server Unavailable';
            }
          }
        })
        .catch(error => {
          console.error('Error checking server status:', error);
          const statusElement = document.getElementById('serverStatus');
          if (statusElement) {
            statusElement.className = 'text-red-500';
            statusElement.textContent = 'Server Check Failed';
          }
        });
    }
    
    // Check server status on page load
    checkServerStatus();
    
    // Add model selector functionality if it exists
    const modelSelector = document.getElementById('gpt4allModelSelector');
    if (modelSelector) {
      // Fetch available models
      fetch('/gpt4all/models')
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success' && Array.isArray(data.models) && data.models.length > 0) {
            // Clear loading option
            modelSelector.innerHTML = '';
            
            // Add models to selector
            data.models.forEach(model => {
              const modelId = typeof model === 'object' ? model.id : model;
              const option = document.createElement('option');
              option.value = modelId;
              option.textContent = modelId;
              modelSelector.appendChild(option);
            });
            
            // Enable selector
            modelSelector.disabled = false;
          } else {
            console.error('Failed to load models:', data);
            modelSelector.innerHTML = '<option value="">No models available</option>';
          }
        })
        .catch(error => {
          console.error('Error loading models:', error);
          modelSelector.innerHTML = '<option value="">Error loading models</option>';
        });
    }
  });
</script>
{% endblock %}