{% extends "base.html" %}

{% block title %}Requirements Analysis - {{ model }}/app{{ app_num }}{% endblock %}

{% block content %}
<div class="space-y-3">
  <!-- Header -->
  <div class="bg-white border border-gray-300 rounded-md shadow-sm">
    <div class="bg-gray-100 border-b border-gray-300 px-3 py-1.5">
      <h2 class="font-semibold text-gray-700">Requirements Analysis</h2>
    </div>
    <div class="p-4">
      <!-- App Information -->
      <div class="mb-4">
        <h3 class="text-sm font-semibold mb-2">App Information</h3>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <p class="text-xs text-gray-500 mb-1">Model:</p>
            <p class="text-sm font-medium">{{ model or "Not specified" }}</p>
          </div>
          <div>
            <p class="text-xs text-gray-500 mb-1">App Number:</p>
            <p class="text-sm font-medium">{{ app_num or "Not specified" }}</p>
          </div>
          <div>
            <p class="text-xs text-gray-500 mb-1">Template:</p>
            <p class="text-sm font-medium">{{ template_name or "Unknown" }}</p>
          </div>
        </div>
      </div>

      <!-- Requirements Form -->
      <div class="mb-4">
        <h3 class="text-sm font-semibold mb-2">Requirements</h3>
        <form method="post" action="{{ url_for('gpt4all.gpt4all_analysis', model=model, app_num=app_num) }}">
          <div class="mb-3">
            <label for="requirements" class="block text-xs text-gray-500 mb-1">Edit the requirements below or use the default ones for this app type.</label>
            <textarea name="requirements" id="requirements" rows="8" class="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">{% for req in requirements %}{{ req }}
{% endfor %}</textarea>
          </div>
          <div class="flex justify-end">
            <button type="submit" id="submitBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-1 text-sm rounded">Check Requirements</button>
          </div>
        </form>
      </div>

      <!-- Error Message -->
      {% if error %}
      <div class="bg-red-50 border border-red-300 text-red-800 px-4 py-3 rounded mb-4">
        <p class="text-sm">{{ error }}</p>
      </div>
      {% endif %}

      <!-- Analysis Results -->
      {% if results %}
      <div class="mb-4">
        <h3 class="text-sm font-semibold mb-2">Analysis Results</h3>
        
        <div class="border border-gray-300 rounded overflow-hidden">
          {% for check in results %}
          <div class="border-b border-gray-300 last:border-b-0 hover:bg-gray-50" {% if loop.index > 1 %}onclick="toggleDetails('details_{{ loop.index }}')"{% endif %}>
            <div class="px-3 py-2 flex justify-between items-center cursor-pointer">
              <div class="flex-grow text-sm">{{ check.requirement }}</div>
              <div class="flex-shrink-0">
                {% if check.result.met %}
                <span class="px-2 py-0.5 text-xs bg-green-100 text-green-800 border border-green-300 rounded">Met</span>
                {% else %}
                <span class="px-2 py-0.5 text-xs bg-red-100 text-red-800 border border-red-300 rounded">Not Met</span>
                {% endif %}
              </div>
            </div>
            
            <!-- Details Section (initially hidden except for first item) -->
            <div id="details_{{ loop.index }}" class="px-3 py-2 bg-gray-50 border-t border-gray-200 text-xs {% if loop.index > 1 %}hidden{% endif %}">
              {% if check.result.error %}
                <div class="text-red-600 mb-2">{{ check.result.error }}</div>
              {% endif %}
              
              <div class="grid grid-cols-2 gap-4 mb-2">
                <div>
                  <p class="font-semibold text-gray-700 mb-1">Result:</p>
                  <p>{{ "Requirement Met" if check.result.met else "Requirement Not Met" }}</p>
                </div>
                <div>
                  <p class="font-semibold text-gray-700 mb-1">Confidence:</p>
                  <p>{{ check.result.confidence }}</p>
                </div>
              </div>
              
              {% if check.result.explanation %}
              <div class="mt-2">
                <p class="font-semibold text-gray-700 mb-1">Explanation:</p>
                <div class="whitespace-pre-wrap bg-white p-2 border border-gray-200 rounded">{{ check.result.explanation }}</div>
              </div>
              {% endif %}
              
              <!-- Show Details button -->
              <div class="mt-3">
                <button type="button" class="expand-btn text-xs text-blue-600 hover:text-blue-800 focus:outline-none" onclick="showAllDetails('{{ loop.index }}')">
                  Show All Details
                </button>
              </div>
              
              <!-- Detailed Analysis (initially hidden) -->
              <div id="full_details_{{ loop.index }}" class="mt-2 hidden">
                {% if check.result.frontend_analysis %}
                <div class="mt-2">
                  <p class="font-semibold text-gray-700 mb-1">Frontend Analysis:</p>
                  <div class="whitespace-pre-wrap bg-white p-2 border border-gray-200 rounded">
                    <p><strong>Met:</strong> {{ "Yes" if check.result.frontend_analysis.met else "No" }}</p>
                    <p><strong>Confidence:</strong> {{ check.result.frontend_analysis.confidence }}</p>
                    <p><strong>Explanation:</strong> {{ check.result.frontend_analysis.explanation }}</p>
                  </div>
                </div>
                {% endif %}
                
                {% if check.result.backend_analysis %}
                <div class="mt-2">
                  <p class="font-semibold text-gray-700 mb-1">Backend Analysis:</p>
                  <div class="whitespace-pre-wrap bg-white p-2 border border-gray-200 rounded">
                    <p><strong>Met:</strong> {{ "Yes" if check.result.backend_analysis.met else "No" }}</p>
                    <p><strong>Confidence:</strong> {{ check.result.backend_analysis.confidence }}</p>
                    <p><strong>Explanation:</strong> {{ check.result.backend_analysis.explanation }}</p>
                  </div>
                </div>
                {% endif %}
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>

{% block extra_scripts %}
<script>
  function toggleDetails(detailId) {
    const details = document.getElementById(detailId);
    if (details) {
      details.classList.toggle('hidden');
    }
  }
  
  function showAllDetails(index) {
    const detailsElement = document.getElementById(`full_details_${index}`);
    const button = document.querySelector(`#details_${index} .expand-btn`);
    
    if (detailsElement.classList.contains('hidden')) {
      detailsElement.classList.remove('hidden');
      button.textContent = 'Hide Details';
    } else {
      detailsElement.classList.add('hidden');
      button.textContent = 'Show All Details';
    }
  }
  
  // Form submission
  document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    const submitBtn = document.getElementById('submitBtn');
    
    if (form && submitBtn) {
      form.addEventListener('submit', function() {
        submitBtn.innerHTML = `
          <svg class="animate-spin w-3 h-3 inline mr-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>Checking...`;
        submitBtn.disabled = true;
      });
    }
  });
</script>
{% endblock %}
{% endblock %}