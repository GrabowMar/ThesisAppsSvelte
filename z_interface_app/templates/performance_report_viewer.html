{% extends "base.html" %}

{% block content %}
<div class="space-y-2">
    <!-- Toolbar - Matches UIController styling -->
    <div class="bg-gray-100 border border-gray-300 p-2 rounded-md shadow-sm">
        <div class="flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <a href="{{ url_for('performance.performance_test', model=model, port=port) }}" class="action-btn h-7 px-2 text-xs">
                    <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                    Back to Test
                </a>
                <a href="{{ url_for('main.index') }}" class="action-btn h-7 px-2 text-xs">
                    <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                    </svg>
                    Dashboard
                </a>
                <button id="refreshReport" class="action-btn h-7 px-2 text-xs">
                    <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                    Refresh Report
                </button>
            </div>
            <div>
                <span class="text-xs font-bold" id="reportName" data-report-name="{{ report_name }}">{{ report_name }}</span>
            </div>
        </div>
    </div>

    <!-- Report Content - Integrated with PerformanceTest class -->
    <div class="border border-gray-300 bg-white rounded-md shadow-sm overflow-hidden">
        <div class="bg-gray-50 border-b border-gray-300 px-3 py-1.5 flex justify-between items-center">
            <h2 class="font-bold text-sm text-gray-800">Performance Report</h2>
            <div class="flex items-center text-xs text-gray-600">
                <span id="reportStatus" class="ml-2">
                    <span class="inline-block h-2 w-2 rounded-full bg-green-500 mr-1"></span>
                    Report Loaded
                </span>
            </div>
        </div>
        <div class="p-0">
            <!-- Performance Report Frame - Used by PerformanceTest.updateStatistics -->
            <div id="reportContainer" class="w-full">
                <iframe id="reportFrame" class="w-full border-0" srcdoc="{{ report_content|safe }}" data-model="{{ model }}" data-port="{{ port }}"></iframe>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  // This script aligns with the PerformanceTest class in dashboard.js
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize report viewer
    initializeReportViewer();
  });

  function initializeReportViewer() {
    const reportFrame = document.getElementById('reportFrame');
    const refreshButton = document.getElementById('refreshReport');
    const reportStatus = document.getElementById('reportStatus');

    if (!reportFrame || !refreshButton || !reportStatus) return;

    // Add refresh functionality - Follows PerformanceTest.runTest pattern
    refreshButton.addEventListener('click', function() {
      updateReportStatus('loading');
      try {
        reportFrame.contentWindow.location.reload();
      } catch(e) {
        console.error('Error refreshing report:', e);
        updateReportStatus('error');
      }
    });

    // Handle iframe loading - Follows UtilityService pattern
    reportFrame.addEventListener('load', function() {
      try {
        // Adjust iframe height based on content
        const frameContent = this.contentDocument || this.contentWindow.document;
        const height = frameContent.body.scrollHeight;
        reportFrame.style.height = (height + 50) + 'px';
        updateReportStatus('loaded');
        
        // Log successful report load
        logReportEvent('loaded');
      } catch(e) {
        console.error('Error adjusting iframe height:', e);
        updateReportStatus('error');
        
        // Log error using UtilityService.logError pattern
        logReportEvent('error', e);
      }
    });

    // Update report status
    function updateReportStatus(status) {
      let statusHTML = '';
      
      switch(status) {
        case 'loading':
          statusHTML = '<span class="inline-block h-2 w-2 rounded-full bg-yellow-500 mr-1"></span> Loading...';
          break;
        case 'loaded':
          statusHTML = '<span class="inline-block h-2 w-2 rounded-full bg-green-500 mr-1"></span> Report Loaded';
          break;
        case 'error':
          statusHTML = '<span class="inline-block h-2 w-2 rounded-full bg-red-500 mr-1"></span> Error Loading Report';
          break;
        default:
          statusHTML = '<span class="inline-block h-2 w-2 rounded-full bg-gray-500 mr-1"></span> Unknown Status';
      }
      
      reportStatus.innerHTML = statusHTML;
    }
    
    // Log report events - Matches UtilityService.logError
    function logReportEvent(event, error) {
      if (window.dashboardApp && window.dashboardApp.utilityService) {
        const model = reportFrame.getAttribute('data-model');
        const port = reportFrame.getAttribute('data-port');
        const reportName = document.getElementById('reportName').getAttribute('data-report-name');
        
        if (event === 'error') {
          window.dashboardApp.utilityService.logError({
            message: 'Error loading performance report',
            context: { model, port, reportName },
            error: error || new Error('Failed to load report')
          });
        }
      }
    }
    
    // Initial status update
    updateReportStatus('loading');
  }
</script>
{% endblock %}